{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13395796",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796",
    "key": "ARROW-13650",
    "fields": {
        "parent": {
            "id": "13393328",
            "key": "ARROW-13542",
            "self": "https://issues.apache.org/jira/rest/api/2/issue/13393328",
            "fields": {
                "summary": "[C++][Compute][Dataset] Add dataset::WriteNode for writing rows from an ExecPlan to disk",
                "status": {
                    "self": "https://issues.apache.org/jira/rest/api/2/status/5",
                    "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
                    "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
                    "name": "Resolved",
                    "id": "5",
                    "statusCategory": {
                        "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                        "id": 3,
                        "key": "done",
                        "colorName": "green",
                        "name": "Done"
                    }
                },
                "priority": {
                    "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
                    "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                    "name": "Major",
                    "id": "3"
                },
                "issuetype": {
                    "self": "https://issues.apache.org/jira/rest/api/2/issuetype/4",
                    "id": "4",
                    "description": "An improvement or enhancement to an existing feature or task.",
                    "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype",
                    "name": "Improvement",
                    "subtask": false,
                    "avatarId": 21140
                }
            }
        },
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12350323",
                "id": "12350323",
                "description": "",
                "name": "6.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-10-26"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available",
            "query-engine"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328935",
                "id": "12328935",
                "name": "C++"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "aggregateprogress": {
            "progress": 42600,
            "total": 42600,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 42600,
            "total": 42600,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-13650/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 71,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/638975",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-900798814\n\n\n   https://issues.apache.org/jira/browse/ARROW-13650\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-18T04:14:44.506+0000",
                    "updated": "2021-08-18T04:14:44.506+0000",
                    "started": "2021-08-18T04:14:44.506+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "638975",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639311",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-900798814\n\n\n   https://issues.apache.org/jira/browse/ARROW-13650\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-18T16:42:06.717+0000",
                    "updated": "2021-08-18T16:42:06.717+0000",
                    "started": "2021-08-18T16:42:06.717+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639311",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639821",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "jorisvandenbossche commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r692070088\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n+\n+  /// If true then the write will delete all files from a partition when it is first\n+  /// written to.  This delete will only affect partitions that have at least one file\n+  /// written to them.\n+  bool purge_modified_partition = false;\n\nReview comment:\n       So this basically allows to \"append\" a dataset (eg adding new days, if it was partitioned per day), without the risk of overriding existing data? \r\n   (seems like a nice option, should it be the default?)\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.h\n##########\n@@ -0,0 +1,89 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <string>\n+\n+#include \"arrow/dataset/file_base.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/status.h\"\n+#include \"arrow/util/future.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+constexpr uint64_t kDefaultDatasetWriterMaxRowsQueued = 64 * 1024 * 1024;\n+\n+/// \\brief Utility class that manages a set of writers to different paths\n+///\n+/// Writers may be closed and reopened (and a new file created) based on the dataset\n+/// write options (for example, min_rows_per_file or max_open_files)\n+///\n+/// The dataset writer enforces its own back pressure based on the # of rows (as opposed\n+/// to # of batches which is how it is typically enforced elsewhere) and # of files.\n+class DatasetWriter {\n+ public:\n+  /// \\brief Creates a dataset writer\n+  /// max_rows_queued represents the max number of rows allowed in the dataset writer\n+  /// at any given time.\n+  DatasetWriter(FileSystemDatasetWriteOptions write_options,\n+                std::shared_ptr<Schema> schema,\n+                uint64_t max_rows_queued = kDefaultDatasetWriterMaxRowsQueued);\n+\n+  ~DatasetWriter();\n+\n+  /// \\brief Writes a batch to the dataset\n+  /// \\param[in] directory The directory to write to\n+  ///\n+  /// Note: The written filename will be {directory}/{filename_factory(i)} where i is a\n+  /// counter controlled by `max_open_files` and `max_rows_per_file`\n+  ///\n+  /// If multiple WriteRecordBatch calls arrive with the same `directory` then the batches\n+  /// may be written to the same file.\n\nReview comment:\n       Could it be an option that this does not happen? (each new batch is a new file) As alternative way to control the files instead of `max_rows_per_file`\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n\nReview comment:\n       What's the default behaviour here? \r\n   I don't fully understand how setting this helps increase performance on S3. I would expect, based on your description of the characteristics of S3, that it helps to write more smaller files to S3 (so they can be written concurrently). \r\n   Or it helps S3 by setting this to a relatively low number (and the default is to always wait on a busy writer to finish so it can the batch can be added to an existing file being written? (resulting is fewer larger files))\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-19T12:43:29.774+0000",
                    "updated": "2021-08-19T12:43:29.774+0000",
                    "started": "2021-08-19T12:43:29.774+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639821",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639953",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r692341993\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.h\n##########\n@@ -0,0 +1,89 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <string>\n+\n+#include \"arrow/dataset/file_base.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/status.h\"\n+#include \"arrow/util/future.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+constexpr uint64_t kDefaultDatasetWriterMaxRowsQueued = 64 * 1024 * 1024;\n+\n+/// \\brief Utility class that manages a set of writers to different paths\n+///\n+/// Writers may be closed and reopened (and a new file created) based on the dataset\n+/// write options (for example, min_rows_per_file or max_open_files)\n+///\n+/// The dataset writer enforces its own back pressure based on the # of rows (as opposed\n+/// to # of batches which is how it is typically enforced elsewhere) and # of files.\n+class DatasetWriter {\n+ public:\n+  /// \\brief Creates a dataset writer\n+  /// max_rows_queued represents the max number of rows allowed in the dataset writer\n+  /// at any given time.\n+  DatasetWriter(FileSystemDatasetWriteOptions write_options,\n+                std::shared_ptr<Schema> schema,\n+                uint64_t max_rows_queued = kDefaultDatasetWriterMaxRowsQueued);\n+\n+  ~DatasetWriter();\n+\n+  /// \\brief Writes a batch to the dataset\n+  /// \\param[in] directory The directory to write to\n+  ///\n+  /// Note: The written filename will be {directory}/{filename_factory(i)} where i is a\n+  /// counter controlled by `max_open_files` and `max_rows_per_file`\n+  ///\n+  /// If multiple WriteRecordBatch calls arrive with the same `directory` then the batches\n+  /// may be written to the same file.\n\nReview comment:\n       It would be pretty easy to add such an option.  I don't know how often it will make sense though as the user doesn't often have a lot of control over the size of the incoming record batches.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-19T17:28:30.808+0000",
                    "updated": "2021-08-19T17:28:30.808+0000",
                    "started": "2021-08-19T17:28:30.808+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639953",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639957",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r692346234\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n+\n+  /// If true then the write will delete all files from a partition when it is first\n+  /// written to.  This delete will only affect partitions that have at least one file\n+  /// written to them.\n+  bool purge_modified_partition = false;\n\nReview comment:\n       The default is admittedly, a little messy, and will probably delete existing data.  When set to true, you will definitely delete existing data, but it will be cleaner.  I will add a third option (now that I remember) which is to error out instead of doing anything.  This is all based on the conversations in ARROW-12358\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-19T17:34:38.119+0000",
                    "updated": "2021-08-19T17:34:38.119+0000",
                    "started": "2021-08-19T17:34:38.119+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639957",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639958",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r692351686\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n\nReview comment:\n       I'm starting to feel a little less certain about this option as it is kind of confusing.  Also, in a lot of cases we will be writing to enough files concurrently that it won't really matter.\r\n   \r\n   If you were to write out one file with one million rows it would be slower than writing out four files with 250,000 rows because S3 performance really relies on multiple concurrent streams.  From [Performance Design Patterns for Amazon S3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/optimizing-performance-design-patterns.html)\r\n   \r\n   > Make one concurrent request for each 85\u201390 MB/s of desired network throughput. To saturate a 10 Gb/s network interface card (NIC), you might use about 15 concurrent requests over separate connections. You can scale up the concurrent requests over more connections to saturate faster NICs, such as 25 Gb/s or 100 Gb/s NICs. \r\n   \r\n   It doesn't take too many CPUs to get a parquet scan running at 500 MB/s so to prevent S3 from being the bottleneck you'd need 5 or 6 concurrent read streams and 5 or 6 concurrent write streams.\r\n   \r\n   The reason I am less certain is that the option the confusing and setting a reasonable max_rows_per_file is probably good enough.  Consider the above example (1 million vs 250k).  If you are writing billions of rows and your max_rows_per_file is 1 million then it probably won't matter, you'll be writing out 4-5 files soon enough anyways.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-19T17:42:44.554+0000",
                    "updated": "2021-08-19T17:42:44.554+0000",
                    "started": "2021-08-19T17:42:44.554+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639958",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/639959",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "jorisvandenbossche commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r692352068\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n+\n+  /// If true then the write will delete all files from a partition when it is first\n+  /// written to.  This delete will only affect partitions that have at least one file\n+  /// written to them.\n+  bool purge_modified_partition = false;\n\nReview comment:\n       Ah, sorry, I misread :) It's indeed clearly still deleting data with this option. Adding an option to error sounds a good idea indeed.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-19T17:43:23.285+0000",
                    "updated": "2021-08-19T17:43:23.285+0000",
                    "started": "2021-08-19T17:43:23.285+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "639959",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/640906",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r694423159\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n+\n+  /// If true then the write will delete all files from a partition when it is first\n+  /// written to.  This delete will only affect partitions that have at least one file\n+  /// written to them.\n+  bool purge_modified_partition = false;\n\nReview comment:\n       I added an option to error.  My first pass was going to be \"raise an error if writing to a partition directory and that directory had files\" however that could lead to a situation where we write some data and then encounter an error.  So now I raise an error if any files exist in the destination directory at all.  Those files may not be in directories that will be written to (if those partitions would not be modified) but there is no way for us to know that ahead of time.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-24T01:46:38.764+0000",
                    "updated": "2021-08-24T01:46:38.764+0000",
                    "started": "2021-08-24T01:46:38.764+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "640906",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/640907",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r694423244\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/file_base.h\n##########\n@@ -364,6 +364,28 @@ struct ARROW_DS_EXPORT FileSystemDatasetWriteOptions {\n   /// {i} will be replaced by an auto incremented integer.\n   std::string basename_template;\n \n+  /// If greater than 0 then this will limit the maximum number of files that can be left\n+  /// open. If an attempt is made to open too many files then the least recently used file\n+  /// will be closed.  If this setting is set too low you may end up fragmenting your data\n+  /// into many small files.\n+  uint32_t max_open_files = 1024;\n+\n+  /// If greater than 0 then this will limit how many rows are placed in any single file.\n+  uint64_t max_rows_per_file = 0;\n+\n+  /// If greater than 0 then the dataset writer will create a new file if a request comes\n+  /// in and all existing writers for that file are busy and have at least\n+  /// min_rows_per_file.  This can be used to increase performance on filesystems like S3\n+  /// where the write speed may be slow but many concurrent writes are supported.  This is\n+  /// a hint only and the writer may need to create smaller files to satisfy\n+  /// max_open_files.\n+  uint64_t min_rows_per_file = 0;\n\nReview comment:\n       I've removed `min_rows_per_file`\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-24T01:46:51.983+0000",
                    "updated": "2021-08-24T01:46:51.983+0000",
                    "started": "2021-08-24T01:46:51.983+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "640907",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/641683",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r695752450\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.cc\n##########\n@@ -0,0 +1,569 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"arrow/dataset/dataset_writer.h\"\n+\n+#include <list>\n+#include <mutex>\n+#include <unordered_map>\n+\n+#include \"arrow/filesystem/path_util.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/result.h\"\n+#include \"arrow/util/future.h\"\n+#include \"arrow/util/logging.h\"\n+#include \"arrow/util/map.h\"\n+#include \"arrow/util/string.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+namespace {\n+\n+constexpr util::string_view kIntegerToken = \"{i}\";\n+\n+class DatasetWriterStatistics {\n+ public:\n+  DatasetWriterStatistics(uint64_t max_rows_in_flight, uint32_t max_files_in_flight)\n+      : max_rows_in_flight_(max_rows_in_flight),\n+        max_files_in_flight_(max_files_in_flight) {}\n+\n+  bool CanWrite(const std::shared_ptr<RecordBatch>& record_batch,\n+                const std::string& filename) {\n+    std::lock_guard<std::mutex> lg(mutex_);\n+    uint64_t rows = record_batch->num_rows();\n+    DCHECK_LT(rows, max_rows_in_flight_);\n+\n+    if (rows_in_flight_ + rows > max_rows_in_flight_) {\n+      rows_in_waiting_ = rows;\n+      backpressure_ = Future<>::Make();\n+      return false;\n+    }\n+    return true;\n+  }\n\nReview comment:\n       This looks convoluted. Why not a single API which would return a `Future`?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-25T13:29:28.803+0000",
                    "updated": "2021-08-25T13:29:28.803+0000",
                    "started": "2021-08-25T13:29:28.802+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "641683",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/641685",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r695753427\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.cc\n##########\n@@ -0,0 +1,569 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"arrow/dataset/dataset_writer.h\"\n+\n+#include <list>\n+#include <mutex>\n+#include <unordered_map>\n+\n+#include \"arrow/filesystem/path_util.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/result.h\"\n+#include \"arrow/util/future.h\"\n+#include \"arrow/util/logging.h\"\n+#include \"arrow/util/map.h\"\n+#include \"arrow/util/string.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+namespace {\n+\n+constexpr util::string_view kIntegerToken = \"{i}\";\n+\n+class DatasetWriterStatistics {\n+ public:\n+  DatasetWriterStatistics(uint64_t max_rows_in_flight, uint32_t max_files_in_flight)\n+      : max_rows_in_flight_(max_rows_in_flight),\n+        max_files_in_flight_(max_files_in_flight) {}\n\nReview comment:\n       It is bizarre IMHO to have a single class managing different independent limits (you may want to write a new batch to an already open file even if the file limit was reached).\r\n   \r\n   Why not separate classes? Also, perhaps give them more meaningful names e.g. `RowsLimiter` and `OpenFilesLimiter`.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-25T13:30:19.766+0000",
                    "updated": "2021-08-25T13:30:19.766+0000",
                    "started": "2021-08-25T13:30:19.765+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "641685",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/643179",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "motybz commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-907773672\n\n\n   Hi\r\n   \r\n   In my POV the user should control the in-memory size of the datasets since the reason to separate the data set is to control the memory consumption of distributed data-consuming systems (like Spark, Presto, etc...).\r\n   Moreover, the size of the final file of the data set depends on:\r\n   number of columns * column type (int8/16/32, string, float... )* number of lines * compression.\r\n   \r\n   I can't see any benefit of controlling the number of the lines (besides the effect on the file size)\r\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-08-29T11:10:50.432+0000",
                    "updated": "2021-08-29T11:10:50.432+0000",
                    "started": "2021-08-29T11:10:50.431+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "643179",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/650886",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r708750761\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.cc\n##########\n@@ -0,0 +1,569 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"arrow/dataset/dataset_writer.h\"\n+\n+#include <list>\n+#include <mutex>\n+#include <unordered_map>\n+\n+#include \"arrow/filesystem/path_util.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/result.h\"\n+#include \"arrow/util/future.h\"\n+#include \"arrow/util/logging.h\"\n+#include \"arrow/util/map.h\"\n+#include \"arrow/util/string.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+namespace {\n+\n+constexpr util::string_view kIntegerToken = \"{i}\";\n+\n+class DatasetWriterStatistics {\n+ public:\n+  DatasetWriterStatistics(uint64_t max_rows_in_flight, uint32_t max_files_in_flight)\n+      : max_rows_in_flight_(max_rows_in_flight),\n+        max_files_in_flight_(max_files_in_flight) {}\n+\n+  bool CanWrite(const std::shared_ptr<RecordBatch>& record_batch,\n+                const std::string& filename) {\n+    std::lock_guard<std::mutex> lg(mutex_);\n+    uint64_t rows = record_batch->num_rows();\n+    DCHECK_LT(rows, max_rows_in_flight_);\n+\n+    if (rows_in_flight_ + rows > max_rows_in_flight_) {\n+      rows_in_waiting_ = rows;\n+      backpressure_ = Future<>::Make();\n+      return false;\n+    }\n+    return true;\n+  }\n\nReview comment:\n       I have cleaned this up and simplified to a single API which returns a Future.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T00:32:32.040+0000",
                    "updated": "2021-09-15T00:32:32.040+0000",
                    "started": "2021-09-15T00:32:32.040+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "650886",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/650888",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r708751012\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_writer.cc\n##########\n@@ -0,0 +1,569 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"arrow/dataset/dataset_writer.h\"\n+\n+#include <list>\n+#include <mutex>\n+#include <unordered_map>\n+\n+#include \"arrow/filesystem/path_util.h\"\n+#include \"arrow/record_batch.h\"\n+#include \"arrow/result.h\"\n+#include \"arrow/util/future.h\"\n+#include \"arrow/util/logging.h\"\n+#include \"arrow/util/map.h\"\n+#include \"arrow/util/string.h\"\n+\n+namespace arrow {\n+namespace dataset {\n+\n+namespace {\n+\n+constexpr util::string_view kIntegerToken = \"{i}\";\n+\n+class DatasetWriterStatistics {\n+ public:\n+  DatasetWriterStatistics(uint64_t max_rows_in_flight, uint32_t max_files_in_flight)\n+      : max_rows_in_flight_(max_rows_in_flight),\n+        max_files_in_flight_(max_files_in_flight) {}\n\nReview comment:\n       I split this logic into a generic Throttle class and now have `open_files_throttle_` and `rows_in_flight_throttle_`\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T00:33:27.531+0000",
                    "updated": "2021-09-15T00:33:27.531+0000",
                    "started": "2021-09-15T00:33:27.531+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "650888",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/650889",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-919607273\n\n\n   CI for MinGW is currently failing due to ARROW-13999\r\n   CI for RTools3.5 is sporadically failing and I am still investigating (I think I need to disable dataset writing examples)\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T00:35:01.174+0000",
                    "updated": "2021-09-15T00:35:01.174+0000",
                    "started": "2021-09-15T00:35:01.174+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "650889",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/650906",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-919629753\n\n\n   I've finished cleaning everything up and this is ready for review.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T01:40:15.222+0000",
                    "updated": "2021-09-15T01:40:15.222+0000",
                    "started": "2021-09-15T01:40:15.222+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "650906",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/650907",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-919630682\n\n\n   @motybz I see your point regarding bytes instead of rows.  Typically rows can be used as a proxy for bytes but I agree that a bytes limit is typically more user friendly.  I will leave ARROW-10439 open to track that work but will not add a bytes limit as part of this PR in the interest of moving this PR forwards.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T01:43:10.823+0000",
                    "updated": "2021-09-15T01:43:10.823+0000",
                    "started": "2021-09-15T01:43:10.823+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "650907",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/651099",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "nealrichardson commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r709212523\n\n\n\n##########\nFile path: r/tests/testthat/test-metadata.R\n##########\n@@ -231,6 +231,9 @@ test_that(\"metadata of list elements (ARROW-10386)\", {\n     \"Row-level metadata is not compatible with datasets and will be discarded\"\n   )\n \n+  # Reset directory as previous write will have created some files and the defualt\n\nReview comment:\n       So this is configurable and we've changed the default? Can we set the default in the R bindings to be the status quo, just to eliminate surprises?\r\n   \r\n   Also:\r\n   ```suggestion\r\n     # Reset directory as previous write will have created some files and the default\r\n   ```\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T13:54:59.014+0000",
                    "updated": "2021-09-15T13:54:59.014+0000",
                    "started": "2021-09-15T13:54:59.014+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "651099",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/651192",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#discussion_r709340469\n\n\n\n##########\nFile path: r/tests/testthat/test-metadata.R\n##########\n@@ -231,6 +231,9 @@ test_that(\"metadata of list elements (ARROW-10386)\", {\n     \"Row-level metadata is not compatible with datasets and will be discarded\"\n   )\n \n+  # Reset directory as previous write will have created some files and the defualt\n\nReview comment:\n       Yes and no.  It's configurable (in `FileSystemDatasetWriteOptions` you would set `existing_data_behavior` to `kOverwriteOrIgnore`) but I have not included exposing those options to R as part of this PR.  I'll add this request to ARROW-13703 if that works for you.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-15T16:12:24.050+0000",
                    "updated": "2021-09-15T16:12:24.050+0000",
                    "started": "2021-09-15T16:12:24.050+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "651192",
                    "issueId": "13395796"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/worklog/653758",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #10955:\nURL: https://github.com/apache/arrow/pull/10955#issuecomment-924296117\n\n\n   @pitrou @jorisvandenbossche Gentle ping\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-21T18:59:05.649+0000",
                    "updated": "2021-09-21T18:59:05.649+0000",
                    "started": "2021-09-21T18:59:05.649+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "653758",
                    "issueId": "13395796"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/7",
            "id": "7",
            "description": "The sub-task of the issue",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype",
            "name": "Sub-task",
            "subtask": true,
            "avatarId": 21146
        },
        "timespent": 42600,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@1015f77e[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3e0ed0c9[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@760b31a7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@3e4b3f37[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4bea75b8[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@56e29041[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@79cb0533[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@1e1e3fba[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@641ce74[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@44e33665[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@65205157[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@a2c41a6[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 42600,
        "customfield_12312520": null,
        "customfield_12312521": "Mon Oct 04 21:07:52 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2021-10-04T21:07:52.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-13650/watchers",
            "watchCount": 4,
            "isWatching": false
        },
        "created": "2021-08-18T04:13:44.000+0000",
        "updated": "2021-10-04T21:08:05.000+0000",
        "timeoriginalestimate": null,
        "description": "The current dataset writing logic is insufficient (ARROW-12321, ARROW-13590, ARROW-10439, ARROW-12803).  This PR moves the logic into a dedicated file and addresses the issues, mainly adding back pressure and size limits.",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "11h 50m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 42600
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[C++] Create dataset writer to encapsulate dataset writer logic",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13395796/comment/17424184",
                    "id": "17424184",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "body": "Issue resolved by pull request 10955\n[https://github.com/apache/arrow/pull/10955]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "created": "2021-10-04T21:07:52.149+0000",
                    "updated": "2021-10-04T21:07:52.149+0000"
                }
            ],
            "maxResults": 1,
            "total": 1,
            "startAt": 0
        },
        "customfield_12311820": "0|z0u028:",
        "customfield_12314139": null
    }
}