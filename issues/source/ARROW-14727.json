{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13412088",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13412088",
    "key": "ARROW-14727",
    "fields": {
        "fixVersions": [],
        "resolution": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": null,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12350323",
                "id": "12350323",
                "description": "",
                "name": "6.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-10-26"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": null,
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/1",
            "description": "The issue is open and ready for the assignee to start work on it.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png",
            "name": "Open",
            "id": "1",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2",
                "id": 2,
                "key": "new",
                "colorName": "blue-gray",
                "name": "To Do"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12333008",
                "id": "12333008",
                "name": "R"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": null,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=svraka",
            "name": "svraka",
            "key": "svraka",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=svraka&avatarId=44226",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=svraka&avatarId=44226",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=svraka&avatarId=44226",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=svraka&avatarId=44226"
            },
            "displayName": "Andr\u00e1s Svraka",
            "active": true,
            "timeZone": "Europe/Budapest"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=svraka",
            "name": "svraka",
            "key": "svraka",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=svraka&avatarId=44226",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=svraka&avatarId=44226",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=svraka&avatarId=44226",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=svraka&avatarId=44226"
            },
            "displayName": "Andr\u00e1s Svraka",
            "active": true,
            "timeZone": "Europe/Budapest"
        },
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14727/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 0,
            "worklogs": []
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": null,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@751009e9[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@60c7f538[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@54fe18a2[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@bcf5930[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@568f79e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@42c3091[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@203313be[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@51c4d851[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@13d201f0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@769f03a3[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4e09402d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@39781fed[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": null,
        "customfield_12312520": null,
        "customfield_12312521": "Fri Nov 19 23:06:47 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": null,
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14727/watchers",
            "watchCount": 3,
            "isWatching": false
        },
        "created": "2021-11-16T17:18:21.000+0000",
        "updated": "2021-12-16T00:57:37.000+0000",
        "timeoriginalestimate": null,
        "description": "I have the following workflow which worked on Arrow 5.0 on Windows 10 and R 4.1.2:\r\n{code:r}\r\nopen_dataset(path) %>%\r\n  select(i, j) %>%\r\n  collect()\r\n{code}\r\nThe dataset in {{path}} is partitioned by {{i}} and {{{}j{}}}, with 16 partitions in total, 5 million rows in each partition and each partition has several other regular columns (i.e.\u00a0present in every partition). The entire dataset can be read into memory on my 16GB machine, which results in an R data.frame of around 3GB. However, on Arrow 6.0 the same operation fails, and R runs out of memory. Interestingly, this still works:\r\n{code:r}\r\nopen_dataset(path) %>%\r\n  select(i, j, x) %>%\r\n  collect() %>%\r\n{code}\r\nwhere {{x}} is a regular column.\r\n\r\nI cannot reproduce the same issue on Linux. Measuring the actual memory consumption with GNU time ({{{}--format=%Mmax{}}}) I get very similar figures for the first pipeline both on 5.0 and 6.0. The same is true for the second pipeline, which of course consumes slightly more memory, as expected. On Windows I don\u2019t know of a simple method to measure maximum memory consumption but eyeballing it from Process Explorer, Arrow 5.0 needs around 0.5GB for the first example, while with Arrow 6.0 my 16GB machine becomes unresponsive, starts swapping, and depending on the circumstances, other apps might crash before R crashes with this error:\r\n{noformat}\r\nterminate called after throwing an instance of 'std::bad_alloc'\r\n  what():  std::bad_alloc {noformat}\r\nWith the second example, both versions consume roughly the same amount of memory.\r\n\r\nWith the new features in Arrow 6.0, this doesn\u2019t work in Windows either, memory consumption shoots up into the 10s of GBs:\r\n{code:r}\r\nopen_dataset(path) %>%\r\n  distinct(i, j) %>%\r\n  collect()\r\n{code}\r\nMeanwhile this works, with under 1GB memory needed:\r\n{code:r}\r\nopen_dataset(path) %>%\r\n  distinct(i, j, x) %>%\r\n  collect()\r\n{code}\r\nThese last two examples work without any issue on Linux, and as expected, they consume significantly less memory, as the select-then-collect examples.",
        "customfield_10010": null,
        "timetracking": {},
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[R] Excessive memory usage on Windows",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13412088/comment/17446716",
                    "id": "17446716",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=willjones127",
                        "name": "willjones127",
                        "key": "willjones127",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"
                        },
                        "displayName": "Will Jones",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "Hi Andr\u00e1s! I've started to work to reproduce this, though haven't yet had success. You might try using the profmem package like below, or even adapt the below script to be closer to your data such that it starts reproducing the behavior.\r\n\r\nI tested this on Windows 10 with Arrow 6.0.0 and R 4.1.2. If you run both open_dataset() in same R session, you'll notice the one you run first having a larger number of allocations. But I consistently saw the version just selecting i and j to allocate less memory in total.\r\n\r\nLet me know if there is some tweak to the script to make it more like your situation. Or what results you are seeing using profmem.\r\n{code:r}\r\nlibrary(dplyr)\r\nlibrary(tidyr)\r\nlibrary(arrow)\r\nlibrary(purrr)\r\nlibrary(profmem)\r\n\r\npath <- \"test_data\"\r\n\r\n# Create big dataset\r\nrows_per_partition <- 5e6\r\ni_values <- letters[1:4]\r\nj_values <- letters[1:4]\r\n\r\nrpartition <- function(n) {\r\n  tibble(x=rnorm(n), y=rnorm(n), z=sample(letters, size=n, replace=TRUE))\r\n}\r\n\r\nds <- expand_grid(i=i_values, j=j_values) %>%\r\n  mutate(data = rerun(n(), rpartition(n=rows_per_partition))) %>%\r\n  unnest(c(\"data\"))\r\n\r\nds %>%\r\n  group_by(i, j) %>%\r\n  arrow::write_dataset(path, format=\"parquet\")\r\n\r\n\r\n# Try 1 : partition cols only\r\nremove(ds)\r\ngc()\r\n\r\np1 <- profmem({\r\n  ds <- open_dataset(path) %>%\r\n    select(i, j) %>%\r\n    collect()\r\n})\r\nprint(p1, expr = FALSE)\r\n\r\n\r\n# Try 2 : add another column\r\nremove(ds)\r\ngc()\r\n\r\n\r\np2 <- profmem({\r\n  ds <- open_dataset(path) %>%\r\n    select(i, j, x) %>%\r\n    collect()\r\n})\r\nprint(p2, expr = FALSE)\r\n\r\n\r\nsum(p1$bytes, na.rm=TRUE)\r\n# 1280025656\r\nsum(p2$bytes, na.rm=TRUE)\r\n# 1934404384\r\n\r\n {code}",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=willjones127",
                        "name": "willjones127",
                        "key": "willjones127",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"
                        },
                        "displayName": "Will Jones",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2021-11-19T23:06:47.326+0000",
                    "updated": "2021-11-22T18:34:23.742+0000"
                }
            ],
            "maxResults": 1,
            "total": 1,
            "startAt": 0
        },
        "customfield_12311820": "0|z0wse8:",
        "customfield_12314139": null
    }
}