{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13333723",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13333723",
    "key": "ARROW-10174",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12348823",
                "id": "12348823",
                "description": "",
                "name": "3.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-01-25"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12348647",
                "id": "12348647",
                "name": "1.0.1",
                "archived": false,
                "released": true,
                "releaseDate": "2020-08-21"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": null,
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328933",
                "id": "12328933",
                "name": "Java"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=benjamin.wilhelm%40knime.com",
            "name": "benjamin.wilhelm@knime.com",
            "key": "benjamin.wilhelm@knime.com",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Benjamin Wilhelm",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=benjamin.wilhelm%40knime.com",
            "name": "benjamin.wilhelm@knime.com",
            "key": "benjamin.wilhelm@knime.com",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Benjamin Wilhelm",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "aggregateprogress": {
            "progress": 14400,
            "total": 14400,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 14400,
            "total": 14400,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-10174/votes",
            "votes": 0,
            "hasVoted": false
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 14400,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@3875454b[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3e4b74d5[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@20a96bf6[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@45a15eea[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@30751d11[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@237dcfac[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@48e0e6ee[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@779b716[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1ffcaf7d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@52311381[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1da958bf[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@57229d1b[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 14400,
        "customfield_12312520": null,
        "customfield_12312521": "Fri Oct 16 02:24:34 UTC 2020",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2020-10-16T02:24:34.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-10174/watchers",
            "watchCount": 1,
            "isWatching": false
        },
        "created": "2020-10-05T13:16:22.000+0000",
        "updated": "2021-01-16T21:38:31.000+0000",
        "timeoriginalestimate": null,
        "description": "Write an index vector and a dictionary with a dictionary vector of the type {{Struct}} using an {{ArrowStreamWriter}}. Reading this again fails with an exception.\r\n\r\nCode to reproduce:\r\n\r\n{code:java}\r\nfinal RootAllocator allocator = new RootAllocator();\r\n\r\n// Create the dictionary\r\nfinal StructVector dict = StructVector.empty(\"Dict\", allocator);\r\nfinal NullableStructWriter dictWriter = dict.getWriter();\r\nfinal IntWriter dictA = dictWriter.integer(\"a\");\r\nfinal IntWriter dictB = dictWriter.integer(\"b\");\r\nfor (int i = 0; i < 3; i++) {\r\n\tdictWriter.start();\r\n\tdictA.writeInt(i);\r\n\tdictB.writeInt(i);\r\n\tdictWriter.end();\r\n}\r\ndict.setValueCount(3);\r\nfinal Dictionary dictionary = new Dictionary(dict, new DictionaryEncoding(1, false, null));\r\n\r\n// Create the vector\r\nfinal Random random = new Random();\r\nfinal StructVector vector = StructVector.empty(\"Dict\", allocator);\r\nfinal NullableStructWriter vectorWriter = vector.getWriter();\r\nfinal IntWriter vectorA = vectorWriter.integer(\"a\");\r\nfinal IntWriter vectorB = vectorWriter.integer(\"b\");\r\nfor (int i = 0; i < 10; i++) {\r\n\tint v = random.nextInt(3);\r\n\tvectorWriter.start();\r\n\tvectorA.writeInt(v);\r\n\tvectorB.writeInt(v);\r\n\tvectorWriter.end();\r\n}\r\nvector.setValueCount(10);\r\n\r\n// Encode the vector using the dictionary\r\nfinal IntVector indexVector = (IntVector) DictionaryEncoder.encode(vector, dictionary);\r\n\r\n// Write the vector to out\r\nfinal ByteArrayOutputStream out = new ByteArrayOutputStream();\r\nfinal VectorSchemaRoot root = new VectorSchemaRoot(Collections.singletonList(indexVector.getField()),\r\n\t\tCollections.singletonList(indexVector));\r\nfinal ArrowStreamWriter writer = new ArrowStreamWriter(root, new MapDictionaryProvider(dictionary),\r\n\t\tChannels.newChannel(out));\r\nwriter.start();\r\nwriter.writeBatch();\r\nwriter.end();\r\n\r\n// Read the vector from out\r\ntry (final ArrowStreamReader reader = new ArrowStreamReader(new ByteArrayInputStream(out.toByteArray()),\r\n\t\tallocator)) {\r\n\treader.loadNextBatch();\r\n\tfinal VectorSchemaRoot readRoot = reader.getVectorSchemaRoot();\r\n\tfinal FieldVector readIndexVector = readRoot.getVector(0);\r\n\r\n\t// Get the dictionary and decode\r\n\tfinal Map<Long, Dictionary> readDictionaryMap = reader.getDictionaryVectors();\r\n\tfinal Dictionary readDictionary = readDictionaryMap.get(readIndexVector.getField().getDictionary().getId());\r\n\tfinal ValueVector readVector = DictionaryEncoder.decode(readIndexVector, readDictionary);\r\n}\r\n{code}\r\n\r\nException:\r\n{code}\r\njava.lang.IllegalArgumentException: not all nodes and buffers were consumed. nodes: [ArrowFieldNode [length=3, nullCount=0], ArrowFieldNode [length=3, nullCount=0]] buffers: [ArrowBuf[21], address:140118352739688, length:1, ArrowBuf[22], address:140118352739696, length:12, ArrowBuf[23], address:140118352739712, length:1, ArrowBuf[24], address:140118352739720, length:12]\r\n\tat org.apache.arrow.vector.VectorLoader.load(VectorLoader.java:63)\r\n\tat org.apache.arrow.vector.ipc.ArrowReader.load(ArrowReader.java:241)\r\n\tat org.apache.arrow.vector.ipc.ArrowReader.loadDictionary(ArrowReader.java:232)\r\n\tat org.apache.arrow.vector.ipc.ArrowStreamReader.loadNextBatch(ArrowStreamReader.java:129)\r\n\tat com.knime.AppTest.testDictionaryStruct(AppTest.java:83)\r\n{code}\r\n\r\nIf I see it corretly the error happens in {{DictionaryUtilities#toMessageFormat}}. If a dictionary encoded vector is encountered still the children of the memory format field are used (none because this is Int). However, the children of the field of the dictionary vector should be mapped to the message format and set as children.\r\n\r\nI can create a fix and open a pull request.",
        "customfield_10010": null,
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Java] Reading of Dictionary encoded struct vector fails ",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "customfield_12311820": "0|z0jf60:",
        "customfield_12314139": null
    }
}