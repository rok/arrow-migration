{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13401854",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854",
    "key": "ARROW-14024",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12350323",
                "id": "12350323",
                "description": "",
                "name": "6.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-10-26"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available",
            "query-engine"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
            "name": "lidavidm",
            "key": "lidavidm",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "David Li",
            "active": true,
            "timeZone": "America/New_York"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328935",
                "id": "12328935",
                "name": "C++"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "aggregateprogress": {
            "progress": 7800,
            "total": 7800,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 7800,
            "total": 7800,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14024/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 13,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/653807",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm opened a new pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207\n\n\n   This wraps the IPC/CSV generators in a sub-generator that will re-slice the batches to respect the batch_size parameter. For Parquet, see #11189.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-21T20:44:35.905+0000",
                    "updated": "2021-09-21T20:44:35.905+0000",
                    "started": "2021-09-21T20:44:35.905+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "653807",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/653808",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#issuecomment-924369751\n\n\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-21T20:44:49.778+0000",
                    "updated": "2021-09-21T20:44:49.778+0000",
                    "started": "2021-09-21T20:44:49.778+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "653808",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654117",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#issuecomment-925044012\n\n\n   Hmm, I think the remaining failures are possibly because we're overflowing the stack - having SSH'd to a MacOS machine to look at things, we have > 2000 stack frames and lldb can't even print a backtrace without segfaulting.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T15:34:02.888+0000",
                    "updated": "2021-09-22T15:34:02.888+0000",
                    "started": "2021-09-22T15:34:02.888+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654117",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654139",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#issuecomment-925065761\n\n\n   Ah, most of the stack frames look like this, once you remove irrelevant ones:\r\n   \r\n   ```\r\n   2021-09-22T14:19:28.6454400Z     frame #83: 0x0000000105789ea0 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc747637bc8, maybe_next=0x00007fc74763cd20)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1029:14\r\n   2021-09-22T14:19:28.6479720Z     frame #91: 0x0000000105789f70 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc74763d1a8, maybe_next=0x00007fc74763b8f0)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1031:48\r\n   2021-09-22T14:19:28.6503520Z     frame #99: 0x0000000105789f70 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc7476357f8, maybe_next=0x00007fc74763cde0)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1031:48\r\n   2021-09-22T14:19:28.6524850Z     frame #107: 0x0000000105789f70 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc74763c008, maybe_next=0x00007fc74763cc60)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1031:48\r\n   2021-09-22T14:19:28.6552850Z     frame #115: 0x0000000105789f70 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc74747fec8, maybe_next=0x00007fc74747a480)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1031:48\r\n   2021-09-22T14:19:28.6580800Z     frame #123: 0x0000000105789f70 libarrow_dataset.600.0.0.dylib`arrow::MergedGenerator<arrow::dataset::EnumeratedRecordBatch>::InnerCallback::operator(this=0x00007fc7475919c8, maybe_next=0x00007fc74759b2a0)(arrow::Result<arrow::dataset::EnumeratedRecordBatch> const&) at async_generator.h:1031:48\r\n   ```\r\n   \r\n   I suppose what's going on is that the merged generator's inner generator is returning a completed future, so callbacks run immediately, and in the process another pull is made to the merged generator; then the merged generator's callback is run, and hence we get stuck in recursion (limited only by the size of the underlying generator). And this only affects the new test, which slices batches up, leading to there being 1024 batches, multiplied by ~10 or so frames per batch - causing a stack overflow. A similar issue happens if we drop the stack size on Linux.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T15:59:39.688+0000",
                    "updated": "2021-09-22T15:59:39.688+0000",
                    "started": "2021-09-22T15:59:39.688+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654139",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654230",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#issuecomment-925251704\n\n\n   @westonpace there are some very fun edge cases I ran into with the generators here, let me know what you think of the workarounds.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T19:26:53.368+0000",
                    "updated": "2021-09-22T19:26:53.368+0000",
                    "started": "2021-09-22T19:26:53.367+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654230",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654246",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714286753\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -221,6 +221,9 @@ class MappingGenerator {\n       bool should_trigger;\n       {\n         auto guard = state->mutex.Lock();\n+        // A MappedCallback may have purged or be purging the queue;\n+        // we shouldn't do anything here.\n+        if (state->finished) return;\n\nReview comment:\n       Shoot, I kind of forgot about this but I have this fix in my CSV streaming PR I kind of half-abandoned because it was too complex and I needed to work on other things.  Can you grab the QueuingMapFailStress test case from https://github.com/apache/arrow/pull/10795/files#diff-aa924daf1e09b13ad031b70e40eeff3b4d4b817b2a32981bb0c0fd2e5313326cR500\r\n   \r\n   I like your fix better anyways.  Instead of returning early I just added more flags and ifs which was a more complex version of the same thing.\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_internal.h\n##########\n@@ -132,5 +133,28 @@ class FragmentDataset : public Dataset {\n   AsyncGenerator<std::shared_ptr<Fragment>> fragment_gen_;\n };\n \n+// Given a record batch generator, creates a new generator that slices\n+// batches so individual batches have at most batch_size rows. The\n+// resulting generator is async-reentrant, but does not forward\n+// reentrant pulls, so apply readahead before using this helper.\n+inline RecordBatchGenerator MakeChunkedBatchGenerator(RecordBatchGenerator gen,\n+                                                      int64_t batch_size) {\n+  return MakeConcatenatedGenerator(MakeMappedGenerator(\n+      std::move(gen),\n+      [batch_size](const std::shared_ptr<RecordBatch>& batch)\n+          -> ::arrow::AsyncGenerator<std::shared_ptr<::arrow::RecordBatch>> {\n+        const int64_t rows = batch->num_rows();\n+        if (rows <= batch_size) {\n+          return ::arrow::MakeVectorGenerator<std::shared_ptr<RecordBatch>>({batch});\n+        }\n+        std::vector<std::shared_ptr<RecordBatch>> slices;\n+        slices.reserve(rows / batch_size + (rows % batch_size != 0));\n+        for (int64_t i = 0; i < rows; i += batch_size) {\n+          slices.push_back(batch->Slice(i, batch_size));\n+        }\n+        return ::arrow::MakeVectorGenerator(std::move(slices));\n\nReview comment:\n       I wonder if we want to create a simple helper function MakeFlattenGenerator which just calls MakeConcatenated(MakeMapped) under the hood.  That way if we ever do decide the overhead is too much we can change the implementation.\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1001,32 +1004,45 @@ class MergedGenerator {\n   };\n \n   struct InnerCallback {\n\nReview comment:\n       Ok, so let me make sure I understand the change.  If a merged generator pulled off a generator and that generator had a whole bunch of already completed futures (e.g. vector generator) then we would end up recursing for each call into the child.\r\n   \r\n   Instead, you setup the TryAddCallback loop to only recurse when the future isn't finished.  I think this is a great addition.  Even if we weren't overflowing the stack in most cases we'd still be creating unnecessarily long stack traces.  Thanks for working through this.\n\n##########\nFile path: cpp/src/arrow/dataset/test_util.h\n##########\n@@ -589,6 +589,23 @@ class FileFormatScanMixin : public FileFormatFixtureMixin<FormatHelper>,\n     }\n     ASSERT_EQ(row_count, GetParam().expected_rows());\n   }\n+  // Ensure batch_size is respected\n+  void TestScanBatchSize() {\n+    auto reader = GetRecordBatchReader(schema({field(\"f64\", float64())}));\n+    auto source = this->GetFileSource(reader.get());\n+\n+    this->SetSchema(reader->schema()->fields());\n+    auto fragment = this->MakeFragment(*source);\n+\n+    int64_t row_count = 0;\n+    opts_->batch_size = 16;\n\nReview comment:\n       I think all of our test cases have # rows evenly divisible by 16.  Maybe make this 15 or something odd so that we ensure we test cases where the read doesn't split into even batches.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T20:44:50.197+0000",
                    "updated": "2021-09-22T20:44:50.197+0000",
                    "started": "2021-09-22T20:44:50.197+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654246",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654261",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714322177\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -221,6 +221,9 @@ class MappingGenerator {\n       bool should_trigger;\n       {\n         auto guard = state->mutex.Lock();\n+        // A MappedCallback may have purged or be purging the queue;\n+        // we shouldn't do anything here.\n+        if (state->finished) return;\n\nReview comment:\n       That test case uses an overload of MakeMappedGenerator which doesn't exist in the fork (it takes a bool as the third argument) - what was the purpose there?\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1001,32 +1004,45 @@ class MergedGenerator {\n   };\n \n   struct InnerCallback {\n\nReview comment:\n       Yup, that's it. And in particular the degenerate case here is that the synchronously-run callback from the mapped generator's futures would pull from the mapped generator, creating a loop implemented as (non-tail) recursion.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T21:25:12.330+0000",
                    "updated": "2021-09-22T21:25:12.330+0000",
                    "started": "2021-09-22T21:25:12.329+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654261",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654262",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714326412\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/dataset_internal.h\n##########\n@@ -132,5 +133,28 @@ class FragmentDataset : public Dataset {\n   AsyncGenerator<std::shared_ptr<Fragment>> fragment_gen_;\n };\n \n+// Given a record batch generator, creates a new generator that slices\n+// batches so individual batches have at most batch_size rows. The\n+// resulting generator is async-reentrant, but does not forward\n+// reentrant pulls, so apply readahead before using this helper.\n+inline RecordBatchGenerator MakeChunkedBatchGenerator(RecordBatchGenerator gen,\n+                                                      int64_t batch_size) {\n+  return MakeConcatenatedGenerator(MakeMappedGenerator(\n+      std::move(gen),\n+      [batch_size](const std::shared_ptr<RecordBatch>& batch)\n+          -> ::arrow::AsyncGenerator<std::shared_ptr<::arrow::RecordBatch>> {\n+        const int64_t rows = batch->num_rows();\n+        if (rows <= batch_size) {\n+          return ::arrow::MakeVectorGenerator<std::shared_ptr<RecordBatch>>({batch});\n+        }\n+        std::vector<std::shared_ptr<RecordBatch>> slices;\n+        slices.reserve(rows / batch_size + (rows % batch_size != 0));\n+        for (int64_t i = 0; i < rows; i += batch_size) {\n+          slices.push_back(batch->Slice(i, batch_size));\n+        }\n+        return ::arrow::MakeVectorGenerator(std::move(slices));\n\nReview comment:\n       Makes sense. This is basically flatmap so I've named it accordingly.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T21:32:38.912+0000",
                    "updated": "2021-09-22T21:32:38.912+0000",
                    "started": "2021-09-22T21:32:38.912+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654262",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654263",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714326580\n\n\n\n##########\nFile path: cpp/src/arrow/dataset/test_util.h\n##########\n@@ -589,6 +589,23 @@ class FileFormatScanMixin : public FileFormatFixtureMixin<FormatHelper>,\n     }\n     ASSERT_EQ(row_count, GetParam().expected_rows());\n   }\n+  // Ensure batch_size is respected\n+  void TestScanBatchSize() {\n+    auto reader = GetRecordBatchReader(schema({field(\"f64\", float64())}));\n+    auto source = this->GetFileSource(reader.get());\n+\n+    this->SetSchema(reader->schema()->fields());\n+    auto fragment = this->MakeFragment(*source);\n+\n+    int64_t row_count = 0;\n+    opts_->batch_size = 16;\n\nReview comment:\n       Good point, I bumped it to 17 which is also prime!\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T21:32:52.144+0000",
                    "updated": "2021-09-22T21:32:52.144+0000",
                    "started": "2021-09-22T21:32:52.144+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654263",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654269",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714333823\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -221,6 +221,9 @@ class MappingGenerator {\n       bool should_trigger;\n       {\n         auto guard = state->mutex.Lock();\n+        // A MappedCallback may have purged or be purging the queue;\n+        // we shouldn't do anything here.\n+        if (state->finished) return;\n\nReview comment:\n       You can ignore the third parameter.  Odd that the overload doesn't exist :confused:.  It was basically to toggle between a newly added BasicMappingGenerator (which pulls from source reentrantly) and the regular mapping generator (which does not pull from the source reentrantly but does allow the map function to run in parallel).  I think the test is always using `true` which maps to what we currently have.  So just drop the `true` and you should be ok.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T21:45:59.262+0000",
                    "updated": "2021-09-22T21:45:59.262+0000",
                    "started": "2021-09-22T21:45:59.262+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654269",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654272",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#discussion_r714339906\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -221,6 +221,9 @@ class MappingGenerator {\n       bool should_trigger;\n       {\n         auto guard = state->mutex.Lock();\n+        // A MappedCallback may have purged or be purging the queue;\n+        // we shouldn't do anything here.\n+        if (state->finished) return;\n\nReview comment:\n       Ah I figured it would be something like that, I added the test here.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-22T21:57:32.151+0000",
                    "updated": "2021-09-22T21:57:32.151+0000",
                    "started": "2021-09-22T21:57:32.150+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654272",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654654",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207#issuecomment-926040989\n\n\n   Once this lands I'll fix up #11189 since it uses the same fix underneath.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-23T18:09:48.512+0000",
                    "updated": "2021-09-23T18:09:48.512+0000",
                    "started": "2021-09-23T18:09:48.511+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654654",
                    "issueId": "13401854"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/worklog/654706",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm closed pull request #11207:\nURL: https://github.com/apache/arrow/pull/11207\n\n\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-09-23T19:24:08.715+0000",
                    "updated": "2021-09-23T19:24:08.715+0000",
                    "started": "2021-09-23T19:24:08.715+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "654706",
                    "issueId": "13401854"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 7800,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@70b34594[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6c528ac9[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@311ff63f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@49e33617[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@34850c04[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@3bd95638[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@75b9e172[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@253a325c[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@39c3efd3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@48da0645[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@72d2dc5d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@60ea889[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 7800,
        "customfield_12312520": null,
        "customfield_12312521": "Thu Sep 23 19:23:59 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2021-09-23T19:23:59.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14024/watchers",
            "watchCount": 3,
            "isWatching": false
        },
        "created": "2021-09-17T11:50:44.000+0000",
        "updated": "2021-09-23T19:24:09.000+0000",
        "timeoriginalestimate": null,
        "description": "At first glance it seems like Parquet's reader should work.  The ScanOptions::batch_size property is forwarded into the ArrowReaderProperties for the parquet::arrow::FileReader.  However, we then use ReadOneRowGroup which doesn't look at the batch_size option.\r\n\r\nThe IPC reader simply doesn't look at the property at all.\r\n\r\nEven if we can't control the source read size (e.g. we have to read a full row group / record batch and have no control over its size) we can still split whatever we read into smaller batches that respect the batch size.  This is important for achieving parallelism as we can then partition the CPU work across these batches.",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "2h 10m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 7800
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[C++] ScanOptions::batch_size not respected in parquet/IPC readers",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/comment/17416655",
                    "id": "17416655",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "For Parquet, we should set max_chunksize on the TableBatchReader: https://github.com/apache/arrow/blob/5260fd5970d34c62e0ae7680f606b29eab56d96b/cpp/src/parquet/arrow/reader.cc#L1042",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-09-17T12:38:58.604+0000",
                    "updated": "2021-09-17T12:38:58.604+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/comment/17416657",
                    "id": "17416657",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "For IPC, the generator just returns the batches as stored in the file itself, maybe file_ipc should slice up the batches before sending them down the pipeline.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-09-17T12:40:49.439+0000",
                    "updated": "2021-09-17T12:40:49.439+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13401854/comment/17419420",
                    "id": "17419420",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 11207\n[https://github.com/apache/arrow/pull/11207]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-09-23T19:23:59.151+0000",
                    "updated": "2021-09-23T19:23:59.151+0000"
                }
            ],
            "maxResults": 3,
            "total": 3,
            "startAt": 0
        },
        "customfield_12311820": "0|z0v1fk:",
        "customfield_12314139": null
    }
}