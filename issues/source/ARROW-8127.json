{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13291877",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877",
    "key": "ARROW-8127",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12346687",
                "id": "12346687",
                "description": "",
                "name": "0.17.0",
                "archived": false,
                "released": true,
                "releaseDate": "2020-04-20"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/4",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg",
            "name": "Minor",
            "id": "4"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "1.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tpboudreau",
            "name": "tpboudreau",
            "key": "tpboudreau",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "TP Boudreau",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328935",
                "id": "12328935",
                "name": "C++"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tpboudreau",
            "name": "tpboudreau",
            "key": "tpboudreau",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "TP Boudreau",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tpboudreau",
            "name": "tpboudreau",
            "key": "tpboudreau",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "TP Boudreau",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "aggregateprogress": {
            "progress": 5400,
            "total": 5400,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 5400,
            "total": 5400,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-8127/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 9,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/404215",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tpboudreau commented on pull request #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637\n \n \n   For buffered column writers and non-dictionary encoded columns, Parquet column chunks that span more than one page get the wrong data_page_offset recorded in the column chunk metadata.  This causes the file to be unreadable and unscannable. (Some more info and a test case [here](https://issues.apache.org/jira/browse/ARROW-8127).)\r\n   \r\n   This patch fixes the error by setting the metadata values from information in the underlying (\"final\") stream sink.  It reorders but retains similar logic for dictionary page offsets introduced in [PARQUET-1706](https://github.com/apache/arrow/pull/5922).\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-16T19:40:18.899+0000",
                    "updated": "2020-03-16T19:40:18.899+0000",
                    "started": "2020-03-16T19:40:18.899+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "404215",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/404219",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on issue #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#issuecomment-599727705\n \n \n   https://issues.apache.org/jira/browse/ARROW-8127\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-16T19:46:41.068+0000",
                    "updated": "2020-03-16T19:46:41.068+0000",
                    "started": "2020-03-16T19:46:41.068+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "404219",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/404343",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tpboudreau commented on issue #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#issuecomment-599810906\n \n \n   The check failure is resource problem, not a code error.  I think this PR is ready for review.\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-16T23:59:58.616+0000",
                    "updated": "2020-03-16T23:59:58.616+0000",
                    "started": "2020-03-16T23:59:58.616+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "404343",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/404678",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on issue #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#issuecomment-600052236\n \n \n   cc @wesm \n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-17T12:49:22.655+0000",
                    "updated": "2020-03-17T12:49:22.655+0000",
                    "started": "2020-03-17T12:49:22.655+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "404678",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/405013",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm commented on pull request #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#discussion_r394013929\n \n \n\n ##########\n File path: cpp/src/parquet/column_writer.cc\n ##########\n @@ -442,10 +442,13 @@ class BufferedPageWriter : public PageWriter {\n     // index_page_offset = -1 since they are not supported\n     PARQUET_ASSIGN_OR_THROW(int64_t final_position, final_sink_->Tell());\n     // dictionary page offset should be 0 iff there are no dictionary pages\n-    auto dictionary_page_offset =\n-        has_dictionary_pages_ ? pager_->dictionary_page_offset() + final_position : 0;\n-    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1,\n-                      pager_->data_page_offset() + final_position,\n+    int64_t dictionary_page_offset = 0;\n+    int64_t data_page_offset = final_position;\n+    if (has_dictionary_pages_) {\n+      dictionary_page_offset = pager_->dictionary_page_offset() + final_position;\n+      data_page_offset += pager_->data_page_offset();\n+    }\n+    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1, data_page_offset,\n \n Review comment:\n   I'm not totally following the changes relative to the unit test. \r\n   \r\n   * The dictionary_page_offset is unchanged \r\n   * When has_dictionary_pages_ is false, data_page_offset is now `final_position` instead of `final_position + pager_->data_page_offset()`. But here `pager_->data_page_offset()` **should be** zero. Why isn't it?\r\n   \r\n   I'm looking at:\r\n   \r\n   ```\r\n       PARQUET_ASSIGN_OR_THROW(int64_t start_pos, sink_->Tell());\r\n       if (data_page_offset_ == 0) {\r\n         data_page_offset_ = start_pos;\r\n       }\r\n   ```\r\n   \r\n   This logic seems wrong. `data_page_offset_` is being set to the offset of the start of the **second** data page. Do you agree? I think that's what we need to fix\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-17T22:45:59.594+0000",
                    "updated": "2020-03-17T22:45:59.594+0000",
                    "started": "2020-03-17T22:45:59.594+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "405013",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/405020",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm commented on issue #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#issuecomment-600339096\n \n \n   @tpboudreau have a look and see if the fix I pushed looks correct based on the discussion above\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-17T22:53:11.080+0000",
                    "updated": "2020-03-17T22:53:11.080+0000",
                    "started": "2020-03-17T22:53:11.079+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "405020",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/405103",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tpboudreau commented on pull request #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#discussion_r394057872\n \n \n\n ##########\n File path: cpp/src/parquet/column_writer.cc\n ##########\n @@ -442,10 +442,13 @@ class BufferedPageWriter : public PageWriter {\n     // index_page_offset = -1 since they are not supported\n     PARQUET_ASSIGN_OR_THROW(int64_t final_position, final_sink_->Tell());\n     // dictionary page offset should be 0 iff there are no dictionary pages\n-    auto dictionary_page_offset =\n-        has_dictionary_pages_ ? pager_->dictionary_page_offset() + final_position : 0;\n-    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1,\n-                      pager_->data_page_offset() + final_position,\n+    int64_t dictionary_page_offset = 0;\n+    int64_t data_page_offset = final_position;\n+    if (has_dictionary_pages_) {\n+      dictionary_page_offset = pager_->dictionary_page_offset() + final_position;\n+      data_page_offset += pager_->data_page_offset();\n+    }\n+    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1, data_page_offset,\n \n Review comment:\n   Yes, @wesm , that's definitely the underlying cause.  That conditional is tripped on second page that looks like it's meant to be part of first page processing. \r\n   \r\n   I went back and forth on fixing it with the approach you took and the one I took.  The reason I settled on the latter was that it seemed slightly better to scope any changes to the buffered writer since that's where the error manifests.  IOW, I conservatively assumed the the data page offset check in the serialized writer has another purpose besides finding the first page.  But I don't feel strongly about it and if you think changing the serialized writer is safe (or preferable), I'm good with that.  \r\n   \r\n   Just one nit with your patch: there's already a member in the serialized writer called page_ordinal_ that we can check for zero to find the first page rather than introducing a new boolean.  Could be something like:\r\n   ```\r\n   PARQUET_ASSIGN_OR_THROW(int64_t start_pos, sink_->Tell());\r\n   if (page_ordinal_ == 0 && data_page_offset_ == 0) {\r\n     data_page_offset_ = start_pos;\r\n   }\r\n   ```\r\n   or maybe just:\r\n   ```\r\n   PARQUET_ASSIGN_OR_THROW(int64_t start_pos, sink_->Tell());\r\n   if (page_ordinal_ == 0) {\r\n     data_page_offset_ = start_pos;\r\n   }\r\n   ```\r\n   Your call.  Let me know and I'll push another commit if necessary.\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-18T01:24:47.523+0000",
                    "updated": "2020-03-18T01:24:47.523+0000",
                    "started": "2020-03-18T01:24:47.523+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "405103",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/405104",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm commented on pull request #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637#discussion_r394058637\n \n \n\n ##########\n File path: cpp/src/parquet/column_writer.cc\n ##########\n @@ -442,10 +442,13 @@ class BufferedPageWriter : public PageWriter {\n     // index_page_offset = -1 since they are not supported\n     PARQUET_ASSIGN_OR_THROW(int64_t final_position, final_sink_->Tell());\n     // dictionary page offset should be 0 iff there are no dictionary pages\n-    auto dictionary_page_offset =\n-        has_dictionary_pages_ ? pager_->dictionary_page_offset() + final_position : 0;\n-    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1,\n-                      pager_->data_page_offset() + final_position,\n+    int64_t dictionary_page_offset = 0;\n+    int64_t data_page_offset = final_position;\n+    if (has_dictionary_pages_) {\n+      dictionary_page_offset = pager_->dictionary_page_offset() + final_position;\n+      data_page_offset += pager_->data_page_offset();\n+    }\n+    metadata_->Finish(pager_->num_values(), dictionary_page_offset, -1, data_page_offset,\n \n Review comment:\n   Ah I see. Yes let's use the page ordinal rather than adding the new member. Thank you!\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-18T01:27:57.929+0000",
                    "updated": "2020-03-18T01:27:57.929+0000",
                    "started": "2020-03-18T01:27:57.929+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "405104",
                    "issueId": "13291877"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/worklog/405601",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm commented on pull request #6637: ARROW-8127: [C++] [Parquet] Incorrect column chunk metadata for multipage batch writes\nURL: https://github.com/apache/arrow/pull/6637\n \n \n   \n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2020-03-18T17:12:14.688+0000",
                    "updated": "2020-03-18T17:12:14.688+0000",
                    "started": "2020-03-18T17:12:14.687+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "405601",
                    "issueId": "13291877"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 5400,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@b5e56c0[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@34807ea9[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@46179ae[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@33a32abd[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7f003599[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@4cf7697[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@becc3a9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@2130f6ab[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5fe2a3e9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@20661d4c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4dfa7362[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@6bd941d8[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 5400,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Mar 18 17:12:18 UTC 2020",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2020-03-18T17:12:18.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-8127/watchers",
            "watchCount": 2,
            "isWatching": false
        },
        "created": "2020-03-16T04:56:04.000+0000",
        "updated": "2020-03-18T17:12:18.000+0000",
        "timeoriginalestimate": null,
        "description": "When writing to a buffered column writer using PLAIN encoding, if the size of the batch supplied for writing exceeds the page size for the writer, the resulting file has an incorrect data_page_offset set in its column chunk metadata.  This causes an exception to be thrown when reading the file (file appears to be too short to the reader).\r\n\r\nFor example, the attached code, which attempts to write a batch of 262145 Int32's (= 1048576 + 4 bytes) using the default page size of 1048576 bytes (with buffered writer, PLAIN encoding), fails on reading, throwing the error: \"Tried reading 1048678 bytes starting at position 1048633 from file but only got 333\".\r\n\r\nThe error is caused by the second page write tripping the conditional here https://github.com/apache/arrow/blob/master/cpp/src/parquet/column_writer.cc#L302, in the serialized in-memory writer wrapped by the buffered writer.\r\n\r\nThe fix builds the metadata with offsets from the terminal sink rather than the in memory buffered sink.  A PR is coming.",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "1.5h",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 5400
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/attachment/12996804",
                "id": "12996804",
                "filename": "multipage-batch-write.cc",
                "author": {
                    "self": "https://issues.apache.org/jira/rest/api/2/user?username=tpboudreau",
                    "name": "tpboudreau",
                    "key": "tpboudreau",
                    "avatarUrls": {
                        "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                    },
                    "displayName": "TP Boudreau",
                    "active": true,
                    "timeZone": "Etc/UTC"
                },
                "created": "2020-03-16T04:54:58.690+0000",
                "size": 2933,
                "mimeType": "text/x-c",
                "content": "https://issues.apache.org/jira/secure/attachment/12996804/multipage-batch-write.cc"
            }
        ],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[C++] [Parquet] Incorrect column chunk metadata for multipage batch writes",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13291877/comment/17061919",
                    "id": "17061919",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 6637\n[https://github.com/apache/arrow/pull/6637]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2020-03-18T17:12:18.102+0000",
                    "updated": "2020-03-18T17:12:18.102+0000"
                }
            ],
            "maxResults": 1,
            "total": 1,
            "startAt": 0
        },
        "customfield_12311820": "0|z0ck48:",
        "customfield_12314139": null
    }
}