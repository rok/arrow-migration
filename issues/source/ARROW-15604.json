{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13427010",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010",
    "key": "ARROW-15604",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12351051",
                "id": "12351051",
                "description": "",
                "name": "8.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2022-05-06"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328935",
                "id": "12328935",
                "name": "C++"
            },
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12333244",
                "id": "12333244",
                "name": "Continuous Integration"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
            "name": "apitrou",
            "key": "pitrou",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
            },
            "displayName": "Antoine Pitrou",
            "active": true,
            "timeZone": "Europe/Paris"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
            "name": "apitrou",
            "key": "pitrou",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
            },
            "displayName": "Antoine Pitrou",
            "active": true,
            "timeZone": "Europe/Paris"
        },
        "aggregateprogress": {
            "progress": 24600,
            "total": 24600,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 24600,
            "total": 24600,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-15604/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 41,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725566",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace opened a new pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408\n\n\n   The particular cause of the failure was:\r\n   \r\n   ```\r\n     void InputReceived(ExecNode* input, ExecBatch batch) override {\r\n       EVENT(span_, \"InputReceived\", {{\"batch.length\", batch.length}});\r\n       util::tracing::Span span;\r\n       START_SPAN_WITH_PARENT(span, span_, \"InputReceived\",\r\n                              {{\"node.label\", label()}, {\"batch.length\", batch.length}});\r\n   \r\n       DCHECK_EQ(input, inputs_[0]);\r\n   \r\n       bool did_push = producer_.Push(std::move(batch));\r\n       if (!did_push) return;  // producer_ was Closed already\r\n   \r\n       if (input_counter_.Increment()) {\r\n         // This will mark the exec plan finished\r\n         Finish();\r\n         // At this point the main thread is generally free to exit but span hasn't been destructed yet\r\n       }\r\n     }\r\n   ```\r\n   \r\n   It could be fixed with scoping:\r\n   \r\n   ```\r\n     void InputReceived(ExecNode* input, ExecBatch batch) override {\r\n       EVENT(span_, \"InputReceived\", {{\"batch.length\", batch.length}});\r\n       {\r\n         util::tracing::Span span;\r\n         START_SPAN_WITH_PARENT(span, span_, \"InputReceived\",\r\n                                {{\"node.label\", label()}, {\"batch.length\", batch.length}});\r\n   \r\n         DCHECK_EQ(input, inputs_[0]);\r\n   \r\n         bool did_push = producer_.Push(std::move(batch));\r\n         if (!did_push) return;  // producer_ was Closed already\r\n       }\r\n       if (input_counter_.Increment()) {\r\n         // This will mark the exec plan finished\r\n         Finish();\r\n         // At this point the main thread is generally free to exit but span hasn't been destructed yet\r\n       }\r\n     }\r\n   ```\r\n   However, I suspect this would quickly get tedious.  Instead it seems we can control the lifetime of the OT runtime storage and bind it to our worker threads.  In the future we may want to consider doing similar tricks to keep alive the memory pool, global thread pools, etc.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T03:11:45.860+0000",
                    "updated": "2022-02-12T03:11:45.860+0000",
                    "started": "2022-02-12T03:11:45.860+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725566",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725567",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#issuecomment-1036969736\n\n\n   https://issues.apache.org/jira/browse/ARROW-15604\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T03:11:58.561+0000",
                    "updated": "2022-02-12T03:11:58.561+0000",
                    "started": "2022-02-12T03:11:58.560+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725567",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725590",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "cyb70289 commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805132924\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n+  }\n+  nostd::shared_ptr<otel::context::RuntimeContextStorage> storage_;\n+};\n+\n }  // namespace\n \n+static StorageSingleton storage_singleton;\n\nReview comment:\n       Nit: what about moving the definition inside Attach()?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T07:55:51.799+0000",
                    "updated": "2022-02-12T07:55:51.799+0000",
                    "started": "2022-02-12T07:55:51.799+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725590",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725591",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "cyb70289 commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805132951\n\n\n\n##########\nFile path: docker-compose.yml\n##########\n@@ -773,8 +773,6 @@ services:\n     shm_size: *shm-size\n     environment:\n       <<: *ccache\n-      # Bundled build of OpenTelemetry needs a git client\n-      ARROW_WITH_OPENTELEMETRY: \"OFF\"\n\nReview comment:\n       Intended or spurious change?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T07:56:16.007+0000",
                    "updated": "2022-02-12T07:56:16.007+0000",
                    "started": "2022-02-12T07:56:16.007+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725591",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725598",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805146224\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Is it ok to do this in a library? Applications or libraries using Arrow C++ may want to use their own context storage and will be surprised that Arrow overrides it. @lidavidm \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T10:36:19.921+0000",
                    "updated": "2022-02-12T10:36:19.921+0000",
                    "started": "2022-02-12T10:36:19.921+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725598",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725599",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805146753\n\n\n\n##########\nFile path: cpp/src/arrow/util/thread_pool.cc\n##########\n@@ -144,6 +145,13 @@ struct ThreadPool::State {\n // after the ThreadPool is destroyed.\n static void WorkerLoop(std::shared_ptr<ThreadPool::State> state,\n                        std::list<std::thread>::iterator it) {\n+#ifdef ARROW_WITH_OPENTELEMETRY\n+  // The main thread may exit and start shutting down static state before\n+  // this thread ends.  This means that any calls to OpenTelemetry's static\n+  // state will potentially access freed memory.  By grabbing a handle we\n+  // keep OpenTelemetry's static state alive until this thread ends.\n+  internal::tracing::OtHandle handle = internal::tracing::Attach();\n\nReview comment:\n       This would probably deserve a more general approach. For example:\r\n   ```c++\r\n   class Executor {\r\n    public:\r\n     class Resource {\r\n      public:\r\n       virtual ~Resource();\r\n     };\r\n     // All live executors should keep this object alive\r\n     static void KeepAlive(Resource);\r\n   };\r\n   ```\r\n   (is it possible to mandate that `Resource` has to be copy-constructible?)\r\n   \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T10:41:17.862+0000",
                    "updated": "2022-02-12T10:41:17.862+0000",
                    "started": "2022-02-12T10:41:17.862+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725599",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725601",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805146753\n\n\n\n##########\nFile path: cpp/src/arrow/util/thread_pool.cc\n##########\n@@ -144,6 +145,13 @@ struct ThreadPool::State {\n // after the ThreadPool is destroyed.\n static void WorkerLoop(std::shared_ptr<ThreadPool::State> state,\n                        std::list<std::thread>::iterator it) {\n+#ifdef ARROW_WITH_OPENTELEMETRY\n+  // The main thread may exit and start shutting down static state before\n+  // this thread ends.  This means that any calls to OpenTelemetry's static\n+  // state will potentially access freed memory.  By grabbing a handle we\n+  // keep OpenTelemetry's static state alive until this thread ends.\n+  internal::tracing::OtHandle handle = internal::tracing::Attach();\n\nReview comment:\n       This would probably deserve a more general approach. For example:\r\n   ```c++\r\n   class Executor {\r\n    public:\r\n     class Resource {\r\n      public:\r\n       virtual ~Resource();\r\n     };\r\n     // All live executors should keep this object alive\r\n     static void KeepAlive(std::shared_ptr<Resource>);\r\n   };\r\n   ```\r\n   \r\n   \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T10:42:02.940+0000",
                    "updated": "2022-02-12T10:42:02.940+0000",
                    "started": "2022-02-12T10:42:02.940+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725601",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/725702",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805186057\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.h\n##########\n@@ -101,6 +101,17 @@ AsyncGenerator<T> WrapAsyncGenerator(AsyncGenerator<T> wrapped,\n   };\n }\n \n+class OtHandle {\n+ public:\n+  OtHandle(opentelemetry::nostd::shared_ptr<opentelemetry::context::RuntimeContextStorage>\n\nReview comment:\n       Should this be a private constructor?\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Right, this should generally be left to the application. For us, I suppose that's technically each individual test; that may get tedious, though.\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Maybe we should file an upstream issue? If we could access the upstream shared_ptr, we could keep references to it ourselves and be independent of what the application wants to do: https://github.com/open-telemetry/opentelemetry-cpp/blob/3a3bf25289901079534b1cabe14e9c4fb3b35968/api/include/opentelemetry/context/runtime_context.h#L154\r\n   \r\n   A brief reproduction using a thread and TSAN might be enough to convince them.\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.h\n##########\n@@ -101,6 +101,17 @@ AsyncGenerator<T> WrapAsyncGenerator(AsyncGenerator<T> wrapped,\n   };\n }\n \n+class OtHandle {\n\nReview comment:\n       Can we add a brief docstring for the class?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-12T17:51:44.005+0000",
                    "updated": "2022-02-12T17:51:44.005+0000",
                    "started": "2022-02-12T17:51:44.004+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "725702",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/726082",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r805186057\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.h\n##########\n@@ -101,6 +101,17 @@ AsyncGenerator<T> WrapAsyncGenerator(AsyncGenerator<T> wrapped,\n   };\n }\n \n+class OtHandle {\n+ public:\n+  OtHandle(opentelemetry::nostd::shared_ptr<opentelemetry::context::RuntimeContextStorage>\n\nReview comment:\n       Should this be a private constructor?\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Right, this should generally be left to the application. For us, I suppose that's technically each individual test; that may get tedious, though.\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Maybe we should file an upstream issue? If we could access the upstream shared_ptr, we could keep references to it ourselves and be independent of what the application wants to do: https://github.com/open-telemetry/opentelemetry-cpp/blob/3a3bf25289901079534b1cabe14e9c4fb3b35968/api/include/opentelemetry/context/runtime_context.h#L154\r\n   \r\n   A brief reproduction using a thread and TSAN might be enough to convince them.\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.h\n##########\n@@ -101,6 +101,17 @@ AsyncGenerator<T> WrapAsyncGenerator(AsyncGenerator<T> wrapped,\n   };\n }\n \n+class OtHandle {\n\nReview comment:\n       Can we add a brief docstring for the class?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-14T02:40:58.539+0000",
                    "updated": "2022-02-14T02:40:58.539+0000",
                    "started": "2022-02-14T02:40:58.539+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "726082",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/726513",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r806154621\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Ah, good points.  I'll file an upstream issue and put this on hold for now.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-14T19:06:08.526+0000",
                    "updated": "2022-02-14T19:06:08.526+0000",
                    "started": "2022-02-14T19:06:08.526+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "726513",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/726556",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r806197721\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       open-telemetry/opentelemetry-cpp#1211\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-14T20:06:13.577+0000",
                    "updated": "2022-02-14T20:06:13.577+0000",
                    "started": "2022-02-14T20:06:13.576+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "726556",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/726582",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r806234546\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Thanks a lot for filing this.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-14T20:59:57.516+0000",
                    "updated": "2022-02-14T20:59:57.516+0000",
                    "started": "2022-02-14T20:59:57.516+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "726582",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/727399",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r806154621\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Ah, good points.  I'll file an upstream issue and put this on hold for now.\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       open-telemetry/opentelemetry-cpp#1211\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-15T18:47:35.642+0000",
                    "updated": "2022-02-15T18:47:35.642+0000",
                    "started": "2022-02-15T18:47:35.641+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "727399",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/727581",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r806234546\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Thanks a lot for filing this.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-15T19:02:48.597+0000",
                    "updated": "2022-02-15T19:02:48.597+0000",
                    "started": "2022-02-15T19:02:48.597+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "727581",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/730140",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r810638389\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Looks like the implemented it indeed. Maybe we can bump the bundled OpenTelemetry, or wait for a new release.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-20T14:57:57.211+0000",
                    "updated": "2022-02-20T14:57:57.211+0000",
                    "started": "2022-02-20T14:57:57.211+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "730140",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/731156",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #12408:\nURL: https://github.com/apache/arrow/pull/12408#discussion_r812335164\n\n\n\n##########\nFile path: cpp/src/arrow/util/tracing_internal.cc\n##########\n@@ -176,8 +176,23 @@ otel::trace::TracerProvider* GetTracerProvider() {\n   static nostd::shared_ptr<otel::trace::TracerProvider> provider = InitializeTracing();\n   return provider.get();\n }\n+\n+struct StorageSingleton {\n+  StorageSingleton() : storage_(otel::context::GetDefaultStorage()) {\n+    otel::context::RuntimeContext::SetRuntimeContextStorage(storage_);\n\nReview comment:\n       Looks like they are releasing monthly. Let's just disable OT in our CI builds until the release is out and we can address this at that point.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-22T20:35:12.917+0000",
                    "updated": "2022-02-22T20:35:12.917+0000",
                    "started": "2022-02-22T20:35:12.917+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "731156",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/731298",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace opened a new pull request #12491:\nURL: https://github.com/apache/arrow/pull/12491\n\n\n   This is not a fix for the issue.  The proper fix is at #12408 but cannot be merged as we are waiting for an OT release with an upstream fix.  This is just to disable TSAN testing of OT in the meantime so we don't hide other bugs that may crop up while we wait for the proper fix.  We should revert this change as part of #12408 \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-23T01:03:23.029+0000",
                    "updated": "2022-02-23T01:03:23.029+0000",
                    "started": "2022-02-23T01:03:23.028+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "731298",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/731299",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #12491:\nURL: https://github.com/apache/arrow/pull/12491#issuecomment-1048361006\n\n\n   https://issues.apache.org/jira/browse/ARROW-15604\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-23T01:03:45.720+0000",
                    "updated": "2022-02-23T01:03:45.720+0000",
                    "started": "2022-02-23T01:03:45.720+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "731299",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/731329",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #12491:\nURL: https://github.com/apache/arrow/pull/12491#issuecomment-1048414951\n\n\n   @github-actions crossbow submit test-*-cpp-thread-sanitizer\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-23T03:19:39.894+0000",
                    "updated": "2022-02-23T03:19:39.894+0000",
                    "started": "2022-02-23T03:19:39.893+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "731329",
                    "issueId": "13427010"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/worklog/731330",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #12491:\nURL: https://github.com/apache/arrow/pull/12491#issuecomment-1048415475\n\n\n   Revision: 476b17cc05b69530ec5ccc0eec8403ae6e2d3844\n   \n   Submitted crossbow builds: [ursacomputing/crossbow @ actions-1667](https://github.com/ursacomputing/crossbow/branches/all?query=actions-1667)\n   \n   |Task|Status|\n   |----|------|\n   |test-ubuntu-20.04-cpp-thread-sanitizer|[![Github Actions](https://github.com/ursacomputing/crossbow/workflows/Crossbow/badge.svg?branch=actions-1667-github-test-ubuntu-20.04-cpp-thread-sanitizer)](https://github.com/ursacomputing/crossbow/actions?query=branch:actions-1667-github-test-ubuntu-20.04-cpp-thread-sanitizer)|\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-02-23T03:21:05.014+0000",
                    "updated": "2022-02-23T03:21:05.014+0000",
                    "started": "2022-02-23T03:21:05.014+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "731330",
                    "issueId": "13427010"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 24600,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@64a9e855[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@25354a93[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@76ad1950[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@7943b4c4[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@703a7285[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@40282703[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5ed1d1cf[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@3a50bb45[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@195d58d0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@184c74c7[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@484381a8[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@77f69176[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 24600,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Apr 13 20:17:39 UTC 2022",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2022-04-13T20:17:39.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-15604/watchers",
            "watchCount": 5,
            "isWatching": false
        },
        "created": "2022-02-07T18:20:22.000+0000",
        "updated": "2022-04-14T17:11:29.000+0000",
        "timeoriginalestimate": null,
        "description": "The error is a heap-use-after-free and involves an OpenTracing structure that was deleted by an atexit hook.\r\nhttps://github.com/ursacomputing/crossbow/runs/5097362072?check_suite_focus=true#step:5:4843\r\n\r\nSummary:\r\n{code}\r\n  Atomic write of size 4 at 0x7b08000136a8 by thread T2:\r\n  [...]\r\n    #10 opentelemetry::v1::context::RuntimeContext::GetRuntimeContextStorage() /build/cpp/opentelemetry_ep-install/include/opentelemetry/context/runtime_context.h:156:12 (libarrow.so.800+0x1e62ef7)\r\n    #11 opentelemetry::v1::context::RuntimeContext::Detach(opentelemetry::v1::context::Token&) /build/cpp/opentelemetry_ep-install/include/opentelemetry/context/runtime_context.h:97:54 (libarrow.so.800+0x1e70178)\r\n    #12 opentelemetry::v1::context::Token::~Token() /build/cpp/opentelemetry_ep-install/include/opentelemetry/context/runtime_context.h:168:3 (libarrow.so.800+0x1e7012f)\r\n  [...]\r\n{code}\r\n\r\n{code}\r\n  Previous write of size 8 at 0x7b08000136a8 by main thread:\r\n    #0 operator delete(void*) <null> (arrow-dataset-scanner-test+0x16a69e)\r\n  [...]\r\n    #7 opentelemetry::v1::nostd::shared_ptr<opentelemetry::v1::context::RuntimeContextStorage>::~shared_ptr() /build/cpp/opentelemetry_ep-install/include/opentelemetry/nostd/shared_ptr.h:98:30 (libarrow.so.800+0x1e62fb3)\r\n    #8 cxa_at_exit_wrapper(void*) <null> (arrow-dataset-scanner-test+0x11866f)\r\n{code}\r\n",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "6h 50m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 24600
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[C++][CI] Sporadic ThreadSanitizer failure with OpenTracing",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488321",
                    "id": "17488321",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "The \"atexit hook\" I mentioned simply seems to be a standard C++ exit hook that destroys global/static variables. Here the static singleton that's stored in {{RuntimeContext::GetStorage}}.\r\n\r\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2022-02-07T18:24:44.764+0000",
                    "updated": "2022-02-07T18:24:44.764+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488325",
                    "id": "17488325",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "So, basically, it seems using OpenTracing in an asynchronous setup where code may run after process teardown has started may be quite delicate. [~lidavidm] [~westonpace]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2022-02-07T18:25:44.213+0000",
                    "updated": "2022-02-07T18:25:44.213+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488347",
                    "id": "17488347",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Hmm, I think I ran into something similar when I working on my PR. https://github.com/apache/arrow/pull/11964#issuecomment-995043666\r\n\r\nCC [~mbrobbel]\r\n\r\nShould we disable OT in CI for now? ",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2022-02-07T18:44:22.686+0000",
                    "updated": "2022-02-07T18:44:22.686+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488349",
                    "id": "17488349",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "It also seems the main thread is being destroyed during/before the thread pools, so maybe this is a static destructor order pitfall\u2026",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2022-02-07T18:45:58.033+0000",
                    "updated": "2022-02-07T18:45:58.033+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488548",
                    "id": "17488548",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "body": "I ran into bugs like this before.  I don't think the cause is really OT but it seems to increase the likelihood of failure.  Basically we have async tasks that do something like...\r\n\r\n * Run task\r\n * Mark future finished with result (at this point the main thread is free to exit and start shutdown)\r\n * Cleanup task\r\n\r\nIf anything in the Cleanup task accesses global state we could get this error.  In the past the problem was that a task was accessing the default memory pool in its cleanup (I don't recall why).  A short term fix is to update the test so it isn't using the eternal thread pool or to call WaitForIdle on the CPU thread pool but these feel more like hacks than real fixes as a real customer would still have a segfault at shutdown.\r\n\r\nIn this case it seems the cleanup step is doing something with OT (which makes perfect sense).\r\n\r\nI don't suppose there is any way to block the shutdown until the eternal thread pool is idle?  It could probably be signal safe if we waited with a busy loop but then I think you run the risk of shutdown delays.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "created": "2022-02-08T02:05:25.417+0000",
                    "updated": "2022-02-08T02:05:25.417+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17488727",
                    "id": "17488727",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "bq. I don't suppose there is any way to block the shutdown until the eternal thread pool is idle?\r\n\r\nWhich shutdown? The problem seems to be (as David diagnosed) that the OT context storage singleton is being destroyed before the Arrow CPU thread pool singleton. I don't know how we can change or workaround that.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2022-02-08T10:20:14.809+0000",
                    "updated": "2022-02-08T10:20:14.809+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17489126",
                    "id": "17489126",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "body": "We could work around it with some kind of guarded singleton class:\r\n * The constructor instantiates the instance on the heap\r\n * The accessor grabs a mutex (or spinlock if we need to be signal safe) and, if instance is null, returns an invalid status\r\n    * Note: will require the accessor to return Result<T*> instead of T* like it does today, not sure if that will be a problem for OT\r\n\r\nThen register an atexit handler that grabs the mutex/spin lock, deletes the instance, and sets the pointer to null\r\n\r\nLooking at the OT code more closely though I am a bit surprised we are encountering this.  The {{END_SPAN_ON_FUTURE_COMPLETION}} macro uses {{Then}} and creates a new future.  The new future should only be marked finished after the OT work is done.\r\n\r\nIf no one tackles this in the meantime I will investigate further on Friday.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "created": "2022-02-08T21:25:06.301+0000",
                    "updated": "2022-02-08T21:25:06.301+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17495358",
                    "id": "17495358",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=yibocai",
                        "name": "yibocai",
                        "key": "yibo",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=yibo&avatarId=47542",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yibo&avatarId=47542",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yibo&avatarId=47542",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yibo&avatarId=47542"
                        },
                        "displayName": "Yibo Cai",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "Saw arrow-dataset-scanner-test segfault in travis CI today, probably same issue.\r\n[https://app.travis-ci\u00a0due to.com/github/apache/arrow/jobs/560510053#L3228|https://app.travis-ci.com/github/apache/arrow/jobs/560510053#L3228]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=yibocai",
                        "name": "yibocai",
                        "key": "yibo",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=yibo&avatarId=47542",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yibo&avatarId=47542",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yibo&avatarId=47542",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yibo&avatarId=47542"
                        },
                        "displayName": "Yibo Cai",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2022-02-21T07:30:58.535+0000",
                    "updated": "2022-02-21T07:30:58.535+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13427010/comment/17521921",
                    "id": "17521921",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "body": "Issue resolved by pull request 12408\n[https://github.com/apache/arrow/pull/12408]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
                        "name": "westonpace",
                        "key": "westonpace",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
                        },
                        "displayName": "Weston Pace",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "created": "2022-04-13T20:17:39.366+0000",
                    "updated": "2022-04-13T20:17:39.366+0000"
                }
            ],
            "maxResults": 9,
            "total": 9,
            "startAt": 0
        },
        "customfield_12311820": "0|z0zbs8:",
        "customfield_12314139": null
    }
}