{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13157829",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829",
    "key": "ARROW-2551",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12342562",
                "id": "12342562",
                "description": "",
                "name": "0.10.0",
                "archived": false,
                "released": true,
                "releaseDate": "2018-08-06"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/4",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg",
            "name": "Minor",
            "id": "4"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12332956",
                "id": "12332956",
                "name": "C++ - Plasma"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "aggregateprogress": {
            "progress": 9600,
            "total": 9600,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 9600,
            "total": 9600,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-2551/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 16,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/99417",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu opened a new pull request #2011: ARROW-2551: [Plasma] notification code improvement\nURL: https://github.com/apache/arrow/pull/2011\n \n \n   This change addresses two issues in plasma notification code:\r\n   \r\n   1. Currently plasma store uses recv_fd to receive the notification fd from client. As mentioned in comments from the code, this could cause plasma store to hang if client doesn't call send_fd. This particular change puts the notification fd in SubscriptionRequest to solve the problem.\r\n   2. When a client subscribes to plasma store, the store pushes notifications of existing objects to ALL subscribers - while in this case it just needs to push to the new subscriber. This change adds a new interface to push to a particular client.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-08T08:14:33.625+0000",
                    "updated": "2018-05-08T08:14:33.625+0000",
                    "started": "2018-05-08T08:14:33.625+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "99417",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/99420",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu closed pull request #2011: ARROW-2551: [Plasma] notification code improvement\nURL: https://github.com/apache/arrow/pull/2011\n \n \n   \n\nThis is a PR merged from a forked repository.\nAs GitHub hides the original diff on merge, it is displayed below for\nthe sake of provenance:\n\nAs this is a foreign pull request (from a fork), the diff is supplied\nbelow (as it won't show otherwise due to GitHub magic):\n\ndiff --git a/cpp/src/plasma/client.cc b/cpp/src/plasma/client.cc\nindex a332686a9c..43547b12f4 100644\n--- a/cpp/src/plasma/client.cc\n+++ b/cpp/src/plasma/client.cc\n@@ -861,10 +861,7 @@ Status PlasmaClient::Impl::Subscribe(int* fd) {\n   int flags = fcntl(sock[1], F_GETFL, 0);\n   ARROW_CHECK(fcntl(sock[1], F_SETFL, flags | O_NONBLOCK) == 0);\n   // Tell the Plasma store about the subscription.\n-  RETURN_NOT_OK(SendSubscribeRequest(store_conn_));\n-  // Send the file descriptor that the Plasma store should use to push\n-  // notifications about sealed objects to this client.\n-  ARROW_CHECK(send_fd(store_conn_, sock[1]) >= 0);\n+  RETURN_NOT_OK(SendSubscribeRequest(store_conn_, sock[1]));\n   close(sock[1]);\n   // Return the file descriptor that the client should use to read notifications\n   // about sealed objects.\ndiff --git a/cpp/src/plasma/format/plasma.fbs b/cpp/src/plasma/format/plasma.fbs\nindex 6a58fb0d58..575faaa3a9 100644\n--- a/cpp/src/plasma/format/plasma.fbs\n+++ b/cpp/src/plasma/format/plasma.fbs\n@@ -312,6 +312,8 @@ table PlasmaWaitReply {\n }\n \n table PlasmaSubscribeRequest {\n+  // The file descriptor used by client to receive object notifications.\n+  notification_fd: int;\n }\n \n table PlasmaDataRequest {\ndiff --git a/cpp/src/plasma/protocol.cc b/cpp/src/plasma/protocol.cc\nindex 9443762ec6..ba83ac64b9 100644\n--- a/cpp/src/plasma/protocol.cc\n+++ b/cpp/src/plasma/protocol.cc\n@@ -574,12 +574,20 @@ Status ReadWaitReply(uint8_t* data, size_t size, ObjectRequest object_requests[]\n \n // Subscribe messages.\n \n-Status SendSubscribeRequest(int sock) {\n+Status SendSubscribeRequest(int sock, int notification_fd) {\n   flatbuffers::FlatBufferBuilder fbb;\n-  auto message = CreatePlasmaSubscribeRequest(fbb);\n+  auto message = CreatePlasmaSubscribeRequest(fbb, notification_fd);\n   return PlasmaSend(sock, MessageType_PlasmaSubscribeRequest, &fbb, message);\n }\n \n+Status ReadSubscribeRequest(uint8_t* data, size_t size, int* notification_fd) {\n+  DCHECK(data);\n+  auto message = flatbuffers::GetRoot<PlasmaSubscribeRequest>(data);\n+  DCHECK(verify_flatbuffer(message, data, size));\n+  *notification_fd = message->notification_fd();\n+  return Status::OK();\n+}\n+\n // Data messages.\n \n Status SendDataRequest(int sock, ObjectID object_id, const char* address, int port) {\ndiff --git a/cpp/src/plasma/protocol.h b/cpp/src/plasma/protocol.h\nindex 86b3577c72..701f2538b0 100644\n--- a/cpp/src/plasma/protocol.h\n+++ b/cpp/src/plasma/protocol.h\n@@ -179,7 +179,9 @@ Status ReadWaitReply(uint8_t* data, size_t size, ObjectRequest object_requests[]\n \n /* Plasma Subscribe message functions. */\n \n-Status SendSubscribeRequest(int sock);\n+Status SendSubscribeRequest(int sock, int notification_fd);\n+\n+Status ReadSubscribeRequest(uint8_t* data, size_t size, int* notification_fd);\n \n /* Data messages. */\n \ndiff --git a/cpp/src/plasma/store.cc b/cpp/src/plasma/store.cc\nindex c06ad6ab1c..973a4ef41d 100644\n--- a/cpp/src/plasma/store.cc\n+++ b/cpp/src/plasma/store.cc\n@@ -630,16 +630,24 @@ void PlasmaStore::push_notification(ObjectInfoT* object_info) {\n   }\n }\n \n+void PlasmaStore::push_notification(ObjectInfoT* object_info, int client_fd) {\n+  auto it = pending_notifications_.find(client_fd);\n+  if (it != pending_notifications_.end()) {\n+    auto notification = create_object_info_buffer(object_info);\n+    it->second.object_notifications.emplace_back(std::move(notification));\n+    send_notifications(it->first);\n+    // The notification gets freed in send_notifications when the notification\n+    // is sent over the socket.\n+  }\n+}\n+\n // Subscribe to notifications about sealed objects.\n-void PlasmaStore::subscribe_to_updates(Client* client) {\n+void PlasmaStore::subscribe_to_updates(Client* client, int notification_fd) {\n   ARROW_LOG(DEBUG) << \"subscribing to updates on fd \" << client->fd;\n-  // TODO(rkn): The store could block here if the client doesn't send a file\n-  // descriptor.\n-  int fd = recv_fd(client->fd);\n+  int fd = notification_fd;\n   if (fd < 0) {\n-    // This may mean that the client died before sending the file descriptor.\n-    ARROW_LOG(WARNING) << \"Failed to receive file descriptor from client on fd \"\n-                       << client->fd << \".\";\n+    // Incorrect fd for client notification.\n+    ARROW_LOG(WARNING) << \"Incorrect file descriptor from client \" << client->fd << \".\";\n     return;\n   }\n \n@@ -651,7 +659,7 @@ void PlasmaStore::subscribe_to_updates(Client* client) {\n \n   // Push notifications to the new subscriber about existing objects.\n   for (const auto& entry : store_info_.objects) {\n-    push_notification(&entry.second->info);\n+    push_notification(&entry.second->info, fd);\n   }\n   send_notifications(fd);\n }\n@@ -735,7 +743,9 @@ Status PlasmaStore::process_message(Client* client) {\n       HANDLE_SIGPIPE(SendEvictReply(client->fd, num_bytes_evicted), client->fd);\n     } break;\n     case MessageType_PlasmaSubscribeRequest:\n-      subscribe_to_updates(client);\n+      int notification_fd;\n+      RETURN_NOT_OK(ReadSubscribeRequest(input, input_size, &notification_fd));\n+      subscribe_to_updates(client, notification_fd);\n       break;\n     case MessageType_PlasmaConnectRequest: {\n       HANDLE_SIGPIPE(SendConnectReply(client->fd, store_info_.memory_capacity),\ndiff --git a/cpp/src/plasma/store.h b/cpp/src/plasma/store.h\nindex ac6b2c4c50..4990b21d2c 100644\n--- a/cpp/src/plasma/store.h\n+++ b/cpp/src/plasma/store.h\n@@ -145,7 +145,8 @@ class PlasmaStore {\n   /// Subscribe a file descriptor to updates about new sealed objects.\n   ///\n   /// @param client The client making this request.\n-  void subscribe_to_updates(Client* client);\n+  /// @param notification_fd The file descriptor used by client to receive notifications.\n+  void subscribe_to_updates(Client* client, int notification_fd);\n \n   /// Connect a new client to the PlasmaStore.\n   ///\n@@ -162,8 +163,17 @@ class PlasmaStore {\n   Status process_message(Client* client);\n \n  private:\n+  /// Push an object notification to all subscribers.\n+  ///\n+  /// @param object_notification The object notification to be pushed.\n   void push_notification(ObjectInfoT* object_notification);\n \n+  /// Push an object notification to one subscribers.\n+  ///\n+  /// @param object_notification The object notification to be pushed.\n+  /// @param client_fd The client file descriptor to which the notification is sent.\n+  void push_notification(ObjectInfoT* object_notification, int client_fd);\n+\n   void add_client_to_object_clients(ObjectTableEntry* entry, Client* client);\n \n   void return_from_get(GetRequest* get_req);\n\n\n \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-08T08:51:48.751+0000",
                    "updated": "2018-05-08T08:51:48.751+0000",
                    "started": "2018-05-08T08:51:48.750+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "99420",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/100967",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu opened a new pull request #2028: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2028\n \n \n   This change targets to improve a few places in current plasma notification code:\r\n   1. When a client subscribes to Plasma, the store pushes notifications about existing objects to ALL subscribers, while it should only push to the new subscriber.\r\n   2. And in the above scenario, it should only push \"sealed\" objects to the new subscriber, while currently it pushes all objects regardless of the state.\r\n   3. When a client disconnects, it will no longer be able to receive notifications, thus the NotificationQueue for the client should be removed from global map.\r\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-11T02:52:45.240+0000",
                    "updated": "2018-05-11T02:52:45.240+0000",
                    "started": "2018-05-11T02:52:45.239+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100967",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/100968",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu closed pull request #2028: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2028\n \n \n   \n\nThis is a PR merged from a forked repository.\nAs GitHub hides the original diff on merge, it is displayed below for\nthe sake of provenance:\n\nAs this is a foreign pull request (from a fork), the diff is supplied\nbelow (as it won't show otherwise due to GitHub magic):\n\ndiff --git a/cpp/src/plasma/store.cc b/cpp/src/plasma/store.cc\nindex 342d228bad..3c1d5c8e9d 100644\n--- a/cpp/src/plasma/store.cc\n+++ b/cpp/src/plasma/store.cc\n@@ -636,6 +636,9 @@ void PlasmaStore::subscribe_to_updates(Client* client) {\n     return;\n   }\n \n+  // Add this fd to global map, which is needed for this client to receive notifications.\n+  pending_notifications_[fd];\n+\n   // Push notifications to the new subscriber about existing objects.\n   for (const auto& entry : store_info_.objects) {\n     push_notification(&entry.second->info);\ndiff --git a/cpp/src/plasma/test/client_tests.cc b/cpp/src/plasma/test/client_tests.cc\nindex 53743cad2d..3b7ae596a9 100644\n--- a/cpp/src/plasma/test/client_tests.cc\n+++ b/cpp/src/plasma/test/client_tests.cc\n@@ -52,15 +52,15 @@ class TestPlasmaStore : public ::testing::Test {\n     std::mt19937 rng;\n     rng.seed(std::random_device()());\n     std::string store_index = std::to_string(rng());\n+    store_socket_name_ = \"/tmp/store\" + store_index;\n \n     std::string plasma_directory =\n         test_executable.substr(0, test_executable.find_last_of(\"/\"));\n-    std::string plasma_command = plasma_directory +\n-                                 \"/plasma_store -m 1000000000 -s /tmp/store\" +\n-                                 store_index + \" 1> /dev/null 2> /dev/null &\";\n+    std::string plasma_command = plasma_directory + \"/plasma_store -m 1000000000 -s \" +\n+                                 store_socket_name_ + \" 1> /dev/null 2> /dev/null &\";\n     system(plasma_command.c_str());\n-    ARROW_CHECK_OK(client_.Connect(\"/tmp/store\" + store_index, \"\"));\n-    ARROW_CHECK_OK(client2_.Connect(\"/tmp/store\" + store_index, \"\"));\n+    ARROW_CHECK_OK(client_.Connect(store_socket_name_, \"\"));\n+    ARROW_CHECK_OK(client2_.Connect(store_socket_name_, \"\"));\n   }\n   virtual void TearDown() {\n     ARROW_CHECK_OK(client_.Disconnect());\n@@ -83,11 +83,60 @@ class TestPlasmaStore : public ::testing::Test {\n     ARROW_CHECK_OK(client.Release(object_id));\n   }\n \n+  const std::string& GetStoreSocketName() const { return store_socket_name_; }\n+\n  protected:\n   PlasmaClient client_;\n   PlasmaClient client2_;\n+  std::string store_socket_name_;\n };\n \n+TEST_F(TestPlasmaStore, NewSubscriberTest) {\n+  PlasmaClient local_client, local_client2;\n+\n+  ARROW_CHECK_OK(local_client.Connect(store_socket_name_, \"\"));\n+  ARROW_CHECK_OK(local_client2.Connect(store_socket_name_, \"\"));\n+\n+  ObjectID object_id = ObjectID::from_random();\n+\n+  // Test for the object being in local Plasma store.\n+  // First create object.\n+  int64_t data_size = 100;\n+  uint8_t metadata[] = {5};\n+  int64_t metadata_size = sizeof(metadata);\n+  std::shared_ptr<Buffer> data;\n+  ARROW_CHECK_OK(\n+      local_client.Create(object_id, data_size, metadata, metadata_size, &data));\n+  ARROW_CHECK_OK(local_client.Seal(object_id));\n+\n+  // Test that new subscriber client2 can receive notifications about existing objects.\n+  int fd = -1;\n+  ARROW_CHECK_OK(local_client2.Subscribe(&fd));\n+  ASSERT_GT(fd, 0);\n+\n+  ObjectID object_id2 = ObjectID::from_random();\n+  int64_t data_size2 = 0;\n+  int64_t metadata_size2 = 0;\n+  ARROW_CHECK_OK(\n+      local_client2.GetNotification(fd, &object_id2, &data_size2, &metadata_size2));\n+  ASSERT_EQ(object_id, object_id2);\n+  ASSERT_EQ(data_size, data_size2);\n+  ASSERT_EQ(metadata_size, metadata_size2);\n+\n+  // Delete the object.\n+  ARROW_CHECK_OK(local_client.Release(object_id));\n+  ARROW_CHECK_OK(local_client.Delete(object_id));\n+\n+  ARROW_CHECK_OK(\n+      local_client2.GetNotification(fd, &object_id2, &data_size2, &metadata_size2));\n+  ASSERT_EQ(object_id, object_id2);\n+  ASSERT_EQ(-1, data_size2);\n+  ASSERT_EQ(-1, metadata_size2);\n+\n+  ARROW_CHECK_OK(local_client2.Disconnect());\n+  ARROW_CHECK_OK(local_client.Disconnect());\n+}\n+\n TEST_F(TestPlasmaStore, SealErrorsTest) {\n   ObjectID object_id = ObjectID::from_random();\n \n\n\n \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-11T02:54:11.984+0000",
                    "updated": "2018-05-11T02:54:11.984+0000",
                    "started": "2018-05-11T02:54:11.984+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100968",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/100970",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu opened a new pull request #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031\n \n \n   This change targets to improve a few places in current plasma notification code:\r\n   1. When a client subscribes to Plasma, the store pushes notifications about existing objects to ALL subscribers, while it should only push to the new subscriber.\r\n   2. And in the above scenario, it should only push \"sealed\" objects to the new subscriber, while currently it pushes all objects regardless of the state.\r\n   3. When a client disconnects, it will no longer be able to receive notifications, thus the NotificationQueue for the client should be removed from global map.\r\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-11T03:07:40.590+0000",
                    "updated": "2018-05-11T03:07:40.590+0000",
                    "started": "2018-05-11T03:07:40.589+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100970",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/101020",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "codecov-io commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-388291207\n \n \n   # [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=h1) Report\n   > Merging [#2031](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=desc) into [master](https://codecov.io/gh/apache/arrow/commit/bb47c36571ab528ae582fda2e0c1037c01f37ffe?src=pr&el=desc) will **increase** coverage by `0.03%`.\n   > The diff coverage is `94.73%`.\n   \n   [![Impacted file tree graph](https://codecov.io/gh/apache/arrow/pull/2031/graphs/tree.svg?token=LpTCFbqVT1&width=650&src=pr&height=150)](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree)\n   \n   ```diff\n   @@            Coverage Diff             @@\n   ##           master    #2031      +/-   ##\n   ==========================================\n   + Coverage   87.42%   87.45%   +0.03%     \n   ==========================================\n     Files         189      178      -11     \n     Lines       29289    28532     -757     \n   ==========================================\n   - Hits        25607    24954     -653     \n   + Misses       3682     3578     -104\n   ```\n   \n   \n   | [Impacted Files](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree) | Coverage \u0394 | |\n   |---|---|---|\n   | [cpp/src/plasma/store.h](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuaA==) | `100% <\u00f8> (\u00f8)` | :arrow_up: |\n   | [cpp/src/plasma/store.cc](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuY2M=) | `88.93% <94.73%> (-0.06%)` | :arrow_down: |\n   | [rust/src/memory\\_pool.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvbWVtb3J5X3Bvb2wucnM=) | | |\n   | [rust/src/bitmap.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYml0bWFwLnJz) | | |\n   | [rust/src/lib.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvbGliLnJz) | | |\n   | [rust/src/buffer.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYnVmZmVyLnJz) | | |\n   | [rust/src/builder.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYnVpbGRlci5ycw==) | | |\n   | [rust/src/array.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYXJyYXkucnM=) | | |\n   | [rust/src/error.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvZXJyb3IucnM=) | | |\n   | ... and [4 more](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree-more) | |\n   \n   ------\n   \n   [Continue to review full report at Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=continue).\n   > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n   > `\u0394 = absolute <relative> (impact)`, `\u00f8 = not affected`, `? = missing data`\n   > Powered by [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=footer). Last update [bb47c36...38d992b](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-11T07:59:49.605+0000",
                    "updated": "2018-05-11T07:59:49.605+0000",
                    "started": "2018-05-11T07:59:49.604+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "101020",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/102332",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#discussion_r188460827\n \n \n\n ##########\n File path: cpp/src/plasma/store.cc\n ##########\n @@ -104,7 +104,7 @@ GetRequest::GetRequest(Client* client, const std::vector<ObjectID>& object_ids)\n   num_objects_to_wait_for = unique_ids.size();\n }\n \n-Client::Client(int fd) : fd(fd) {}\n+Client::Client(int fd) : fd(fd), notification_fd(boost::none) {}\n \n Review comment:\n   Let's make notification_fd = -1 by default if not set (and get rid of the boost dependency)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-15T22:57:46.497+0000",
                    "updated": "2018-05-15T22:57:46.497+0000",
                    "started": "2018-05-15T22:57:46.497+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "102332",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/102514",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-389561887\n \n \n   @pcmoritz Thanks for reviewing :)  Changed boost::none to -1 and did a rebase to resolve the conflict.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-16T15:30:01.336+0000",
                    "updated": "2018-05-16T15:30:01.336+0000",
                    "started": "2018-05-16T15:30:01.336+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "102514",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/102761",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "codecov-io commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-388291207\n \n \n   # [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=h1) Report\n   > Merging [#2031](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=desc) into [master](https://codecov.io/gh/apache/arrow/commit/6ca246a172cfcc692b96701aa87b1b89f1d9a742?src=pr&el=desc) will **increase** coverage by `0.02%`.\n   > The diff coverage is `94.73%`.\n   \n   [![Impacted file tree graph](https://codecov.io/gh/apache/arrow/pull/2031/graphs/tree.svg?src=pr&token=LpTCFbqVT1&height=150&width=650)](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree)\n   \n   ```diff\n   @@            Coverage Diff             @@\n   ##           master    #2031      +/-   ##\n   ==========================================\n   + Coverage   87.44%   87.47%   +0.02%     \n   ==========================================\n     Files         189      178      -11     \n     Lines       29374    28617     -757     \n   ==========================================\n   - Hits        25686    25032     -654     \n   + Misses       3688     3585     -103\n   ```\n   \n   \n   | [Impacted Files](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree) | Coverage \u0394 | |\n   |---|---|---|\n   | [cpp/src/plasma/store.h](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuaA==) | `100% <\u00f8> (\u00f8)` | :arrow_up: |\n   | [cpp/src/plasma/store.cc](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuY2M=) | `88.61% <94.73%> (-0.05%)` | :arrow_down: |\n   | [cpp/src/arrow/util/thread-pool-test.cc](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9hcnJvdy91dGlsL3RocmVhZC1wb29sLXRlc3QuY2M=) | `98.87% <0%> (-0.57%)` | :arrow_down: |\n   | [rust/src/memory.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvbWVtb3J5LnJz) | | |\n   | [rust/src/datatypes.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvZGF0YXR5cGVzLnJz) | | |\n   | [rust/src/bitmap.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYml0bWFwLnJz) | | |\n   | [rust/src/error.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvZXJyb3IucnM=) | | |\n   | [rust/src/buffer.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvYnVmZmVyLnJz) | | |\n   | [rust/src/memory\\_pool.rs](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cnVzdC9zcmMvbWVtb3J5X3Bvb2wucnM=) | | |\n   | ... and [5 more](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree-more) | |\n   \n   ------\n   \n   [Continue to review full report at Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=continue).\n   > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n   > `\u0394 = absolute <relative> (impact)`, `\u00f8 = not affected`, `? = missing data`\n   > Powered by [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=footer). Last update [6ca246a...3199eea](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-17T03:11:54.784+0000",
                    "updated": "2018-05-17T03:11:54.784+0000",
                    "started": "2018-05-17T03:11:54.783+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "102761",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/103694",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-390429208\n \n \n   @zhijunfu Sorry, the other PR caused a merge conflict, can you rebase/merge so we can get this PR in? Thanks :)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-19T20:05:36.572+0000",
                    "updated": "2018-05-19T20:05:36.572+0000",
                    "started": "2018-05-19T20:05:36.571+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "103694",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/106283",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-392472722\n \n \n   @pcmoritz Sorry for the long delay in reply, I just rebased the change on top of latest code. The build failures w/ parquet and tool-chain should be unrelated with the change. \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-28T09:25:35.329+0000",
                    "updated": "2018-05-28T09:25:35.329+0000",
                    "started": "2018-05-28T09:25:35.328+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "106283",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/106426",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm commented on a change in pull request #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#discussion_r191292855\n \n \n\n ##########\n File path: cpp/src/plasma/store.h\n ##########\n @@ -50,6 +50,10 @@ struct Client {\n \n   /// Object ids that are used by this client.\n   std::unordered_set<ObjectID> object_ids;\n+\n+  /// The file descriptor used to push notifications to client. This is only valid\n+  /// if client subscribes to plasma store. -1 indicates invalid.\n+  int notification_fd;\n \n Review comment:\n   Unrelated to the content of this patch: could we regularize the variable name convention in this header and elsewhere in Plasma? Would help with readability\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-29T02:33:14.994+0000",
                    "updated": "2018-05-29T02:33:14.994+0000",
                    "started": "2018-05-29T02:33:14.994+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "106426",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/109310",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "codecov-io commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-388291207\n \n \n   # [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=h1) Report\n   > Merging [#2031](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=desc) into [master](https://codecov.io/gh/apache/arrow/commit/664686416d4f35e2396c759095801bbdd7e38772?src=pr&el=desc) will **increase** coverage by `0.02%`.\n   > The diff coverage is `94.73%`.\n   \n   [![Impacted file tree graph](https://codecov.io/gh/apache/arrow/pull/2031/graphs/tree.svg?token=LpTCFbqVT1&src=pr&height=150&width=650)](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree)\n   \n   ```diff\n   @@            Coverage Diff             @@\n   ##           master    #2031      +/-   ##\n   ==========================================\n   + Coverage   86.35%   86.37%   +0.02%     \n   ==========================================\n     Files         242      230      -12     \n     Lines       41184    40474     -710     \n   ==========================================\n   - Hits        35565    34960     -605     \n   + Misses       5619     5514     -105\n   ```\n   \n   \n   | [Impacted Files](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=tree) | Coverage \u0394 | |\n   |---|---|---|\n   | [cpp/src/plasma/store.h](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuaA==) | `100% <\u00f8> (\u00f8)` | :arrow_up: |\n   | [cpp/src/plasma/store.cc](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9wbGFzbWEvc3RvcmUuY2M=) | `88.71% <94.73%> (-0.05%)` | :arrow_down: |\n   | [python/pyarrow/array.pxi](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvYXJyYXkucHhp) | `66.04% <0%> (-2.5%)` | :arrow_down: |\n   | [python/pyarrow/feather.pxi](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvZmVhdGhlci5weGk=) | `67.44% <0%> (-1.45%)` | :arrow_down: |\n   | [cpp/src/arrow/util/bit-util.h](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9hcnJvdy91dGlsL2JpdC11dGlsLmg=) | `98.01% <0%> (-1.23%)` | :arrow_down: |\n   | [python/pyarrow/types.pxi](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvdHlwZXMucHhp) | `57.9% <0%> (-1.09%)` | :arrow_down: |\n   | [python/pyarrow/table.pxi](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvdGFibGUucHhp) | `68.69% <0%> (-1.07%)` | :arrow_down: |\n   | [python/pyarrow/\\_\\_init\\_\\_.py](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvX19pbml0X18ucHk=) | `57.14% <0%> (-0.76%)` | :arrow_down: |\n   | [python/pyarrow/io.pxi](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-cHl0aG9uL3B5YXJyb3cvaW8ucHhp) | `62.23% <0%> (-0.53%)` | :arrow_down: |\n   | [cpp/src/arrow/io/hdfs-internal.cc](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree#diff-Y3BwL3NyYy9hcnJvdy9pby9oZGZzLWludGVybmFsLmNj) | `33.62% <0%> (-0.45%)` | :arrow_down: |\n   | ... and [52 more](https://codecov.io/gh/apache/arrow/pull/2031/diff?src=pr&el=tree-more) | |\n   \n   ------\n   \n   [Continue to review full report at Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=continue).\n   > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n   > `\u0394 = absolute <relative> (impact)`, `\u00f8 = not affected`, `? = missing data`\n   > Powered by [Codecov](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=footer). Last update [6646864...84f4935](https://codecov.io/gh/apache/arrow/pull/2031?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-06-06T08:52:39.429+0000",
                    "updated": "2018-06-06T08:52:39.429+0000",
                    "started": "2018-06-06T08:52:39.429+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "109310",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/109354",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on a change in pull request #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#discussion_r193377002\n \n \n\n ##########\n File path: cpp/src/plasma/store.h\n ##########\n @@ -50,6 +50,10 @@ struct Client {\n \n   /// Object ids that are used by this client.\n   std::unordered_set<ObjectID> object_ids;\n+\n+  /// The file descriptor used to push notifications to client. This is only valid\n+  /// if client subscribes to plasma store. -1 indicates invalid.\n+  int notification_fd;\n \n Review comment:\n   Yes that makes a lot of sense:)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-06-06T11:27:39.424+0000",
                    "updated": "2018-06-06T11:27:39.424+0000",
                    "started": "2018-06-06T11:27:39.424+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "109354",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/109355",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on issue #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031#issuecomment-395036053\n \n \n   Re-triggered the build and it passed this time. \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-06-06T11:28:24.843+0000",
                    "updated": "2018-06-06T11:28:24.843+0000",
                    "started": "2018-06-06T11:28:24.842+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "109355",
                    "issueId": "13157829"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/worklog/110356",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "wesm closed pull request #2031: ARROW-2551: [Plasma] Improve notification logic\nURL: https://github.com/apache/arrow/pull/2031\n \n \n   \n\nThis is a PR merged from a forked repository.\nAs GitHub hides the original diff on merge, it is displayed below for\nthe sake of provenance:\n\nAs this is a foreign pull request (from a fork), the diff is supplied\nbelow (as it won't show otherwise due to GitHub magic):\n\ndiff --git a/cpp/src/plasma/store.cc b/cpp/src/plasma/store.cc\nindex 171f062225..69a02dc0f2 100644\n--- a/cpp/src/plasma/store.cc\n+++ b/cpp/src/plasma/store.cc\n@@ -103,7 +103,7 @@ GetRequest::GetRequest(Client* client, const std::vector<ObjectID>& object_ids)\n   num_objects_to_wait_for = unique_ids.size();\n }\n \n-Client::Client(int fd) : fd(fd) {}\n+Client::Client(int fd) : fd(fd), notification_fd(-1) {}\n \n PlasmaStore::PlasmaStore(EventLoop* loop, int64_t system_memory, std::string directory,\n                          bool hugepages_enabled)\n@@ -559,10 +559,18 @@ void PlasmaStore::disconnect_client(int client_fd) {\n     remove_from_client_object_ids(entry, client);\n   }\n \n-  // Note, the store may still attempt to send a message to the disconnected\n-  // client (for example, when an object ID that the client was waiting for\n-  // is ready). In these cases, the attempt to send the message will fail, but\n-  // the store should just ignore the failure.\n+  if (client->notification_fd > 0) {\n+    // This client has subscribed for notifications.\n+    auto notify_fd = client->notification_fd;\n+    loop_->RemoveFileEvent(notify_fd);\n+    // Close socket.\n+    close(notify_fd);\n+    // Remove notification queue for this fd from global map.\n+    pending_notifications_.erase(notify_fd);\n+    // Reset fd.\n+    client->notification_fd = -1;\n+  }\n+\n   connected_clients_.erase(it);\n }\n \n@@ -642,9 +650,23 @@ void PlasmaStore::push_notification(ObjectInfoT* object_info) {\n   }\n }\n \n+void PlasmaStore::push_notification(ObjectInfoT* object_info, int client_fd) {\n+  auto it = pending_notifications_.find(client_fd);\n+  if (it != pending_notifications_.end()) {\n+    auto notification = create_object_info_buffer(object_info);\n+    it->second.object_notifications.emplace_back(std::move(notification));\n+    send_notifications(it);\n+  }\n+}\n+\n // Subscribe to notifications about sealed objects.\n void PlasmaStore::subscribe_to_updates(Client* client) {\n   ARROW_LOG(DEBUG) << \"subscribing to updates on fd \" << client->fd;\n+  if (client->notification_fd > 0) {\n+    // This client has already subscribed. Return.\n+    return;\n+  }\n+\n   // TODO(rkn): The store could block here if the client doesn't send a file\n   // descriptor.\n   int fd = recv_fd(client->fd);\n@@ -657,12 +679,14 @@ void PlasmaStore::subscribe_to_updates(Client* client) {\n \n   // Add this fd to global map, which is needed for this client to receive notifications.\n   pending_notifications_[fd];\n+  client->notification_fd = fd;\n \n-  // Push notifications to the new subscriber about existing objects.\n+  // Push notifications to the new subscriber about existing sealed objects.\n   for (const auto& entry : store_info_.objects) {\n-    push_notification(&entry.second->info);\n+    if (entry.second->state == PLASMA_SEALED) {\n+      push_notification(&entry.second->info, fd);\n+    }\n   }\n-  send_notifications(pending_notifications_.find(fd));\n }\n \n Status PlasmaStore::process_message(Client* client) {\ndiff --git a/cpp/src/plasma/store.h b/cpp/src/plasma/store.h\nindex 9b3850b5a1..e5ef9172ee 100644\n--- a/cpp/src/plasma/store.h\n+++ b/cpp/src/plasma/store.h\n@@ -50,6 +50,10 @@ struct Client {\n \n   /// Object ids that are used by this client.\n   std::unordered_set<ObjectID> object_ids;\n+\n+  /// The file descriptor used to push notifications to client. This is only valid\n+  /// if client subscribes to plasma store. -1 indicates invalid.\n+  int notification_fd;\n };\n \n class PlasmaStore {\n@@ -170,6 +174,8 @@ class PlasmaStore {\n  private:\n   void push_notification(ObjectInfoT* object_notification);\n \n+  void push_notification(ObjectInfoT* object_notification, int client_fd);\n+\n   void add_to_client_object_ids(ObjectTableEntry* entry, Client* client);\n \n   void return_from_get(GetRequest* get_req);\n\n\n \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-06-09T01:01:56.789+0000",
                    "updated": "2018-06-09T01:01:56.789+0000",
                    "started": "2018-06-09T01:01:56.788+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "110356",
                    "issueId": "13157829"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/4",
            "id": "4",
            "description": "An improvement or enhancement to an existing feature or task.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype",
            "name": "Improvement",
            "subtask": false,
            "avatarId": 21140
        },
        "timespent": 9600,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@b73a2a5[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@12182a2e[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6929562d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@3ab3487c[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@301a616b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@25e6c7c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@21e5da24[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@13596cc[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@62c7aeb8[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@138b1310[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1c30dfbf[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@319eb903[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 9600,
        "customfield_12312520": null,
        "customfield_12312521": "Sat Jun 09 01:02:06 UTC 2018",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2018-06-09T01:02:06.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-2551/watchers",
            "watchCount": 2,
            "isWatching": false
        },
        "created": "2018-05-08T08:12:15.000+0000",
        "updated": "2018-06-09T01:03:23.000+0000",
        "timeoriginalestimate": null,
        "description": "There are\u00a0a few issues in current Plasma notification code:\r\n * When a client subscribes to Plasma, the store pushes notifications about existing objects to ALL subscribers, while it should only push to the new subscriber.\r\n * And in the above scenario, it should only push \"sealed\" objects to the new subscriber, while currently it pushes all objects regardless of the state.\r\n * When a client disconnects, it will no longer be able to receive notifications, thus the NotificationQueue for the client should be removed from global map.",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "2h 40m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 9600
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Plasma] Improve notification logic",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/comment/16478859",
                    "id": "16478859",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=ovidiumarcu",
                        "name": "ovidiumarcu",
                        "key": "ovidiumarcu",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Ovidiu Marcu",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "Thanks for #2028, it fixed a bug when the client crashed the second run will crash the plasma store (could change\u00a0issue type from improvement to bug?).\r\n\r\nI am using plasma notifications and I\u00a0observe\u00a0I do not get objects in order of their creation although\u00a0I receive all objects.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=ovidiumarcu",
                        "name": "ovidiumarcu",
                        "key": "ovidiumarcu",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Ovidiu Marcu",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2018-05-17T10:24:11.709+0000",
                    "updated": "2018-05-17T10:34:08.444+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/comment/16504230",
                    "id": "16504230",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
                        "name": "zhijunfu",
                        "key": "zhijunfu",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
                        },
                        "displayName": "Zhijun Fu",
                        "active": true,
                        "timeZone": "Asia/Shanghai"
                    },
                    "body": "[~ovidiumarcu]\u00a0 Sorry for the late reply. Good to know that it fixed your issue:)\r\n\r\nFor the order of notifications, there are two cases:\r\n\r\n1) When a client\u00a0subscribes to plasma store, the store will push notifications for all existing objects to the new client, in this case there's *no specific order*\u00a0among these notifications - the store simply loop through all the objects from an unordered_map and push notification for each of them.\r\n\r\n2) When a new object is sealed, a notification is pushed to all the clients that have subscribed for notifications. In this case, the object notifications are sent in the order of their *sealed* time, instead of creation time.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
                        "name": "zhijunfu",
                        "key": "zhijunfu",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
                        },
                        "displayName": "Zhijun Fu",
                        "active": true,
                        "timeZone": "Asia/Shanghai"
                    },
                    "created": "2018-06-07T04:44:01.661+0000",
                    "updated": "2018-06-07T04:44:01.661+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13157829/comment/16506756",
                    "id": "16506756",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 2031\n[https://github.com/apache/arrow/pull/2031]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2018-06-09T01:02:06.531+0000",
                    "updated": "2018-06-09T01:02:06.531+0000"
                }
            ],
            "maxResults": 3,
            "total": 3,
            "startAt": 0
        },
        "customfield_12311820": "0|i3tgin:",
        "customfield_12314139": null
    }
}