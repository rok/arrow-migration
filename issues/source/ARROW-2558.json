{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13158114",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114",
    "key": "ARROW-2558",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12342562",
                "id": "12342562",
                "description": "",
                "name": "0.10.0",
                "archived": false,
                "released": true,
                "releaseDate": "2018-08-06"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/4",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg",
            "name": "Minor",
            "id": "4"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12332956",
                "id": "12332956",
                "name": "C++ - Plasma"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=zhijunfu",
            "name": "zhijunfu",
            "key": "zhijunfu",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"
            },
            "displayName": "Zhijun Fu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "aggregateprogress": {
            "progress": 7200,
            "total": 7200,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 7200,
            "total": 7200,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-2558/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 12,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/99897",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu opened a new pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015\n \n \n   Currently plasma stores list-of-clients in ObjectTableEntry, which is used to track which clients are using a given object, this serves for two purposes:\r\n   - If an object is in use.\r\n   - If the client trying to abort an object is the one who created it.\r\n   \r\n   A problem with list-of-clients approach is that when a client disconnects, we need to walk through all the objects and remove the client pointer from the list for each object.\r\n   \r\n   Instead, we could add a reference count in ObjectTableEntry, and store list-of-object-ids in client structure. This could both goals that the original approach is targeting, while when a client disconnects, it just walk through its object-ids and dereference each ObjectTableEntry, there's no need to walk through all objects.\r\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T07:18:25.613+0000",
                    "updated": "2018-05-09T07:18:25.613+0000",
                    "started": "2018-05-09T07:18:25.613+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "99897",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100327",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187205164\n \n \n\n ##########\n File path: cpp/src/plasma/plasma.h\n ##########\n @@ -134,8 +134,9 @@ struct ObjectTableEntry {\n   /// IPC GPU handle to share with clients.\n   std::shared_ptr<CudaIpcMemHandle> ipc_handle;\n #endif\n-  /// Set of clients currently using this object.\n-  std::unordered_set<Client*> clients;\n+  /// Reference count.\n \n Review comment:\n   Better documentation is: Number of clients currently using this object.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T23:34:51.547+0000",
                    "updated": "2018-05-09T23:34:51.547+0000",
                    "started": "2018-05-09T23:34:51.547+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100327",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100328",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187205338\n \n \n\n ##########\n File path: cpp/src/plasma/plasma.h\n ##########\n @@ -134,8 +134,9 @@ struct ObjectTableEntry {\n   /// IPC GPU handle to share with clients.\n   std::shared_ptr<CudaIpcMemHandle> ipc_handle;\n #endif\n-  /// Set of clients currently using this object.\n-  std::unordered_set<Client*> clients;\n+  /// Reference count.\n+  int refcnt;\n \n Review comment:\n   Let's rename this to ref_count, it's good to be not too cryptic ;)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T23:35:56.394+0000",
                    "updated": "2018-05-09T23:35:56.394+0000",
                    "started": "2018-05-09T23:35:56.392+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100328",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100329",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187205514\n \n \n\n ##########\n File path: cpp/src/plasma/store.cc\n ##########\n @@ -124,21 +124,24 @@ const PlasmaStoreInfo* PlasmaStore::get_plasma_store_info() { return &store_info\n \n // If this client is not already using the object, add the client to the\n // object's list of clients, otherwise do nothing.\n-void PlasmaStore::add_client_to_object_clients(ObjectTableEntry* entry, Client* client) {\n+void PlasmaStore::add_to_client_object_ids(ObjectTableEntry* entry, Client* client) {\n   // Check if this client is already using the object.\n-  if (entry->clients.find(client) != entry->clients.end()) {\n+  if (client->object_ids.find(entry->object_id) != client->object_ids.end()) {\n     return;\n   }\n   // If there are no other clients using this object, notify the eviction policy\n   // that the object is being used.\n-  if (entry->clients.size() == 0) {\n+  if (entry->refcnt == 0) {\n     // Tell the eviction policy that this object is being used.\n     std::vector<ObjectID> objects_to_evict;\n     eviction_policy_.begin_object_access(entry->object_id, &objects_to_evict);\n     delete_objects(objects_to_evict);\n   }\n-  // Add the client pointer to the list of clients using this object.\n-  entry->clients.insert(client);\n+  // Increase refcnt.\n \n Review comment:\n   // Increase reference count.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T23:37:12.695+0000",
                    "updated": "2018-05-09T23:37:12.695+0000",
                    "started": "2018-05-09T23:37:12.694+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100329",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100330",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187205713\n \n \n\n ##########\n File path: cpp/src/plasma/store.cc\n ##########\n @@ -383,14 +386,16 @@ void PlasmaStore::process_get_request(Client* client,\n   }\n }\n \n-int PlasmaStore::remove_client_from_object_clients(ObjectTableEntry* entry,\n-                                                   Client* client) {\n-  auto it = entry->clients.find(client);\n-  if (it != entry->clients.end()) {\n-    entry->clients.erase(it);\n+int PlasmaStore::remove_from_client_object_ids(ObjectTableEntry* entry, Client* client) {\n+  auto it = client->object_ids.find(entry->object_id);\n+  if (it != client->object_ids.end()) {\n+    client->object_ids.erase(it);\n+    // Decrease refcnt.\n \n Review comment:\n   // Decrease reference count.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T23:38:47.054+0000",
                    "updated": "2018-05-09T23:38:47.054+0000",
                    "started": "2018-05-09T23:38:47.053+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100330",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100332",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187205926\n \n \n\n ##########\n File path: cpp/src/plasma/store.cc\n ##########\n @@ -533,19 +538,25 @@ void PlasmaStore::disconnect_client(int client_fd) {\n   // lists.\n   // TODO(swang): Avoid iteration through the object table.\n \n Review comment:\n   can remove the TODO(swang) now\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-09T23:40:21.264+0000",
                    "updated": "2018-05-09T23:40:21.264+0000",
                    "started": "2018-05-09T23:40:21.264+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100332",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100372",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187224282\n \n \n\n ##########\n File path: cpp/src/plasma/plasma.h\n ##########\n @@ -134,8 +134,9 @@ struct ObjectTableEntry {\n   /// IPC GPU handle to share with clients.\n   std::shared_ptr<CudaIpcMemHandle> ipc_handle;\n #endif\n-  /// Set of clients currently using this object.\n-  std::unordered_set<Client*> clients;\n+  /// Reference count.\n \n Review comment:\n   Yes this is indeed better:)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-10T02:12:13.543+0000",
                    "updated": "2018-05-10T02:12:13.543+0000",
                    "started": "2018-05-10T02:12:13.543+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100372",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100373",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187224304\n \n \n\n ##########\n File path: cpp/src/plasma/plasma.h\n ##########\n @@ -134,8 +134,9 @@ struct ObjectTableEntry {\n   /// IPC GPU handle to share with clients.\n   std::shared_ptr<CudaIpcMemHandle> ipc_handle;\n #endif\n-  /// Set of clients currently using this object.\n-  std::unordered_set<Client*> clients;\n+  /// Reference count.\n+  int refcnt;\n \n Review comment:\n   sure.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-10T02:12:28.229+0000",
                    "updated": "2018-05-10T02:12:28.229+0000",
                    "started": "2018-05-10T02:12:28.229+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100373",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100374",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on a change in pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#discussion_r187224617\n \n \n\n ##########\n File path: cpp/src/plasma/store.cc\n ##########\n @@ -533,19 +538,25 @@ void PlasmaStore::disconnect_client(int client_fd) {\n   // lists.\n   // TODO(swang): Avoid iteration through the object table.\n \n Review comment:\n   sure:)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-10T02:15:40.800+0000",
                    "updated": "2018-05-10T02:15:40.800+0000",
                    "started": "2018-05-10T02:15:40.799+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100374",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/100392",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "zhijunfu commented on issue #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#issuecomment-387941473\n \n \n   Comments addressed. Thanks \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-10T03:30:32.044+0000",
                    "updated": "2018-05-10T03:30:32.044+0000",
                    "started": "2018-05-10T03:30:32.043+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "100392",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/102323",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz commented on issue #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015#issuecomment-389337505\n \n \n   Performance impact:\r\n   \r\n   Without this PR:\r\n   ```\r\n   [ 78.57%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaLatency.time_plasma_put                                                                                                             498.27ms\r\n   [ 85.71%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaLatency.time_plasma_putget                                                                                                          694.21ms\r\n   [ 92.86%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaThroughput.time_plasma_put_data                                                                                                           ok\r\n   [ 92.86%] \u00b7\u00b7\u00b7\u00b7 \r\n                  ========== ==========\r\n                    param1             \r\n                  ---------- ----------\r\n                     1000     552.60\u03bcs \r\n                    100000    768.20\u03bcs \r\n                   10000000    5.61ms  \r\n                  ========== ==========\r\n   ```\r\n   \r\n   With this PR:\r\n   ```\r\n   [ 78.57%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaLatency.time_plasma_put                                                                                                             500.77ms\r\n   [ 85.71%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaLatency.time_plasma_putget                                                                                                          697.12ms\r\n   [ 92.86%] \u00b7\u00b7\u00b7 Running plasma.SimplePlasmaThroughput.time_plasma_put_data                                                                                                           ok\r\n   [ 92.86%] \u00b7\u00b7\u00b7\u00b7 \r\n                  ========== ==========\r\n                    param1             \r\n                  ---------- ----------\r\n                     1000     557.60\u03bcs \r\n                    100000    741.20\u03bcs \r\n                   10000000    4.89ms  \r\n                  ========== ==========\r\n   ```\r\n   \r\n   So looks like the performance is approximately the same.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-15T22:45:27.977+0000",
                    "updated": "2018-05-15T22:45:27.977+0000",
                    "started": "2018-05-15T22:45:27.976+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "102323",
                    "issueId": "13158114"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/worklog/102329",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pcmoritz closed pull request #2015: ARROW-2558: [Plasma] avoid walk through all the objects when a client disconnects\nURL: https://github.com/apache/arrow/pull/2015\n \n \n   \n\nThis is a PR merged from a forked repository.\nAs GitHub hides the original diff on merge, it is displayed below for\nthe sake of provenance:\n\nAs this is a foreign pull request (from a fork), the diff is supplied\nbelow (as it won't show otherwise due to GitHub magic):\n\ndiff --git a/cpp/src/plasma/plasma.cc b/cpp/src/plasma/plasma.cc\nindex 60b7c3f63c..d98cbb978f 100644\n--- a/cpp/src/plasma/plasma.cc\n+++ b/cpp/src/plasma/plasma.cc\n@@ -30,7 +30,7 @@ extern \"C\" {\n void dlfree(void* mem);\n }\n \n-ObjectTableEntry::ObjectTableEntry() : pointer(nullptr) {}\n+ObjectTableEntry::ObjectTableEntry() : pointer(nullptr), ref_count(0) {}\n \n ObjectTableEntry::~ObjectTableEntry() {\n   dlfree(pointer);\ndiff --git a/cpp/src/plasma/plasma.h b/cpp/src/plasma/plasma.h\nindex 7a513ea3ce..86730365fd 100644\n--- a/cpp/src/plasma/plasma.h\n+++ b/cpp/src/plasma/plasma.h\n@@ -134,8 +134,9 @@ struct ObjectTableEntry {\n   /// IPC GPU handle to share with clients.\n   std::shared_ptr<CudaIpcMemHandle> ipc_handle;\n #endif\n-  /// Set of clients currently using this object.\n-  std::unordered_set<Client*> clients;\n+  /// Number of clients currently using this object.\n+  int ref_count;\n+\n   /// The state of the object, e.g., whether it is open or sealed.\n   object_state state;\n   /// The digest of the object. Used to see if two objects are the same.\ndiff --git a/cpp/src/plasma/store.cc b/cpp/src/plasma/store.cc\nindex 6253afbb88..430b088c01 100644\n--- a/cpp/src/plasma/store.cc\n+++ b/cpp/src/plasma/store.cc\n@@ -124,21 +124,24 @@ const PlasmaStoreInfo* PlasmaStore::get_plasma_store_info() { return &store_info\n \n // If this client is not already using the object, add the client to the\n // object's list of clients, otherwise do nothing.\n-void PlasmaStore::add_client_to_object_clients(ObjectTableEntry* entry, Client* client) {\n+void PlasmaStore::add_to_client_object_ids(ObjectTableEntry* entry, Client* client) {\n   // Check if this client is already using the object.\n-  if (entry->clients.find(client) != entry->clients.end()) {\n+  if (client->object_ids.find(entry->object_id) != client->object_ids.end()) {\n     return;\n   }\n   // If there are no other clients using this object, notify the eviction policy\n   // that the object is being used.\n-  if (entry->clients.size() == 0) {\n+  if (entry->ref_count == 0) {\n     // Tell the eviction policy that this object is being used.\n     std::vector<ObjectID> objects_to_evict;\n     eviction_policy_.begin_object_access(entry->object_id, &objects_to_evict);\n     delete_objects(objects_to_evict);\n   }\n-  // Add the client pointer to the list of clients using this object.\n-  entry->clients.insert(client);\n+  // Increase reference count.\n+  entry->ref_count++;\n+\n+  // Add object id to the list of object ids that this client is using.\n+  client->object_ids.insert(entry->object_id);\n }\n \n // Create a new object buffer in the hash table.\n@@ -225,11 +228,11 @@ int PlasmaStore::create_object(const ObjectID& object_id, int64_t data_size,\n   result->metadata_size = metadata_size;\n   result->device_num = device_num;\n   // Notify the eviction policy that this object was created. This must be done\n-  // immediately before the call to add_client_to_object_clients so that the\n+  // immediately before the call to add_to_client_object_ids so that the\n   // eviction policy does not have an opportunity to evict the object.\n   eviction_policy_.object_created(object_id);\n   // Record that this client is using this object.\n-  add_client_to_object_clients(store_info_.objects[object_id].get(), client);\n+  add_to_client_object_ids(store_info_.objects[object_id].get(), client);\n   return PlasmaError_OK;\n }\n \n@@ -324,7 +327,7 @@ void PlasmaStore::update_object_get_requests(const ObjectID& object_id) {\n     get_req->num_satisfied += 1;\n     // Record the fact that this client will be using this object and will\n     // be responsible for releasing this object.\n-    add_client_to_object_clients(entry, get_req->client);\n+    add_to_client_object_ids(entry, get_req->client);\n \n     // If this get request is done, reply to the client.\n     if (get_req->num_satisfied == get_req->num_objects_to_wait_for) {\n@@ -358,7 +361,7 @@ void PlasmaStore::process_get_request(Client* client,\n       get_req->num_satisfied += 1;\n       // If necessary, record that this client is using this object. In the case\n       // where entry == NULL, this will be called from seal_object.\n-      add_client_to_object_clients(entry, client);\n+      add_to_client_object_ids(entry, client);\n     } else {\n       // Add a placeholder plasma object to the get request to indicate that the\n       // object is not present. This will be parsed by the client. We set the\n@@ -383,14 +386,16 @@ void PlasmaStore::process_get_request(Client* client,\n   }\n }\n \n-int PlasmaStore::remove_client_from_object_clients(ObjectTableEntry* entry,\n-                                                   Client* client) {\n-  auto it = entry->clients.find(client);\n-  if (it != entry->clients.end()) {\n-    entry->clients.erase(it);\n+int PlasmaStore::remove_from_client_object_ids(ObjectTableEntry* entry, Client* client) {\n+  auto it = client->object_ids.find(entry->object_id);\n+  if (it != client->object_ids.end()) {\n+    client->object_ids.erase(it);\n+    // Decrease reference count.\n+    entry->ref_count--;\n+\n     // If no more clients are using this object, notify the eviction policy\n     // that the object is no longer being used.\n-    if (entry->clients.size() == 0) {\n+    if (entry->ref_count == 0) {\n       // Tell the eviction policy that this object is no longer being used.\n       std::vector<ObjectID> objects_to_evict;\n       eviction_policy_.end_object_access(entry->object_id, &objects_to_evict);\n@@ -408,7 +413,7 @@ void PlasmaStore::release_object(const ObjectID& object_id, Client* client) {\n   auto entry = get_object_table_entry(&store_info_, object_id);\n   ARROW_CHECK(entry != NULL);\n   // Remove the client from the object's array of clients.\n-  ARROW_CHECK(remove_client_from_object_clients(entry, client) == 1);\n+  ARROW_CHECK(remove_from_client_object_ids(entry, client) == 1);\n }\n \n // Check if an object is present.\n@@ -439,8 +444,8 @@ int PlasmaStore::abort_object(const ObjectID& object_id, Client* client) {\n   ARROW_CHECK(entry != NULL) << \"To abort an object it must be in the object table.\";\n   ARROW_CHECK(entry->state != PLASMA_SEALED)\n       << \"To abort an object it must not have been sealed.\";\n-  auto it = entry->clients.find(client);\n-  if (it == entry->clients.end()) {\n+  auto it = client->object_ids.find(object_id);\n+  if (it == client->object_ids.end()) {\n     // If the client requesting the abort is not the creator, do not\n     // perform the abort.\n     return 0;\n@@ -466,7 +471,7 @@ int PlasmaStore::delete_object(ObjectID& object_id) {\n     return PlasmaError_ObjectNotSealed;\n   }\n \n-  if (entry->clients.size() != 0) {\n+  if (entry->ref_count != 0) {\n     // To delete an object, there must be no clients currently using it.\n     return PlasmaError_ObjectInUse;\n   }\n@@ -493,7 +498,7 @@ void PlasmaStore::delete_objects(const std::vector<ObjectID>& object_ids) {\n     ARROW_CHECK(entry != NULL) << \"To delete an object it must be in the object table.\";\n     ARROW_CHECK(entry->state == PLASMA_SEALED)\n         << \"To delete an object it must have been sealed.\";\n-    ARROW_CHECK(entry->clients.size() == 0)\n+    ARROW_CHECK(entry->ref_count == 0)\n         << \"To delete an object, there must be no clients currently using it.\";\n     store_info_.objects.erase(object_id);\n     // Inform all subscribers that the object has been deleted.\n@@ -529,23 +534,27 @@ void PlasmaStore::disconnect_client(int client_fd) {\n   // Close the socket.\n   close(client_fd);\n   ARROW_LOG(INFO) << \"Disconnecting client on fd \" << client_fd;\n-  // If this client was using any objects, remove it from the appropriate\n-  // lists.\n-  // TODO(swang): Avoid iteration through the object table.\n+  // Release all the objects that the client was using.\n   auto client = it->second.get();\n-  std::vector<ObjectID> unsealed_objects;\n-  for (const auto& entry : store_info_.objects) {\n-    if (entry.second->state == PLASMA_SEALED) {\n-      remove_client_from_object_clients(entry.second.get(), client);\n+  std::vector<ObjectTableEntry*> sealed_objects;\n+  for (const auto& object_id : client->object_ids) {\n+    auto it = store_info_.objects.find(object_id);\n+    if (it == store_info_.objects.end()) {\n+      continue;\n+    }\n+\n+    if (it->second->state == PLASMA_SEALED) {\n+      // Add sealed objects to a temporary list of object IDs. Do not perform\n+      // the remove here, since it potentially modifies the object_ids table.\n+      sealed_objects.push_back(it->second.get());\n     } else {\n-      // Add unsealed objects to a temporary list of object IDs. Do not perform\n-      // the abort here, since it potentially modifies the object table.\n-      unsealed_objects.push_back(entry.first);\n+      // Abort unsealed object.\n+      abort_object(it->first, client);\n     }\n   }\n-  // If the client was creating any objects, abort them.\n-  for (const auto& entry : unsealed_objects) {\n-    abort_object(entry, client);\n+\n+  for (const auto& entry : sealed_objects) {\n+    remove_from_client_object_ids(entry, client);\n   }\n \n   // Note, the store may still attempt to send a message to the disconnected\ndiff --git a/cpp/src/plasma/store.h b/cpp/src/plasma/store.h\nindex ac6b2c4c50..fd077f9843 100644\n--- a/cpp/src/plasma/store.h\n+++ b/cpp/src/plasma/store.h\n@@ -22,6 +22,7 @@\n #include <memory>\n #include <string>\n #include <unordered_map>\n+#include <unordered_set>\n #include <vector>\n \n #include \"plasma/common.h\"\n@@ -46,6 +47,9 @@ struct Client {\n \n   /// The file descriptor used to communicate with the client.\n   int fd;\n+\n+  /// Object ids that are used by this client.\n+  std::unordered_set<ObjectID, UniqueIDHasher> object_ids;\n };\n \n class PlasmaStore {\n@@ -164,13 +168,13 @@ class PlasmaStore {\n  private:\n   void push_notification(ObjectInfoT* object_notification);\n \n-  void add_client_to_object_clients(ObjectTableEntry* entry, Client* client);\n+  void add_to_client_object_ids(ObjectTableEntry* entry, Client* client);\n \n   void return_from_get(GetRequest* get_req);\n \n   void update_object_get_requests(const ObjectID& object_id);\n \n-  int remove_client_from_object_clients(ObjectTableEntry* entry, Client* client);\n+  int remove_from_client_object_ids(ObjectTableEntry* entry, Client* client);\n \n   /// Event loop of the plasma store.\n   EventLoop* loop_;\n\n\n \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2018-05-15T22:54:42.658+0000",
                    "updated": "2018-05-15T22:54:42.658+0000",
                    "started": "2018-05-15T22:54:42.657+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "102329",
                    "issueId": "13158114"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/4",
            "id": "4",
            "description": "An improvement or enhancement to an existing feature or task.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype",
            "name": "Improvement",
            "subtask": false,
            "avatarId": 21140
        },
        "timespent": 7200,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@243b5f76[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@24fbbd2d[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1a40e3d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@78cfc9f1[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3687ac21[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@18c15420[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@393574e3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@3fb3a275[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@34def706[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@262cc5e9[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@34ac2fa3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@162e9349[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 7200,
        "customfield_12312520": null,
        "customfield_12312521": "Tue May 15 22:54:43 UTC 2018",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2018-05-15T22:54:43.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-2558/watchers",
            "watchCount": 1,
            "isWatching": false
        },
        "created": "2018-05-09T07:17:43.000+0000",
        "updated": "2018-07-27T15:49:58.000+0000",
        "timeoriginalestimate": null,
        "description": "Currently plasma stores list-of-clients in ObjectTableEntry, which is used to track which clients are using a given object, this serves for two purposes:\r\n- If an object is in use.\r\n- If the client trying to abort an object is the one who created it.\r\n\r\nA problem with list-of-clients approach is that when a client disconnects, we need to walk through all the objects and remove the client pointer from the list for each object.\r\n\r\nInstead, we could add a reference count in ObjectTableEntry, and store list-of-object-ids in client structure. This could both goals that the original approach is targeting, while when a client disconnects, it just walk through its object-ids and dereference each ObjectTableEntry, there's no need to walk through all objects.",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "2h",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 7200
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Plasma] avoid walk through all the objects when a client disconnects",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13158114/comment/16476582",
                    "id": "16476582",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=pcmoritz",
                        "name": "pcmoritz",
                        "key": "pcmoritz",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Philipp Moritz",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "Issue resolved by pull request 2015\n[https://github.com/apache/arrow/pull/2015]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=pcmoritz",
                        "name": "pcmoritz",
                        "key": "pcmoritz",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Philipp Moritz",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2018-05-15T22:54:43.788+0000",
                    "updated": "2018-05-15T22:54:43.788+0000"
                }
            ],
            "maxResults": 1,
            "total": 1,
            "startAt": 0
        },
        "customfield_12311820": "0|i3ti9z:",
        "customfield_12314139": null
    }
}