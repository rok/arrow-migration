{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13369726",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726",
    "key": "ARROW-12220",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12349493",
                "id": "12349493",
                "description": "",
                "name": "4.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-04-26"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [
            {
                "id": "12613642",
                "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12613642",
                "type": {
                    "id": "10030",
                    "name": "Reference",
                    "inward": "is related to",
                    "outward": "relates to",
                    "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
                },
                "inwardIssue": {
                    "id": "13372344",
                    "key": "ARROW-12379",
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13372344",
                    "fields": {
                        "summary": "[C++][CI] Thread sanitizer failure in SerialExecutor",
                        "status": {
                            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
                            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
                            "name": "Resolved",
                            "id": "5",
                            "statusCategory": {
                                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                                "id": 3,
                                "key": "done",
                                "colorName": "green",
                                "name": "Done"
                            }
                        },
                        "priority": {
                            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                            "name": "Major",
                            "id": "3"
                        },
                        "issuetype": {
                            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                            "id": "1",
                            "description": "A problem which impairs or prevents the functions of the product.",
                            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                            "name": "Bug",
                            "subtask": false,
                            "avatarId": 21133
                        }
                    }
                }
            }
        ],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=westonpace",
            "name": "westonpace",
            "key": "westonpace",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"
            },
            "displayName": "Weston Pace",
            "active": true,
            "timeZone": "America/Los_Angeles"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328935",
                "id": "12328935",
                "name": "C++"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
            "name": "apitrou",
            "key": "pitrou",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
            },
            "displayName": "Antoine Pitrou",
            "active": true,
            "timeZone": "Europe/Paris"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
            "name": "apitrou",
            "key": "pitrou",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
            },
            "displayName": "Antoine Pitrou",
            "active": true,
            "timeZone": "Europe/Paris"
        },
        "aggregateprogress": {
            "progress": 21600,
            "total": 21600,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 21600,
            "total": 21600,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-12220/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 36,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578661",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace opened a new pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941\n\n\n   The background generator kept reading from the source even after the downstream had given up on it.  Other than the obvious memory / resource usage problems this also meant that callback handlers could reference deleted state downstream.  Now we block the destructor until the background thread is finished and we stop the background thread early if all consumer references are lost.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T20:39:14.510+0000",
                    "updated": "2021-04-07T20:39:14.510+0000",
                    "started": "2021-04-07T20:39:14.510+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578661",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578663",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-815249350\n\n\n   I was able to reproduce the original error pretty reliably.  The tricky part was that it would only be triggered when the CPU executor was cleaned up and so I had to do the repeat outside of gtest (i.e. no --gtest_repeat) so that the process kept closing/opening.  This combined with CPU stress triggered the issue pretty reliably.  I used this to verify the fix.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T20:43:29.272+0000",
                    "updated": "2021-04-07T20:43:29.272+0000",
                    "started": "2021-04-07T20:43:29.271+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578663",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578687",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609073856\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,25 +1199,48 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n+    bool started;\n     bool running;\n     bool finished;\n+    bool should_shutdown;\n     int max_q;\n     int q_restart;\n     std::queue<Result<T>> queue;\n     util::optional<Future<T>> waiting_future;\n     util::Mutex mutex;\n+    Future<> task_finished;\n+  };\n+\n+  struct Cleanup {\n+    explicit Cleanup(State* state) : state(state) {}\n+    ~Cleanup() {\n+      Future<> finish_fut;\n+      {\n+        auto lock = state->mutex.Lock();\n+        if (!state->started) {\n\nReview comment:\n       I think we need only `state->running` since that also covers the case that the background task is not currently running, but has run in the past (which this check misses).\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T21:21:57.985+0000",
                    "updated": "2021-04-07T21:21:57.985+0000",
                    "started": "2021-04-07T21:21:57.984+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578687",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578688",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-815274048\n\n\n   On a side note, when you mentioned rxcpp, it seems the lead maintainer moved on to [libunifex](https://github.com/facebookexperimental/libunifex) which is an implementation of a [C++23 proposal](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p0443r13.html) (Unified Executors), wonder if there's any ideas to borrow from there.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T21:23:25.416+0000",
                    "updated": "2021-04-07T21:23:25.416+0000",
                    "started": "2021-04-07T21:23:25.416+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578688",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578725",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-815296766\n\n\n   https://issues.apache.org/jira/browse/ARROW-12220\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:13:06.985+0000",
                    "updated": "2021-04-07T22:13:06.985+0000",
                    "started": "2021-04-07T22:13:06.984+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578725",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578727",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609106645\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,25 +1199,48 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n+    bool started;\n     bool running;\n     bool finished;\n+    bool should_shutdown;\n     int max_q;\n     int q_restart;\n     std::queue<Result<T>> queue;\n     util::optional<Future<T>> waiting_future;\n     util::Mutex mutex;\n+    Future<> task_finished;\n+  };\n+\n+  struct Cleanup {\n+    explicit Cleanup(State* state) : state(state) {}\n+    ~Cleanup() {\n+      Future<> finish_fut;\n+      {\n+        auto lock = state->mutex.Lock();\n+        if (!state->started) {\n\nReview comment:\n       I don't think running works.  Consider the cleanup happens while the background thread is about to call `waiting_future.MarkFinished(next);` and the queue has just filled up so `running` is false.  If we don't wait and just return then it is possible the callback accesses deleted state.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:18:54.448+0000",
                    "updated": "2021-04-07T22:18:54.448+0000",
                    "started": "2021-04-07T22:18:54.448+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578727",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578728",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-815299660\n\n\n   First, I was not familiar with `libunifex`, just scanning through it looks pretty cool.  Their AsyncStream looks to be pretty compatible with AsyncGenerator so maybe we can borrow some ideas.  I'll have to read through in more detail later.\r\n   \r\n   Second, yes, I had the same thought about the stop token.  I'll add a note to ARROW-11875.\r\n   \r\n   Third, I hadn't thought of the serial executor as a nursery but you may be on to something.  For example, off the top of my head you could do something like...\r\n   \r\n   ```\r\n   Future<T> AsyncBind(std::function<Future<T>(S*)>, std::shared_ptr<S>)\r\n   ```\r\n   \r\n   I'll make a JIRA for it.\r\n   \r\n   ...it's not exactly a nursery but similar.  There is also the `oox_var` concept mentioned in ARROW-7001 's JIRA comments which is more of a classic nursery (but a bit more complicated).\r\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:19:09.339+0000",
                    "updated": "2021-04-07T22:19:09.339+0000",
                    "started": "2021-04-07T22:19:09.339+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578728",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578736",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609110316\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,25 +1199,48 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n+    bool started;\n     bool running;\n     bool finished;\n+    bool should_shutdown;\n     int max_q;\n     int q_restart;\n     std::queue<Result<T>> queue;\n     util::optional<Future<T>> waiting_future;\n     util::Mutex mutex;\n+    Future<> task_finished;\n+  };\n+\n+  struct Cleanup {\n+    explicit Cleanup(State* state) : state(state) {}\n+    ~Cleanup() {\n+      Future<> finish_fut;\n+      {\n+        auto lock = state->mutex.Lock();\n+        if (!state->started) {\n\nReview comment:\n       Hmm, you're right, I got myself mixed up before. I guess the concern is actually - what if (a) the background task is currently running and (b) it's not the first time it's run - it looks like task_finished will have been completed the first time we ran the background task, so this won't actually wait for the background task to end. Maybe task_finished needs to be reinitialized when the task starts?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:27:53.883+0000",
                    "updated": "2021-04-07T22:27:53.883+0000",
                    "started": "2021-04-07T22:27:53.883+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578736",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578742",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-815305838\n\n\n   It seems there is some corner case that leads to deadlock.  More work is needed.  Also, I created ARROW-12285 for discussion on async state management.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:35:23.586+0000",
                    "updated": "2021-04-07T22:35:23.586+0000",
                    "started": "2021-04-07T22:35:23.586+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578742",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578743",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609113945\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,25 +1199,48 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n+    bool started;\n     bool running;\n     bool finished;\n+    bool should_shutdown;\n     int max_q;\n     int q_restart;\n     std::queue<Result<T>> queue;\n     util::optional<Future<T>> waiting_future;\n     util::Mutex mutex;\n+    Future<> task_finished;\n+  };\n+\n+  struct Cleanup {\n+    explicit Cleanup(State* state) : state(state) {}\n+    ~Cleanup() {\n+      Future<> finish_fut;\n+      {\n+        auto lock = state->mutex.Lock();\n+        if (!state->started) {\n\nReview comment:\n       `task_finished` should only be marked complete on the last execution of `Task` (e.g. `Task` should never be relaunched once `state->finished` is true).\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:36:57.398+0000",
                    "updated": "2021-04-07T22:36:57.398+0000",
                    "started": "2021-04-07T22:36:57.398+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578743",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578747",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609117403\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,25 +1199,48 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n+    bool started;\n     bool running;\n     bool finished;\n+    bool should_shutdown;\n     int max_q;\n     int q_restart;\n     std::queue<Result<T>> queue;\n     util::optional<Future<T>> waiting_future;\n     util::Mutex mutex;\n+    Future<> task_finished;\n+  };\n+\n+  struct Cleanup {\n+    explicit Cleanup(State* state) : state(state) {}\n+    ~Cleanup() {\n+      Future<> finish_fut;\n+      {\n+        auto lock = state->mutex.Lock();\n+        if (!state->started) {\n\nReview comment:\n       I think you're right though that it's not properly taking into account what happens if cleanup runs and task isn't running.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-07T22:45:30.502+0000",
                    "updated": "2021-04-07T22:45:30.502+0000",
                    "started": "2021-04-07T22:45:30.502+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578747",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/578972",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609432471\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,36 +1199,71 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n-    bool running;\n+    // True if we are still running in the loop and will be adding more items to the\n+    // queue, don't restart the task if this is true.  However, even if this is false we\n+    // might still be running some finish callbacks or marking the finish future.\n+    bool running_in_loop;\n+    // If this is false then the background thread is done with everything.  It will not\n+    // be running any additional callbacks or marking the finish future.  There is no need\n+    // to wait for it when cleaning up.\n+    bool running_at_all;\n     bool finished;\n\nReview comment:\n       This is where complexity starts being difficult to reason about. What's the difference between `running_at_all` and `finished`? What are the possible combinations?\r\n   You may want to define a enum to describe the current state rather than having three different booleans...\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1247,10 +1286,23 @@ class BackgroundGenerator {\n           waiting_future.MarkFinished(next);\n         }\n       }\n+      {\n+        auto guard = state->mutex.Lock();\n+        state->running_at_all = false;\n+        if (state->finished) {\n+          state->task_finished.MarkFinished();\n+        }\n+      }\n     }\n   };\n \n   std::shared_ptr<State> state_;\n+  // state_ is held by both the generator and the background thread so it won't be cleaned\n+  // up when all consumer references are relinquished.  cleanup_ is only held by the\n+  // generator so it will be destructed when the last consumer reference is gone.  We use\n+  // this to cleanup / stop the background generator in case the consuming end stops\n+  // listening (e.g. due to a downstream error)\n+  std::shared_ptr<Cleanup> cleanup_;\n\nReview comment:\n       Would it be possible to simply use a `std::weak_ptr<State>` in the background thread?\r\n   (if there is some cleanup to do, you may do it in the State destructor?)\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T08:13:16.176+0000",
                    "updated": "2021-04-08T08:13:16.176+0000",
                    "started": "2021-04-08T08:13:16.175+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "578972",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579000",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609468742\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1247,10 +1286,23 @@ class BackgroundGenerator {\n           waiting_future.MarkFinished(next);\n         }\n       }\n+      {\n+        auto guard = state->mutex.Lock();\n+        state->running_at_all = false;\n+        if (state->finished) {\n+          state->task_finished.MarkFinished();\n+        }\n+      }\n     }\n   };\n \n   std::shared_ptr<State> state_;\n+  // state_ is held by both the generator and the background thread so it won't be cleaned\n+  // up when all consumer references are relinquished.  cleanup_ is only held by the\n+  // generator so it will be destructed when the last consumer reference is gone.  We use\n+  // this to cleanup / stop the background generator in case the consuming end stops\n+  // listening (e.g. due to a downstream error)\n+  std::shared_ptr<Cleanup> cleanup_;\n\nReview comment:\n       Yes, I was torn on this myself.  If `weak_ptr` seems like a cleaner approach I can do that.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T08:52:07.325+0000",
                    "updated": "2021-04-08T08:52:07.325+0000",
                    "started": "2021-04-08T08:52:07.325+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579000",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579003",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609471342\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1195,36 +1199,71 @@ class BackgroundGenerator {\n             ClearQueue();\n             queue.push(spawn_status);\n           }\n+          task_finished.MarkFinished();\n         }\n       }\n     }\n \n     internal::Executor* io_executor;\n     Iterator<T> it;\n-    bool running;\n+    // True if we are still running in the loop and will be adding more items to the\n+    // queue, don't restart the task if this is true.  However, even if this is false we\n+    // might still be running some finish callbacks or marking the finish future.\n+    bool running_in_loop;\n+    // If this is false then the background thread is done with everything.  It will not\n+    // be running any additional callbacks or marking the finish future.  There is no need\n+    // to wait for it when cleaning up.\n+    bool running_at_all;\n     bool finished;\n\nReview comment:\n       `finished` means that the background thread is done.  Any future reads that would require starting the background generator back up should return an end token.\r\n   \r\n   `running_at_all` means that not only is it finished but the background thread is done delivering the last item (we mark finished and \"reserve a spot\" in the mutex but can't deliver the item in the mutex) and is not going to be checking to see if it needs to mark the final future complete.\r\n   \r\n   I will consider an enum and see if the 8 possible states collapse down to some reasonable subset.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T08:55:11.126+0000",
                    "updated": "2021-04-08T08:55:11.126+0000",
                    "started": "2021-04-08T08:55:11.126+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579003",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579175",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609663885\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1247,10 +1286,23 @@ class BackgroundGenerator {\n           waiting_future.MarkFinished(next);\n         }\n       }\n+      {\n+        auto guard = state->mutex.Lock();\n+        state->running_at_all = false;\n+        if (state->finished) {\n+          state->task_finished.MarkFinished();\n+        }\n+      }\n     }\n   };\n \n   std::shared_ptr<State> state_;\n+  // state_ is held by both the generator and the background thread so it won't be cleaned\n+  // up when all consumer references are relinquished.  cleanup_ is only held by the\n+  // generator so it will be destructed when the last consumer reference is gone.  We use\n+  // this to cleanup / stop the background generator in case the consuming end stops\n+  // listening (e.g. due to a downstream error)\n+  std::shared_ptr<Cleanup> cleanup_;\n\nReview comment:\n       Would be nice to give it a try and see what that gives.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T12:51:17.654+0000",
                    "updated": "2021-04-08T12:51:17.654+0000",
                    "started": "2021-04-08T12:51:17.654+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579175",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579401",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609956429\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1247,10 +1286,23 @@ class BackgroundGenerator {\n           waiting_future.MarkFinished(next);\n         }\n       }\n+      {\n+        auto guard = state->mutex.Lock();\n+        state->running_at_all = false;\n+        if (state->finished) {\n+          state->task_finished.MarkFinished();\n+        }\n+      }\n     }\n   };\n \n   std::shared_ptr<State> state_;\n+  // state_ is held by both the generator and the background thread so it won't be cleaned\n+  // up when all consumer references are relinquished.  cleanup_ is only held by the\n+  // generator so it will be destructed when the last consumer reference is gone.  We use\n+  // this to cleanup / stop the background generator in case the consuming end stops\n+  // listening (e.g. due to a downstream error)\n+  std::shared_ptr<Cleanup> cleanup_;\n\nReview comment:\n       I started down this route and ran into a bit of difficulty.  The challenge is that I'd want to release the weak pointer while I do slow operations (otherwise I'm back at the original problem where the background thread keeps the state alive forever).  So right now the code look something like...\r\n   \r\n   ```\r\n   std::shared_ptr<State> current_state = state_.lock();\r\n   auto next = current_state->it.Next();\r\n   ```\r\n   \r\n   I could do something like...\r\n   \r\n   ```\r\n   std::shared_ptr<State> current_state = state_.lock();\r\n   auto& it = current_state->it;\r\n   current_state.reset();\r\n   auto next = it.Next();\r\n   ```\r\n   \r\n   ...and it would actually be valid.  The state destructor would be waiting on task_finished before it returns so even though state might be in the middle of destruction it would not complete destruction until later.\r\n   \r\n   In other words, when I realize I need to abandon I can't immediately delete state.  I have to signal the background worker to terminate immediately, wait for it to terminate, and then delete state.\r\n   \r\n   So it works but I feel like the resulting code would be even harder to reason about because it would contain things that look invalid (accessing references obtained off a pointer after I give up the lifecycle tracking for that pointer) even though they just so happen to be valid.  That would complicate things for future readers I feel.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T17:54:23.120+0000",
                    "updated": "2021-04-08T17:54:23.120+0000",
                    "started": "2021-04-08T17:54:23.120+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579401",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579414",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "pitrou commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r609960677\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1247,10 +1286,23 @@ class BackgroundGenerator {\n           waiting_future.MarkFinished(next);\n         }\n       }\n+      {\n+        auto guard = state->mutex.Lock();\n+        state->running_at_all = false;\n+        if (state->finished) {\n+          state->task_finished.MarkFinished();\n+        }\n+      }\n     }\n   };\n \n   std::shared_ptr<State> state_;\n+  // state_ is held by both the generator and the background thread so it won't be cleaned\n+  // up when all consumer references are relinquished.  cleanup_ is only held by the\n+  // generator so it will be destructed when the last consumer reference is gone.  We use\n+  // this to cleanup / stop the background generator in case the consuming end stops\n+  // listening (e.g. due to a downstream error)\n+  std::shared_ptr<Cleanup> cleanup_;\n\nReview comment:\n       I see, let's keep the cleanup object then. Thanks for the investigation!\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-08T17:59:04.950+0000",
                    "updated": "2021-04-08T17:59:04.950+0000",
                    "started": "2021-04-08T17:59:04.950+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579414",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/579717",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#issuecomment-816376215\n\n\n   Ok.  I got lost trying to simplify things with an enum and, in the process, found a bug where a really fast consumer could try and restart the queue multiple times.\r\n   \r\n   @pitrou @lidavidm \r\n   \r\n   So, I have reworked it and I think it is a bit easier to reason with now (a bit).\r\n   \r\n   Every background task gets a future that it marks complete when it finishes.\r\n   \r\n   The background task cannot be restarted (and the cleanup cannot finish) until that future has been marked complete.\r\n   \r\n   There is still a \"running\" flag so that we know when we add an item to the queue if we have to restart the background task (because it is no longer running and merely cleaning up) or not (because it is still running and will pick it up on the next loop).\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-09T03:31:54.615+0000",
                    "updated": "2021-04-09T03:31:54.615+0000",
                    "started": "2021-04-09T03:31:54.615+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "579717",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/580016",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r610631804\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1149,108 +1148,197 @@ class BackgroundGenerator {\n     } else {\n       auto next = Future<T>::MakeFinished(std::move(state_->queue.front()));\n       state_->queue.pop();\n-      if (!state_->running &&\n-          static_cast<int>(state_->queue.size()) <= state_->q_restart) {\n-        state_->RestartTask(state_, std::move(guard));\n+      if (state_->NeedsRestart()) {\n+        return state_->RestartTask(state_, std::move(guard), std::move(next));\n       }\n       return next;\n     }\n-    if (!state_->running) {\n-      // This branch should only be needed to start the background thread on the first\n-      // call\n-      state_->RestartTask(state_, std::move(guard));\n+    // This should only trigger the very first time this method is called\n+    if (state_->NeedsRestart()) {\n+      return state_->RestartTask(state_, std::move(guard), std::move(waiting_future));\n     }\n     return waiting_future;\n   }\n \n  protected:\n+  enum class BackgroundThreadState : char { Reading = 0, Quitting = 1, Idle = 2 };\n\nReview comment:\n       This enum seems to be unused in favor of the booleans still?\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-09T13:52:13.494+0000",
                    "updated": "2021-04-09T13:52:13.494+0000",
                    "started": "2021-04-09T13:52:13.493+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "580016",
                    "issueId": "13369726"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/worklog/580148",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "westonpace commented on a change in pull request #9941:\nURL: https://github.com/apache/arrow/pull/9941#discussion_r610782311\n\n\n\n##########\nFile path: cpp/src/arrow/util/async_generator.h\n##########\n@@ -1149,108 +1148,197 @@ class BackgroundGenerator {\n     } else {\n       auto next = Future<T>::MakeFinished(std::move(state_->queue.front()));\n       state_->queue.pop();\n-      if (!state_->running &&\n-          static_cast<int>(state_->queue.size()) <= state_->q_restart) {\n-        state_->RestartTask(state_, std::move(guard));\n+      if (state_->NeedsRestart()) {\n+        return state_->RestartTask(state_, std::move(guard), std::move(next));\n       }\n       return next;\n     }\n-    if (!state_->running) {\n-      // This branch should only be needed to start the background thread on the first\n-      // call\n-      state_->RestartTask(state_, std::move(guard));\n+    // This should only trigger the very first time this method is called\n+    if (state_->NeedsRestart()) {\n+      return state_->RestartTask(state_, std::move(guard), std::move(waiting_future));\n     }\n     return waiting_future;\n   }\n \n  protected:\n+  enum class BackgroundThreadState : char { Reading = 0, Quitting = 1, Idle = 2 };\n\nReview comment:\n       Ah, whoops.  Missed removing that when I was abandoning the enum approach.  I've removed it.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-09T17:05:41.447+0000",
                    "updated": "2021-04-09T17:05:41.447+0000",
                    "started": "2021-04-09T17:05:41.447+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "580148",
                    "issueId": "13369726"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 21600,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@67233585[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@67d1e614[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7bb0079[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@6fb2a7dc[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@32fb8cd6[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@1ff2631c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@40950053[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@3a63c3da[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5410657c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@58f61661[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@308902b4[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@14d06a6c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 21600,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Apr 14 14:01:58 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2021-04-14T14:00:48.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-12220/watchers",
            "watchCount": 2,
            "isWatching": false
        },
        "created": "2021-04-06T08:46:23.000+0000",
        "updated": "2021-04-14T14:17:56.000+0000",
        "timeoriginalestimate": null,
        "description": "It appears this is due to some tasks being spawned or transferred (by the background generator) while the thread pool is destroying at shutdown.\r\n\r\nSee https://github.com/ursacomputing/crossbow/runs/2276268779#step:6:3414\r\n",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "6h",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 21600
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[C++][CI] Thread sanitizer failure",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/comment/17315351",
                    "id": "17315351",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "cc [~westonpace]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2021-04-06T08:46:37.040+0000",
                    "updated": "2021-04-06T08:46:37.040+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/comment/17315677",
                    "id": "17315677",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "body": "Unfortunately I'm not able to reproduce locally. It probably depends heavily on timing conditions.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=apitrou",
                        "name": "apitrou",
                        "key": "pitrou",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=pitrou&avatarId=35049",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pitrou&avatarId=35049",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pitrou&avatarId=35049",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pitrou&avatarId=35049"
                        },
                        "displayName": "Antoine Pitrou",
                        "active": true,
                        "timeZone": "Europe/Paris"
                    },
                    "created": "2021-04-06T15:50:34.954+0000",
                    "updated": "2021-04-06T15:50:34.954+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/comment/17321022",
                    "id": "17321022",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 9941\n[https://github.com/apache/arrow/pull/9941]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-04-14T14:00:48.199+0000",
                    "updated": "2021-04-14T14:00:48.199+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13369726/comment/17321023",
                    "id": "17321023",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Note that another TSan failure was found possibly resulting from ARROW-12208:\u00a0https://github.com/ursacomputing/crossbow/runs/2340248774",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-04-14T14:01:58.303+0000",
                    "updated": "2021-04-14T14:01:58.303+0000"
                }
            ],
            "maxResults": 4,
            "total": 4,
            "startAt": 0
        },
        "customfield_12311820": "0|z0pk3c:",
        "customfield_12314139": null
    }
}