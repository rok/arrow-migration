{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13368954",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954",
    "key": "ARROW-12170",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12349493",
                "id": "12349493",
                "description": "",
                "name": "4.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-04-26"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Dandandan",
            "name": "Dandandan",
            "key": "dandandan",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Dani\u00ebl Heres",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12335005",
                "id": "12335005",
                "name": "Rust - DataFusion"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Dandandan",
            "name": "Dandandan",
            "key": "dandandan",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Dani\u00ebl Heres",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Dandandan",
            "name": "Dandandan",
            "key": "dandandan",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Dani\u00ebl Heres",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "aggregateprogress": {
            "progress": 22200,
            "total": 22200,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 22200,
            "total": 22200,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-12170/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 37,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575094",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan opened a new pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865\n\n\n   This introduces a optimization pass to introduce repartition whenever the number of partitions of the plan drops below the configured amount of concurrency to optimize the amount of achievable concurrency.\r\n   \r\n   TODO:\r\n   \r\n   * fix tests related to countexec\r\n   * add more tests\r\n   * add some benchmark results\r\n   * tweak optimization rule (e.g. limiting)\r\n   * organization\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-03-31T19:58:44.119+0000",
                    "updated": "2021-03-31T19:58:44.119+0000",
                    "started": "2021-03-31T19:58:44.118+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575094",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575228",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "andygrove commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-811527532\n\n\n   I like where this is heading @Dandandan :rocket: \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-03-31T23:21:26.543+0000",
                    "updated": "2021-03-31T23:21:26.543+0000",
                    "started": "2021-03-31T23:21:26.542+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575228",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575268",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-811569688\n\n\n   https://issues.apache.org/jira/browse/ARROW-12170\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-01T01:20:34.357+0000",
                    "updated": "2021-04-01T01:20:34.357+0000",
                    "started": "2021-04-01T01:20:34.356+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575268",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575750",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "alamb commented on a change in pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#discussion_r605945522\n\n\n\n##########\nFile path: rust/datafusion/src/physical_optimizer/coalesce_batches.rs\n##########\n@@ -0,0 +1,88 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! CoalesceBatches optimizer that groups batches together rows\n+//! in bigger batches to avoid overhead with small batches\n+\n+use super::optimizer::PhysicalOptimizerRule;\n+use crate::{\n+    error::Result,\n+    physical_plan::{\n+        coalesce_batches::CoalesceBatchesExec, filter::FilterExec,\n+        hash_join::HashJoinExec, repartition::RepartitionExec,\n+    },\n+};\n+use std::sync::Arc;\n+\n+/// Optimizer that introduces CoalesceBatchesExec to avoid overhead with small batches\n+pub struct CoalesceBatches {}\n+\n+impl CoalesceBatches {\n+    #[allow(missing_docs)]\n+    pub fn new() -> Self {\n+        Self {}\n+    }\n+}\n+impl PhysicalOptimizerRule for CoalesceBatches {\n+    fn optimize(\n+        &self,\n+        plan: Arc<dyn crate::physical_plan::ExecutionPlan>,\n+        config: &crate::execution::context::ExecutionConfig,\n+    ) -> Result<Arc<dyn crate::physical_plan::ExecutionPlan>> {\n+        // wrap operators in CoalesceBatches to avoid lots of tiny batches when we have\n+        // highly selective filters\n+        let children = plan\n+            .children()\n+            .iter()\n+            .map(|child| self.optimize(child.clone(), config))\n+            .collect::<Result<Vec<_>>>()?;\n\nReview comment:\n       I realize you are just moving code around so this comment is outside the context of this PR....\r\n   \r\n   However, I wonder if it would be more performant to do the coalescing directly in the filter kernel code -- the way coalsce is written today requires copying the the (filtered) output into a different (coalesced) array\r\n   \r\n   I think @ritchie46  had some code that allowed incrementally building up output in several chunks as part of polars which may be relevant\r\n   \r\n   I think this code is good, but I wanted to plant a seed \ud83c\udf31 for future optimizations\n\n##########\nFile path: rust/datafusion/src/physical_optimizer/merge_exec.rs\n##########\n@@ -0,0 +1,74 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! CoalesceBatches optimizer that groups batches together rows\n\nReview comment:\n       this comment seems like it may need updating\n\n##########\nFile path: rust/datafusion/src/physical_optimizer/repartition.rs\n##########\n@@ -0,0 +1,135 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! Repartition optimizer that introduces repartition nodes to increase the level of parallism available\n+use std::sync::Arc;\n+\n+use super::optimizer::PhysicalOptimizerRule;\n+use crate::physical_plan::{repartition::RepartitionExec, ExecutionPlan};\n+use crate::physical_plan::{Distribution, Partitioning::*};\n+use crate::{error::Result, execution::context::ExecutionConfig};\n+\n+/// Optimizer that introduces repartition to introduce more parallelism in the plan\n+pub struct Repartition {}\n+\n+impl Repartition {\n+    #[allow(missing_docs)]\n+    pub fn new() -> Self {\n+        Self {}\n+    }\n+}\n+\n+fn optimize_concurrency(\n+    concurrency: usize,\n+    requires_single_partition: bool,\n+    plan: Arc<dyn ExecutionPlan>,\n+) -> Result<Arc<dyn ExecutionPlan>> {\n+    // Recurse into children bottom-up (added nodes should be as deep as possible)\n+\n+    let new_plan = if plan.children().is_empty() {\n+        // leaf node - don't replace children\n\nReview comment:\n       it seems like `new_with_children` could handle the case of zero children as well, FWIW\n\n##########\nFile path: rust/datafusion/src/physical_plan/planner.rs\n##########\n@@ -103,66 +102,21 @@ impl DefaultPhysicalPlanner {\n         Self { extension_planners }\n     }\n \n-    /// Create a physical plan from a logical plan\n+    /// Optimize a physical plan\n     fn optimize_plan(\n         &self,\n         plan: Arc<dyn ExecutionPlan>,\n         ctx_state: &ExecutionContextState,\n     ) -> Result<Arc<dyn ExecutionPlan>> {\n-        let children = plan\n-            .children()\n-            .iter()\n-            .map(|child| self.optimize_plan(child.clone(), ctx_state))\n-            .collect::<Result<Vec<_>>>()?;\n-\n-        if children.is_empty() {\n-            // leaf node, children cannot be replaced\n-            Ok(plan.clone())\n-        } else {\n-            // wrap operators in CoalesceBatches to avoid lots of tiny batches when we have\n-            // highly selective filters\n-            let plan_any = plan.as_any();\n-            //TODO we should do this in a more generic way either by wrapping all operators\n-            // or having an API so that operators can declare when their inputs or outputs\n-            // need to be wrapped in a coalesce batches operator.\n-            // See https://issues.apache.org/jira/browse/ARROW-11068\n-            let wrap_in_coalesce = plan_any.downcast_ref::<FilterExec>().is_some()\n-                || plan_any.downcast_ref::<HashJoinExec>().is_some()\n-                || plan_any.downcast_ref::<RepartitionExec>().is_some();\n-\n-            //TODO we should also do this for HashAggregateExec but we need to update tests\n-            // as part of this work - see https://issues.apache.org/jira/browse/ARROW-11068\n-            // || plan_any.downcast_ref::<HashAggregateExec>().is_some();\n-\n-            let plan = if wrap_in_coalesce {\n-                //TODO we should add specific configuration settings for coalescing batches and\n-                // we should do that once https://issues.apache.org/jira/browse/ARROW-11059 is\n-                // implemented. For now, we choose half the configured batch size to avoid copies\n-                // when a small number of rows are removed from a batch\n-                let target_batch_size = ctx_state.config.batch_size / 2;\n-                Arc::new(CoalesceBatchesExec::new(plan.clone(), target_batch_size))\n-            } else {\n-                plan.clone()\n-            };\n-\n-            let children = plan.children().clone();\n-\n-            match plan.required_child_distribution() {\n-                Distribution::UnspecifiedDistribution => plan.with_new_children(children),\n-                Distribution::SinglePartition => plan.with_new_children(\n-                    children\n-                        .iter()\n-                        .map(|child| {\n-                            if child.output_partitioning().partition_count() == 1 {\n-                                child.clone()\n-                            } else {\n-                                Arc::new(MergeExec::new(child.clone()))\n-                            }\n-                        })\n-                        .collect(),\n-                ),\n-            }\n+        let optimizers = &ctx_state.config.physical_optimizers;\n\nReview comment:\n       \ud83d\udc4d \n\n##########\nFile path: rust/datafusion/src/physical_optimizer/coalesce_batches.rs\n##########\n@@ -0,0 +1,88 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! CoalesceBatches optimizer that groups batches together rows\n+//! in bigger batches to avoid overhead with small batches\n+\n+use super::optimizer::PhysicalOptimizerRule;\n+use crate::{\n+    error::Result,\n+    physical_plan::{\n+        coalesce_batches::CoalesceBatchesExec, filter::FilterExec,\n+        hash_join::HashJoinExec, repartition::RepartitionExec,\n+    },\n+};\n+use std::sync::Arc;\n+\n+/// Optimizer that introduces CoalesceBatchesExec to avoid overhead with small batches\n+pub struct CoalesceBatches {}\n+\n+impl CoalesceBatches {\n+    #[allow(missing_docs)]\n+    pub fn new() -> Self {\n+        Self {}\n+    }\n+}\n+impl PhysicalOptimizerRule for CoalesceBatches {\n+    fn optimize(\n+        &self,\n+        plan: Arc<dyn crate::physical_plan::ExecutionPlan>,\n+        config: &crate::execution::context::ExecutionConfig,\n+    ) -> Result<Arc<dyn crate::physical_plan::ExecutionPlan>> {\n+        // wrap operators in CoalesceBatches to avoid lots of tiny batches when we have\n+        // highly selective filters\n+        let children = plan\n+            .children()\n+            .iter()\n+            .map(|child| self.optimize(child.clone(), config))\n+            .collect::<Result<Vec<_>>>()?;\n+\n+        let plan_any = plan.as_any();\n+        //TODO we should do this in a more generic way either by wrapping all operators\n\nReview comment:\n       what about if we did coalescing at runtime (as in had all operators buffer batches until the output exceeded whatever threshold we wanted)? That way we wouldn't have a plan time decision that we could get wrong\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-01T21:11:48.842+0000",
                    "updated": "2021-04-01T21:11:48.842+0000",
                    "started": "2021-04-01T21:11:48.842+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575750",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575761",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on a change in pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#discussion_r605958280\n\n\n\n##########\nFile path: rust/datafusion/src/physical_optimizer/coalesce_batches.rs\n##########\n@@ -0,0 +1,88 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! CoalesceBatches optimizer that groups batches together rows\n+//! in bigger batches to avoid overhead with small batches\n+\n+use super::optimizer::PhysicalOptimizerRule;\n+use crate::{\n+    error::Result,\n+    physical_plan::{\n+        coalesce_batches::CoalesceBatchesExec, filter::FilterExec,\n+        hash_join::HashJoinExec, repartition::RepartitionExec,\n+    },\n+};\n+use std::sync::Arc;\n+\n+/// Optimizer that introduces CoalesceBatchesExec to avoid overhead with small batches\n+pub struct CoalesceBatches {}\n+\n+impl CoalesceBatches {\n+    #[allow(missing_docs)]\n+    pub fn new() -> Self {\n+        Self {}\n+    }\n+}\n+impl PhysicalOptimizerRule for CoalesceBatches {\n+    fn optimize(\n+        &self,\n+        plan: Arc<dyn crate::physical_plan::ExecutionPlan>,\n+        config: &crate::execution::context::ExecutionConfig,\n+    ) -> Result<Arc<dyn crate::physical_plan::ExecutionPlan>> {\n+        // wrap operators in CoalesceBatches to avoid lots of tiny batches when we have\n+        // highly selective filters\n+        let children = plan\n+            .children()\n+            .iter()\n+            .map(|child| self.optimize(child.clone(), config))\n+            .collect::<Result<Vec<_>>>()?;\n\nReview comment:\n       I think that might be a useful direction indeed!\n   \n   I think indeed it can be more efficient in some cases for nodes to write to multiple buffers than produce smaller batches and concatenate them afterwards, although currently it does not seem to me like it would be a enormous performance improvement based on what I saw in profiling info.\n   \n   Probably not something in the scope of this PR indeed as it's already getting pretty big.\n   \n   Some other notes:\n   \n   * In this PR I think I had to create the physical optimizer abstraction, as otherwise I felt the planner would become unmaintainable. The planning and optimization are now separated and not in the same pass like before (I was a bit confused actually about how it worked before!)\n   * Currently I added the AddMergeExec as an optimization pass, as that was like that in the code before, however it feels a bit off as optimization pass? But I will probably keep it like that for now.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-01T21:32:58.107+0000",
                    "updated": "2021-04-01T21:32:58.107+0000",
                    "started": "2021-04-01T21:32:58.107+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575761",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575872",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "seddonm1 commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812278537\n\n\n   @Dandandan great that someone is working through these optimisations!\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T02:15:01.446+0000",
                    "updated": "2021-04-02T02:15:01.446+0000",
                    "started": "2021-04-02T02:15:01.446+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575872",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/575939",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812357880\n\n\n   @alamb @andygrove \r\n   \r\n   PR is ready enough for review by now. I added some benchmark results to demonstrate the impact of this change on under-partitioned data (or nested queries, but the TPC-H queries are not great examples of that).\r\n   Probably don't have a lot of time to spent during easter.\r\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T06:55:53.586+0000",
                    "updated": "2021-04-02T06:55:53.586+0000",
                    "started": "2021-04-02T06:55:53.586+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "575939",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576170",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812607838\n\n\n   There are two issues still I think originating with `RepartitionExec` (but I can not find the source of the bug) now that we add RepartitionExec in many situations.\r\n   \r\n   * `RepartitionExec` + `EmptyExec` causes empty results -> I disabled adding RepartitionExec for EmptyExec nodes\r\n   * `RepartitionExec` + custom `TopKExec` extension causes emtpy results -> don't know what to do about this\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T16:39:24.011+0000",
                    "updated": "2021-04-02T16:39:24.011+0000",
                    "started": "2021-04-02T16:39:24.011+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576170",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576172",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan edited a comment on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812607838\n\n\n   There are two issues still I think originating with `RepartitionExec` (but I can not find the source of the bug) now that we add RepartitionExec in many situations.\r\n   \r\n   * `RepartitionExec` + `EmptyExec` causes empty results -> I disabled adding RepartitionExec for EmptyExec nodes (doesn't help anyway)\r\n   * `RepartitionExec` + custom `TopKExec` extension causes emtpy results -> don't know what to do about this\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T16:40:20.304+0000",
                    "updated": "2021-04-02T16:40:20.304+0000",
                    "started": "2021-04-02T16:40:20.303+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576172",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576230",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on a change in pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#discussion_r605958280\n\n\n\n##########\nFile path: rust/datafusion/src/physical_optimizer/coalesce_batches.rs\n##########\n@@ -0,0 +1,88 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+//! CoalesceBatches optimizer that groups batches together rows\n+//! in bigger batches to avoid overhead with small batches\n+\n+use super::optimizer::PhysicalOptimizerRule;\n+use crate::{\n+    error::Result,\n+    physical_plan::{\n+        coalesce_batches::CoalesceBatchesExec, filter::FilterExec,\n+        hash_join::HashJoinExec, repartition::RepartitionExec,\n+    },\n+};\n+use std::sync::Arc;\n+\n+/// Optimizer that introduces CoalesceBatchesExec to avoid overhead with small batches\n+pub struct CoalesceBatches {}\n+\n+impl CoalesceBatches {\n+    #[allow(missing_docs)]\n+    pub fn new() -> Self {\n+        Self {}\n+    }\n+}\n+impl PhysicalOptimizerRule for CoalesceBatches {\n+    fn optimize(\n+        &self,\n+        plan: Arc<dyn crate::physical_plan::ExecutionPlan>,\n+        config: &crate::execution::context::ExecutionConfig,\n+    ) -> Result<Arc<dyn crate::physical_plan::ExecutionPlan>> {\n+        // wrap operators in CoalesceBatches to avoid lots of tiny batches when we have\n+        // highly selective filters\n+        let children = plan\n+            .children()\n+            .iter()\n+            .map(|child| self.optimize(child.clone(), config))\n+            .collect::<Result<Vec<_>>>()?;\n\nReview comment:\n       I think that might be a useful direction indeed!\r\n   \r\n   I think indeed it can be more efficient in some cases for nodes to write to mutable buffers than produce smaller batches and concatenate them afterwards, although currently it does not seem to me like it would be a enormous performance improvement based on what I saw in profiling info.\r\n   \r\n   Probably not something in the scope of this PR indeed as it's already getting pretty big.\r\n   \r\n   Some other notes:\r\n   \r\n   * In this PR I think I had to create the physical optimizer abstraction, as otherwise I felt the planner would become unmaintainable. The planning and optimization are now separated and not in the same pass like before (I was a bit confused actually about how it worked before!)\r\n   * Currently I added the AddMergeExec as an optimization pass, as that was like that in the code before, however it feels a bit off as optimization pass? But I will probably keep it like that for now.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T18:26:32.970+0000",
                    "updated": "2021-04-02T18:26:32.970+0000",
                    "started": "2021-04-02T18:26:32.970+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576230",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576283",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "alamb commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812683568\n\n\n   Thanks @Dandandan  -- I'll try and take a closer look at this tomorrow. Given we use custom execution nodes (ala `TopKExec` in IOx I would prefer to figure out what is going on there first). \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-02T19:46:42.422+0000",
                    "updated": "2021-04-02T19:46:42.422+0000",
                    "started": "2021-04-02T19:46:42.422+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576283",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576398",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812823292\n\n\n   Thanks @alamb much appreciated \ud83d\ude03\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-03T06:51:59.155+0000",
                    "updated": "2021-04-03T06:51:59.155+0000",
                    "started": "2021-04-03T06:51:59.154+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576398",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576471",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "alamb commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812901557\n\n\n   @Dandandan  -- sorry I ran out of time today -- I will try and find time tomorrow. Sorry about that\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-03T17:56:44.710+0000",
                    "updated": "2021-04-03T17:56:44.710+0000",
                    "started": "2021-04-03T17:56:44.710+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576471",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576477",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812911439\n\n\n   No worries @alamb \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-03T19:01:55.889+0000",
                    "updated": "2021-04-03T19:01:55.889+0000",
                    "started": "2021-04-03T19:01:55.889+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576477",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576479",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "codecov-io commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-812913241\n\n\n   # [Codecov](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=h1) Report\n   > Merging [#9865](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=desc) (fb2183b) into [master](https://codecov.io/gh/apache/arrow/commit/2b87dfc5da67dc39d18ccc1d49ed5212b468496e?el=desc) (2b87dfc) will **increase** coverage by `0.02%`.\n   > The diff coverage is `89.34%`.\n   \n   [![Impacted file tree graph](https://codecov.io/gh/apache/arrow/pull/9865/graphs/tree.svg?width=650&height=150&src=pr&token=LpTCFbqVT1)](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=tree)\n   \n   ```diff\n   @@            Coverage Diff             @@\n   ##           master    #9865      +/-   ##\n   ==========================================\n   + Coverage   82.68%   82.70%   +0.02%     \n   ==========================================\n     Files         256      259       +3     \n     Lines       60105    60155      +50     \n   ==========================================\n   + Hits        49698    49753      +55     \n   + Misses      10407    10402       -5     \n   ```\n   \n   \n   | [Impacted Files](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=tree) | Coverage \u0394 | |\n   |---|---|---|\n   | [rust/datafusion/src/physical\\_plan/mod.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9wbGFuL21vZC5ycw==) | `88.00% <\u00f8> (\u00f8)` | |\n   | [rust/datafusion/src/physical\\_plan/parquet.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9wbGFuL3BhcnF1ZXQucnM=) | `87.57% <\u00f8> (+0.29%)` | :arrow_up: |\n   | [rust/datafusion/src/execution/context.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9leGVjdXRpb24vY29udGV4dC5ycw==) | `91.65% <57.14%> (-0.53%)` | :arrow_down: |\n   | [...st/datafusion/src/physical\\_optimizer/merge\\_exec.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9vcHRpbWl6ZXIvbWVyZ2VfZXhlYy5ycw==) | `77.77% <77.77%> (\u00f8)` | |\n   | [...afusion/src/physical\\_optimizer/coalesce\\_batches.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9vcHRpbWl6ZXIvY29hbGVzY2VfYmF0Y2hlcy5ycw==) | `88.23% <88.23%> (\u00f8)` | |\n   | [rust/datafusion/src/physical\\_plan/planner.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9wbGFuL3BsYW5uZXIucnM=) | `79.54% <94.44%> (-0.24%)` | :arrow_down: |\n   | [...t/datafusion/src/physical\\_optimizer/repartition.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9vcHRpbWl6ZXIvcmVwYXJ0aXRpb24ucnM=) | `95.08% <95.08%> (\u00f8)` | |\n   | [rust/datafusion/src/datasource/parquet.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9kYXRhc291cmNlL3BhcnF1ZXQucnM=) | `94.40% <100.00%> (-0.04%)` | :arrow_down: |\n   | [rust/datafusion/src/physical\\_plan/merge.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9wbGFuL21lcmdlLnJz) | `68.65% <0.00%> (-8.96%)` | :arrow_down: |\n   | [...t/datafusion/src/physical\\_plan/coalesce\\_batches.rs](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9waHlzaWNhbF9wbGFuL2NvYWxlc2NlX2JhdGNoZXMucnM=) | `84.07% <0.00%> (-0.89%)` | :arrow_down: |\n   | ... and [14 more](https://codecov.io/gh/apache/arrow/pull/9865/diff?src=pr&el=tree-more) | |\n   \n   ------\n   \n   [Continue to review full report at Codecov](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=continue).\n   > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)\n   > `\u0394 = absolute <relative> (impact)`, `\u00f8 = not affected`, `? = missing data`\n   > Powered by [Codecov](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=footer). Last update [2b87dfc...fb2183b](https://codecov.io/gh/apache/arrow/pull/9865?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-03T19:16:37.349+0000",
                    "updated": "2021-04-03T19:16:37.349+0000",
                    "started": "2021-04-03T19:16:37.349+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576479",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576562",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "alamb commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-813013550\n\n\n   I spent some time looking at this. \r\n   \r\n   It seems as if at least one problem is that the `TopKExec` user defined plan should declare that it takes only a single input partition from its child:\r\n   \r\n   ```\r\n   #[async_trait]\r\n   impl ExecutionPlan for TopKExec {\r\n   ...\r\n       fn required_child_distribution(&self) -> Distribution {\r\n           Distribution::SinglePartition\r\n       }\r\n   ...\r\n   ```\r\n   \r\n   However, that is still not enough to get the tests to pass. My debugging of `cargo test -p datafusion --test user_defined_plan` suggests that the actual TopK stream never runs; I'll keep putzing with it \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-04T11:01:04.954+0000",
                    "updated": "2021-04-04T11:01:04.954+0000",
                    "started": "2021-04-04T11:01:04.954+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576562",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576644",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-813083469\n\n\n   Thanks @alamb that gives some more pointers to continue with. I am also interested what the even\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-04T19:00:46.729+0000",
                    "updated": "2021-04-04T19:00:46.729+0000",
                    "started": "2021-04-04T19:00:46.729+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576644",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576646",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan edited a comment on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-813083469\n\n\n   Thanks @alamb that gives some more pointers to continue with. I am also interested what the eventual (optimized) physical plan looks like. At least not having  the single partition will avoid having the mergeexec and/or allow the repartitioning to be added as a direct child.\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-04T19:02:42.767+0000",
                    "updated": "2021-04-04T19:02:42.767+0000",
                    "started": "2021-04-04T19:02:42.766+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576646",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576778",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan commented on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-813315064\n\n\n   Somehow this is what the plan looks like - already before optimization(?)\r\n   \r\n   ```Physical plan:\r\n   TopKExec\r\n   ```\r\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-05T09:59:04.630+0000",
                    "updated": "2021-04-05T09:59:04.630+0000",
                    "started": "2021-04-05T09:59:04.629+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576778",
                    "issueId": "13368954"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/worklog/576779",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "Dandandan edited a comment on pull request #9865:\nURL: https://github.com/apache/arrow/pull/9865#issuecomment-813315064\n\n\n   Somehow this is what the plan looks like - already before optimization(?) it seems it doesn't have children somehow\r\n   \r\n   ```Physical plan:\r\n   TopKExec\r\n   ```\r\n   \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2021-04-05T09:59:37.678+0000",
                    "updated": "2021-04-05T09:59:37.678+0000",
                    "started": "2021-04-05T09:59:37.678+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "576779",
                    "issueId": "13368954"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/4",
            "id": "4",
            "description": "An improvement or enhancement to an existing feature or task.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype",
            "name": "Improvement",
            "subtask": false,
            "avatarId": 21140
        },
        "timespent": 22200,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@6116ba0e[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2378e5b4[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6e2da491[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@a9ca9a5[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1d90ca23[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@5a90213c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@591a0fd3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@362444d4[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2d7e51e1[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@763c1cb3[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7f51e130[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@6b4708ea[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 22200,
        "customfield_12312520": null,
        "customfield_12312521": "Fri Apr 09 10:26:57 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2021-04-09T10:26:57.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-12170/watchers",
            "watchCount": 2,
            "isWatching": false
        },
        "created": "2021-03-31T19:18:36.000+0000",
        "updated": "2021-04-09T10:27:02.000+0000",
        "timeoriginalestimate": null,
        "description": "To achieve a higher amount of parallelism, automatic repartition can help.\r\nEspecially on a single node, a round robin  repartitioning step is almost free while it can improve the amount of parallelism .",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "6h 10m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 22200
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Rust][DataFusion] Introduce repartition optimization",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13368954/comment/17317864",
                    "id": "17317864",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=alamb",
                        "name": "alamb",
                        "key": "alamb",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=alamb&avatarId=43364",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alamb&avatarId=43364",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alamb&avatarId=43364",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alamb&avatarId=43364"
                        },
                        "displayName": "Andrew Lamb",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 9865\n[https://github.com/apache/arrow/pull/9865]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=alamb",
                        "name": "alamb",
                        "key": "alamb",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=alamb&avatarId=43364",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alamb&avatarId=43364",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alamb&avatarId=43364",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alamb&avatarId=43364"
                        },
                        "displayName": "Andrew Lamb",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2021-04-09T10:26:57.459+0000",
                    "updated": "2021-04-09T10:26:57.459+0000"
                }
            ],
            "maxResults": 1,
            "total": 1,
            "startAt": 0
        },
        "customfield_12311820": "0|z0pfbs:",
        "customfield_12314139": null
    }
}