{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13435156",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156",
    "key": "ARROW-16005",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12351550",
                "id": "12351550",
                "name": "9.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2022-08-03"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12350591",
                "id": "12350591",
                "description": "",
                "name": "7.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2022-02-03"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tom-s-powell",
            "name": "tom-s-powell",
            "key": "JIRAUSER286935",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Thomas Powell",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328933",
                "id": "12328933",
                "name": "Java"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tom-s-powell",
            "name": "tom-s-powell",
            "key": "JIRAUSER286935",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Thomas Powell",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tom-s-powell",
            "name": "tom-s-powell",
            "key": "JIRAUSER286935",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Thomas Powell",
            "active": true,
            "timeZone": "Etc/UTC"
        },
        "aggregateprogress": {
            "progress": 11400,
            "total": 11400,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 11400,
            "total": 11400,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-16005/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 19,
            "worklogs": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/745909",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell opened a new pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692\n\n\n   Fixes https://issues.apache.org/jira/browse/ARROW-16005. \n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-22T16:24:59.072+0000",
                    "updated": "2022-03-22T16:24:59.072+0000",
                    "started": "2022-03-22T16:24:59.071+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "745909",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/745911",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on a change in pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r832372322\n\n\n\n##########\nFile path: java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n+      for (int i = 1; i <= consumers.length; i++) {\n+        ArrowType arrowType = config.getJdbcToArrowTypeConverter()\n+                .apply(new JdbcFieldInfo(resultSet.getMetaData(), i));\n+        consumers[i - 1] = JdbcToArrowUtils.getConsumer(\n\nReview comment:\n       Because `ArrayConsumer` requires a `FieldVector` to be passed, I've opted for lazily initialising the consumers after the first `VectorSchemaRoot` is created. \r\n   \r\n   https://github.com/apache/arrow/pull/12692/files#diff-f812c76a565e7c56500943f512b8498487209b15ed036d404d703854841df3d0R152 will update the vector in the consumer on subsequent iterations. \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-22T16:25:26.668+0000",
                    "updated": "2022-03-22T16:25:26.668+0000",
                    "started": "2022-03-22T16:25:26.668+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "745911",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/745912",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on a change in pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r832373127\n\n\n\n##########\nFile path: java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/consumer/ArrayConsumer.java\n##########\n@@ -90,13 +97,12 @@ public void consume(ResultSet resultSet) throws SQLException, IOException {\n         int count = 0;\n         try (ResultSet rs = array.getResultSet()) {\n           while (rs.next()) {\n-            ensureInnerVectorCapacity(innerVectorIndex + count + 1);\n\nReview comment:\n       I couldn't work out the value of this `innerVectorIndex`? It didn't seem to ever be reset but nor did it seem to be used when consuming results.  \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-22T16:25:50.781+0000",
                    "updated": "2022-03-22T16:25:50.781+0000",
                    "started": "2022-03-22T16:25:50.780+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "745912",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/745919",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on a change in pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r832378685\n\n\n\n##########\nFile path: java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/consumer/ArrayConsumer.java\n##########\n@@ -64,6 +63,14 @@ public void close() throws Exception {\n     this.delegate.close();\n   }\n \n+  @Override\n+  public void resetValueVector(ListVector vector) {\n+    super.resetValueVector(vector);\n+\n+    FieldVector childVector = vector.getDataVector();\n\nReview comment:\n       When `VectorSchemaRoot` is reused in `ArrowVectorIterator`, we currently hit the issue that the `currentIndex` here is reset to `0` but is never updated in the delegate consumer. As such, subsequent iterations will result in `null` array values because the `ListVector` (and data vector) is reset https://github.com/apache/arrow/pull/12692/files#diff-f812c76a565e7c56500943f512b8498487209b15ed036d404d703854841df3d0R150. \r\n   \r\n   For example, if you have a batch size of 2 and a `ResultSet` with 4 rows, the second iteration will be writing values into index 0 and 1 in the `ListVector` but the offsets for those in the data vector will be pointing at null values (because it was reset) and the values written to the data vector will be at larger indexes.\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-22T16:31:02.952+0000",
                    "updated": "2022-03-22T16:31:02.952+0000",
                    "started": "2022-03-22T16:31:02.952+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "745919",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/745920",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "github-actions[bot] commented on pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692#issuecomment-1075359755\n\n\n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-22T16:31:15.429+0000",
                    "updated": "2022-03-22T16:31:15.429+0000",
                    "started": "2022-03-22T16:31:15.429+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "745920",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/747938",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on a change in pull request #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r835556364\n\n\n\n##########\nFile path: java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/consumer/ArrayConsumer.java\n##########\n@@ -90,13 +97,12 @@ public void consume(ResultSet resultSet) throws SQLException, IOException {\n         int count = 0;\n         try (ResultSet rs = array.getResultSet()) {\n           while (rs.next()) {\n-            ensureInnerVectorCapacity(innerVectorIndex + count + 1);\n\nReview comment:\n       It's because of how a ListVector is laid out in memory. The list `[[1, 2], [], [3, 4, 5]]` is represented as the child vector `[1, 2, 3, 4, 5]` and the offsets `[0, 2, 2, 5]`. `ensureInnerVectorCapacity` is resizing the child vector, so when we call `consume` for the last element, we want to ensure the child vector has enough capacity for the current elements, along with all the previous elements, and it looks like that's what `innerVectorIndex` is tracking. \r\n   \r\n   In other words when we call `consume` for what will be `[3, 4, 5]` we need to ensure the child vector has space for at least 3, 4, 5, \u2026 elements not 1, 2, 3\u2026 elements.\n\n##########\nFile path: java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n\nReview comment:\n       It seems this isn't right if `!config.isReuseVectorSchemaRoot()` because we'll have recreated the root. Since `ensureInitialized` is only ever called when creating a new root, I don't think we need to guard this with `initialized`? \n\n\n\n\n-- \nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n\nTo unsubscribe, e-mail: github-unsubscribe@arrow.apache.org\n\nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "created": "2022-03-25T19:29:11.342+0000",
                    "updated": "2022-03-25T19:29:11.342+0000",
                    "started": "2022-03-25T19:29:11.341+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "747938",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/773984",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r880430602\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java:\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n\nReview Comment:\n   Ah yes good point!\n\n\n\n",
                    "created": "2022-05-24T12:17:42.358+0000",
                    "updated": "2022-05-24T12:17:42.358+0000",
                    "started": "2022-05-24T12:17:42.358+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "773984",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/773985",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r880434958\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java:\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n\nReview Comment:\n   Actually, it's fine as its currently written. After creating a new `VectorSchemaRoot` we'll call `load` and this will call `JdbcConsumer#resetValueVector` passing the vectors of the _new_ `VectorSchemaRoot` and obtaining a reference to them (https://github.com/apache/arrow/pull/12692/files#diff-f812c76a565e7c56500943f512b8498487209b15ed036d404d703854841df3d0R161). This will happen before we consume data. \n\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java:\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n\nReview Comment:\n   ~~Ah yes good point!~~\n\n\n\n",
                    "created": "2022-05-24T12:22:22.161+0000",
                    "updated": "2022-05-24T12:22:22.161+0000",
                    "started": "2022-05-24T12:22:22.160+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "773985",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774176",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r880842894\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/consumer/ArrayConsumer.java:\n##########\n@@ -90,13 +97,12 @@ public void consume(ResultSet resultSet) throws SQLException, IOException {\n         int count = 0;\n         try (ResultSet rs = array.getResultSet()) {\n           while (rs.next()) {\n-            ensureInnerVectorCapacity(innerVectorIndex + count + 1);\n\nReview Comment:\n   I'm still not entirely convinced we can remove `innerVectorIndex` here?\n\n\n\n",
                    "created": "2022-05-24T18:46:24.122+0000",
                    "updated": "2022-05-24T18:46:24.122+0000",
                    "started": "2022-05-24T18:46:24.122+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774176",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774466",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r881488842\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java:\n##########\n@@ -134,11 +122,26 @@ private VectorSchemaRoot createVectorSchemaRoot() {\n       }\n       throw new RuntimeException(\"Error occurred while creating schema root.\", e);\n     }\n+\n+    // ensure consumers have been initialized\n+    ensureInitialized(root);\n     return root;\n   }\n \n+  private void ensureInitialized(VectorSchemaRoot root) throws SQLException {\n+    if (!initialized) {\n\nReview Comment:\n   Actually sorry I see we have to recreate the delegate consumer as it references the child vector so it does make sense to initialize each time.\n\n\n\n",
                    "created": "2022-05-25T10:25:47.083+0000",
                    "updated": "2022-05-25T10:25:47.083+0000",
                    "started": "2022-05-25T10:25:47.083+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774466",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774474",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#issuecomment-1137099723\n\n   I've updated the unit tests for `arrow-jdbc` to include array types.\n\n\n",
                    "created": "2022-05-25T10:59:22.166+0000",
                    "updated": "2022-05-25T10:59:22.166+0000",
                    "started": "2022-05-25T10:59:22.166+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774474",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774502",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r881557986\n\n\n##########\njava/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/consumer/ArrayConsumer.java:\n##########\n@@ -90,13 +97,12 @@ public void consume(ResultSet resultSet) throws SQLException, IOException {\n         int count = 0;\n         try (ResultSet rs = array.getResultSet()) {\n           while (rs.next()) {\n-            ensureInnerVectorCapacity(innerVectorIndex + count + 1);\n\nReview Comment:\n   I've reverted the change to `innerVectorIndex`. Only thing I've done is reset it to 0 when we reset inner vector.\r\n   \r\n   I've added unit tests for Arrays which covers the two issues when reusing `VectorSchemaRoot`:\r\n   1) NPE error from `ArrowVectorIterator`.\r\n   2) `ArrayConsumer` not reseting the delegate consumer.\n\n\n\n",
                    "created": "2022-05-25T11:50:25.040+0000",
                    "updated": "2022-05-25T11:50:25.040+0000",
                    "started": "2022-05-25T11:50:25.040+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774502",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774504",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r881559943\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/Table.java:\n##########\n@@ -204,6 +219,11 @@ public void setRowCount(int rowCount) {\n     this.rowCount = rowCount;\n   }\n \n+  @Override\n+  public String toString() {\n+    return \"Table{name='\" + name + \"', type='\" + type + \"'}\";\n\nReview Comment:\n   Have added this for debugging purposes, helpful in the `ParameterizedTest` to easily see which test file is failing. I updated the table names to match the YML file name. \n\n\n\n",
                    "created": "2022-05-25T11:52:40.136+0000",
                    "updated": "2022-05-25T11:52:40.136+0000",
                    "started": "2022-05-25T11:52:40.135+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774504",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/774507",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r881560720\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/h2/JdbcToArrowVectorIteratorTest.java:\n##########\n@@ -99,15 +104,25 @@ public void testJdbcToArrowValues() throws SQLException, IOException {\n \n   @Test\n   public void testVectorSchemaRootReuse() throws SQLException, IOException {\n-    String[] expectedColValues = {\n+    String[] expectedIntColValues = {\n         \"[101, 102, 103]\",\n         \"[104, null, null]\",\n         \"[107, 108, 109]\",\n         \"[110]\"\n     };\n+    String[] expectedArrayColValues = {\n\nReview Comment:\n   Added this test case for arrays specifically to test the fix to `ArrayConsumer` when resetting the delegate. Without the reset you end up reading null values.\n\n\n\n",
                    "created": "2022-05-25T11:53:36.023+0000",
                    "updated": "2022-05-25T11:53:36.023+0000",
                    "started": "2022-05-25T11:53:36.023+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "774507",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/776390",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r885780647\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/h2/JdbcToArrowVectorIteratorTest.java:\n##########\n@@ -119,7 +134,10 @@ public void testVectorSchemaRootReuse() throws SQLException, IOException {\n       assertNotNull(cur);\n \n       // verify the first column, with may contain nulls.\n-      assertEquals(expectedColValues[batchCount], cur.getVector(0).toString());\n+      assertEquals(expectedIntColValues[batchCount], cur.getVector(0).toString());\n\nReview Comment:\n   Is there a better way to assert equality than the string representation (perhaps with getObject as done elsewhere)? This is a little brittle\n\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/JdbcToArrowTestHelper.java:\n##########\n@@ -378,4 +393,25 @@ public static String[] getValues(String[] values, String dataType) {\n     }\n     return value.split(\",\");\n   }\n+\n+  public static Integer[][] getListValues(String[] values, String dataType) {\n+    String[] dataArr = getValues(values, dataType);\n+    Integer[][] valueArr = new Integer[dataArr.length][];\n+    int i = 0;\n+    for (String data : dataArr) {\n+      if (\"null\".equals(data.trim())) {\n+        valueArr[i++] = null;\n+      } else if (\"()\".equals(data.trim())) {\n+        valueArr[i++] = new Integer[0];\n+      } else {\n+        String[] row = data.replace(\"(\", \"\").replace(\")\", \"\").split(\";\");\n+        Integer[] arr = new Integer[row.length];\n+        for (int j = 0; j < arr.length; j++) {\n+          arr[j] = \"null\".equals(row[j]) ? null : Integer.parseInt(row[j]);\n+        }\n+        valueArr[i++] = arr;\n+      }\n+    }\n+    return valueArr;\n+  }\n\nReview Comment:\n   It feels like this could be reused from Table.getListValues? Especially as this seems to also handle nulls\n\n\n\n",
                    "created": "2022-05-31T15:23:33.002+0000",
                    "updated": "2022-05-31T15:23:33.002+0000",
                    "started": "2022-05-31T15:23:33.002+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "776390",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/776509",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r886027586\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/JdbcToArrowTestHelper.java:\n##########\n@@ -378,4 +393,25 @@ public static String[] getValues(String[] values, String dataType) {\n     }\n     return value.split(\",\");\n   }\n+\n+  public static Integer[][] getListValues(String[] values, String dataType) {\n+    String[] dataArr = getValues(values, dataType);\n+    Integer[][] valueArr = new Integer[dataArr.length][];\n+    int i = 0;\n+    for (String data : dataArr) {\n+      if (\"null\".equals(data.trim())) {\n+        valueArr[i++] = null;\n+      } else if (\"()\".equals(data.trim())) {\n+        valueArr[i++] = new Integer[0];\n+      } else {\n+        String[] row = data.replace(\"(\", \"\").replace(\")\", \"\").split(\";\");\n+        Integer[] arr = new Integer[row.length];\n+        for (int j = 0; j < arr.length; j++) {\n+          arr[j] = \"null\".equals(row[j]) ? null : Integer.parseInt(row[j]);\n+        }\n+        valueArr[i++] = arr;\n+      }\n+    }\n+    return valueArr;\n+  }\n\nReview Comment:\n   Refactored so they can be reused\n\n\n\n",
                    "created": "2022-05-31T18:58:30.125+0000",
                    "updated": "2022-05-31T18:58:30.125+0000",
                    "started": "2022-05-31T18:58:30.125+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "776509",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/776510",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on code in PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#discussion_r886027781\n\n\n##########\njava/adapter/jdbc/src/test/java/org/apache/arrow/adapter/jdbc/h2/JdbcToArrowVectorIteratorTest.java:\n##########\n@@ -119,7 +134,10 @@ public void testVectorSchemaRootReuse() throws SQLException, IOException {\n       assertNotNull(cur);\n \n       // verify the first column, with may contain nulls.\n-      assertEquals(expectedColValues[batchCount], cur.getVector(0).toString());\n+      assertEquals(expectedIntColValues[batchCount], cur.getVector(0).toString());\n\nReview Comment:\n   Switched to use the `assertIntVectorValues` and `assertListVectorValues`\n\n\n\n",
                    "created": "2022-05-31T18:58:44.982+0000",
                    "updated": "2022-05-31T18:58:44.982+0000",
                    "started": "2022-05-31T18:58:44.982+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "776510",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/776718",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "tom-s-powell commented on PR #12692:\nURL: https://github.com/apache/arrow/pull/12692#issuecomment-1143293591\n\n   @lidavidm this should be good to merge\n\n\n",
                    "created": "2022-06-01T08:38:34.098+0000",
                    "updated": "2022-06-01T08:38:34.098+0000",
                    "started": "2022-06-01T08:38:34.097+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "776718",
                    "issueId": "13435156"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/worklog/777158",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "comment": "lidavidm merged PR #12692:\nURL: https://github.com/apache/arrow/pull/12692\n\n\n",
                    "created": "2022-06-01T20:54:49.111+0000",
                    "updated": "2022-06-01T20:54:49.111+0000",
                    "started": "2022-06-01T20:54:49.111+0000",
                    "timeSpent": "10m",
                    "timeSpentSeconds": 600,
                    "id": "777158",
                    "issueId": "13435156"
                }
            ]
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 11400,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@24106a3b[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7bfe82f7[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@67bdf14c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@685b3e76[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4bca6dd1[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@535f131c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5b60afaa[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6af9923e[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7245ce55[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@59a9e4f2[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@76a1d92[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@21241723[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 11400,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Jun 01 20:54:58 UTC 2022",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2022-06-01T20:54:58.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-16005/watchers",
            "watchCount": 2,
            "isWatching": false
        },
        "created": "2022-03-22T16:13:03.000+0000",
        "updated": "2022-06-01T20:54:58.000+0000",
        "timeoriginalestimate": null,
        "description": "{{ArrowVectorIterator}} does not currently work with arrays.\r\n\r\nOne issue is that initializing the {{ArrayConsumer}} requires {{ListVector#getDataVector}} but currently this is called before the {{VectorSchemaRoot}} is initialized so there is no {{ListVector}} to pass: [https://github.com/apache/arrow/blob/master/java/adapter/jdbc/src/main/java/org/apache/arrow/adapter/jdbc/ArrowVectorIterator.java#L76.]\u00a0\r\n{code:java}\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"org.apache.arrow.vector.complex.ListVector.getDataVector()\" because \"vector\" is null\r\n\u00a0 \u00a0 at org.apache.arrow.adapter.jdbc.JdbcToArrowUtils.getConsumer(JdbcToArrowUtils.java:432)\r\n\u00a0 \u00a0 at org.apache.arrow.adapter.jdbc.ArrowVectorIterator.initialize(ArrowVectorIterator.java:74)\r\n\u00a0 \u00a0 at org.apache.arrow.adapter.jdbc.ArrowVectorIterator.create(ArrowVectorIterator.java:91)\r\n\u00a0 \u00a0 ... 72 more {code}\r\nA second issue comes when there are multiple batches. {{ArrayConsumer#resetValueVector}} does not currently do anything with the delegate. As a result, {{ListVector#dataVector}} does not have its index reset which is an issue when reusing the {{{}VectorSchemaRoot{}}}.\u00a0",
        "customfield_10010": null,
        "timetracking": {
            "remainingEstimate": "0h",
            "timeSpent": "3h 10m",
            "remainingEstimateSeconds": 0,
            "timeSpentSeconds": 11400
        },
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Java] JDBC-to-Arrow: Arrays do not work with ArrowVectorIterator",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/comment/17510740",
                    "id": "17510740",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=tom-s-powell",
                        "name": "tom-s-powell",
                        "key": "JIRAUSER286935",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Thomas Powell",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "Started a fix in https://github.com/apache/arrow/pull/12692.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=tom-s-powell",
                        "name": "tom-s-powell",
                        "key": "JIRAUSER286935",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "Thomas Powell",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2022-03-22T16:39:03.196+0000",
                    "updated": "2022-03-22T16:39:03.196+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13435156/comment/17545139",
                    "id": "17545139",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 12692\n[https://github.com/apache/arrow/pull/12692]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=lidavidm",
                        "name": "lidavidm",
                        "key": "lidavidm",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "David Li",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2022-06-01T20:54:58.057+0000",
                    "updated": "2022-06-01T20:54:58.057+0000"
                }
            ],
            "maxResults": 2,
            "total": 2,
            "startAt": 0
        },
        "customfield_12311820": "0|z10ps0:",
        "customfield_12314139": null
    }
}