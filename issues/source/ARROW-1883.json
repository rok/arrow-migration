{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13122572",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572",
    "key": "ARROW-1883",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12341352",
                "id": "12341352",
                "name": "0.8.0",
                "archived": false,
                "released": true,
                "releaseDate": "2017-12-18"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": null,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12341666",
                "id": "12341666",
                "name": "0.7.1",
                "archived": false,
                "released": true,
                "releaseDate": "2017-10-01"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=jorisvandenbossche",
            "name": "jorisvandenbossche",
            "key": "jorisvandenbossche",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Joris Van den Bossche",
            "active": true,
            "timeZone": "Europe/Brussels"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328936",
                "id": "12328936",
                "name": "Python"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": null,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=jorisvandenbossche",
            "name": "jorisvandenbossche",
            "key": "jorisvandenbossche",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Joris Van den Bossche",
            "active": true,
            "timeZone": "Europe/Brussels"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=jorisvandenbossche",
            "name": "jorisvandenbossche",
            "key": "jorisvandenbossche",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
            },
            "displayName": "Joris Van den Bossche",
            "active": true,
            "timeZone": "Europe/Brussels"
        },
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-1883/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 0,
            "worklogs": []
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": null,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@4f90fe69[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1c905cda[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@23756f50[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@3d9d8168[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@750d3b72[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@6bf24330[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@63f5bef1[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@32b2f526[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2e788ea9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@57eaa395[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@19a69daf[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@3c184078[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": null,
        "customfield_12312520": null,
        "customfield_12312521": "Sun Dec 10 23:41:53 UTC 2017",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2017-12-10T23:40:16.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-1883/watchers",
            "watchCount": 3,
            "isWatching": false
        },
        "created": "2017-12-04T13:07:22.000+0000",
        "updated": "2017-12-10T23:41:53.000+0000",
        "timeoriginalestimate": null,
        "description": "Found this bug in the example in the pandas documentation (http://pandas-docs.github.io/pandas-docs-travis/io.html#parquet), which does:\r\n\r\n\r\n{code}\r\ndf = pd.DataFrame({'a': list('abc'),\r\n                   'b': list(range(1, 4)),\r\n                   'c': np.arange(3, 6).astype('u1'),\r\n                   'd': np.arange(4.0, 7.0, dtype='float64'),\r\n                   'e': [True, False, True],\r\n                   'f': pd.date_range('20130101', periods=3),\r\n                   'g': pd.date_range('20130101', periods=3, tz='US/Eastern')})\r\n\r\ndf.to_parquet('example_pa.parquet', engine='pyarrow')\r\n\r\npd.read_parquet('example_pa.parquet', engine='pyarrow', columns=['a', 'b'])\r\n{code}\r\n\r\n\r\nand this raises in the last line reading a subset of columns:\r\n\r\n{code}\r\n...\r\n/home/joris/miniconda3/envs/dev/lib/python3.5/site-packages/pyarrow/pandas_compat.py in _add_any_metadata(table, pandas_metadata)\r\n    357     for i, col_meta in enumerate(pandas_metadata['columns']):\r\n    358         if col_meta['pandas_type'] == 'datetimetz':\r\n--> 359             col = table[i]\r\n    360             converted = col.to_pandas()\r\n    361             tz = col_meta['metadata']['timezone']\r\n\r\ntable.pxi in pyarrow.lib.Table.__getitem__()\r\n\r\ntable.pxi in pyarrow.lib.Table.column()\r\n\r\nIndexError: Table column index 6 is out of range\r\n{code}\r\n\r\n\r\nThis is due to checking the `pandas_metadata` for all columns (and in this case trying to deal with a datetime tz column), while in practice not all columns are present in this case ('mismatch' between pandas metadata and actual schema). \r\n\r\nA smaller example without parquet:\r\n\r\n{code}\r\nIn [38]: df = pd.DataFrame({'a': [1, 2, 3], 'b': pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')})\r\n\r\nIn [39]: table = pyarrow.Table.from_pandas(df)\r\n\r\nIn [40]: table\r\nOut[40]: \r\npyarrow.Table\r\na: int64\r\nb: timestamp[ns, tz=Europe/Brussels]\r\n__index_level_0__: int64\r\nmetadata\r\n--------\r\n{b'pandas': b'{\"columns\": [{\"pandas_type\": \"int64\", \"metadata\": null, \"numpy_t'\r\n            b'ype\": \"int64\", \"name\": \"a\"}, {\"pandas_type\": \"datetimetz\", \"meta'\r\n            b'data\": {\"timezone\": \"Europe/Brussels\"}, \"numpy_type\": \"datetime6'\r\n            b'4[ns, Europe/Brussels]\", \"name\": \"b\"}, {\"pandas_type\": \"int64\", '\r\n            b'\"metadata\": null, \"numpy_type\": \"int64\", \"name\": \"__index_level_'\r\n            b'0__\"}], \"index_columns\": [\"__index_level_0__\"], \"pandas_version\"'\r\n            b': \"0.22.0.dev0+277.gd61f411\"}'}\r\n\r\nIn [41]: table.to_pandas()\r\nOut[41]: \r\n   a                         b\r\n0  1 2017-01-01 00:00:00+01:00\r\n1  2 2017-01-02 00:00:00+01:00\r\n2  3 2017-01-03 00:00:00+01:00\r\n\r\nIn [44]: table_without_tz = table.remove_column(1)\r\n\r\nIn [45]: table_without_tz\r\nOut[45]: \r\npyarrow.Table\r\na: int64\r\n__index_level_0__: int64\r\nmetadata\r\n--------\r\n{b'pandas': b'{\"columns\": [{\"pandas_type\": \"int64\", \"metadata\": null, \"numpy_t'\r\n            b'ype\": \"int64\", \"name\": \"a\"}, {\"pandas_type\": \"datetimetz\", \"meta'\r\n            b'data\": {\"timezone\": \"Europe/Brussels\"}, \"numpy_type\": \"datetime6'\r\n            b'4[ns, Europe/Brussels]\", \"name\": \"b\"}, {\"pandas_type\": \"int64\", '\r\n            b'\"metadata\": null, \"numpy_type\": \"int64\", \"name\": \"__index_level_'\r\n            b'0__\"}], \"index_columns\": [\"__index_level_0__\"], \"pandas_version\"'\r\n            b': \"0.22.0.dev0+277.gd61f411\"}'}\r\n\r\nIn [46]: table_without_tz.to_pandas()          # <------ wrong output !\r\nOut[46]: \r\n                                     a\r\n1970-01-01 01:00:00+01:00            1\r\n1970-01-01 01:00:00.000000001+01:00  2\r\n1970-01-01 01:00:00.000000002+01:00  3\r\n\r\nIn [47]: table_without_tz2 = table_without_tz.remove_column(1)\r\n\r\nIn [48]: table_without_tz2\r\nOut[48]: \r\npyarrow.Table\r\na: int64\r\nmetadata\r\n--------\r\n{b'pandas': b'{\"columns\": [{\"pandas_type\": \"int64\", \"metadata\": null, \"numpy_t'\r\n            b'ype\": \"int64\", \"name\": \"a\"}, {\"pandas_type\": \"datetimetz\", \"meta'\r\n            b'data\": {\"timezone\": \"Europe/Brussels\"}, \"numpy_type\": \"datetime6'\r\n            b'4[ns, Europe/Brussels]\", \"name\": \"b\"}, {\"pandas_type\": \"int64\", '\r\n            b'\"metadata\": null, \"numpy_type\": \"int64\", \"name\": \"__index_level_'\r\n            b'0__\"}], \"index_columns\": [\"__index_level_0__\"], \"pandas_version\"'\r\n            b': \"0.22.0.dev0+277.gd61f411\"}'}\r\n\r\nIn [49]: table_without_tz2.to_pandas()     # <------ error !\r\n---------------------------------------------------------------------------\r\nIndexError                                Traceback (most recent call last)\r\n<ipython-input-49-c82f33476c6b> in <module>()\r\n----> 1 table_without_tz2.to_pandas()\r\n\r\ntable.pxi in pyarrow.lib.Table.to_pandas()\r\n\r\n/home/joris/miniconda3/envs/dev/lib/python3.5/site-packages/pyarrow/pandas_compat.py in table_to_blockmanager(options, table, memory_pool, nthreads)\r\n    289         pandas_metadata = json.loads(metadata[b'pandas'].decode('utf8'))\r\n    290         index_columns = pandas_metadata['index_columns']\r\n--> 291         table = _add_any_metadata(table, pandas_metadata)\r\n    292 \r\n    293     block_table = table\r\n\r\n/home/joris/miniconda3/envs/dev/lib/python3.5/site-packages/pyarrow/pandas_compat.py in _add_any_metadata(table, pandas_metadata)\r\n    357     for i, col_meta in enumerate(pandas_metadata['columns']):\r\n    358         if col_meta['pandas_type'] == 'datetimetz':\r\n--> 359             col = table[i]\r\n    360             converted = col.to_pandas()\r\n    361             tz = col_meta['metadata']['timezone']\r\n\r\ntable.pxi in pyarrow.lib.Table.__getitem__()\r\n\r\ntable.pxi in pyarrow.lib.Table.column()\r\n\r\nIndexError: Table column index 1 is out of range\r\n{code}\r\n\r\nThe reason is that `_add_any_metadata` does not check if the column it is processing (currently only datetime tz columns need such processing) is actually present in the schema.\r\n\r\nWorking on a fix, will submit a PR.\r\n",
        "customfield_10010": null,
        "timetracking": {},
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[Python] BUG: Table.to_pandas metadata checking fails if columns are not present",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16276787",
                    "id": "16276787",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche opened a new pull request #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386\n \n \n   This closes [ARROW-1883](https://issues.apache.org/jira/browse/ARROW-1883).\r\n   \r\n   So basically what I did in `_add_any_metadata` was replacing `col = table[i]` with:\r\n   \r\n   ```\r\n   idx = schema.get_field_index(raw_name)\r\n   if idx != -1:\r\n        col = table[idx]\r\n   ```\r\n   \r\n   to check that the column is actually present in the schema. However, that involved some more code to get to `raw_name` (the name how the column is present in the schema), as this does not always match the name in `pandas_metadata['column'][..]['name']`. Not sure if there is a better way to get that name. \r\n   (or if it would be better to filter `pandas_metadata` earlier on, instead of checking when actually trying to process the metadata of that column)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-04T13:39:55.569+0000",
                    "updated": "2017-12-04T13:39:55.569+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16277200",
                    "id": "16277200",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "cpcloud commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-349056473\n \n \n   The travis failure looks unrelated.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-04T18:25:52.885+0000",
                    "updated": "2017-12-04T18:25:52.885+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16277208",
                    "id": "16277208",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "cpcloud commented on a change in pull request #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#discussion_r154730944\n \n \n\n ##########\n File path: python/pyarrow/pandas_compat.py\n ##########\n @@ -530,19 +530,32 @@ def _add_any_metadata(table, pandas_metadata):\n \n     schema = table.schema\n \n+    n_index_levels = len(pandas_metadata['index_columns'])\n+    n_columns = len(pandas_metadata['columns']) - n_index_levels\n+\n     # Add time zones\n     for i, col_meta in enumerate(pandas_metadata['columns']):\n-        if col_meta['pandas_type'] == 'datetimetz':\n-            col = table[i]\n-            converted = col.to_pandas()\n-            tz = col_meta['metadata']['timezone']\n-            tz_aware_type = pa.timestamp('ns', tz=tz)\n-            with_metadata = pa.Array.from_pandas(converted.values,\n-                                                 type=tz_aware_type)\n-\n-            field = pa.field(schema[i].name, tz_aware_type)\n-            modified_columns[i] = pa.Column.from_array(field,\n-                                                       with_metadata)\n+\n+        raw_name = col_meta['name']\n+        if i >= n_columns:\n+            # index columns\n+            raw_name = pandas_metadata['index_columns'][i - n_columns]\n \n Review comment:\n   can you pull `pandas_metadata['index_columns']` out into a variable?\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-04T18:30:23.429+0000",
                    "updated": "2017-12-04T18:30:23.429+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16277209",
                    "id": "16277209",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "cpcloud commented on a change in pull request #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#discussion_r154733630\n \n \n\n ##########\n File path: python/pyarrow/tests/test_convert_pandas.py\n ##########\n @@ -1221,6 +1221,21 @@ def test_array_from_pandas_typed_array_with_mask(self, t, data, expected):\n         assert pa.Array.from_pandas(expected,\n                                     type=pa.list_(t())).equals(result)\n \n+    def test_table_column_subset_metadata(self):\n \n Review comment:\n   Can you add 2 tests: 1 against a datetime index and 1 against another index that isn't datetime? We need to make sure the `i >= ncolumns` condition is tested.\r\n   \r\n   You'll need to pass `preserve_index=True` to `pa.Table.from_pandas()`.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-04T18:30:23.429+0000",
                    "updated": "2017-12-04T18:30:23.429+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16278777",
                    "id": "16278777",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on a change in pull request #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#discussion_r154990736\n \n \n\n ##########\n File path: python/pyarrow/tests/test_convert_pandas.py\n ##########\n @@ -1221,6 +1221,21 @@ def test_array_from_pandas_typed_array_with_mask(self, t, data, expected):\n         assert pa.Array.from_pandas(expected,\n                                     type=pa.list_(t())).equals(result)\n \n+    def test_table_column_subset_metadata(self):\n \n Review comment:\n   Yes, I was actually playing with such frames interactively testing it out, but forgot to add to the actual tests. \r\n   \r\n   `preserve_index=True` is the default, but I can add it for explicitness if you want\r\n   \r\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-05T15:58:08.650+0000",
                    "updated": "2017-12-05T15:58:08.650+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16278783",
                    "id": "16278783",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-349349398\n \n \n   Thanks for the review, added some more tests.\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-05T15:59:43.719+0000",
                    "updated": "2017-12-05T15:59:43.719+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16284997",
                    "id": "16284997",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "wesm commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350506200\n \n \n   How does this patch align with #1397?\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-09T21:18:19.785+0000",
                    "updated": "2017-12-09T21:18:19.785+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285011",
                    "id": "16285011",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "cpcloud commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350507249\n \n \n   @wesm I believe @jorisvandenbossche said he was going to rebase on top of #1397 when that's merged\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-09T21:37:02.154+0000",
                    "updated": "2017-12-09T21:37:02.154+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285229",
                    "id": "16285229",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350546832\n \n \n   @wesm yes, and I have time to that today (or tomorrow) once the other is merged\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T12:59:49.194+0000",
                    "updated": "2017-12-10T12:59:49.194+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285353",
                    "id": "16285353",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350577456\n \n \n   I updated this now #1397 is merged. But, I could not really simplify the code to just use the new `'field_name'` as I suppose we still want to be able to read in metadata written by older versions of arrow? \r\n   \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T20:04:17.848+0000",
                    "updated": "2017-12-10T20:04:17.848+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285361",
                    "id": "16285361",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350579429\n \n \n   Added a test that a parquet file written by arrow 0.7.1 is correctly read.\r\n   \r\n   @cpcloud @wesm @xhochy this is ready again for review\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T20:33:05.895+0000",
                    "updated": "2017-12-10T20:33:05.895+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285363",
                    "id": "16285363",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350579660\n \n \n   For reference, the test file is written as:\r\n   \r\n   ```\r\n   In [114]: pa.__version__\r\n   Out[114]: '0.7.1'\r\n   \r\n   In [117]: df = pd.DataFrame({\r\n        ...:             'a': [1, 2, 3],\r\n        ...:             'b': [.1, .2, .3], 'c': pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')})\r\n   \r\n   In [118]: df.index = pd.MultiIndex.from_arrays([['a', 'b', 'c'], pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')], names=['index', None])\r\n   \r\n   In [119]: df\r\n   Out[119]: \r\n                                    a    b                         c\r\n   index                                                            \r\n   a     2017-01-01 00:00:00+01:00  1  0.1 2017-01-01 00:00:00+01:00\r\n   b     2017-01-02 00:00:00+01:00  2  0.2 2017-01-02 00:00:00+01:00\r\n   c     2017-01-03 00:00:00+01:00  3  0.3 2017-01-03 00:00:00+01:00\r\n   \r\n   In [120]: import pyarrow.parquet as pq\r\n   \r\n   In [123]: table = pa.Table.from_pandas(df)\r\n   \r\n   In [124]: table\r\n   Out[124]: \r\n   pyarrow.Table\r\n   a: int64\r\n   b: double\r\n   c: timestamp[ns, tz=Europe/Brussels]\r\n   index: string\r\n   __index_level_1__: timestamp[ns, tz=Europe/Brussels]\r\n   metadata\r\n   --------\r\n   {b'pandas': b'{\"index_columns\": [\"index\", \"__index_level_1__\"], \"pandas_versio'\r\n               b'n\": \"0.22.0.dev0+313.g7105339\", \"columns\": [{\"numpy_type\": \"int6'\r\n               b'4\", \"metadata\": null, \"pandas_type\": \"int64\", \"name\": \"a\"}, {\"nu'\r\n               b'mpy_type\": \"float64\", \"metadata\": null, \"pandas_type\": \"float64\"'\r\n               b', \"name\": \"b\"}, {\"numpy_type\": \"datetime64[ns, Europe/Brussels]\"'\r\n               b', \"metadata\": {\"timezone\": \"Europe/Brussels\"}, \"pandas_type\": \"d'\r\n               b'atetimetz\", \"name\": \"c\"}, {\"numpy_type\": \"object\", \"metadata\": n'\r\n               b'ull, \"pandas_type\": \"unicode\", \"name\": \"index\"}, {\"numpy_type\": '\r\n               b'\"datetime64[ns, Europe/Brussels]\", \"metadata\": {\"timezone\": \"Eur'\r\n               b'ope/Brussels\"}, \"pandas_type\": \"datetimetz\", \"name\": \"__index_le'\r\n               b'vel_1__\"}]}'}\r\n   \r\n   In [125]: pq.write_table(table, 'v0.7.1.column-metadata-handling.parquet')\r\n   ```\r\n   \r\n   (similar code to construct the dataframe is in the test to create the expected result)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T20:36:39.097+0000",
                    "updated": "2017-12-10T20:36:39.097+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285389",
                    "id": "16285389",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350584123\n \n \n   > We should probably remove the backwards compatibility code after some statute of limitations has passed\r\n   \r\n   To make this cleaner, I could also move all back compat-handling code to a function that takes a metadata object and rewrites it in a new form, so the rest of the code doesn't need to care about it, and it is easier to remove later on. If you would be interested in that, I can do that here, or in a new PR (as that is not release critical)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T21:46:19.767+0000",
                    "updated": "2017-12-10T21:46:19.767+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285397",
                    "id": "16285397",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "wesm commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350585186\n \n \n   No need to rock the boat here, I will merge this once the Appveyor build runs\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T22:01:37.134+0000",
                    "updated": "2017-12-10T22:01:37.134+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285413",
                    "id": "16285413",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "body": "Issue resolved by pull request 1386\n[https://github.com/apache/arrow/pull/1386]",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=wesm",
                        "name": "wesm",
                        "key": "wesmckinn",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=wesmckinn&avatarId=29931",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wesmckinn&avatarId=29931",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wesmckinn&avatarId=29931",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wesmckinn&avatarId=29931"
                        },
                        "displayName": "Wes McKinney",
                        "active": true,
                        "timeZone": "America/New_York"
                    },
                    "created": "2017-12-10T23:40:16.426+0000",
                    "updated": "2017-12-10T23:40:16.426+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285414",
                    "id": "16285414",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "wesm closed pull request #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386\n \n \n   \n\nThis is a PR merged from a forked repository.\nAs GitHub hides the original diff on merge, it is displayed below for\nthe sake of provenance:\n\nAs this is a foreign pull request (from a fork), the diff is supplied\nbelow (as it won't show otherwise due to GitHub magic):\n\ndiff --git a/python/pyarrow/pandas_compat.py b/python/pyarrow/pandas_compat.py\nindex 668048fd6..b5d395fe5 100644\n--- a/python/pyarrow/pandas_compat.py\n+++ b/python/pyarrow/pandas_compat.py\n@@ -641,19 +641,36 @@ def _add_any_metadata(table, pandas_metadata):\n \n     schema = table.schema\n \n+    index_columns = pandas_metadata['index_columns']\n+    n_index_levels = len(index_columns)\n+    n_columns = len(pandas_metadata['columns']) - n_index_levels\n+\n     # Add time zones\n     for i, col_meta in enumerate(pandas_metadata['columns']):\n-        if col_meta['pandas_type'] == 'datetimetz':\n-            col = table[i]\n-            converted = col.to_pandas()\n-            tz = col_meta['metadata']['timezone']\n-            tz_aware_type = pa.timestamp('ns', tz=tz)\n-            with_metadata = pa.Array.from_pandas(converted.values,\n-                                                 type=tz_aware_type)\n-\n-            field = pa.field(schema[i].name, tz_aware_type)\n-            modified_columns[i] = pa.Column.from_array(field,\n-                                                       with_metadata)\n+\n+        raw_name = col_meta.get('field_name')\n+        if not raw_name:\n+            # deal with metadata written with arrow < 0.8\n+            raw_name = col_meta['name']\n+            if i >= n_columns:\n+                # index columns\n+                raw_name = index_columns[i - n_columns]\n+            if raw_name is None:\n+                raw_name = 'None'\n+\n+        idx = schema.get_field_index(raw_name)\n+        if idx != -1:\n+            if col_meta['pandas_type'] == 'datetimetz':\n+                col = table[idx]\n+                converted = col.to_pandas()\n+                tz = col_meta['metadata']['timezone']\n+                tz_aware_type = pa.timestamp('ns', tz=tz)\n+                with_metadata = pa.Array.from_pandas(converted.values,\n+                                                     type=tz_aware_type)\n+\n+                field = pa.field(schema[idx].name, tz_aware_type)\n+                modified_columns[idx] = pa.Column.from_array(field,\n+                                                             with_metadata)\n \n     if len(modified_columns) > 0:\n         columns = []\ndiff --git a/python/pyarrow/tests/data/v0.7.1.column-metadata-handling.parquet b/python/pyarrow/tests/data/v0.7.1.column-metadata-handling.parquet\nnew file mode 100644\nindex 000000000..d48041f51\nBinary files /dev/null and b/python/pyarrow/tests/data/v0.7.1.column-metadata-handling.parquet differ\ndiff --git a/python/pyarrow/tests/test_convert_pandas.py b/python/pyarrow/tests/test_convert_pandas.py\nindex 97bbb6a17..7609d3488 100644\n--- a/python/pyarrow/tests/test_convert_pandas.py\n+++ b/python/pyarrow/tests/test_convert_pandas.py\n@@ -1286,6 +1286,37 @@ def test_array_from_pandas_typed_array_with_mask(self, t, data, expected):\n         assert pa.Array.from_pandas(expected,\n                                     type=pa.list_(t())).equals(result)\n \n+    def test_table_column_subset_metadata(self):\n+        # ARROW-1883\n+        df = pd.DataFrame({\n+            'a': [1, 2, 3],\n+            'b': pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')})\n+        table = pa.Table.from_pandas(df)\n+\n+        table_subset = table.remove_column(1)\n+        result = table_subset.to_pandas()\n+        tm.assert_frame_equal(result, df[['a']])\n+\n+        table_subset2 = table_subset.remove_column(1)\n+        result = table_subset2.to_pandas()\n+        tm.assert_frame_equal(result, df[['a']])\n+\n+        # non-default index\n+        for index in [\n+                pd.Index(['a', 'b', 'c'], name='index'),\n+                pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')]:\n+            df = pd.DataFrame({'a': [1, 2, 3],\n+                               'b': [.1, .2, .3]}, index=index)\n+            table = pa.Table.from_pandas(df)\n+\n+            table_subset = table.remove_column(1)\n+            result = table_subset.to_pandas()\n+            tm.assert_frame_equal(result, df[['a']])\n+\n+            table_subset2 = table_subset.remove_column(1)\n+            result = table_subset2.to_pandas()\n+            tm.assert_frame_equal(result, df[['a']].reset_index(drop=True))\n+\n \n def _fully_loaded_dataframe_example():\n     from distutils.version import LooseVersion\ndiff --git a/python/pyarrow/tests/test_parquet.py b/python/pyarrow/tests/test_parquet.py\nindex 2543e7d17..79e24d8d4 100644\n--- a/python/pyarrow/tests/test_parquet.py\n+++ b/python/pyarrow/tests/test_parquet.py\n@@ -1570,6 +1570,29 @@ def test_backwards_compatible_index_multi_level_some_named():\n     tm.assert_frame_equal(result, expected)\n \n \n+@parquet\n+def test_backwards_compatible_column_metadata_handling():\n+    expected = pd.DataFrame(\n+        {'a': [1, 2, 3], 'b': [.1, .2, .3],\n+         'c': pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')})\n+    expected.index = pd.MultiIndex.from_arrays(\n+        [['a', 'b', 'c'],\n+         pd.date_range(\"2017-01-01\", periods=3, tz='Europe/Brussels')],\n+        names=['index', None])\n+\n+    path = os.path.join(\n+        os.path.dirname(__file__), 'data',\n+        'v0.7.1.column-metadata-handling.parquet'\n+    )\n+    t = _read_table(path)\n+    result = t.to_pandas()\n+    tm.assert_frame_equal(result, expected)\n+\n+    t = _read_table(path, columns=['a'])\n+    result = t.to_pandas()\n+    tm.assert_frame_equal(result, expected[['a']].reset_index(drop=True))\n+\n+\n def test_decimal_roundtrip(tmpdir):\n     num_values = 10\n \n\n\n \n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T23:40:18.500+0000",
                    "updated": "2017-12-10T23:40:18.500+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285415",
                    "id": "16285415",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "wesm commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350591546\n \n \n   thanks @jorisvandenbossche!!\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T23:40:40.065+0000",
                    "updated": "2017-12-10T23:40:40.065+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13122572/comment/16285416",
                    "id": "16285416",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "body": "jorisvandenbossche commented on issue #1386: ARROW-1883: [Python] Fix handling of metadata in to_pandas when not all columns are present\nURL: https://github.com/apache/arrow/pull/1386#issuecomment-350591617\n \n \n   You're welcome! And happy to have a first patch to arrow :)\n\n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=githubbot",
                        "name": "githubbot",
                        "key": "githubbot",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
                        },
                        "displayName": "ASF GitHub Bot",
                        "active": true,
                        "timeZone": "Etc/UTC"
                    },
                    "created": "2017-12-10T23:41:53.220+0000",
                    "updated": "2017-12-10T23:41:53.220+0000"
                }
            ],
            "maxResults": 18,
            "total": 18,
            "startAt": 0
        },
        "customfield_12311820": "0|i3nhyv:",
        "customfield_12314139": null
    }
}