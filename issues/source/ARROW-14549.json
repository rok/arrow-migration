{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13409601",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13409601",
    "key": "ARROW-14549",
    "fields": {
        "fixVersions": [],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/8",
            "id": "8",
            "description": "The described issue is not actually a problem - it is as designed.",
            "name": "Not A Problem"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "0.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": null,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12350323",
                "id": "12350323",
                "description": "",
                "name": "6.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-10-26"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [],
        "customfield_12313825": null,
        "assignee": null,
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/6",
            "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
            "name": "Closed",
            "id": "6",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12328933",
                "id": "12328933",
                "name": "Java"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": null,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=hu6360567",
            "name": "hu6360567",
            "key": "hu6360567",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=hu6360567&avatarId=47724",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hu6360567&avatarId=47724",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hu6360567&avatarId=47724",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hu6360567&avatarId=47724"
            },
            "displayName": "Wenbo Hu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=hu6360567",
            "name": "hu6360567",
            "key": "hu6360567",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=hu6360567&avatarId=47724",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hu6360567&avatarId=47724",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hu6360567&avatarId=47724",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hu6360567&avatarId=47724"
            },
            "displayName": "Wenbo Hu",
            "active": true,
            "timeZone": "Asia/Shanghai"
        },
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 0,
            "total": 0
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14549/votes",
            "votes": 0,
            "hasVoted": false
        },
        "worklog": {
            "startAt": 0,
            "maxResults": 20,
            "total": 0,
            "worklogs": []
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": null,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@7a809a8b[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2797f6b0[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3d26c8d4[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@259c9bb6[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@65b219da[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@44a888a6[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4fc3988f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@ec3ebea[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7b4a4f21[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@7b271556[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@28f3ed5d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@39fecf12[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": null,
        "customfield_12312520": null,
        "customfield_12312521": "Sat Aug 27 14:41:43 UTC 2022",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2022-02-25T18:22:33.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-14549/watchers",
            "watchCount": 2,
            "isWatching": true
        },
        "created": "2021-11-02T07:45:55.000+0000",
        "updated": "2022-08-27T14:41:43.000+0000",
        "timeoriginalestimate": null,
        "description": "I'm using `arrow-jdbc` to convert query result from JDBC to arrow.\r\n But the following code, unexpected behaivor happens.\r\n\r\nAssuming a sqlite db, the 2nd row of col_2 and col_3 are null.\r\n|col_1|col_2|col_3|\r\n|1|abc|3.14|\r\n|2|NULL|NULL|\r\n\r\nAs document suggests,\r\n{quote}populated data over and over into the same VectorSchemaRoot in a stream of batches rather than creating a new VectorSchemaRoot instance each time.\r\n{quote}\r\n*JdbcToArrowConfig* is set to reuse root.\r\n{code:java}\r\npublic void querySql(String query, QueryOption option) throws Exception {\r\n try (final java.sql.Connection conn = connectContainer.getConnection();\r\n     final Statement stmt = conn.createStatement();\r\n     final ResultSet rs = stmt.executeQuery(query)\r\n ) {\r\n // create config with reuse schema root and custom batch size from option\r\n     final JdbcToArrowConfig config = new JdbcToArrowConfigBuilder().setAllocator(new RootAllocator()).setCalendar(JdbcToArrowUtils.getUtcCalendar())\r\n     .setTargetBatchSize(option.getBatchSize()).setReuseVectorSchemaRoot(true).build();\r\n\r\n  final ArrowVectorIterator iterator = JdbcToArrow.sqlToArrowVectorIterator(rs, config);\r\n   while (iterator.hasNext()){ // retrieve result from iterator \r\n\u00a0\u00a0\u00a0\u00a0\u00a0final VectorSchemaRoot root = iterator.next(); option.getCallback().handleBatchResult(root); \r\n     root.allocateNew(); // it has to be allocate new \r\n\u00a0\u00a0\u00a0}\r\n  } catch (java.lang.Exception e){ throw new Exception(e.getMessage()); }\r\n }\r\n \r\n ......\r\n // batch_size is set to 1, then callback is called twice.\r\n QueryOptions options = new QueryOption(1, \r\n     root -> {\r\n // if printer is not set, get schema, write header\r\n if (printer == null) { \r\n      final String[] headers = root.getSchema().getFields().stream().map(Field::getName).toArray(String[]::new); \r\n      printer = new CSVPrinter(writer, CSVFormat.Builder.create(CSVFormat.DEFAULT).setHeader(headers).build()); \r\n  }\r\n \r\n final int rows = root.getRowCount();\r\n final List<FieldVector> fieldVectors = root.getFieldVectors();\r\n \r\n // iterate over rows\r\n for (int i = 0; i < rows; i++) { \r\n      final int rowId = i; \r\n      final List<String> row = fieldVectors.stream().map(v -> v.getObject(rowId)).map(String::valueOf).collect(Collectors.toList()); printer.printRecord(row); \r\n  }\r\n });\r\n \r\n connection.querySql(\"SELECT * FROM test_db\", options);\r\n ......\r\n{code}\r\nif `root.allocateNew()` is called, the csv file is expected,\r\n ```\r\n column_1,column_2,column_3\r\n 1,abc,3.14\r\n 2,null,null\r\n ```\r\n Otherwise, null values of 2nd row are remaining the same values of 1st row\r\n ```\r\n column_1,column_2,column_3\r\n 1,abc,3.14\r\n 2,abc,3.14\r\n ```\r\n\r\n**Question: Is expected to call `allocateNew` every time when the schema root is reused?**\r\n\r\nBy without reusing schemaroot, the following code works as expected.\r\n{code:java}\r\n public void querySql(String query, QueryOption option) throws Exception {\r\n try (final java.sql.Connection conn = connectContainer.getConnection();\r\n     final Statement stmt = conn.createStatement();\r\n     final ResultSet rs = stmt.executeQuery(query)) {\r\n     // create config without reuse schema root and custom batch size from option\r\n     final JdbcToArrowConfig config = new JdbcToArrowConfigBuilder().setAllocator(new RootAllocator()).setCalendar(JdbcToArrowUtils.getUtcCalendar())\r\n     .setTargetBatchSize(option.getBatchSize()).setReuseVectorSchemaRoot(false).build();\r\n \r\n     final ArrowVectorIterator iterator = JdbcToArrow.sqlToArrowVectorIterator(rs, config);\r\n     while (iterator.hasNext()) {\r\n     // retrieve result from iterator\r\n     try (VectorSchemaRoot root = iterator.next()) { \r\n          option.getCallback().handleBatchResult(root); root.allocateNew(); \r\n      }\r\n   }\r\n } catch (java.lang.Exception e) { throw new Exception(e.getMessage()); }\r\n\r\n}\r\n\r\n{code}",
        "customfield_10010": null,
        "timetracking": {},
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "attachment": [],
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "VectorSchemaRoot is not refreshed when value is null",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": null,
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "comment": {
            "comments": [
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13409601/comment/17498249",
                    "id": "17498249",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=bryanc",
                        "name": "bryanc",
                        "key": "bryanc",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=bryanc&avatarId=23479",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bryanc&avatarId=23479",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bryanc&avatarId=23479",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bryanc&avatarId=23479"
                        },
                        "displayName": "Bryan Cutler",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "body": "[~hu6360567] Calling `allocateNew()` will create new buffers, which is one way to clear previous results. If you don't want to allocate any new memory, you would need to to zero out all the vectors by calling `zeroVector()` and `setValueCount(0)`. If you don't do either of these, the incorrect data you see is expected.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=bryanc",
                        "name": "bryanc",
                        "key": "bryanc",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=bryanc&avatarId=23479",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bryanc&avatarId=23479",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bryanc&avatarId=23479",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bryanc&avatarId=23479"
                        },
                        "displayName": "Bryan Cutler",
                        "active": true,
                        "timeZone": "America/Los_Angeles"
                    },
                    "created": "2022-02-25T18:21:49.335+0000",
                    "updated": "2022-02-25T18:22:23.998+0000"
                },
                {
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13409601/comment/17585806",
                    "id": "17585806",
                    "author": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=toddfarmer",
                        "name": "toddfarmer",
                        "key": "JIRAUSER288796",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=39935",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=39935",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=39935",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=39935"
                        },
                        "displayName": "Todd Farmer",
                        "active": true,
                        "timeZone": "America/Boise"
                    },
                    "body": "Transitioning issue from Resolved to Closed to based on resolution field value.",
                    "updateAuthor": {
                        "self": "https://issues.apache.org/jira/rest/api/2/user?username=toddfarmer",
                        "name": "toddfarmer",
                        "key": "JIRAUSER288796",
                        "avatarUrls": {
                            "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=39935",
                            "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=39935",
                            "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=39935",
                            "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=39935"
                        },
                        "displayName": "Todd Farmer",
                        "active": true,
                        "timeZone": "America/Boise"
                    },
                    "created": "2022-08-27T14:41:43.385+0000",
                    "updated": "2022-08-27T14:41:43.385+0000"
                }
            ],
            "maxResults": 2,
            "total": 2,
            "startAt": 0
        },
        "customfield_12311820": "0|z0wd74:",
        "customfield_12314139": null
    }
}