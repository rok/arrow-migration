{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "id": "13329177",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13329177",
    "key": "ARROW-10080",
    "fields": {
        "fixVersions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12348823",
                "id": "12348823",
                "description": "",
                "name": "3.0.0",
                "archived": false,
                "released": true,
                "releaseDate": "2021-01-25"
            }
        ],
        "resolution": {
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
            "id": "1",
            "description": "A fix for this issue is checked into the tree and tested.",
            "name": "Fixed"
        },
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12312321": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312326": null,
        "customfield_12310300": null,
        "customfield_12312327": null,
        "customfield_12312324": null,
        "customfield_12312720": null,
        "customfield_12312325": null,
        "lastViewed": null,
        "priority": {
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "name": "Major",
            "id": "3"
        },
        "labels": [
            "pull-request-available"
        ],
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12313422": "false",
        "customfield_12310310": "1.0",
        "customfield_12312331": null,
        "customfield_12312332": null,
        "aggregatetimeoriginalestimate": null,
        "timeestimate": 0,
        "customfield_12312330": null,
        "versions": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/version/12348647",
                "id": "12348647",
                "name": "1.0.1",
                "archived": false,
                "released": true,
                "releaseDate": "2020-08-21"
            }
        ],
        "customfield_12311120": null,
        "customfield_12313826": null,
        "customfield_12312339": null,
        "issuelinks": [
            {
                "id": "12605739",
                "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12605739",
                "type": {
                    "id": "10030",
                    "name": "Reference",
                    "inward": "is related to",
                    "outward": "relates to",
                    "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
                },
                "inwardIssue": {
                    "id": "13325823",
                    "key": "ARROW-9903",
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/13325823",
                    "fields": {
                        "summary": "[R] open_dataset freezes opening feather files on Windows",
                        "status": {
                            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
                            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
                            "name": "Resolved",
                            "id": "5",
                            "statusCategory": {
                                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                                "id": 3,
                                "key": "done",
                                "colorName": "green",
                                "name": "Done"
                            }
                        },
                        "priority": {
                            "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                            "name": "Major",
                            "id": "3"
                        },
                        "issuetype": {
                            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                            "id": "1",
                            "description": "A problem which impairs or prevents the functions of the product.",
                            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                            "name": "Bug",
                            "subtask": false,
                            "avatarId": 21133
                        }
                    }
                }
            }
        ],
        "customfield_12313825": null,
        "assignee": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=bkietz",
            "name": "bkietz",
            "key": "bkietz",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=bkietz&avatarId=37277",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bkietz&avatarId=37277",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bkietz&avatarId=37277",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bkietz&avatarId=37277"
            },
            "displayName": "Ben Kietzman",
            "active": true,
            "timeZone": "America/New_York"
        },
        "customfield_12312337": null,
        "customfield_12313823": null,
        "customfield_12312338": null,
        "customfield_12311920": null,
        "customfield_12313822": null,
        "customfield_12312335": null,
        "customfield_12313821": null,
        "customfield_12312336": null,
        "customfield_12313820": null,
        "status": {
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "name": "Resolved",
            "id": "5",
            "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
            }
        },
        "components": [
            {
                "self": "https://issues.apache.org/jira/rest/api/2/component/12333008",
                "id": "12333008",
                "name": "R"
            }
        ],
        "customfield_12312026": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "aggregatetimeestimate": 0,
        "customfield_12312022": null,
        "customfield_12310921": null,
        "customfield_12310920": "9223372036854775807",
        "customfield_12312823": null,
        "creator": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=svraka",
            "name": "svraka",
            "key": "svraka",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=svraka&avatarId=44226",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=svraka&avatarId=44226",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=svraka&avatarId=44226",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=svraka&avatarId=44226"
            },
            "displayName": "Andr\u00e1s Svraka",
            "active": true,
            "timeZone": "Europe/Budapest"
        },
        "subtasks": [],
        "reporter": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=svraka",
            "name": "svraka",
            "key": "svraka",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=svraka&avatarId=44226",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=svraka&avatarId=44226",
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=svraka&avatarId=44226",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=svraka&avatarId=44226"
            },
            "displayName": "Andr\u00e1s Svraka",
            "active": true,
            "timeZone": "Europe/Budapest"
        },
        "aggregateprogress": {
            "progress": 14400,
            "total": 14400,
            "percent": 100
        },
        "customfield_12313520": null,
        "customfield_12310250": null,
        "progress": {
            "progress": 14400,
            "total": 14400,
            "percent": 100
        },
        "customfield_12313924": null,
        "votes": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-10080/votes",
            "votes": 0,
            "hasVoted": false
        },
        "customfield_12313920": null,
        "issuetype": {
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "id": "1",
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "name": "Bug",
            "subtask": false,
            "avatarId": 21133
        },
        "timespent": 14400,
        "customfield_12314020": "{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@74a8e442[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@70a650fd[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5a863321[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@1865a134[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@911663d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@1ab89d6f[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@71ccaa22[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4415d92e[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@46b77f1f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@18bad143[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@cb3e5cc[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@668591dd[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}",
        "customfield_12314141": null,
        "customfield_12314140": null,
        "project": {
            "self": "https://issues.apache.org/jira/rest/api/2/project/12319525",
            "id": "12319525",
            "key": "ARROW",
            "name": "Apache Arrow",
            "projectTypeKey": "software",
            "avatarUrls": {
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12319525&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12319525&avatarId=10011",
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12319525&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12319525&avatarId=10011"
            },
            "projectCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/13960",
                "id": "13960",
                "description": "Apache Arrow",
                "name": "Arrow"
            }
        },
        "aggregatetimespent": 14400,
        "customfield_12312520": null,
        "customfield_12312521": "Fri Aug 20 13:05:52 UTC 2021",
        "customfield_12314422": null,
        "customfield_12314421": null,
        "customfield_12314146": null,
        "customfield_12314420": null,
        "customfield_12314145": null,
        "customfield_12314144": null,
        "customfield_12314143": null,
        "resolutiondate": "2020-10-30T01:05:22.000+0000",
        "workratio": -1,
        "customfield_12312923": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "watches": {
            "self": "https://issues.apache.org/jira/rest/api/2/issue/ARROW-10080/watchers",
            "watchCount": 6,
            "isWatching": false
        },
        "created": "2020-09-24T10:11:07.000+0000",
        "updated": "2021-08-20T13:05:52.000+0000",
        "timeoriginalestimate": null,
        "description": "I\u2019m having problems when {{collect()}}-ing Arrow data sources into data frames that are close in size to the available memory on the machine. Consider the following workflow. I have a dataset which I want to query so that at some point in needs to be {{collect()}}-ed but at the same I\u2019m also reducing the result. During the intermediate step the entire data frame fits into memory, and the following code runs without any problems.\r\n{code:r}\r\ntest_ds <- \"memory_test\"\r\n\r\nds1 <- open_dataset(test_ds) %>%\r\n  collect() %>%\r\n  dim()\r\n{code}\r\nHowever, running the same code in the same R session again fails with R running out of memory.\r\n{code:r}\r\nds1 <- open_dataset(test_ds) %>%\r\n  collect() %>%\r\n  dim()\r\n{code}\r\nThe example might be a but contrived but you can easily imagine a workflow where different queries are ran on a dataset and the reduced results are stored.\r\n\r\nAs far as I understand, R is a garbage collected language, and in this case there aren\u2019t any references left to large objects in memory. And indeed, the second query succeeds when manually forcing a garbage collection.\r\n\r\nIs this the expected behaviour from Arrow?\r\n\r\nI know, this is quite hard to reproduce, as the exact dataset size required to trigger this behaviour depends on the particular machine but I prepared a reproducible example in [this gist|https://gist.github.com/svraka/c63fca51c6cc50020551e2319ff652b7], that should give the same result on Ubuntu 20.04 with 1GB RAM and no swap. See attachment for {{sessionInfo()}} output. I ran it on a Digitalocean {{s-1vcpu-1gb}} droplet.\r\n\r\nFirst, let\u2019s create a a partitioned Arrow dataset:\r\n{code:java}\r\n$ Rscript ds_prep.R 1000000 5\r\n{code}\r\nThe first command line argument gives the number of rows in each partition, and second gives the number of partitions. The parameters are set so that the entire dataset should fit into memory.\r\n\r\nThen running the two queries fails:\r\n{code:java}\r\n$ Rscript ds_read.R\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nRunning query, 2nd try...\r\n[1]    11151 killed     Rscript ds_read.R\r\n{code}\r\nHowever, when forcing a {{gc()}} (which I\u2019m controlling here with a command line argument), it succeeds:\r\n{code:java}\r\n$ Rscript ds_read.R 1\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nrunning gc() ...\r\n          used (Mb) gc trigger  (Mb) max used  (Mb)\r\nNcells  703052 37.6    1571691  84.0  1038494  55.5\r\nVcells 1179578  9.0   36405636 277.8 41188956 314.3\r\nRunning query, 2nd try...\r\nds size, 2nd run: 56\r\n{code}\r\nIn general, [one shouldn\u2019t have to use {{gc()}} manually|https://adv-r.hadley.nz/names-values.html#gc]. Interestingly, setting R\u2019s garbage collection more aggressive (see {{?Memory}}) doesn\u2019t help either:\r\n{code:java}\r\n$ R_GC_MEM_GROW=0 Rscript ds_read.R\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nRunning query, 2nd try...\r\n[1]    11422 killed     Rscript ds_read.R\r\n{code}\r\nI didn\u2019t try to reproduce this problem on macOS, as my Mac would probably start swapping furiously but I managed to reproduce it on a Windows 7 machine with practically no swap. Of course the parameters are different, and the error messages are presumably system specific.\r\n{code:java}\r\n$ Rscript ds_prep.R 1000000 40\r\n$ Rscript ds_read.R\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nRunning query, 2nd try...\r\nError in dataset___Scanner__ToTable(self) :\r\n  IOError: Out of memory: malloc of size 524288 failed\r\nCalls: collect ... shared_ptr -> shared_ptr_is_null -> dataset___Scanner__ToTable\r\nExecution halted\r\n$ Rscript ds_read.R 1\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nrunning gc() ...\r\n          used (Mb) gc trigger   (Mb)  max used (Mb)\r\nNcells  688789 36.8    1198030   64.0   1198030   64\r\nVcells 1109451  8.5  271538343 2071.7 321118845 2450\r\nRunning query, 2nd try...\r\nds size, 2nd run: 56\r\n$ R_GC_MEM_GROW=0 Rscript ds_read.R\r\nRunning query, 1st try...\r\nds size, 1st run: 56\r\nRunning query, 2nd try...\r\nError in dataset___Scanner__ToTable(self) :\r\n  IOError: Out of memory: malloc of size 524288 failed\r\nCalls: collect ... shared_ptr -> shared_ptr_is_null -> dataset___Scanner__ToTable\r\nExecution halted\r\n{code}",
        "customfield_10010": null,
        "customfield_12314523": null,
        "customfield_12314127": null,
        "customfield_12314522": null,
        "customfield_12314126": null,
        "customfield_12314521": null,
        "customfield_12314125": null,
        "customfield_12314520": null,
        "customfield_12314124": null,
        "customfield_12312340": null,
        "customfield_12314123": null,
        "customfield_12312341": null,
        "customfield_12312220": null,
        "customfield_12314122": null,
        "customfield_12314121": null,
        "customfield_12314120": null,
        "customfield_12314129": null,
        "customfield_12314524": null,
        "customfield_12314128": null,
        "summary": "[R] Arrow does not release unused memory",
        "customfield_12314130": null,
        "customfield_12310291": null,
        "customfield_12310290": null,
        "customfield_12314138": null,
        "customfield_12314137": null,
        "environment": "Linux, Windows",
        "customfield_12314136": null,
        "customfield_12314135": null,
        "customfield_12311020": null,
        "customfield_12314134": null,
        "duedate": null,
        "customfield_12314132": null,
        "customfield_12314131": null,
        "customfield_12311820": "0|z0ivmo:",
        "customfield_12314139": null
    }
}