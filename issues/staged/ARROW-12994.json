{
    "issue": {
        "title": "[R] Fix tests that assume UTC local tz",
        "body": "***Note**: This issue was originally created as [ARROW-12994](https://issues.apache.org/jira/browse/ARROW-12994). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nHere's the problem I detected while  triaging tickets. \r\n\r\nThis was run locally after merging from apache/arrow at commit 8773b9d and re-building both Arrow library and Arrow R package.\r\n\r\n```r\n\r\nlibrary(arrow)\r\n#> See arrow_info() for available features\r\n#> \r\n#> Attaching package: 'arrow'\r\n#> The following object is masked from 'package:utils':\r\n#> \r\n#>     timestamp\r\nlibrary(dplyr)\r\n#> \r\n#> Attaching package: 'dplyr'\r\n#> The following objects are masked from 'package:stats':\r\n#> \r\n#>     filter, lag\r\n#> The following objects are masked from 'package:base':\r\n#> \r\n#>     intersect, setdiff, setequal, union\r\nlibrary(testthat)\r\n#> \r\n#> Attaching package: 'testthat'\r\n#> The following object is masked from 'package:dplyr':\r\n#> \r\n#>     matches\r\n#> The following object is masked from 'package:arrow':\r\n#> \r\n#>     matches\r\n\r\ntstring <- tibble(x = c(\"08-05-2008\", NA))\r\ntstamp <- tibble(x = c(strptime(\"08-05-2008\", format = \"%m-%d-%Y\"), NA))\r\n\r\nexpect_equal(\r\n  tstring %>%\r\n    Table$create() %>%\r\n    mutate(\r\n      x = strptime(x, format = \"%m-%d-%Y\")\r\n    ) %>%\r\n    collect(),\r\n  tstamp,\r\n  check.tzone = FALSE\r\n)\r\n#> Error: `%>%`(...) not equal to `tstamp`.\r\n#> Component \"x\": Mean absolute difference: 14400\r\n```\r\n\r\nWe can see that the dates are different by exact 4 hours by removing the expectation:\r\n\r\n```r\n\r\nlibrary(arrow)\r\n#> See arrow_info() for available features\r\n#> \r\n#> Attaching package: 'arrow'\r\n#> The following object is masked from 'package:utils':\r\n#> \r\n#>     timestamp\r\nlibrary(dplyr)\r\n#> \r\n#> Attaching package: 'dplyr'\r\n#> The following objects are masked from 'package:stats':\r\n#> \r\n#>     filter, lag\r\n#> The following objects are masked from 'package:base':\r\n#> \r\n#>     intersect, setdiff, setequal, union\r\nlibrary(testthat)\r\n#> \r\n#> Attaching package: 'testthat'\r\n#> The following object is masked from 'package:dplyr':\r\n#> \r\n#>     matches\r\n#> The following object is masked from 'package:arrow':\r\n#> \r\n#>     matches\r\n\r\ntstring <- tibble(x = c(\"08-05-2008\", NA))\r\ntstamp <- tibble(x = c(strptime(\"08-05-2008\", format = \"%m-%d-%Y\"), NA))\r\n\r\ntstring %>%\r\n  Table$create() %>%\r\n  mutate(\r\n    x = strptime(x, format = \"%m-%d-%Y\")\r\n  ) %>%\r\n  collect()\r\n#> # A tibble: 2 x 1\r\n#>   x                  \r\n#>   <dttm>             \r\n#> 1 2008-08-04 20:00:00\r\n#> 2 NA\r\n\r\ntstamp\r\n#> # A tibble: 2 x 1\r\n#>   x                  \r\n#>   <dttm>             \r\n#> 1 2008-08-05 00:00:00\r\n#> 2 NA\r\n```\r\n\r\n_Created on 2021-06-07 by the [reprex package](https://reprex.tidyverse.org) (v2.0.0)_\r\n",
        "created_at": "2021-06-07T16:17:06.000Z",
        "updated_at": "2021-07-13T14:34:03.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: R",
            "Type: task"
        ],
        "closed": true,
        "closed_at": "2021-07-13T14:33:55.000Z"
    },
    "comments": [
        {
            "created_at": "2021-06-07T22:42:56.497Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-12994?focusedCommentId=17358898) by Mauricio 'Pach\u00e1' Vargas Sep\u00falveda (pachamaltese):*\n```r\n\r\n\u2500 Session info \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n setting  value                       \r\n version  R version 4.1.0 (2021-05-18)\r\n os       Ubuntu 20.04.2 LTS          \r\n system   x86_64, linux-gnu           \r\n ui       RStudio                     \r\n language (EN)                        \r\n collate  en_US.UTF-8                 \r\n ctype    en_US.UTF-8                 \r\n tz       America/Santiago            \r\n date     2021-06-07                  \r\n\r\n\u2500 Packages \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n package     * version    date       lib source        \r\n arrow       * 4.0.1.9000 2021-06-07 [1] local         \r\n assertthat    0.2.1      2019-03-21 [1] CRAN (R 4.1.0)\r\n bit           4.0.4      2020-08-04 [1] CRAN (R 4.1.0)\r\n bit64         4.0.5      2020-08-30 [1] CRAN (R 4.1.0)\r\n cachem        1.0.5      2021-05-15 [1] CRAN (R 4.1.0)\r\n callr         3.7.0      2021-04-20 [1] CRAN (R 4.1.0)\r\n cli           2.5.0      2021-04-26 [1] CRAN (R 4.1.0)\r\n crayon        1.4.1      2021-02-08 [1] CRAN (R 4.1.0)\r\n DBI           1.1.1      2021-01-15 [1] CRAN (R 4.1.0)\r\n desc          1.3.0      2021-03-05 [1] CRAN (R 4.1.0)\r\n devtools    * 2.4.1      2021-05-05 [1] CRAN (R 4.1.0)\r\n dplyr       * 1.0.6      2021-05-05 [1] CRAN (R 4.1.0)\r\n ellipsis      0.3.2      2021-04-29 [1] CRAN (R 4.1.0)\r\n fansi         0.5.0      2021-05-25 [1] CRAN (R 4.1.0)\r\n fastmap       1.1.0      2021-01-25 [1] CRAN (R 4.1.0)\r\n fs            1.5.0      2020-07-31 [1] CRAN (R 4.1.0)\r\n generics      0.1.0      2020-10-31 [1] CRAN (R 4.1.0)\r\n glue          1.4.2      2020-08-27 [1] CRAN (R 4.1.0)\r\n lifecycle     1.0.0      2021-02-15 [1] CRAN (R 4.1.0)\r\n magrittr      2.0.1      2020-11-17 [1] CRAN (R 4.1.0)\r\n memoise       2.0.0      2021-01-26 [1] CRAN (R 4.1.0)\r\n pillar        1.6.1      2021-05-16 [1] CRAN (R 4.1.0)\r\n pkgbuild      1.2.0      2020-12-15 [1] CRAN (R 4.1.0)\r\n pkgconfig     2.0.3      2019-09-22 [1] CRAN (R 4.1.0)\r\n pkgload       1.2.1      2021-04-06 [1] CRAN (R 4.1.0)\r\n prettyunits   1.1.1      2020-01-24 [1] CRAN (R 4.1.0)\r\n processx      3.5.2      2021-04-30 [1] CRAN (R 4.1.0)\r\n ps            1.6.0      2021-02-28 [1] CRAN (R 4.1.0)\r\n purrr         0.3.4      2020-04-17 [1] CRAN (R 4.1.0)\r\n R6            2.5.0      2020-10-28 [1] CRAN (R 4.1.0)\r\n remotes       2.3.0      2021-04-01 [1] CRAN (R 4.1.0)\r\n rlang         0.4.11     2021-04-30 [1] CRAN (R 4.1.0)\r\n rprojroot     2.0.2      2020-11-15 [1] CRAN (R 4.1.0)\r\n rstudioapi    0.13       2020-11-12 [1] CRAN (R 4.1.0)\r\n sessioninfo   1.1.1      2018-11-05 [1] CRAN (R 4.1.0)\r\n testthat    * 3.0.2      2021-02-14 [1] CRAN (R 4.1.0)\r\n tibble        3.1.2      2021-05-16 [1] CRAN (R 4.1.0)\r\n tidyselect    1.1.1      2021-04-30 [1] CRAN (R 4.1.0)\r\n usethis     * 2.0.1      2021-02-10 [1] CRAN (R 4.1.0)\r\n utf8          1.2.1      2021-03-12 [1] CRAN (R 4.1.0)\r\n vctrs         0.3.8      2021-04-29 [1] CRAN (R 4.1.0)\r\n withr         2.4.2      2021-04-18 [1] CRAN (R 4.1.0)\r\n\r\n[1] /home/pacha/R/x86_64-pc-linux-gnu-library/4.1\r\n[2] /usr/local/lib/R/site-library\r\n[3] /usr/lib/R/site-library\r\n[4] /usr/lib/R/library\r\n```"
        },
        {
            "created_at": "2021-06-09T12:56:45.906Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-12994?focusedCommentId=17360045) by Nicola Crane (thisisnic):*\n`[~pachamaltese]` - this test fails locally for you and I but not on the CI, as we have non-UTC timezones.\u00a0\u00a0 The docs for the `tz` argument of `strptime` say \"A character string specifying the time zone to be used for the conversion. System-specific (see as.POSIXlt), but \"\" is the current time zone\".\u00a0 The default timezone on the CI is UTC, so the tests will pass there, whereas you and I are both in non-UTC timezones, so we get local failures.\u00a0\r\n\r\nHave submitted a PR which specifies tz=\"UTC\" which should fix this."
        },
        {
            "created_at": "2021-07-12T14:01:47.037Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-12994?focusedCommentId=17379194) by Jonathan Keane (jonkeane):*\nIt looks like we've acquired a few more of these that fail due to local timezone issues, would be good to clean them up in this same way:\r\n\r\n```Java\n\r\n\u2550\u2550 Failed \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\u2500\u2500 1. Failure (test-dplyr-lubridate.R:153:3): extract hour from date \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n`object` not equivalent to `expected`.\r\nComponent \u201cx\u201d: Mean relative difference: 1\r\nBacktrace:\r\n 1. arrow:::expect_dplyr_equal(...) test-dplyr-lubridate.R:153:2\r\n 2. arrow:::expect_equivalent(via_batch, expected, ...) helper-expectation.R:88:4\r\n 3. testthat::expect_equivalent(object, expected, ...) helper-expectation.R:46:2\r\n\r\n\u2500\u2500 2. Failure (test-dplyr-lubridate.R:153:3): extract hour from date \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n`object` not equivalent to `expected`.\r\nComponent \u201cx\u201d: Mean relative difference: 1\r\nBacktrace:\r\n 1. arrow:::expect_dplyr_equal(...) test-dplyr-lubridate.R:153:2\r\n 2. arrow:::expect_equivalent(via_table, expected, ...) helper-expectation.R:98:4\r\n 3. testthat::expect_equivalent(object, expected, ...) helper-expectation.R:46:2\r\n\r\n\u2500\u2500 3. Failure (test-dplyr-string-functions.R:706:3): strptime \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n`%>%`(...) not equal to `tstamp`.\r\nComponent \u201cx\u201d: Mean absolute difference: 18000\r\n```"
        },
        {
            "created_at": "2021-07-13T14:33:55.547Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-12994?focusedCommentId=17379924) by Neal Richardson (npr):*\nIssue resolved by pull request 10706\n<https://github.com/apache/arrow/pull/10706>"
        }
    ]
}