{
    "issue": {
        "title": "[R] dplyr queries create locks on FileSystemDataset files",
        "body": "***Note**: This issue was originally created as [ARROW-17002](https://issues.apache.org/jira/browse/ARROW-17002). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI think that dplyr queries on FileSystemDataset objects will create locks that persist unnecessarily. This issue only seems to occur on Windows. I'm using Windows 10. Calling the garbage collector after the dplyr query seems to release the lock.\r\n```r\n\r\nlibrary(arrow)\r\nlibrary(dplyr)\r\n\r\n# I can delete an arrow dataset that has been opened\r\nwrite_dataset(iris, \"iris\")\r\nds <- open_dataset(\"iris\")\r\nfile.exists(\"iris\")\r\n#> [1] TRUE\r\nprint(unlink(\"iris\", recursive = T))\r\n#> [1] 0\r\nfile.exists(\"iris\")\r\n#> [1] FALSE\r\n\r\n# However if I run a dplyr query on the data before deleting it the file is locked.\r\nwrite_dataset(iris, \"iris\")\r\nds <- open_dataset(\"iris\")\r\nfile.exists(\"iris\")\r\n#> [1] TRUE\r\n\r\n# I think this adds a lock that is not removed\r\nds %>% count() %>% collect()\r\n#> # A tibble: 1 x 1\r\n#>       n\r\n#>   <int>\r\n#> 1   150\r\n\r\nprint(unlink(\"iris\", recursive = T))\r\n#> [1] 1\r\nfile.exists(\"iris\")\r\n#> [1] TRUE\r\nprint(unlink(\"iris\", recursive = T, force = T))\r\n#> [1] 1\r\nfile.exists(\"iris\")\r\n#> [1] TRUE\r\nfile.remove(\"iris/part-0.parquet\")\r\n#> Warning in file.remove(\"iris/part-0.parquet\"): cannot remove file 'iris/\r\n#> part-0.parquet', reason 'Permission denied'\r\n#> [1] FALSE\r\n\r\n# running gc() will clean up the lock and allow the file to be deleted\r\ngc()\r\n#>           used (Mb) gc trigger  (Mb) max used (Mb)\r\n#> Ncells 1178845   63    2349652 125.5  1656436 88.5\r\n#> Vcells 2093715   16    8388608  64.0  3170844 24.2\r\nprint(unlink(\"iris\", recursive = T))\r\n#> [1] 0\r\nfile.exists(\"iris\")\r\n#> [1] FALSE\r\n\r\nsessioninfo::session_info()\r\n#> - Session info ---------------------------------------------------------------\r\n#>  setting  value                       \r\n#>  version  R version 4.0.5 (2021-03-31)\r\n#>  os       Windows 10 x64              \r\n#>  system   x86_64, mingw32             \r\n#>  ui       RTerm                       \r\n#>  language (EN)                        \r\n#>  collate  English_United States.1252  \r\n#>  ctype    English_United States.1252  \r\n#>  tz       America/New_York            \r\n#>  date     2022-07-07                  \r\n#> \r\n#> - Packages -------------------------------------------------------------------\r\n#>  package     * version date       lib source        \r\n#>  arrow       * 8.0.0   2022-05-09 [1] CRAN (R 4.0.5)\r\n#>  assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.0.5)\r\n#>  backports     1.4.0   2021-11-23 [1] CRAN (R 4.0.5)\r\n#>  bit           4.0.4   2020-08-04 [1] CRAN (R 4.0.5)\r\n#>  bit64         4.0.5   2020-08-30 [1] CRAN (R 4.0.5)\r\n#>  cli           3.0.1   2021-07-17 [1] CRAN (R 4.0.5)\r\n#>  crayon        1.5.1   2022-03-26 [1] CRAN (R 4.0.5)\r\n#>  DBI           1.1.2   2021-12-20 [1] CRAN (R 4.0.5)\r\n#>  digest        0.6.27  2020-10-24 [1] CRAN (R 4.0.5)\r\n#>  dplyr       * 1.0.8   2022-02-08 [1] CRAN (R 4.0.5)\r\n#>  ellipsis      0.3.2   2021-04-29 [1] CRAN (R 4.0.5)\r\n#>  evaluate      0.14    2019-05-28 [1] CRAN (R 4.0.5)\r\n#>  fansi         0.5.0   2021-05-25 [1] CRAN (R 4.0.5)\r\n#>  fastmap       1.1.0   2021-01-25 [1] CRAN (R 4.0.5)\r\n#>  fs            1.5.0   2020-07-31 [1] CRAN (R 4.0.5)\r\n#>  generics      0.1.2   2022-01-31 [1] CRAN (R 4.0.5)\r\n#>  glue          1.4.2   2020-08-27 [1] CRAN (R 4.0.5)\r\n#>  highr         0.9     2021-04-16 [1] CRAN (R 4.0.5)\r\n#>  htmltools     0.5.2   2021-08-25 [1] CRAN (R 4.0.5)\r\n#>  knitr         1.36    2021-09-29 [1] CRAN (R 4.0.5)\r\n#>  lifecycle     1.0.1   2021-09-24 [1] CRAN (R 4.0.5)\r\n#>  magrittr      2.0.1   2020-11-17 [1] CRAN (R 4.0.5)\r\n#>  pillar        1.7.0   2022-02-01 [1] CRAN (R 4.0.5)\r\n#>  pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.0.5)\r\n#>  purrr         0.3.4   2020-04-17 [1] CRAN (R 4.0.5)\r\n#>  R6            2.5.1   2021-08-19 [1] CRAN (R 4.0.5)\r\n#>  reprex        2.0.1   2021-08-05 [1] CRAN (R 4.0.5)\r\n#>  rlang         1.0.2   2022-03-04 [1] CRAN (R 4.0.5)\r\n#>  rmarkdown     2.10    2021-08-06 [1] CRAN (R 4.0.5)\r\n#>  rstudioapi    0.13    2020-11-12 [1] CRAN (R 4.0.5)\r\n#>  sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 4.0.5)\r\n#>  stringi       1.7.5   2021-10-04 [1] CRAN (R 4.0.5)\r\n#>  stringr       1.4.0   2019-02-10 [1] CRAN (R 4.0.5)\r\n#>  styler        1.5.1   2021-07-13 [1] CRAN (R 4.0.5)\r\n#>  tibble        3.1.2   2021-05-16 [1] CRAN (R 4.0.5)\r\n#>  tidyselect    1.1.2   2022-02-21 [1] CRAN (R 4.0.5)\r\n#>  tzdb          0.2.0   2021-10-27 [1] CRAN (R 4.0.5)\r\n#>  utf8          1.2.1   2021-03-12 [1] CRAN (R 4.0.5)\r\n#>  vctrs         0.3.8   2021-04-29 [1] CRAN (R 4.0.5)\r\n#>  withr         2.5.0   2022-03-03 [1] CRAN (R 4.0.5)\r\n#>  xfun          0.25    2021-08-06 [1] CRAN (R 4.0.5)\r\n#>  yaml          2.2.1   2020-02-01 [1] CRAN (R 4.0.5)\r\n#> \r\n#> [1] C:/Users/adam.DESKTOP-D3KQQA1/Documents/R/win-library/4.0\r\n#> [2] C:/Program Files/R/R-4.0.5/library\r\n```",
        "created_at": "2022-07-07T14:10:01.000Z",
        "updated_at": "2022-07-08T12:47:42.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: R",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-07-07T20:29:15.955Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17002?focusedCommentId=17563958) by Will Jones (willjones127):*\nThanks for reporting this! I was looking what I think is a similar issue earlier with 7.0.0, but was finding that I couldn't reproduce it in 8.0.0.\u00a0"
        }
    ]
}