{
    "issue": {
        "title": "[C++] Bundled gRPC fails building",
        "body": "***Note**: This issue was originally created as [ARROW-11225](https://issues.apache.org/jira/browse/ARROW-11225). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nIf I try to build with a bundled gRPC, I get the following error:\r\n```Java\n\r\nFAILED: gen_hpack_tables \r\n: && /usr/bin/clang++-10 -Qunused-arguments -fcolor-diagnostics -ggdb -O0 -g -fPIC   -Qunused-arguments -fcolor-diagnostics -ggdb -O0 -g -fPIC  CMakeFiles/gen_hpack_tables.dir/tools/codegen/core/gen_hpack_tables.cc.o -o gen_hpack_tables  -Wl,-rpath,/home/antoine/miniconda3/envs/pyarrow/lib  /home/antoine/arrow/dev/cpp/build-deps-debug/protobuf_ep-install/lib/libprotobuf.a  -ldl  -lrt  -lm  -lpthread  libgrpc.a  libgpr.a  /usr/lib/x86_64-linux-gnu/libz.so  /home/antoine/miniconda3/envs/pyarrow/lib/libssl.so  /home/antoine/miniconda3/envs/pyarrow/lib/libcrypto.so  /home/antoine/arrow/dev/cpp/build-deps-debug/cares_ep-install/lib/libcares.a  libaddress_sorting.a  /home/antoine/arrow/dev/cpp/build-deps-debug/re2_ep-install/lib/libre2.a  libupb.a  -ldl  -lrt  -lm  -lpthread  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_status.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_str_format_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_cord.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_hash.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_bad_variant_access.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_city.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_raw_hash_set.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_bad_optional_access.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_hashtablez_sampler.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_synchronization.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_stacktrace.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_symbolize.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_debugging_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_demangle_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_graphcycles_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_time.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_strings.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_strings_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_throw_delegate.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_int128.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_civil_time.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_time_zone.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_malloc_internal.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_base.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_raw_logging_internal.a  -lpthread  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_log_severity.a  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_spinlock_wait.a  -lrt  /home/antoine/arrow/dev/cpp/build-deps-debug/absl_ep-install/lib/libabsl_exponential_biased.a && :\r\n/usr/bin/ld: libgpr.a(log_linux.cc.o): in function `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > absl::lts_2020_02_25::StrFormat<char const*, char [64], int, long, char const*, int>(absl::lts_2020_02_25::str_format_internal::FormatSpecDeductionBarrier<char const*, char [64], int, long, char const*, int>::type const&, char const* const&, char const (&) [64], int const&, long const&, char const* const&, int const&)':\r\n/home/antoine/miniconda3/envs/pyarrow/include/absl/strings/str_format.h:315: undefined reference to `absl::lts_2020_02_25::str_format_internal::FormatPack[abi:cxx11](absl::lts_2020_02_25::str_format_internal::UntypedFormatSpecImpl, absl::lts_2020_02_25::Span<absl::lts_2020_02_25::str_format_internal::FormatArgImpl const>)'\r\n/usr/bin/ld: libgpr.a(log_linux.cc.o): in function `void absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Init<char const*>(char const* const&)':\r\n/home/antoine/miniconda3/envs/pyarrow/include/absl/strings/internal/str_format/arg.h:338: undefined reference to `bool absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Dispatch<char const*>(absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Data, absl::lts_2020_02_25::str_format_internal::FormatConversionSpec, void*)'\r\n/usr/bin/ld: libgpr.a(log_linux.cc.o): in function `void absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Init<int>(int const&)':\r\n/home/antoine/miniconda3/envs/pyarrow/include/absl/strings/internal/str_format/arg.h:338: undefined reference to `bool absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Dispatch<int>(absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Data, absl::lts_2020_02_25::str_format_internal::FormatConversionSpec, void*)'\r\n/usr/bin/ld: libgpr.a(log_linux.cc.o): in function `void absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Init<long>(long const&)':\r\n/home/antoine/miniconda3/envs/pyarrow/include/absl/strings/internal/str_format/arg.h:338: undefined reference to `bool absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Dispatch<long>(absl::lts_2020_02_25::str_format_internal::FormatArgImpl::Data, absl::lts_2020_02_25::str_format_internal::FormatConversionSpec, void*)'\r\n/usr/bin/ld: libgpr.a(string.cc.o): in function `gpr_format_timespec[abi:cxx11](gpr_timespec)':\r\n/home/antoine/arrow/dev/cpp/build-deps-debug/grpc_ep-prefix/src/grpc_ep/src/core/lib/gpr/string.cc:76: undefined reference to `absl::lts_2020_02_25::StrCat[abi:cxx11](absl::lts_2020_02_25::AlphaNum const&, absl::lts_2020_02_25::AlphaNum const&, absl::lts_2020_02_25::AlphaNum const&)'\r\n/usr/bin/ld: libgpr.a(global_config_env.cc.o): in function `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > absl::lts_2020_02_25::StrFormat<char const*, char const*>(absl::lts_2020_02_25::str_format_internal::FormatSpecDeductionBarrier<char const*, char const*>::type const&, char const* const&, char const* const&)':\r\n/home/antoine/miniconda3/envs/pyarrow/include/absl/strings/str_format.h:315: undefined reference to `absl::lts_2020_02_25::str_format_internal::FormatPack[abi:cxx11](absl::lts_2020_02_25::str_format_internal::UntypedFormatSpecImpl, absl::lts_2020_02_25::Span<absl::lts_2020_02_25::str_format_internal::FormatArgImpl const>)'\r\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n```\r\n",
        "created_at": "2021-01-12T17:43:39.000Z",
        "updated_at": "2021-01-13T10:29:08.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2021-01-13T10:29:08.000Z"
    },
    "comments": [
        {
            "created_at": "2021-01-12T17:44:01.367Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11225?focusedCommentId=17263551) by Antoine Pitrou (apitrou):*\ncc `[~kou]`"
        },
        {
            "created_at": "2021-01-12T21:50:07.378Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11225?focusedCommentId=17263718) by Kouhei Sutou (kou):*\nIt seems that gRPC uses header files in your system Abseil installed miniconda not the Abseil built by Apache Arrow C++.\r\nCould you also show build logs to build `libgpr.a`?"
        },
        {
            "created_at": "2021-01-12T22:16:01.733Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11225?focusedCommentId=17263727) by Kouhei Sutou (kou):*\nWe may have a missing dependency. Does the following patch fix this?\r\n\r\n```\n\r\ndiff --git a/cpp/cmake_modules/ThirdpartyToolchain.cmake b/cpp/cmake_modules/ThirdpartyToolchain.cmake\r\nindex 9cca412be..abd811fae 100644\r\n--- a/cpp/cmake_modules/ThirdpartyToolchain.cmake\r\n+++ b/cpp/cmake_modules/ThirdpartyToolchain.cmake\r\n@@ -2346,6 +2346,7 @@ macro(build_grpc)\r\n       spinlock_wait\r\n       stacktrace\r\n       status\r\n+      str_format\r\n       str_format_internal\r\n       strings\r\n       strings_internal\r\n```"
        },
        {
            "created_at": "2021-01-13T10:28:59.717Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11225?focusedCommentId=17264044) by Antoine Pitrou (apitrou):*\nYou were right: this is simply because of the conda environment. With conda disabled, it works fine. Sorry!"
        }
    ]
}