{
    "issue": {
        "title": "[Python] Error with errno 22 when loading 3.6 GB Parquet file",
        "body": "***Note**: This issue was originally created as [ARROW-2654](https://issues.apache.org/jira/browse/ARROW-2654). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI saved a file using pandas to_parquet method, but can't read it back in. Here's the full stack trace:\r\n\r\n\u00a0\r\n```java\n\r\nTraceback (most recent call last):\r\nFile \"src/data/CLXP_pull.py\", line 214, in <module>\r\n main()\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 722, in _call_\r\n return self.main(*args, **kwargs)\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 697, in main\r\n rv = self.invoke(ctx)\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\r\n return ctx.invoke(self.callback, **ctx.params)\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\r\n return callback(*args, **kwargs)\r\n File \"src/data/CLXP_pull.py\", line 188, in main\r\n results[fullname] = pd.read_parquet(os.path.join(project_dir, \"data\", \"raw\", fullname+\".parquet\"), engine=\"pyarrow\")\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py\", line 257, in read_parquet\r\n return impl.read(path, columns=columns, **kwargs)\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py\", line 130, in read\r\n **kwargs).to_pandas()\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py\", line 939, in read_table\r\n pf = ParquetFile(source, metadata=metadata)\r\n File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py\", line 64, in _init_\r\n self.reader.open(source, metadata=metadata)\r\n File \"_parquet.pyx\", line 651, in pyarrow._parquet.ParquetReader.open\r\n File \"error.pxi\", line 79, in pyarrow.lib.check_status\r\n pyarrow.lib.ArrowIOError: Arrow error: IOError: [Errno 22] Invalid argument\r\n```\r\nAny ideas what could cause this? The file itself is 3.6GB.\r\n\r\nI'm running\u00a0pandas==0.22.0.",
        "created_at": "2018-05-31T20:15:11.000Z",
        "updated_at": "2018-11-21T23:29:00.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2018-11-21T17:42:25.000Z"
    },
    "comments": [
        {
            "created_at": "2018-05-31T20:18:24.119Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16497104) by Andy Reagan (andyreagan):*\nI upgraded to the latest version of Pandas (0.23.0), which now has\u00a0pyarrow==0.9.0.post1, and I get basically the same\r\n```java\n\r\nTraceback (most recent call last): File \"src/data/CLXP_pull.py\", line 214, in <module> main() File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 722, in __call__ return self.main(*args, **kwargs) File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 697, in main rv = self.invoke(ctx) File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 895, in invoke return ctx.invoke(self.callback, **ctx.params) File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/click/core.py\", line 535, in invoke return callback(*args, **kwargs) File \"src/data/CLXP_pull.py\", line 188, in main results[fullname] = pd.read_parquet(os.path.join(project_dir, \"data\", \"raw\", fullname+\".parquet\"), engine=\"pyarrow\") File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py\", line 288, in read_parquet return impl.read(path, columns=columns, **kwargs) File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py\", line 131, in read **kwargs).to_pandas() File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py\", line 939, in read_table pf = ParquetFile(source, metadata=metadata) File \"/Users/mm51929/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py\", line 64, in __init__ self.reader.open(source, metadata=metadata) File \"_parquet.pyx\", line 651, in pyarrow._parquet.ParquetReader.open File \"error.pxi\", line 79, in pyarrow.lib.check_status pyarrow.lib.ArrowIOError: Arrow error: IOError: [Errno 22] Invalid argument\r\n```"
        },
        {
            "created_at": "2018-06-12T21:40:59.084Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16510247) by Wes McKinney (wesm):*\nAny chance you can provide a minimally reproducible example?\u00a0"
        },
        {
            "created_at": "2018-06-14T19:12:45.643Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16512894) by Andy Reagan (andyreagan):*\nYeah, I realize there's not as much to be done without it.\r\n\r\nThe data is confidential, so I can't just provide a copy (which is why I didn't provide right away), but I'll see what I can do (at least, maybe I can narrow it down to a particular row and scramble that data)."
        },
        {
            "created_at": "2018-06-29T14:33:19.861Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16527687) by Antoine Pitrou (apitrou):*\nDoes it work if you make the file smaller than 2GB? This might be a 64-bitness issue (which may actually be fixed in git master)."
        },
        {
            "created_at": "2018-07-07T20:37:18.897Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16535899) by Wes McKinney (wesm):*\n`[~andyreagan]` where is the data stored? The error suggests that the `mmap` call failed, but without more detail it's hard for me to tell. Can you please test using the appropriate wheel for your platform from\r\n\r\nhttps://github.com/kszucs/crossbow/releases/tag/build-163\r\n\r\n? I'm moving this issue off the 0.10.0 for now\r\n\r\nI noticed that it's not possible to disable memory mapping when reading Parquet files: opened ARROW-2807"
        },
        {
            "created_at": "2018-08-09T14:05:25.869Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16574878) by Antoine Pitrou (apitrou):*\n`[~andyreagan]` Can you upgrade again to Arrow 0.10.0 and see whether the issues is fixed?"
        },
        {
            "created_at": "2018-09-12T13:19:25.689Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16612122) by Andy Reagan (andyreagan):*\nI get a different error now on 0.10.0. Here is the full stacktrace:\r\n```java\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py in read_parquet(path, engine, columns, **kwargs)\r\n286\r\n287 impl = get_engine(engine)\r\n--> 288 return impl.read(path, columns=columns, **kwargs)\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pandas/io/parquet.py in read(self, path, columns, **kwargs)\r\n129 kwargs['use_pandas_metadata'] = True\r\n130 result = self.api.parquet.read_table(path, columns=columns,\r\n--> 131 **kwargs).to_pandas()\r\n132 if should_close:\r\n133 try:\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py in read_table(source, columns, nthreads, metadata, use_pandas_metadata)\r\n1044 fs = _get_fs_from_path(source)\r\n1045 return fs.read_parquet(source, columns=columns, metadata=metadata,\r\n-> 1046 use_pandas_metadata=use_pandas_metadata)\r\n1047\r\n1048 pf = ParquetFile(source, metadata=metadata)\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/filesystem.py in read_parquet(self, path, columns, metadata, schema, nthreads, use_pandas_metadata)\r\n175 filesystem=self)\r\n176 return dataset.read(columns=columns, nthreads=nthreads,\r\n--> 177 use_pandas_metadata=use_pandas_metadata)\r\n178\r\n179 def open(self, path, mode='rb'):\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py in read(self, columns, nthreads, use_pandas_metadata)\r\n896 partitions=self.partitions,\r\n897 open_file_func=open_file,\r\n--> 898 use_pandas_metadata=use_pandas_metadata)\r\n899 tables.append(table)\r\n900\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py in read(self, columns, nthreads, partitions, open_file_func, file, use_pandas_metadata)\r\n459 table = reader.read_row_group(self.row_group, **options)\r\n460 else:\r\n--> 461 table = reader.read(**options)\r\n462\r\n463 if len(self.partition_keys) > 0:\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/parquet.py in read(self, columns, nthreads, use_pandas_metadata)\r\n150 columns, use_pandas_metadata=use_pandas_metadata)\r\n151 return self.reader.read_all(column_indices=column_indices,\r\n--> 152 nthreads=nthreads)\r\n153\r\n154 def scan_contents(self, columns=None, batch_size=65536):\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/_parquet.pyx in pyarrow._parquet.ParquetReader.read_all()\r\n\r\n~/projects/2018/03-advisor-recruiting/pyenv/lib/python3.6/site-packages/pyarrow/error.pxi in pyarrow.lib.check_status()\r\n\r\nArrowIOError: Arrow error: Capacity error: BinaryArray cannot contain more than 2147483646 bytes, have 2147484002\r\n```\r\n\u00a0"
        },
        {
            "created_at": "2018-09-13T22:08:38.556Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16614117) by Wes McKinney (wesm):*\nI think this issue has been reported elsewhere. I'm not going to have a chance to investigate in the next couple of weeks but if anyone wants to look in the meantime, producing a chunked array in this case should be similar to the way we handle such cases when converting to Arrow from pandas"
        },
        {
            "created_at": "2018-09-15T19:05:35.441Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16616472) by Wes McKinney (wesm):*\nThis will have to be tackled in the 0.12 release cycle if no one gets to it in time for 0.11"
        },
        {
            "created_at": "2018-11-21T17:42:25.428Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16695016) by Wes McKinney (wesm):*\nClosing as duplicate of ARROW-3762. That issue contains a repro so we'll use that one for fixing the issue"
        },
        {
            "created_at": "2018-11-21T23:29:00.114Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-2654?focusedCommentId=16695361) by Andy Reagan (andyreagan):*\n\ud83d\udc4c\r\n\r\n\r\n\r\nSent from my Samsung Galaxy smartphone.\r\n\r\n\r\n-------- Original message --------\r\nFrom: \"Wes McKinney (JIRA)\" <jira@apache.org>\r\nDate: 11/21/18 12:46 PM (GMT-05:00)\r\nTo: \"Reagan, Andrew\" <AReagan@MassMutual.com>\r\nSubject: [EXTERNAL][jira] [Closed] (ARROW-2654) [Python] Error with errno 22 when loading 3.6 GB Parquet file\r\n\r\n\r\n     [ https://urldefense.proofpoint.com/v2/url?u=https-3A__issues.apache.org_jira_browse_ARROW-2D2654-3Fpage-3Dcom.atlassian.jira.plugin.system.issuetabpanels-3Aall-2Dtabpanel&d=DwIFaQ&c=BX7Y4KpGhcDnIsrgHKqkbfoiiDvjhxwuYUpcrPD7xrE&r=a3UJQ6cVzThaj2bmSG-EKQHCpiQSdhnF6mf5fZPUK8Y&m=w_LcK_-uCZKvZ2zgobYJW5GfFcksTlVY0r8YUPcZnDM&s=0yFlBigppaVMfLgXwrIzmnIsCEK2cnpyQ139gtCKTZs&e= ]\r\n\r\nWes McKinney closed ARROW-2654.\r\n-------------------------------\r\n    Resolution: Duplicate\r\n      Assignee: Wes McKinney\r\n\r\nClosing as duplicate of ARROW-3762. That issue contains a repro so we'll use that one for fixing the issue\r\n\r\n\r\n\r\n\r\n\u2013\r\nThis message was sent by Atlassian JIRA\r\n(v7.6.3#76005)\r\n\nThis e-mail transmission may contain information that is proprietary, privileged and/or confidential and is intended exclusively for the person(s) to whom it is addressed. Any use, copying, retention or disclosure by any person other than the intended recipient or the intended recipient's designees is strictly prohibited. If you are not the intended recipient or their designee, please notify the sender immediately by return e-mail and delete all copies\n"
        }
    ]
}