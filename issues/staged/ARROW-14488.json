{
    "issue": {
        "title": "[Python] Incorrect inferred schema from pandas dataframe with length 0.",
        "body": "***Note**: This issue was originally created as [ARROW-14488](https://issues.apache.org/jira/browse/ARROW-14488). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nWe use pandas(with pyarrow engine) to write out parquet files and those outputs will be consumed by other applications such as Java apps using org.apache.parquet.hadoop.ParquetFileReader. We found that some empty dataframes would get incorrect schema for string columns in other applications. After some investigation, we narrow down the issue to the schema inference by pyarrow:\r\n```java\n\r\nIn [1]: import pandas as pd\r\nIn [2]: df = pd.DataFrame([['a', 1, 1.0]], columns=['a', 'b', 'c'])\r\nIn [3]: import pyarrow as pa\r\nIn [4]: pa.Schema.from_pandas(df)\r\n Out[4]:\r\n a: string\r\n b: int64\r\n c: double\r\n -- schema metadata --\r\n pandas: '{\"index_columns\": [{\"kind\": \"range\", \"name\": null, \"start\": 0, \"' + 562\r\nIn [5]: pa.Schema.from_pandas(df.head(0))\r\n Out[5]:\r\n a: null\r\n b: int64\r\n c: double\r\n -- schema metadata --\r\n pandas: '{\"index_columns\": [{\"kind\": \"range\", \"name\": null, \"start\": 0, \"' + 560\r\nIn [6]: pa._version_\r\n Out[6]: '5.0.0'\r\n```\r\n\u00a0As you can see, the column 'a' which should be string type if inferred as null type and is converted to int32 while writing to parquet files.\r\n\r\nIs this an expected behavior? Or do we have any workaround for this issue? Could anyone take a look please. Thanks!",
        "created_at": "2021-10-27T05:38:56.000Z",
        "updated_at": "2022-02-07T19:50:23.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-02-07T06:44:00.022Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14488?focusedCommentId=17487900) by Alenka Frim (alenka):*\nHi `[~zijie0]` , thank you for reporting! And sorry for a late reply.\r\n\r\nI think this may be a bug on Arrow side: when constructing metadata in _dataframe_to_types_ ({_}pandas_compat.py{_}) the conversion from empty Pandas series to pa.array is wrong in the case of a string dtype. Here is an example:\r\n```python\n\r\n>>> import pandas as pd\r\n>>> import pyarrow as pa\r\n>>> df = pd.DataFrame([['a', 1, 1.0]], columns=['a', 'b', 'c'])\r\n>>> df\r\n   a  b    c\r\n0  a  1  1.0\r\n>>> df[\"a\"]\r\n0    a\r\nName: a, dtype: object\r\n\r\n# Non-empty dataframe\r\n>>> pa.array(df[\"a\"], from_pandas=True) # Works for non-empty dataframe\r\n<pyarrow.lib.StringArray object at 0x12462ed00>\r\n[\r\n  \"a\"\r\n]\r\n>>> pa.array(df[\"a\"], from_pandas=True).type\r\nDataType(string)\r\n\r\n# Empty dataframe\r\n>>> pa.array(df[\"a\"].head(0), from_pandas=True) # Becomes NullArray with no dtype in case of string/object\r\n<pyarrow.lib.NullArray object at 0x12462eac0>\r\n0 nulls\r\n>>> pa.array(df[\"a\"].head(0), from_pandas=True).type\r\nDataType(null)\r\n```\r\nbut that doesn't happen for integer or double:\r\n```python\n\r\n>>> df[\"b\"]\r\n0    1\r\nName: b, dtype: int64\r\n\r\n>>> pa.array(df[\"b\"], from_pandas=True)\r\n<pyarrow.lib.Int64Array object at 0x12462eac0>\r\n[\r\n  1\r\n]\r\n\r\n>>> pa.array(df[\"b\"].head(0), from_pandas=True)\r\n<pyarrow.lib.Int64Array object at 0x12462ea60>\r\n[]\r\n>>> pa.array(df[\"b\"].head(0), from_pandas=True).type\r\nDataType(int64)\r\n```\r\n`[~jorisvandenbossche]` what do you think?"
        },
        {
            "created_at": "2022-02-07T16:29:22.222Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14488?focusedCommentId=17488237) by Joris Van den Bossche (jorisvandenbossche):*\n> the conversion from empty Pandas series to pa.array is wrong in the case of a string dtype.\r\n\r\nThe main problem is that the example code is not using a \"string dtype\". By default, pandas uses the generic \"object\" dtype to store strings. But this data type basically means that it can hold _any_ Python object. So it is not guaranteed to be strings (eg it could also be decimals, bytes, .., for some python types that pyarrow also infers). \r\n\r\nAs long as the array is not empty, the conversion to a pyarrow array will try to infer the appropriate type based on the values in the input array (eg in case of an object dtype array with strings, it will indeed convert that to a `pa.string()` type). But if the array is empty, there are no values to infer the type from. And that is the reason why pyarrow defaults to use the generic \"null\" data type for such array (or column in a DataFrame).\r\n\r\nIf you know that you have strings for a certain column, and want the pandas->pyarrow conversion to robustly work (regardless of having empty dataframes/arrays), the `from_pandas` method has a `schema` argument, and this way you can specific a schema to use (and so pyarrow will not try to infer the types based on the values in the array). You will have to construct this schema manually, though, in this case. \r\n\r\n"
        },
        {
            "created_at": "2022-02-07T19:50:23.188Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14488?focusedCommentId=17488402) by Alenka Frim (alenka):*\nThank you Joris!\r\n\r\nAn example would be:\r\n```python\n\r\n>>> import pandas as pd\r\n>>> df = pd.DataFrame([['a', 1, 1.0]], columns=['a', 'b', 'c'])\r\n>>> import pyarrow as pa\r\n>>> \r\n>>> schema = pa.schema([\r\n...    pa.field('a', pa.string()),\r\n...    pa.field('b', pa.int64()),\r\n...    pa.field('c', pa.float64())])\r\n>>> \r\n>>> pa.Table.from_pandas(df, schema=schema)\r\npyarrow.Table\r\na: string\r\nb: int64\r\nc: double\r\n----\r\na: [[\"a\"]]\r\nb: [[1]]\r\nc: [[1]]\r\n>>> pa.Table.from_pandas(df.head(0), schema=schema)\r\npyarrow.Table\r\na: string\r\nb: int64\r\nc: double\r\n----\r\na: [[]]\r\nb: [[]]\r\nc: [[]]\r\n```"
        }
    ]
}