{
    "issue": {
        "title": "Cmake build of Apache Arrow fails using grpc's Findre2.cmake with \"add_library cannot create imported target \"RE2::re2\" because another target with the same name already exists.\"",
        "body": "***Note**: This issue was originally created as [ARROW-11888](https://issues.apache.org/jira/browse/ARROW-11888). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI'm trying to create a MacPorts port of Apache Arrow. See <https://github.com/macports/macports-ports/pull/7791>\r\n\r\nI'm using a library install of grpc, version 1.36.2. This issue is also observed with grpc version 1.35.0.\r\n\r\nThe grpc cmake file [Findre2.cmake](https://github.com/grpc/grpc/blob/master/cmake/modules/Findre2.cmake) causes this cmake error when building pyarrow.\r\n\r\nI see that there is also a file\u00a0Findre2.cmake created and installed in the cmake build of arrow. Also see this issue raised at grpc, <https://github.com/grpc/grpc/issues/25434>\r\n\r\nError:\r\n\r\n:info:build CMake Error at /opt/local/lib/cmake/grpc/modules/Findre2.cmake:29 (add_library):\r\n:info:build add_library cannot create imported target \"re2::re2\" because another target\r\n:info:build with the same name already exists.\r\n\r\nRelated:\r\n \\* <http://mail-archives.apache.org/mod_mbox/arrow-dev/202009.mbox/%3C6ECB7D60-844F-410D-8840-24F2CE261752@yahoo.com%3E>\r\n<http://mail-archives.apache.org/mod_mbox/arrow-jira/202009.mbox/%3CJIRA.13327607.1600156125000.372264.1600157460269@Atlassian.JIRA%3E>\r\n \\* <https://www.mail-archive.com/dev@arrow.apache.org/msg20631.html>\r\n \\* <https://github.com/macports/macports-ports/pull/7791>",
        "created_at": "2021-03-06T01:13:20.000Z",
        "updated_at": "2022-04-08T15:39:39.000Z",
        "labels": [
            "Migrated from Jira",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2022-04-08T15:39:39.000Z"
    },
    "comments": [
        {
            "created_at": "2021-03-06T21:17:55.038Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296660) by Kouhei Sutou (kou):*\nThe latest build shows `gprc_cpp_plugin` related error:\r\n\r\n```\n\r\n  cd /opt/local/var/macports/build/_Users_runner_work_macports-ports_macports-ports_ports_devel_apache-arrow/apache-arrow/work/build/src/arrow/flight && /opt/local/bin/protoc -I/opt/local/var/macports/build/_Users_runner_work_macports-ports_macports-ports_ports_devel_apache-arrow/apache-arrow/work/arrow-3.0.0/cpp/../format --grpc_out=/opt/local/var/macports/build/_Users_runner_work_macports-ports_macports-ports_ports_devel_apache-arrow/apache-arrow/work/build/src/arrow/flight --plugin=protoc-gen-grpc=/opt/local/bin/grpc_cpp_plugin /opt/local/var/macports/build/_Users_runner_work_macports-ports_macports-ports_ports_devel_apache-arrow/apache-arrow/work/arrow-3.0.0/cpp/../format/Flight.proto\r\n  dyld: Library not loaded: /opt/local/lib/libprotoc.22.dylib\r\n    Referenced from: /opt/local/bin/grpc_cpp_plugin\r\n    Reason: image not found\r\n  --grpc_out: protoc-gen-grpc: Plugin killed by signal 6.\r\n```\r\n\r\nCould you confirm that `/opt/local/lib/libprotoc.22.dylib` exists?"
        },
        {
            "created_at": "2021-03-06T22:09:20.559Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296667) by Steven Smith (s.t.smith):*\nYes libprotoc exists by the protobuf3-cpp port:\r\n\r\n$ ls -1 /opt/local/lib/libprotoc.\\*\r\n/opt/local/lib/libprotoc.25.dylib\\*\r\n/opt/local/lib/libprotoc.a\r\n/opt/local/lib/libprotoc.dylib@\r\n\r\nAlso note that the apache-arrow port build works\u2014it\u2019s the pyarrow build that throws the re2-related cmake error."
        },
        {
            "created_at": "2021-03-06T22:47:49.062Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296673) by Kouhei Sutou (kou):*\nAh, sorry. I missed the latest build URL I referred: https://github.com/macports/macports-ports/pull/7791/checks?check_run_id=1847335315#step:8:2652\r\n\r\nThe error message shows `22.dylib` but you just have `25.dylib`.\r\n\r\nCould you show the real latest build URL you refer?"
        },
        {
            "created_at": "2021-03-06T22:54:33.903Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296674) by Steven Smith (s.t.smith):*\n~~Please see\u00a0<https://github.com/grpc/grpc/files/5972195/main.log>\u00a0(from <https://github.com/grpc/grpc/issues/25434>).~~"
        },
        {
            "created_at": "2021-03-07T14:34:57.986Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296899) by Steven Smith (s.t.smith):*\nPlease see this log attached to the ticket:\r\n\r\n[main.log](main.log)"
        },
        {
            "created_at": "2021-03-07T21:17:28.298Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17296976) by Kouhei Sutou (kou):*\nThanks.\r\n\r\nCould you confirm that the re2 package in MacPorts provides `re2Config.cmake`?"
        },
        {
            "created_at": "2021-03-07T23:25:14.509Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17297005) by Steven Smith (s.t.smith):*\n> re2Config.cmake\r\n\r\nMacPorts does not provide this cmake file and does not use a cmake build for re2 because re2 itself recommends against using cmake:\r\n\r\n\"RE2 supports CMake mostly for the sake of users who don't have GNU make (e.g. Visual Studio users, Xcode users) and only partly \u2013 and unenthusiastically \u2013 for the sake of CMake users.\"\r\n\r\nSee:\u00a0<https://github.com/macports/macports-ports/pull/9836>\r\n\r\n<https://github.com/google/re2/issues/274>\r\n\r\nWe use a standard install of re2 that includes these files:\r\n\r\n$ port contents re2\r\nPort re2 contains:\r\n /opt/local/include/re2/filtered_re2.h\r\n /opt/local/include/re2/re2.h\r\n /opt/local/include/re2/set.h\r\n /opt/local/include/re2/stringpiece.h\r\n /opt/local/lib/libre2.9.0.0.dylib\r\n /opt/local/lib/libre2.9.dylib\r\n /opt/local/lib/libre2.a\r\n /opt/local/lib/libre2.dylib\r\n /opt/local/lib/pkgconfig/re2.pc\r\n /opt/local/share/doc/re2/AUTHORS\r\n /opt/local/share/doc/re2/CONTRIBUTORS\r\n /opt/local/share/doc/re2/LICENSE\r\n /opt/local/share/doc/re2/README\r\n /opt/local/share/doc/re2/syntax.html\r\n /opt/local/share/doc/re2/syntax.txt"
        },
        {
            "created_at": "2021-03-13T00:04:00.011Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17300655) by Steven Smith (s.t.smith):*\n`[~kou]`, I confirm that pyarrow builds without issue **if** re2 is built using a cmake.\r\n\r\nWould you please indicate what Apache Arrow's position is on this?\r\n\r\nDoes Apache Arrow require a cmake build of re2? Or is is it a Apache Arrow cmake issue if re2 is built with a Makefile?"
        },
        {
            "created_at": "2021-03-13T03:00:16.618Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17300689) by Kouhei Sutou (kou):*\nThis is caused by calling `Findre2.cmake` provided by gRPC twice.\r\n\r\nApache Arrow itself uses re2. So Apache Arrow calls `find_package(re2)` (from `Findre2Alt.cmake` in Apache Arrow). If re2 provides `re2Config.cmake`, the `find_package(re2)` uses the `re2Config.cmake`. If `re2Config.cmake` doesn't exist, it uses `Findre2.cmake` provided by gRPC. `Findre2.cmake` defines `re2::re2` CMake target.\r\n\r\nApache Arrow Flight uses gRPC. gRPC uses re2. So gRPC tries to find re2 by `find_package(re2 CONFIG)`. It uses `re2Config.cmake`. Note that we can use `re2Config.cmake` multiple times. Because `re2Config.cmake` doesn't define `re2::re2` CMake target if there is already `re2::re2` CMake target. If `re2Config.cmake` doesn't exist, `Findre2.cmake` in gRPC defines `re2::re2` CMake target. Note that it doesn't check `re2::re2` CMake target existence. So using `Findre2.cmake` in gRPC without `re2Config.cmake` twice causes the error.\r\n\r\nThere are some solutions:\r\n\r\n1. re2 provides `re2Config.cmake`\r\n\r\n2. gRPC's `Findre2.cmake` doesn't define `re2::re2` multiple times:\r\n\r\n```\n\r\ndiff --git a/cmake/modules/Findre2.cmake b/cmake/modules/Findre2.cmake\r\nindex 41df454713..906aabfeba 100644\r\n--- a/cmake/modules/Findre2.cmake\r\n+++ b/cmake/modules/Findre2.cmake\r\n@@ -26,26 +26,28 @@ find_package(PkgConfig REQUIRED)\r\n pkg_check_modules(RE2 QUIET re2)\r\n if(RE2_FOUND)\r\n   set(re2_FOUND \"${RE2_FOUND}\")\r\n-  add_library(re2::re2 INTERFACE IMPORTED)\r\n-  if(RE2_INCLUDE_DIRS)\r\n-    set_property(TARGET re2::re2 PROPERTY\r\n-                 INTERFACE_INCLUDE_DIRECTORIES \"${RE2_INCLUDE_DIRS}\")\r\n-  endif()\r\n-  if(RE2_CFLAGS_OTHER)\r\n-    # Filter out the -std flag, which is handled by CMAKE_CXX_STANDARD.\r\n-    # TODO(junyer): Use the FILTER option whenever CMake 3.6 (or newer)\r\n-    # becomes the minimum required: that will allow this to be concise.\r\n-    foreach(flag IN LISTS RE2_CFLAGS_OTHER)\r\n-      if(\"${flag}\" MATCHES \"^-std=\")\r\n-        list(REMOVE_ITEM RE2_CFLAGS_OTHER \"${flag}\")\r\n-      endif()\r\n-    endforeach()\r\n-    set_property(TARGET re2::re2 PROPERTY\r\n-                 INTERFACE_COMPILE_OPTIONS \"${RE2_CFLAGS_OTHER}\")\r\n-  endif()\r\n-  if(RE2_LDFLAGS)\r\n-    set_property(TARGET re2::re2 PROPERTY\r\n-                 INTERFACE_LINK_LIBRARIES \"${RE2_LDFLAGS}\")\r\n+  if(NOT TARGET re2::re2)\r\n+    add_library(re2::re2 INTERFACE IMPORTED)\r\n+    if(RE2_INCLUDE_DIRS)\r\n+      set_property(TARGET re2::re2 PROPERTY\r\n+\t\t   INTERFACE_INCLUDE_DIRECTORIES \"${RE2_INCLUDE_DIRS}\")\r\n+    endif()\r\n+    if(RE2_CFLAGS_OTHER)\r\n+      # Filter out the -std flag, which is handled by CMAKE_CXX_STANDARD.\r\n+      # TODO(junyer): Use the FILTER option whenever CMake 3.6 (or newer)\r\n+      # becomes the minimum required: that will allow this to be concise.\r\n+      foreach(flag IN LISTS RE2_CFLAGS_OTHER)\r\n+\tif(\"${flag}\" MATCHES \"^-std=\")\r\n+\t  list(REMOVE_ITEM RE2_CFLAGS_OTHER \"${flag}\")\r\n+\tendif()\r\n+      endforeach()\r\n+      set_property(TARGET re2::re2 PROPERTY\r\n+\t\t   INTERFACE_COMPILE_OPTIONS \"${RE2_CFLAGS_OTHER}\")\r\n+    endif()\r\n+    if(RE2_LDFLAGS)\r\n+      set_property(TARGET re2::re2 PROPERTY\r\n+\t\t   INTERFACE_LINK_LIBRARIES \"${RE2_LDFLAGS}\")\r\n+    endif()\r\n   endif()\r\n   message(STATUS \"Found RE2 via pkg-config.\")\r\n   return()\r\n```\r\n\r\n3. Apache Arrow doesn't find dependencies (re2, gRPC and so on) if `libarrow.a` isn't required.\r\n\r\n`find_package(Arrow)` in pyarrow always find Apache Arrow dependencies but it's only for `libarrow.a`. `libarrow.so` doesn't need to find them. pyarrow only uses `libarrow.so`. So we can avoid calling `find_package(re2)` and `find_package(gRPC)` for just building pyarrow.\r\n\r\n1. will be the easiest solution if MacPorts accepts it.\r\n\r\n2. may be an acceptable solution if gRPC accepts it.\r\n\r\n3. will be implemented in the future. We'll improve our `find_package(Arrow)` to support component feature of `find_package`. 3. will be implemented in the improvement.\r\n"
        },
        {
            "created_at": "2022-04-08T15:39:39.437Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11888?focusedCommentId=17519657) by Jacob Wujciak-Jens (assignUser):*\nThe related [PR to macports](https://github.com/macports/macports-ports/pull/7791) was merged, problem was solved."
        }
    ]
}