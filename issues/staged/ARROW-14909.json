{
    "issue": {
        "title": "[R] List column containing data frames with varying numbers of columns",
        "body": "***Note**: This issue was originally created as [ARROW-14909](https://issues.apache.org/jira/browse/ARROW-14909). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI'm brand new to arrow, but didn't seem to find anything like this issue in this bug tracker; apologies if this is a known issue.\u00a0\r\n\r\nArrow is giving me an error when I try to write Parquet or Feather files for a dataframe that contains a list column (`{}df{`} in the MWE) that contains dataframes that have varying numbers of columns:\r\n```r\n\r\nlibrary(tibble)\r\nlibrary(arrow)\r\n\r\ndf1 = data.frame(x = c(1, 2, 3),\u00a0\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0y = c('a', 'b', 'c'))\r\n\r\ndf2 = data.frame(x = c(4),\u00a0\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0y = c('d'),\u00a0\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0z = c('foo'))\r\n\r\ncomb_df = tibble(id = c(1, 2),\u00a0\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0df = c(list(df1), list(df2)))\r\n\r\nwrite_dataset(comb_df, 'mwe', format = 'feather')\r\n```\r\nThis gives me\r\n```java\n\r\nError: Unknown: Number of fields in struct (2) incompatible with number of columns in the data frame (3)\r\n```\r\n\r\nSession info: \r\n```Java\n\r\n\u2500 Session info \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n setting  value                       \r\n version  R version 4.1.0 (2021-05-18)\r\n os       macOS Big Sur 11.6          \r\n system   x86_64, darwin17.0          \r\n ui       RStudio                     \r\n language (EN)                        \r\n collate  en_US.UTF-8                 \r\n ctype    en_US.UTF-8                 \r\n tz       America/Los_Angeles         \r\n date     2021-11-29                  \r\n\r\n\u2500 Packages \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n package     * version date       lib source        \r\n arrow       * 6.0.1   2021-11-20 [1] CRAN (R 4.1.0)\r\n assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.1.0)\r\n bit           4.0.4   2020-08-04 [1] CRAN (R 4.1.0)\r\n bit64         4.0.5   2020-08-30 [1] CRAN (R 4.1.0)\r\n cli           3.0.1   2021-07-17 [1] CRAN (R 4.1.0)\r\n crayon        1.4.1   2021-02-08 [1] CRAN (R 4.1.0)\r\n ellipsis      0.3.2   2021-04-29 [1] CRAN (R 4.1.0)\r\n fansi         0.5.0   2021-05-25 [1] CRAN (R 4.1.0)\r\n glue          1.4.2   2020-08-27 [1] CRAN (R 4.1.0)\r\n lifecycle     1.0.1   2021-09-24 [1] CRAN (R 4.1.0)\r\n magrittr      2.0.1   2020-11-17 [1] CRAN (R 4.1.0)\r\n pillar        1.6.3   2021-09-26 [1] CRAN (R 4.1.0)\r\n pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.1.0)\r\n purrr         0.3.4   2020-04-17 [1] CRAN (R 4.1.0)\r\n R6            2.5.1   2021-08-19 [1] CRAN (R 4.1.0)\r\n rlang         0.4.11  2021-04-30 [1] CRAN (R 4.1.0)\r\n rstudioapi    0.13    2020-11-12 [1] CRAN (R 4.1.0)\r\n sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 4.1.0)\r\n tibble      * 3.1.5   2021-09-30 [1] CRAN (R 4.1.0)\r\n tidyselect    1.1.1   2021-04-30 [1] CRAN (R 4.1.0)\r\n utf8          1.2.2   2021-07-24 [1] CRAN (R 4.1.0)\r\n vctrs         0.3.8   2021-04-29 [1] CRAN (R 4.1.0)\r\n withr         2.4.2   2021-04-18 [1] CRAN (R 4.1.0)\r\n\r\n[1] /Library/Frameworks/R.framework/Versions/4.1/Resources/library\r\n```",
        "created_at": "2021-11-29T17:27:58.000Z",
        "updated_at": "2022-02-01T10:23:46.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: R",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-02-01T10:23:46.988Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14909?focusedCommentId=17485165) by Drago\u0219 Moldovan-Gr\u00fcnfeld (dragosmg):*\nHi [~hicks.daniel.j@gmail.com],\r\n\r\nThanks for submitting this issue. You are correct, list columns of varying lengths are not yet supported in `arrow`.\u00a0For the time being there are a couple of possible workarounds.\r\n```r\n\r\nlibrary(tibble)\r\nlibrary(arrow, warn.conflicts = FALSE)\r\n\r\ndf1 = data.frame(x = c(1, 2, 3), \r\n                 y = c('a', 'b', 'c'))\r\n\r\ndf2 = data.frame(x = c(4), \r\n                 y = c('d'), \r\n                 z = c('foo'))\r\n\r\ncomb_df = tibble(id = c(1, 2), \r\n                 df = c(list(df1), list(df2)))\r\n\r\n# make them all have the same column names\r\nall_ptypes <- lapply(comb_df$df, vctrs::vec_ptype)\r\ncommon_ptype <- vctrs::vec_ptype_common(!!! all_ptypes)\r\ncomb_df$df <- lapply(comb_df$df, vctrs::vec_cast, common_ptype)\r\nTable$create(comb_df)\r\n#> Table\r\n#> 2 rows x 2 columns\r\n#> $id <double>\r\n#> $df: list<item: struct<x: double, y: string, z <string>>>\r\n\r\n# serialize them to JSON\r\ncomb_df = tibble(id = c(1, 2), \r\n                 df = c(list(df1), list(df2)))\r\n\r\ncomb_df$df <- vapply(comb_df$df, jsonlite::toJSON, character(1))\r\nTable$create(comb_df)\r\n#> Table\r\n#> 2 rows x 2 columns\r\n#> $id <double>\r\n#> $df <string>\r\n```\r\n"
        }
    ]
}