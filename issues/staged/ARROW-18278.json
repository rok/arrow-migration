{
    "issue": {
        "title": "[Java] Maven generate-libs-jni-macos-linux on M1 fails due to cmake error",
        "body": "***Note**: This issue was originally created as [ARROW-18278](https://issues.apache.org/jira/browse/ARROW-18278). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nWhen building with maven on M1 [as per docs](https://arrow.apache.org/docs/dev/developers/java/building.html#id3):\r\n```bash\n\r\nmvn clean install\r\nmvn generate-resources -Pgenerate-libs-jni-macos-linux -N\r\n```\r\nI get the following error:\r\n```bash\n\r\n[INFO] --- exec-maven-plugin:3.1.0:exec (jni-cmake) @ arrow-java-root ---\r\n-- Building using CMake version: 3.24.2\r\n-- The C compiler identification is AppleClang 14.0.0.14000029\r\n-- The CXX compiler identification is AppleClang 14.0.0.14000029\r\n-- Detecting C compiler ABI info\r\n-- Detecting C compiler ABI info - done\r\n-- Check for working C compiler: /Library/Developer/CommandLineTools/usr/bin/cc - skipped\r\n-- Detecting C compile features\r\n-- Detecting C compile features - done\r\n-- Detecting CXX compiler ABI info\r\n-- Detecting CXX compiler ABI info - done\r\n-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/c++ - skipped\r\n-- Detecting CXX compile features\r\n-- Detecting CXX compile features - done\r\n-- Found Java: /Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home/bin/java (found version \"11.0.16\") \r\n-- Found JNI: /Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home/include  found components: AWT JVM \r\nCMake Error at dataset/CMakeLists.txt:18 (find_package):\r\n  By not providing \"FindArrowDataset.cmake\" in CMAKE_MODULE_PATH this project\r\n  has asked CMake to find a package configuration file provided by\r\n  \"ArrowDataset\", but CMake did not find one.\r\n\r\n  Could not find a package configuration file provided by \"ArrowDataset\" with\r\n  any of the following names:\r\n\r\n    ArrowDatasetConfig.cmake\r\n    arrowdataset-config.cmake\r\n\r\n  Add the installation prefix of \"ArrowDataset\" to CMAKE_PREFIX_PATH or set\r\n  \"ArrowDataset_DIR\" to a directory containing one of the above files.  If\r\n  \"ArrowDataset\" provides a separate development package or SDK, be sure it\r\n  has been installed.\r\n\r\n\r\n-- Configuring incomplete, errors occurred!\r\nSee also \"/Users/rok/Documents/repos/arrow/java-jni/CMakeFiles/CMakeOutput.log\".\r\nSee also \"/Users/rok/Documents/repos/arrow/java-jni/CMakeFiles/CMakeError.log\".\r\n[ERROR] Command execution failed.\r\norg.apache.commons.exec.ExecuteException: Process exited with an error: 1 (Exit value: 1)\r\n    at org.apache.commons.exec.DefaultExecutor.executeInternal (DefaultExecutor.java:404)\r\n    at org.apache.commons.exec.DefaultExecutor.execute (DefaultExecutor.java:166)\r\n    at org.codehaus.mojo.exec.ExecMojo.executeCommandLine (ExecMojo.java:1000)\r\n    at org.codehaus.mojo.exec.ExecMojo.executeCommandLine (ExecMojo.java:947)\r\n    at org.codehaus.mojo.exec.ExecMojo.execute (ExecMojo.java:471)\r\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:137)\r\n    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute2 (MojoExecutor.java:370)\r\n    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute (MojoExecutor.java:351)\r\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:215)\r\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:171)\r\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:163)\r\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\r\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\r\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\r\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\r\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:294)\r\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\r\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\r\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:960)\r\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:293)\r\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:196)\r\n    at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\r\n    at jdk.internal.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\r\n    at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\r\n    at java.lang.reflect.Method.invoke (Method.java:566)\r\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\r\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\r\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\r\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] BUILD FAILURE\r\n[INFO] ------------------------------------------------------------------------\r\n```\r\n\r\nI assume it's a bug, but could just be my laptop. `[~kou]`",
        "created_at": "2022-11-08T03:33:49.000Z",
        "updated_at": "2022-11-16T16:42:40.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Java",
            "Type: enhancement"
        ],
        "closed": true,
        "closed_at": "2022-11-16T05:25:11.000Z"
    },
    "comments": [
        {
            "created_at": "2022-11-10T01:16:05.345Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17631373) by Kouhei Sutou (kou):*\nThis is caused by using not CMake compatible architecture name. `lib/cmake/ArrrowDataset/ArrowDatasetConfig.cmake` matches `find_package()`'s search pattern but `lib/x86_64/cmake/ArrowDataset/ARrowDatasetConfig.cmake` doesn't.\r\nSee https://cmake.org/cmake/help/latest/command/find_package.html#config-mode-search-procedure for the `find_package()`'s search path.\r\n\r\nCould you try the following patch?\r\n\r\n```\n\r\ndiff --git a/java/pom.xml b/java/pom.xml\r\nindex 78182242ad..44137d819e 100644\r\n--- a/java/pom.xml\r\n+++ b/java/pom.xml\r\n@@ -1058,7 +1058,7 @@\r\n                     -DCMAKE_BUILD_TYPE=Release\r\n                     -DCMAKE_INSTALL_LIBDIR=lib/${os.detected.arch}\r\n                     -DCMAKE_INSTALL_PREFIX=${arrow.dataset.jni.dist.dir}\r\n-                    -DCMAKE_PREFIX_PATH=${project.basedir}/../java-dist\r\n+                    -DCMAKE_PREFIX_PATH=${project.basedir}/../java-dist/lib/${os.detected.arch}/cmake\r\n                   </commandlineArgs>\r\n                   <workingDirectory>../</workingDirectory>\r\n                 </configuration>\r\n@@ -1175,7 +1175,7 @@\r\n                     -DCMAKE_BUILD_TYPE=Release\r\n                     -DCMAKE_INSTALL_LIBDIR=lib/${os.detected.arch}\r\n                     -DCMAKE_INSTALL_PREFIX=${arrow.dataset.jni.dist.dir}\r\n-                    -DCMAKE_PREFIX_PATH=${project.basedir}/../java-dist\r\n+                    -DCMAKE_PREFIX_PATH=${project.basedir}/../java-dist/lib/${os.detected.arch}/cmake\r\n                   </commandlineArgs>\r\n                   <workingDirectory>../</workingDirectory>\r\n```"
        },
        {
            "created_at": "2022-11-10T02:57:41.823Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17631409) by Rok Mihevc (rokm):*\n@kou this diff on top of master builds dynlibs on M1. This\r\n```bash\n\r\nmvn generate-resources -Pgenerate-libs-jni-macos-linux -N\r\n```\r\ncompletes fine.\r\nHowever:\r\n```bash\n\r\nmvn -Darrow.cpp.build.dir=/Users/rok/Documents/repos/arrow/java-dist/lib/ -Parrow-jni clean install\r\n```\r\nFails for gandiva and c data interface with:\r\n```bash\n\r\n[ERROR] Failed to execute goal org.xolstice.maven.plugins:protobuf-maven-plugin:0.6.1:compile (default) on project arrow-gandiva: Unable to resolve artifact: Missing:\r\n[ERROR] ----------\r\n[ERROR] 1) com.google.protobuf:protoc:exe:osx-aarch_64:3.20.3\r\n[ERROR] \r\n[ERROR]   Try downloading the file manually from the project website.\r\n[ERROR] \r\n[ERROR]   Then, install it using the command: \r\n[ERROR]       mvn install:install-file -DgroupId=com.google.protobuf -DartifactId=protoc -Dversion=3.20.3 -Dclassifier=osx-aarch_64 -Dpackaging=exe -Dfile=/path/to/file\r\n[ERROR] \r\n[ERROR]   Alternatively, if you host your own repository you can deploy the file there: \r\n[ERROR]       mvn deploy:deploy-file -DgroupId=com.google.protobuf -DartifactId=protoc -Dversion=3.20.3 -Dclassifier=osx-aarch_64 -Dpackaging=exe -Dfile=/path/to/file -Durl=[url] -DrepositoryId=[id]\r\n[ERROR] \r\n[ERROR]   Path to dependency: \r\n[ERROR]   \t1) org.apache.arrow.gandiva:arrow-gandiva:jar:11.0.0-SNAPSHOT\r\n[ERROR]   \t2) com.google.protobuf:protoc:exe:osx-aarch_64:3.20.3\r\n[ERROR] \r\n[ERROR] ----------\r\n[ERROR] 1 required artifact is missing.\r\n[ERROR] \r\n[ERROR] for artifact: \r\n[ERROR]   org.apache.arrow.gandiva:arrow-gandiva:jar:11.0.0-SNAPSHOT\r\n[ERROR] \r\n[ERROR] from the specified remote repositories:\r\n[ERROR]   apache.snapshots (https://repository.apache.org/snapshots, releases=false, snapshots=true),\r\n[ERROR]   central (https://repo.maven.apache.org/maven2, releases=true, snapshots=false)\r\n[ERROR] \r\n[ERROR] -> [Help 1]\r\n[ERROR] \r\n[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\r\n[ERROR] Re-run Maven using the -X switch to enable full debug logging.\r\n[ERROR] \r\n[ERROR] For more information about the errors and possible solutions, please read the following articles:\r\n[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException\r\n[ERROR] \r\n[ERROR] After correcting the problems, you can resume the build with the command\r\n[ERROR]   mvn <args> -rf :arrow-gandiva\r\n```\r\nand\r\n```bash\n\r\n[ERROR]   StreamTest.testRoundtripInts:94->roundtrip:257->roundtrip:228 \u00bb IllegalState error loading native libraries: java.io.FileNotFoundException: aarch_64/libarrow_cdata_jni.dylib\r\n```\r\nrespectively."
        },
        {
            "created_at": "2022-11-10T03:00:00.828Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17631410) by Rok Mihevc (rokm):*\nI can take a look at these tomorrow."
        },
        {
            "created_at": "2022-11-10T23:50:49.260Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17631968) by Rok Mihevc (rokm):*\n@kou I didn't manage today, I'll do it first thing in the morning."
        },
        {
            "created_at": "2022-11-11T01:27:24.430Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17632011) by Kouhei Sutou (kou):*\nIf we  want to support these command lines, we need to enable Gandiva:\r\n\r\n```\n\r\ndiff --git a/java/pom.xml b/java/pom.xml\r\nindex 78182242ad..70dc69bd72 100644\r\n--- a/java/pom.xml\r\n+++ b/java/pom.xml\r\n@@ -1089,6 +1089,7 @@\r\n         <arrow.dataset.jni.dist.dir>java-dist</arrow.dataset.jni.dist.dir>\r\n         <cpp.dependencies.builded>false</cpp.dependencies.builded>\r\n         <ARROW_CSV>ON</ARROW_CSV>\r\n+        <ARROW_GANDIVA>ON</ARROW_GANDIVA>\r\n         <ARROW_ORC>OFF</ARROW_ORC>\r\n         <ARROW_PARQUET>ON</ARROW_PARQUET>\r\n         <ARROW_JAVA_JNI_ENABLE_C>OFF</ARROW_JAVA_JNI_ENABLE_C>\r\n@@ -1120,6 +1121,7 @@\r\n                     -DARROW_DATASET=ON\r\n                     -DARROW_DEPENDENCY_USE_SHARED=OFF\r\n                     -DARROW_FILESYSTEM=ON\r\n+                    -DARROW_GANDIVA=${ARROW_GANDIVA}\r\n                     -DARROW_ORC=${ARROW_ORC}\r\n                     -DARROW_PARQUET=${ARROW_PARQUET}\r\n                     -DARROW_S3=ON\r\n```"
        },
        {
            "created_at": "2022-11-11T01:28:56.978Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17632012) by Kouhei Sutou (kou):*\nAh, sorry. This is the configuration for Windows.\r\n\r\nWe need to enable Gandiva explicitly:\r\n\r\n```\n\r\nmvn generate-resources -Pgenerate-libs-jni-macos-linux -DARROW_GANDIVA=ON -DARROW_JAVA_JNI_ENABLE_GANDIVA=ON -N\r\n```"
        },
        {
            "created_at": "2022-11-11T02:34:49.368Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17632036) by Kouhei Sutou (kou):*\nFor C data, we also need `-DARROW_JAVA_JNI_ENABLE_C=ON` and `-Darrow.c.jni.dist.dir`:\r\n\r\n```\n\r\nmvn generate-resources -Pgenerate-libs-jni-macos-linux -DARROW_GANDIVA=ON -DARROW_JAVA_JNI_ENABLE_GANDIVA=ON -DARROW_JAVA_JNI_ENABLE_C=ON -N\r\nmvn -Darrow.cpp.build.dir=$PWD/../java-dist/lib/ -Darrow.c.jni.dist.dir=$PWD/../java-dist/lib/ -Parrow-jni clean install\r\n```"
        },
        {
            "created_at": "2022-11-11T12:26:42.235Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17632309) by Rok Mihevc (rokm):*\nThis works @kou! I'll open a PR for the docs.\r\nThe only thing I had to do extra was install protobuf for aarch_64 as suggested by the error I pasted above:\r\n```bash\n\r\nmvn install:install-file -DgroupId=com.google.protobuf -DartifactId=protoc -Dversion=3.20.3 -Dclassifier=osx-aarch_64 -Dpackaging=exe -Dfile=/path/to/file\r\n```\r\nI wonder if that can be automated somehow.\r\n"
        },
        {
            "created_at": "2022-11-16T05:25:11.339Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18278?focusedCommentId=17634651) by Kouhei Sutou (kou):*\nIssue resolved by pull request 14623\n<https://github.com/apache/arrow/pull/14623>"
        }
    ]
}