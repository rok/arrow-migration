{
    "issue": {
        "title": "[C++] ASAN reports initialization-order-fiasco",
        "body": "***Note**: This issue was originally created as [ARROW-14622](https://issues.apache.org/jira/browse/ARROW-14622). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\n```Java\n\r\nin arrow::compute::SortOptions::SortOptions(std::__u::vector<arrow::compute::SortKey, std::__u::allocator<arrow::compute::SortKey> >) arrow/compute/api_vector.cc:136:23\r\n\r\nin arrow::compute::SortOptions::Defaults() arrow/compute/api_vector.h:117:42\r\n\r\nin __cxx_global_var_init arrow/compute/kernels/vector_sort.cc:1622:34\r\n\r\nin _GLOBAL__sub_I_vector_sort.cc arrow/compute/kernels/vector_sort.cc\r\n```",
        "created_at": "2021-11-06T06:28:04.000Z",
        "updated_at": "2021-11-08T22:38:31.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2021-11-08T14:53:43.000Z"
    },
    "comments": [
        {
            "created_at": "2021-11-06T07:09:08.825Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14622?focusedCommentId=17439613) by Vitaly Buka (bvsbvs):*\n```Java\n\r\nclang --version\r\nclang version 14.0.0 (https://github.com/llvm/llvm-project.git 3c7960cba19ed926b8e86b4c619e81c0f7da4d15)\r\n```\r\n\r\n```Java\n\r\ncmake -DCMAKE_C_COMPILER=<CLANG_BUILD_DIR>/bin/clang -DCMAKE_CXX_COMPILER=<CLANG_BUILD_DIR>/bin/clang++ -DARROW_COMPUTE=ON -DCMAKE_BUILD_TYPE=Debug -DARROW_BUILD_TESTS=ON -DARROW_USE_ASAN=ON -GNinja ..\r\n\r\nASAN_OPTIONS=check_initialization_order=1:strict_init_order=1 ninja unittest\r\n\r\n38/38 Test  #5: arrow-public-api-test ...............***Failed    0.41 sec\r\nRunning arrow-public-api-test, redirecting output into arrow/cpp/debug/build/test-logs/arrow-public-api-test.txt (attempt 1/1)\r\n=================================================================\r\n==4121244==ERROR: AddressSanitizer: initialization-order-fiasco on address 0x7f2b4da96de0 at pc 0x7f2b4a0aa803 bp 0x7ffcd9bcc450 sp 0x7ffcd9bcc448\r\nREAD of size 8 at 0x7f2b4da96de0 thread T0\r\n    #0 0x7f2b4a0aa802 in arrow::compute::JoinOptions::JoinOptions(arrow::compute::JoinOptions::NullHandlingBehavior, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >) arrow/cpp/src/arrow/compute/api_scalar.cc:295:23\r\n    #1 0x7f2b4b80a347 in arrow::compute::JoinOptions::Defaults() arrow/cpp/src/arrow/compute/api_scalar.h:126:42\r\n    #2 0x7f2b4906653f in __cxx_global_var_init.140 arrow/cpp/src/arrow/compute/kernels/scalar_string.cc:4620:34\r\n    #3 0x7f2b4907030f in _GLOBAL__sub_I_scalar_string.cc arrow/cpp/src/arrow/compute/kernels/scalar_string.cc\r\n    #4 0x7f2b4e24a10d in call_init elf/dl-init.c:74:3\r\n    #5 0x7f2b4e24a1ef in call_init elf/dl-init.c:37:6\r\n    #6 0x7f2b4e24a1ef in _dl_init elf/dl-init.c:121:5\r\naddr2line: DWARF error: section .debug_info is larger than its filesize! (0x6f5fb vs 0x63220)\r\n    #0 0x7f2b4e23b089 in ?? ??:0\r\n\r\n0x7f2b4da96de0 is located 32 bytes to the left of global variable 'arrow::compute::internal::(anonymous namespace)::kMatchSubstringOptionsType' defined in 'arrow/cpp/src/arrow/compute/api_scalar.cc:202:13' (0x7f2b4da96e00) of size 8\r\n  registered at:\r\n    #0 0x43aa96 in __asan_register_globals /usr/local/google/home/vitalybuka/src/llvm.git/llvm-project/compiler-rt/lib/asan/asan_globals.cpp:360:3\r\n    #1 0x7f2b4a19560e in asan.module_ctor api_scalar.cc\r\n    #2 0x7f2b4e24a10d in call_init elf/dl-init.c:74:3\r\n\r\n0x7f2b4da96de0 is located 0 bytes inside of global variable 'arrow::compute::internal::(anonymous namespace)::kJoinOptionsType' defined in 'arrow/cpp/src/arrow/compute/api_scalar.cc:199:13' (0x7f2b4da96de0) of size 8\r\n  registered at:\r\n    #0 0x43aa96 in __asan_register_globals /usr/local/google/home/vitalybuka/src/llvm.git/llvm-project/compiler-rt/lib/asan/asan_globals.cpp:360:3\r\n    #1 0x7f2b4a19560e in asan.module_ctor api_scalar.cc\r\n    #2 0x7f2b4e24a10d in call_init elf/dl-init.c:74:3\r\n\r\nSUMMARY: AddressSanitizer: initialization-order-fiasco arrow/cpp/src/arrow/compute/api_scalar.cc:295:23 in arrow::compute::JoinOptions::JoinOptions(arrow::compute::JoinOptions::NullHandlingBehavior, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >)\r\nShadow bytes around the buggy address:\r\n  0x0fe5e9b4ad60: 00 f9 f9 f9 00 00 00 00 f9 f9 f9 f9 00 f9 f9 f9\r\n  0x0fe5e9b4ad70: 00 00 00 00 00 00 f9 f9 f9 f9 f9 f9 00 f9 f9 f9\r\n  0x0fe5e9b4ad80: 00 f9 f9 f9 00 f9 f9 f9 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4ad90: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4ada0: f6 f6 f6 f6 00 00 00 00 00 00 00 00 f6 f6 f6 f6\r\n=>0x0fe5e9b4adb0: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6[f6]f6 f6 f6\r\n  0x0fe5e9b4adc0: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4add0: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4ade0: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4adf0: f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6 f6\r\n  0x0fe5e9b4ae00: f6 f6 f6 f6 00 00 00 00 00 00 00 00 00 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07\r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==4121244==ABORTING\r\n\r\n\r\n0% tests passed, 38 tests failed out of 38\r\n\r\nLabel Time Summary:\r\narrow-tests      =  11.47 sec*proc (27 tests)\r\narrow_compute    =   4.73 sec*proc (11 tests)\r\nunittest         =  16.21 sec*proc (38 tests)\r\n\r\nTotal Test time (real) =   4.27 sec\r\n\r\nThe following tests FAILED:\r\n\t  1 - arrow-array-test (Failed)\r\n\t  2 - arrow-buffer-test (Failed)\r\n\t  3 - arrow-extension-type-test (Failed)\r\n\t  4 - arrow-misc-test (Failed)\r\n\t  5 - arrow-public-api-test (Failed)\r\n\t  6 - arrow-scalar-test (Failed)\r\n\t  7 - arrow-type-test (Failed)\r\n\t  8 - arrow-table-test (Failed)\r\n\t  9 - arrow-tensor-test (Failed)\r\n\t 10 - arrow-sparse-tensor-test (Failed)\r\n\t 11 - arrow-stl-test (Failed)\r\n\t 12 - arrow-random-test (Failed)\r\n\t 13 - arrow-json-integration-test (Failed)\r\n\t 14 - arrow-concatenate-test (Failed)\r\n\t 15 - arrow-diff-test (Failed)\r\n\t 16 - arrow-c-bridge-test (Failed)\r\n\t 17 - arrow-io-buffered-test (Failed)\r\n\t 18 - arrow-io-compressed-test (Failed)\r\n\t 19 - arrow-io-file-test (Failed)\r\n\t 20 - arrow-io-memory-test (Failed)\r\n\t 21 - arrow-utility-test (Failed)\r\n\t 22 - arrow-threading-utility-test (Failed)\r\n\t 23 - arrow-compute-internals-test (Failed)\r\n\t 24 - arrow-compute-scalar-test (Failed)\r\n\t 25 - arrow-compute-vector-test (Failed)\r\n\t 26 - arrow-compute-aggregate-test (Failed)\r\n\t 27 - arrow-compute-kernel-utility-test (Failed)\r\n\t 28 - arrow-compute-expression-test (Failed)\r\n\t 29 - arrow-compute-plan-test (Failed)\r\n\t 30 - arrow-compute-hash-join-node-test (Failed)\r\n\t 31 - arrow-compute-union-node-test (Failed)\r\n\t 32 - arrow-compute-util-test (Failed)\r\n\t 33 - arrow-compute-ir-test (Failed)\r\n\t 34 - arrow-feather-test (Failed)\r\n\t 35 - arrow-ipc-json-simple-test (Failed)\r\n\t 36 - arrow-ipc-read-write-test (Failed)\r\n\t 37 - arrow-ipc-tensor-test (Failed)\r\n\t 38 - arrow-json-test (Failed)\r\nErrors while running CTest\r\n```\r\n"
        },
        {
            "created_at": "2021-11-08T14:53:43.321Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14622?focusedCommentId=17440525) by Antoine Pitrou (apitrou):*\nIssue resolved by pull request 11633\n<https://github.com/apache/arrow/pull/11633>"
        }
    ]
}