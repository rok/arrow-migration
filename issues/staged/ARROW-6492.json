{
    "issue": {
        "title": "[Python] file written with latest fastparquet cannot be read with latest pyarrow",
        "body": "***Note**: This issue was originally created as [ARROW-6492](https://issues.apache.org/jira/browse/ARROW-6492). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nFrom report on the pandas issue tracker: https://github.com/pandas-dev/pandas/issues/28252\r\n\r\nWith the latest released versions of fastparquet (0.3.2) and pyarrow (0.14.1), writing a file with pandas using the fastparquet engine cannot be read with the pyarrow engine:\r\n\r\n```Java\n\r\ndf = pd.DataFrame({'A': [1, 2, 3]})\r\ndf.to_parquet(\"test.parquet\", engine=\"fastparquet\", compression=None)                                                                                                                                     \r\npd.read_parquet(\"test.parquet\", engine=\"pyarrow\")   \r\n```\r\n\r\ngives the following error when reading:\r\n\r\n```Java\n\r\n----> 1 pd.read_parquet(\"test.parquet\", engine=\"pyarrow\")\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pandas/io/parquet.py in read_parquet(path, engine, columns, **kwargs)\r\n    292 \r\n    293     impl = get_engine(engine)\r\n--> 294     return impl.read(path, columns=columns, **kwargs)\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pandas/io/parquet.py in read(self, path, columns, **kwargs)\r\n    123         kwargs[\"use_pandas_metadata\"] = True\r\n    124         result = self.api.parquet.read_table(\r\n--> 125             path, columns=columns, **kwargs\r\n    126         ).to_pandas()\r\n    127         if should_close:\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/array.pxi in pyarrow.lib._PandasConvertible.to_pandas()\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/table.pxi in pyarrow.lib.Table._to_pandas()\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/pandas_compat.py in table_to_blockmanager(options, table, categories, ignore_metadata)\r\n    642         column_indexes = pandas_metadata.get('column_indexes', [])\r\n    643         index_descriptors = pandas_metadata['index_columns']\r\n--> 644         table = _add_any_metadata(table, pandas_metadata)\r\n    645         table, index = _reconstruct_index(table, index_descriptors,\r\n    646                                           all_columns)\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/pandas_compat.py in _add_any_metadata(table, pandas_metadata)\r\n    965                 raw_name = 'None'\r\n    966 \r\n--> 967         idx = schema.get_field_index(raw_name)\r\n    968         if idx != -1:\r\n    969             if col_meta['pandas_type'] == 'datetimetz':\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/types.pxi in pyarrow.lib.Schema.get_field_index()\r\n\r\n~/miniconda3/lib/python3.7/site-packages/pyarrow/lib.cpython-37m-x86_64-linux-gnu.so in string.from_py.__pyx_convert_string_from_py_std__in_string()\r\n\r\nTypeError: expected bytes, dict found\r\n```",
        "created_at": "2019-09-09T12:39:37.000Z",
        "updated_at": "2019-09-09T20:33:24.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2019-09-09T20:33:23.000Z"
    },
    "comments": [
        {
            "created_at": "2019-09-09T12:48:12.128Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6492?focusedCommentId=16925656) by Joris Van den Bossche (jorisvandenbossche):*\nThis is related to a difference in the pandas metadata written by both libraries:\r\n\r\n```Java\n\r\nIn [58]: import pyarrow.parquet as pq\r\n\r\nIn [59]: pq.read_schema(\"test.parquet\").pandas_metadata\r\nOut[59]: \r\n{'column_indexes': [{'field_name': None,\r\n   'metadata': None,\r\n   'name': None,\r\n   'numpy_type': 'object',\r\n   'pandas_type': 'mixed-integer'}],\r\n 'columns': [{'metadata': None,\r\n   'name': 'A',\r\n   'numpy_type': 'int64',\r\n   'pandas_type': 'int64'}],\r\n 'index_columns': [{'kind': 'range',\r\n   'name': None,\r\n   'start': 0,\r\n   'step': 1,\r\n   'stop': 3}],\r\n 'pandas_version': '0.25.0'}\r\n\r\nIn [60]: df.to_parquet(\"test_pa.parquet\", engine=\"pyarrow\")\r\n\r\nIn [61]: pq.read_schema(\"test_pa.parquet\").pandas_metadata \r\nOut[61]: \r\n{'index_columns': [{'kind': 'range',\r\n   'name': None,\r\n   'start': 0,\r\n   'stop': 3,\r\n   'step': 1}],\r\n 'column_indexes': [{'name': None,\r\n   'field_name': None,\r\n   'pandas_type': 'unicode',\r\n   'numpy_type': 'object',\r\n   'metadata': {'encoding': 'UTF-8'}}],\r\n 'columns': [{'name': 'A',\r\n   'field_name': 'A',\r\n   'pandas_type': 'int64',\r\n   'numpy_type': 'int64',\r\n   'metadata': None}],\r\n 'creator': {'library': 'pyarrow', 'version': '0.14.1'},\r\n 'pandas_version': '0.25.0'}\r\n```\r\n\r\nThe difference that is causing the bug is in the `columns` field where in the \"field_name\" key is not written by the fastparquet engine (it does write a field_name in \"column_indexes\", but not in \"columns\").\r\n\r\nI will open an issue on the fastparquet side to ensure both libraries write consistent metadata, but on the short term let's also fix this in pyarrow (this seems a bug in the code that deals with older files, where there was no \"field_name\" as well)."
        },
        {
            "created_at": "2019-09-09T20:33:23.315Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6492?focusedCommentId=16926082) by Wes McKinney (wesm):*\nIssue resolved by pull request 5331\n<https://github.com/apache/arrow/pull/5331>"
        }
    ]
}