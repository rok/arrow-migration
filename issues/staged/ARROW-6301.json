{
    "issue": {
        "title": "[Python] atexit: pyarrow.lib.ArrowKeyError: 'No type extension with name arrow.py_extension_type found'",
        "body": "***Note**: This issue was originally created as [ARROW-6301](https://issues.apache.org/jira/browse/ARROW-6301). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nOn interrupt, I am frequently seeing the atexit function failing in pyarrow 0.14.1.\r\n```java\n\r\n ^CSIGINT/SIGQUIT received...killing workers... \r\nkilling the spooler with pid 22640 \r\nError in atexit._run_exitfuncs: \r\nTraceback (most recent call last): \r\n \u00a0File \"/home/alpha/.virtualenvs/wsgi/lib/python2.7/atexit.py\", line 24, in _run_exitfuncs \r\n \u00a0\u00a0\u00a0func(*targs, **kargs) \r\n \u00a0File \"pyarrow/types.pxi\", line 1860, in pyarrow.lib._unregister_py_extension_type \r\n \u00a0\u00a0\u00a0check_status(UnregisterPyExtensionType()) \r\n \u00a0File \"pyarrow/error.pxi\", line 91, in pyarrow.lib.check_status \r\n \u00a0\u00a0\u00a0raise ArrowKeyError(message) \r\nArrowKeyError: 'No type extension with name arrow.py_extension_type found' \r\nError in sys.exitfunc: \r\nTraceback (most recent call last): \r\n \u00a0File \"/home/alpha/.virtualenvs/wsgi/lib/python2.7/atexit.py\", line 24, in _run_exitfuncs \r\n \u00a0\u00a0\u00a0func(*targs, **kargs) \r\n \u00a0File \"pyarrow/types.pxi\", line 1860, in pyarrow.lib._unregister_py_extension_type \r\n \u00a0File \"pyarrow/error.pxi\", line 91, in pyarrow.lib.check_status \r\npyarrow.lib.ArrowKeyError: 'No type extension with name arrow.py_extension_type found' \r\nspooler (pid: 22640) annihilated \r\nworker 1 buried after 1 seconds \r\ngoodbye to uWSGI.\n```",
        "created_at": "2019-08-20T14:50:47.000Z",
        "updated_at": "2019-08-27T15:34:36.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2019-08-26T10:12:05.000Z"
    },
    "comments": [
        {
            "created_at": "2019-08-20T15:22:22.212Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16911454) by David Alphus (david.alphus):*\nWhen recompiling I got a segfault during atexit. Not totally sure if this is a separate issue.\r\n```java\n\r\n Program terminated with signal SIGSEGV, Segmentation fault.\r\n#0  0x00007fc08437576d in accept () at ../sysdeps/unix/syscall-template.S:84\r\n84      ../sysdeps/unix/syscall-template.S: No such file or directory.\r\n[Current thread is 1 (Thread 0x7fc07e2f6700 (LWP 28153))]\r\n(gdb) thread apply all btThread 6 (Thread 0x7fc06249a700 (LWP 28169)):\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\r\n#1  0x00007fc0625134d8 in th_worker (tidptr=<optimized out>) at numexpr/module.cpp:59\r\n#2  0x00007fc08436c6ba in start_thread (arg=0x7fc06249a700) at pthread_create.c:333\r\n#3  0x00007fc08333b41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109Thread 5 (Thread 0x7fc061498700 (LWP 28171)):\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\r\n#1  0x00007fc0625134d8 in th_worker (tidptr=<optimized out>) at numexpr/module.cpp:59\r\n#2  0x00007fc08436c6ba in start_thread (arg=0x7fc061498700) at pthread_create.c:333\r\n#3  0x00007fc08333b41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109Thread 4 (Thread 0x7fc060c97700 (LWP 28172)):\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\r\n#1  0x00007fc0625134d8 in th_worker (tidptr=<optimized out>) at numexpr/module.cpp:59\r\n#2  0x00007fc08436c6ba in start_thread (arg=0x7fc060c97700) at pthread_create.c:333\r\n#3  0x00007fc08333b41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109Thread 3 (Thread 0x7fc08477a700 (LWP 28151)):\r\n#0  _dl_fini () at dl-fini.c:180\r\n#1  0x00007fc08326dff8 in __run_exit_handlers (status=1, listp=0x7fc0835f85f8 <__exit_funcs>, \r\n    run_list_atexit=run_list_atexit@entry=true) at exit.c:82\r\n#2  0x00007fc08326e045 in __GI_exit (status=<optimized out>) at exit.c:104\r\n#3  0x000000000041b72f in uwsgi_exit ()\r\n#4  0x0000000000469a81 in uwsgi_segfault ()\r\n#5  <signal handler called>\r\n#6  0x00007fc0646a47aa in std::_Hashtable<std::string, std::pair<std::string const, std::shared_ptr<arrow::ExtensionType> >, std::allocator<std::pair<std::string const, std::shared_ptr<arrow::ExtensionType> > >, std::__detail::_Select1st, std::equal_to<std::string>, std::hash<std::string>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<true, false, true> >::_M_find_before_node(unsigned long, std::string const&, unsigned long) const () from /home/alpha/.virtualenvs/uwsgi/lib/libarrow.so.14\r\n#7  0x00007fc0646a4864 in std::_Hashtable<std::string, std::pair<std::string const, std::shared_ptr<arrow::ExtensionType> >, std::allocator<std::pair<std::string const, std::shared_ptr<arrow::ExtensionType> > >, std::__detail::_Select1st, std::equal_to<std::string>, std::hash<std::string>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<true, false, true> >::find(std::string const&) ()\r\n   from /home/alpha/.virtualenvs/uwsgi/lib/libarrow.so.14\r\n#8  0x00007fc0646a2624 in arrow::UnregisterExtensionType(std::string const&) ()\r\n   from /home/alpha/.virtualenvs/uwsgi/lib/libarrow.so.14\r\n#9  0x00007fc0641976fd in arrow::py::UnregisterPyExtensionType() ()\r\n   from /home/alpha/.virtualenvs/uwsgi/lib/libarrow_python.so.14\r\n#10 0x00007fc064db8486 in __pyx_pw_7pyarrow_3lib_91_unregister_py_extension_type(_object*, _object*) ()\r\n   from /home/alpha/.virtualenvs/uwsgi/lib/python2.7/site-packages/pyarrow/lib.so\r\n#11 0x00007fc08394630f in PyEval_EvalFrameEx () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#12 0x00007fc083948fe8 in PyEval_EvalCodeEx () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#13 0x00007fc0838bd3e9 in ?? () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#14 0x00007fc08388c773 in PyObject_Call () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#15 0x00007fc08393ee57 in PyEval_CallObjectWithKeywords () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#16 0x00007fc08396d764 in Py_Finalize () from /home/alpha/.virtualenvs/uwsgi/lib/libpython2.7.so.1.0\r\n#17 0x000000000046549d in uwsgi_plugins_atexit ()\r\n#18 0x00007fc08326dff8 in __run_exit_handlers (status=30, listp=0x7fc0835f85f8 <__exit_funcs>, \r\n    run_list_atexit=run_list_atexit@entry=true) at exit.c:82\r\n#19 0x00007fc08326e045 in __GI_exit (status=<optimized out>) at exit.c:104\r\n#20 0x000000000041b72f in uwsgi_exit ()\r\n#21 0x00000000004655d5 in end_me ()\r\n#22 <signal handler called>\r\n#23 0x00007fc08333ba13 in epoll_wait () at ../sysdeps/unix/syscall-template.S:84\r\n#24 0x0000000000458ea2 in event_queue_wait ()\r\n#25 0x000000000041d241 in wsgi_req_accept ()\r\n#26 0x0000000000461c67 in simple_loop_run ()\r\n#27 0x000000000046a3f4 in uwsgi_ignition ()\r\n#28 0x000000000046a7a0 in uwsgi_worker_run ()\r\n#29 0x000000000046ace5 in uwsgi_run ()\r\n#30 0x00007fc083254830 in __libc_start_main (main=0x46acf0 <main>, argc=6, argv=0x7ffdd9a19348, init=<optimized out>, \r\n    fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7ffdd9a19338) at ../csu/libc-start.c:291\r\n#31 0x000000000041a3d9 in _start ()\r\n---Type <return> to continue, or q <return> to quit---Thread 2 (Thread 0x7fc061c99700 (LWP 28170)):\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\r\n#1  0x00007fc0625134d8 in th_worker (tidptr=<optimized out>) at numexpr/module.cpp:59\r\n#2  0x00007fc08436c6ba in start_thread (arg=0x7fc061c99700) at pthread_create.c:333\r\n#3  0x00007fc08333b41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109Thread 1 (Thread 0x7fc07e2f6700 (LWP 28153)):\r\n#0  0x00007fc08437576d in accept () at ../sysdeps/unix/syscall-template.S:84\r\n#1  0x0000000000481207 in uwsgi_python_tracebacker_thread ()\r\n#2  0x00007fc08436c6ba in start_thread (arg=0x7fc07e2f6700) at pthread_create.c:333\r\n#3  0x00007fc08333b41d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\r\n```"
        },
        {
            "created_at": "2019-08-21T04:41:29.605Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16911943) by Wes McKinney (wesm):*\nIt looks like a race condition at teardown, some additional synchronization may be required. Since we aren't seeing this anywhere else it must have something to do with uWSGI's involvement"
        },
        {
            "created_at": "2019-08-21T15:22:01.220Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16912401) by Joris Van den Bossche (jorisvandenbossche):*\nShould we put the call to unregister the type in a `try .. except` block? Or would that only be masking the problem?"
        },
        {
            "created_at": "2019-08-21T20:28:59.049Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16912658) by Wes McKinney (wesm):*\nThat won't help with the segfault. I think we have to explicitly extend the lifetime of the extension registry so that we can ensure that it's still alive when the atexit teardown function is called. I will take a closer look when I can"
        },
        {
            "created_at": "2019-08-26T10:12:05.877Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16915666) by Antoine Pitrou (apitrou):*\nIssue resolved by pull request 5174\n<https://github.com/apache/arrow/pull/5174>"
        },
        {
            "created_at": "2019-08-27T15:21:06.470Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16916798) by Bogdan Klichuk (klichukb):*\nBumping this thread with related segfault, that [~david.alphus]\u00a0has during uWSGI atexit.\r\n\r\nI have\u00a0 a custom atexit handler during uWSGI graceful shutdown, which uses pyarrow code. Getting segfault. Is there an issue created for this?"
        },
        {
            "created_at": "2019-08-27T15:22:41.234Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16916799) by Antoine Pitrou (apitrou):*\n`[~klichukb]` not to my knowledge, can you open a new issue?"
        },
        {
            "created_at": "2019-08-27T15:34:36.895Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-6301?focusedCommentId=16916814) by Wes McKinney (wesm):*\n`[~klichukb]` do you still have the segfault on the master branch? "
        }
    ]
}