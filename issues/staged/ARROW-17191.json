{
    "issue": {
        "title": "[C++] MinGW Flight tests failing ",
        "body": "***Note**: This issue was originally created as [ARROW-17191](https://issues.apache.org/jira/browse/ARROW-17191). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nNoticed across several PRs\r\n```\n\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDataTest.TestDoExchangeError\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:490: Failure\r\nValue of: _st.IsNotImplemented()\r\n\u00a0 Actual: false\r\nExpected: true\r\nExpected 'writer->Close()' to fail with NotImplemented, but got IOError: Stream finished before first message sent. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52323 {created_time:\"2022-07-23T01:21:23.785644223+00:00\", grpc_status:2, grpc_message:\"Stream finished before first message sent\"}. Client context: OK. Detail: Failed\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:490: Failure\r\nValue of: _st.ToString()\r\nExpected: has substring \"Expected error\"\r\n\u00a0 Actual: \"IOError: Stream finished before first message sent. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52323 {created_time:\\\"2022-07-23T01:21:23.785644223+00:00\\\", grpc_status:2, grpc_message:\\\"Stream finished before first message sent\\\"}. Client context: OK. Detail: Failed\"\r\n[ \u00a0FAILED \u00a0] GrpcDataTest.TestDoExchangeError (5 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDataTest.TestDoExchangeConcurrency\r\n[ \u00a0 \u00a0 \u00a0 OK ] GrpcDataTest.TestDoExchangeConcurrency (5 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDataTest.TestDoExchangeUndrained\r\n[ \u00a0 \u00a0 \u00a0 OK ] GrpcDataTest.TestDoExchangeUndrained (4 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDataTest.TestIssue5095\r\n[ \u00a0 \u00a0 \u00a0 OK ] GrpcDataTest.TestIssue5095 (9 ms)\r\n[----------] 17 tests from GrpcDataTest (891 ms total)\r\n[----------] 7 tests from GrpcDoPutTest\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestInts\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0L\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52331 {grpc_message:\"Expected app_metadata to be foo bar but got \\x00L\\xf4\\x86\\x02\\xe0\\xa1\", grpc_status:3, created_time:\"2022-07-23T01:21:23.810734286+00:00\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestInts (4 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestFloats\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0<\ufffd\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52333 {grpc_message:\"Expected app_metadata to be foo bar but got \\x00<\\xee\\xc6\\x02\\xe0\\xa1\", grpc_status:3, created_time:\"2022-07-23T01:21:23.815439591+00:00\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestFloats (4 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestEmptyBatch\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0\ufffd\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52335 {grpc_message:\"Expected app_metadata to be foo bar but got \\x00\\x9c\\xef\\xa6\\x02\\xe0\\xa1\", grpc_status:3, created_time:\"2022-07-23T01:21:23.819872813+00:00\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestEmptyBatch (4 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestDicts\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0\\\ufffd\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52337 {grpc_message:\"Expected app_metadata to be foo bar but got \\x00\\\\\\xf0\\xc6\\x02\\xe0\\xa1\", grpc_status:3, created_time:\"2022-07-23T01:21:23.824172893+00:00\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestDicts (4 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestLargeBatch\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0|\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52339 {created_time:\"2022-07-23T01:21:24.001437714+00:00\", grpc_status:3, grpc_message:\"Expected app_metadata to be foo bar but got \\x00|\\xf2\\xa6\\x02\\xe0\\xa1\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestLargeBatch (185 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestSizeLimit\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:802: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0\\\ufffd,\u0007\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52341 {grpc_message:\"Expected app_metadata to be foo bar but got \\x00\\\\\\xef,\\x07\\xe0\\xa1\", grpc_status:3, created_time:\"2022-07-23T01:21:24.016917836+00:00\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestSizeLimit (8 ms)\r\n[ RUN \u00a0 \u00a0 \u00a0] GrpcDoPutTest.TestUndrained\r\nD:/a/arrow/arrow/cpp/src/arrow/flight/test_definitions.cc:690: Failure\r\nFailed\r\n'writer->Close()' failed with Invalid: Expected app_metadata to be foo bar but got \\0\ufffd\ufffd\u0002\ufffd. gRPC client debug context: UNKNOWN:Error received from peer ipv4:127.0.0.1:52343 {created_time:\"2022-07-23T01:21:24.022330532+00:00\", grpc_status:3, grpc_message:\"Expected app_metadata to be foo bar but got \\x00\\xac\\xee\\xa6\\x02\\xe0\\xa1\"}. Client context: OK\r\n[ \u00a0FAILED \u00a0] GrpcDoPutTest.TestUndrained (4 ms) \n```",
        "created_at": "2022-07-23T12:03:17.000Z",
        "updated_at": "2022-07-25T10:44:29.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2022-07-25T02:31:29.000Z"
    },
    "comments": [
        {
            "created_at": "2022-07-24T18:02:04.801Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17191?focusedCommentId=17570521) by David Li (lidavidm):*\nWhat I currently see: calling `make_shared` and passing the existing `shared_ptr<Buffer>` to slice a buffer also overwrites the data in the buffer, since the newly allocated buffer (or `shared_ptr` control structure?) overlaps the allocated gRPC buffer. The reason is unclear\u2026"
        },
        {
            "created_at": "2022-07-24T18:20:41.101Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17191?focusedCommentId=17570526) by David Li (lidavidm):*\nThe reason is that: sometimes (most times!) gRPC hands us a noncontiguous set of slices, which we have to concatenate into a single memory region to use with Flight. We use a gRPC function to do this. Also, slices can inline the data into the structure directly for small slices. It turns out that after concatenation, we can still get an inlined slice, which we weren't properly accounting for. And then the inlined slice would have its data overwritten when we sliced the buffer. I'm unclear why this is the case, though."
        },
        {
            "created_at": "2022-07-24T18:37:30.042Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17191?focusedCommentId=17570532) by David Li (lidavidm):*\n```\n\r\nThread 8 hit Watchpoint 2: *(uint8_t*) 0x509bfe569Old value = 26 '\\032'\r\nNew value = 169 '\u2592'\r\n0x00007ffa24604f88 in ?? () from C:\\msys64\\mingw64\\bin\\libstdc++-6.dll\r\n(gdb) bt\r\n#0 \u00a00x00007ffa24604f88 in ?? () from C:\\msys64\\mingw64\\bin\\libstdc++-6.dll\r\n#1 \u00a00x00007ffa2470a95c in ?? () from C:\\msys64\\mingw64\\bin\\libstdc++-6.dll\r\n#2 \u00a00x00007ff9dfb09f7d in std::__new_allocator<std::_Sp_counted_ptr_inplace<arrow::Buffer, std::allocator<void>, (__gnu_cxx::_Lock_policy)2> >::allocate (\r\n\u00a0 \u00a0 this=0x509bfe67f, __n=1)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/new_allocator.h:137\r\n#3 \u00a00x00007ff9dfb10eb6 in std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<arrow::Buffer, std::allocator<void>, (__gnu_cxx::_Lock_policy)2> > >::allocate (__a=..., __n=1)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/alloc_traits.h:464\r\n#4 \u00a00x00007ff9dfb30691 in std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<arrow::Buffer, std::allocator<void>, (__gnu_cxx::_Lock_policy)2> > > (__a=...) at C:/msys64/mingw64/include/c++/12.1.0/bits/allocated_ptr.h:98\r\n#5 \u00a00x00007ff9dfb055a3 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<arrow::Buffer, std::allocator<void>, std::shared_ptr<arrow::Buffer> const&, long long const&, long long const&> (this=0x509bfe848,\r\n\u00a0 \u00a0 __p=@0x509bfe840: 0x0, __a=...)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/shared_ptr_base.h:969\r\n#6 \u00a00x00007ff9dfafc2e0 in std::__shared_ptr<arrow::Buffer, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<void>, std::shared_ptr<arrow::Buffer> const&, long long const&, long long const&> (this=0x509bfe840, __tag=...)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/shared_ptr_base.h:1712\r\n#7 \u00a00x00007ff9dfaefb38 in std::shared_ptr<arrow::Buffer>::shared_ptr<std::allocator<void>, std::shared_ptr<arrow::Buffer> const&, long long const&, long long const&> (this=0x509bfe840, __tag=...)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/shared_ptr.h:464\r\n#8 \u00a00x00007ff9dfb2bc5a in std::make_shared<arrow::Buffer, std::shared_ptr<arrow::Buffer> const&, long long const&, long long const&> ()\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/c++/12.1.0/bits/shared_ptr.h:1010\r\n#9 \u00a00x00007ff9dfa79401 in arrow::SliceBuffer (\r\n\u00a0 \u00a0 buffer=std::shared_ptr<arrow::Buffer> (use count 1, weak count 0) = {...}, offset=2, length=7) at C:/msys64/home/User/arrow/cpp/src/arrow/buffer.h:324\r\n#10 0x00007ff9dfa7946a in arrow::flight::transport::grpc::ReadBytesZeroCopy (\r\n\u00a0 \u00a0 source_data=std::shared_ptr<arrow::Buffer> (use count 1, weak count 0) = {...}, input=0x509bfe960, out=0x1ace67a3020)\r\n\u00a0 \u00a0 at C:/msys64/home/User/arrow/cpp/src/arrow/flight/transport/grpc/serialization_internal.cc:83\r\n#11 0x00007ff9dfa7ac8f in arrow::flight::transport::grpc::FlightDataDeserialize (buffer=0x509bfed58, out=0x1ace67a3008)\r\n\u00a0 \u00a0 at C:/msys64/home/User/arrow/cpp/src/arrow/flight/transport/grpc/serialization_internal.cc:366\r\n#12 0x00007ff9dfa943fb in grpc::SerializationTraits<arrow::flight::protocol::FlightData, void>::Deserialize (buffer=0x509bfed58, msg=0x1ace67a3008)\r\n\u00a0 \u00a0 at C:/msys64/home/User/arrow/cpp/src/arrow/flight/transport/grpc/customize_grpc.h:102\r\n#13 0x00007ff9dfa9a651 in grpc::internal::CallOpRecvMessage<arrow::flight::protocol::FlightData>::FinishOp (this=0x509bfed48, status=0x509bfecef)\r\n\u00a0 \u00a0 at C:/msys64/mingw64/include/grpcpp/impl/codegen/call_op_set.h:456\r\n \n```"
        },
        {
            "created_at": "2022-07-25T02:31:29.236Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17191?focusedCommentId=17570581) by Kouhei Sutou (kou):*\nIssue resolved by pull request 13696\n<https://github.com/apache/arrow/pull/13696>"
        }
    ]
}