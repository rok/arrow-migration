{
    "issue": {
        "title": "[R] Don't store \"data.table\" pointer in metadata",
        "body": "***Note**: This issue was originally created as [ARROW-10088](https://issues.apache.org/jira/browse/ARROW-10088). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nIssues with metadata$r:\r\n\r\n- The \".internal.selfref\" attribute from data.table is an externalptr, which won't be valid to serialize and restore, so it needs to be dropped (and then presumably also the data.table class too)\n  \n-----\r\nOriginal description:\r\n\r\nI've got a proprietary dataset where one of the columns is an integer64 but all of the values would fit within 32bits.\u00a0 As I understand it, arrow/feather will downcast that column when the data is read back into R (not ideal IMO, but not an issue generally).\u00a0 However, I'm having some trouble with a specific dataset.\u00a0\r\n\r\nWhen I read in the data, the column is set to the class \"integer64\", however the column type (typeof) is 'integer' and not 'double', which is the underlying type used by bit64.\u00a0 This mismatch causes R data.table to error out (<https://github.com/Rdatatable/data.table/blob/master/src/rbindlist.c#L325)>\r\n\r\nI do not have any issue with integer64 columns which have values > 2^32, and suspiciously I am also unable to recreate the issue by manually creating a data.table with an int64 column with small values (e.g data.table(col=as.integer64(c(1,2,3))) )\r\n\r\nI did look thru the arrow::r cpp source and couldnt find an obvious case where the underlying storage array would be an integer but also have the 'integer64' class attr assigned...\u00a0 A fix would either be to remove the integer64 class attr, or ensure that the underlying data store is a REALSXP instead of INTEGERSXP\r\n\r\nMy company's network policies wont let me upload the sample dataset, hoping to see if this triggers an immediate thoughts.\u00a0 If not, I can try to figure our how to upload the dataset or otherwise provide details from it as requested.\r\n\r\n\u00a0\r\n```java\n\r\n> arrow::write_feather(df[,list(testCol)][1], '~/test.feather')\r\n> test = arrow::read_feather('~/test.feather')\r\n> class(test$testCol)\r\n[1] \"integer64\" \"np.ulong\"\r\n> typeof(test$testCol)\r\n[1] \"integer\"\r\n\r\n> str(test)\r\nClasses \u2018tbl_df\u2019, \u2018tbl\u2019 and 'data.frame':       1 obs. of  1 variable: $ testCol:Error in as.character.integer64(object) :  REAL() can only be applied to a 'numeric', not a 'integer'\r\n\r\n\r\n#In the larger original dataset, it handles most columns properly, only the 'testCol' breaks things.  Note the difference:\r\n> typeof(df$goodCol)\r\n[1] \"double\"\r\n> class(df$goodCol)\r\n[1] \"integer64\" \"np.ulong\"\r\n\r\n> typeof(df$testCol)\r\n[1] \"integer\"\r\n> class(df$testCol)\r\n[1] \"integer64\" \"np.ulong\"\r\n\r\n> str(df)\r\nClasses \u2018data.table\u2019 and 'data.frame':  214781 obs. of  17 variables: \r\n$ goodCol        :integer64 1599777000000604025 ... \r\n$ testCol        :Error in as.character.integer64(object) :\r\n\r\n> sessionInfo()\r\nR version 3.6.1 (2019-07-05)Platform: x86_64-pc-linux-gnu (64-bit)Running under: Red Hat Enterprise Linux Server 7.7 (Maipo)\r\nMatrix products: defaultBLAS:   /usr/lib64/libblas.so.3.4.2LAPACK: /usr/lib64/liblapack.so.3.4.2locale: \r\n\r\n[1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C [9] LC_ADDRESS=C               LC_TELEPHONE=C[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C\r\n\r\nattached base packages:[1] stats     graphics  grDevices utils     datasets  methods   baseother attached packages:[1] data.table_1.13.0 bit64_4.0.5       bit_4.0.4loaded via a namespace (and not attached): [1] Rcpp_1.0.5           lattice_0.20-41      arrow_1.0.1 [4] assertthat_0.2.1     rappdirs_0.3.1       grid_3.6.1 [7] R6_2.4.1             jsonlite_1.7.1       magrittr_1.5[10] rlang_0.4.7          Matrix_1.2-18        vctrs_0.3.4[13] reticulate_1.14-9001 tools_3.6.1          glue_1.4.2[16] purrr_0.3.4          compiler_3.6.1       tidyselect_1.1.0\n```",
        "created_at": "2020-09-25T02:53:54.000Z",
        "updated_at": "2022-07-12T14:04:42.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: R",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2020-09-25T15:03:33.148Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17202225) by Neal Richardson (npr):*\nMy guess is that the issue is related to the fact that you don't have a true `integer64`: the \"class\" attribute has `np.ulong` in there too, so the code that looks to preserve R attributes is coming in after the downcast and adding those classes back on. \r\n\r\nOn the latest development version, there are some changes in the logic, and this now seems to come out as just \"integer\". Perhaps try installing a nightly version of the package and see if you see the same?\r\n\r\nEven so, this probably isn't ideal. Maybe you want to be able to control whether int64 downcasts to R integer (currently it only does it if all values fit in the int32 range). Maybe you want an explicit \"integer64\" class from R in the metadata to mean that you don't downcast, for R roundtrip fidelity. Or other possibilities. Unclear though that they justify the added complexity, but happy to discuss."
        },
        {
            "created_at": "2020-09-25T15:08:37.085Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17202231) by Neal Richardson (npr):*\nAh, I see you've also made ARROW-10093"
        },
        {
            "created_at": "2020-09-27T21:00:03.691Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17202925) by Kyle Kavanagh (kdkavanagh):*\nThose np class tags are likely coming from my usage of reticulate.\u00a0 I have not been able to try the nightly build as arrow::install_arrow(nightly=T) is still giving me 1.0.1 for some reason... however I've implemented logic to yank those classes off before writing the file and this seems to have fixed the issue described above.\u00a0 However, this has revealed another issue related to downcasting...\u00a0 That opt-out feature request in the linked ticket above would be super helpful to remove this as a variable entirely.\r\n\r\nWhen I have an int64 dataframe column containing many zeros and many epoch nanotimes (ie proper int64 values), I'm noticing that arrow::r is incorrectly downcasting to int32, while arrow:py reading the same file preserves the in64 datatype and displays the correct values:\r\n\r\nR\r\n```java\n\r\n> df2 = arrow::read_feather('../0x80cdbe0.feather')\r\n> str(df2)\r\nClasses \u2018data.table\u2019 and 'data.frame':\t2928489 obs. of  1 variable:\r\n $ col: int  0 0 0 0 0 0 0 0 0 0 ...\r\n - attr(*, \".internal.selfref\")=<externalptr> \r\n> str(df2[col>0])\r\nClasses \u2018data.table\u2019 and 'data.frame':\t2126 obs. of  1 variable:\r\n $ col: int  911390201 911666786 1949972332 1950146353 609740195 162563531 1070775442 1377384707 1493499527 446960602 ...\r\n - attr(*, \".internal.selfref\")=<externalptr> \r\n```\r\nPython:\r\n```java\n\r\n> g=pd.read_feather('../0x80cdbe0.feather')[['col']]\r\n> g.dtypes\r\ncol int64\r\ndtype: object\r\n> g.head()\r\ncol \r\n0 0\r\n1 0\r\n2 0\r\n3 0\r\n4 0\r\n5 0                 \r\n> g[g.col > 0].head()\r\n      col\r\n1064     1580686242311484921\r\n1068     1580686242311761506\r\n1262     1580686257372412575\r\n1266     1580686257474045875\r\n3851     1580686342134314860\n```"
        },
        {
            "created_at": "2020-09-28T22:57:04.202Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17203548) by Neal Richardson (npr):*\nOk, it looks like there are multiple issues here, in addition to the ability to control the downcasting behavior:\r\n\r\n- Handling subclasses of integer64, esp. when relating to automatic downcasting\n- (Not discussed here but) the \".internal.selfref\" attribute from data.table is an externalptr, which won't be valid to serialize and restore, so it needs to be dropped (and then presumably also the data.table class too)\n- The auto-downcast logic appears only to consider the first chunk of a ChunkedArray (which you have in the feather Table you've read in, I suspect). I've reproduced that:\n  \n  {code}\n  diff --git a/r/tests/testthat/test-chunked-array.R b/r/tests/testthat/test-chunked-array.R\n  index e5d3a68e0..3e2d2fd76 100644\n\u2014 a/r/tests/testthat/test-chunked-array.R\r\n+++ b/r/tests/testthat/test-chunked-array.R\r\n@@ -158,6 +158,13 @@ test_that(\"ChunkedArray supports POSIXct (ARROW-3716)\", {\r\n test_that(\"ChunkedArray supports integer64 (ARROW-3716)\", {\r\n   x <- bit64::as.integer64(1:10) + MAX_INT\r\n   expect_chunked_roundtrip(list(x, x), int64())\r\n+  # Also with a first chunk that would downcast\r\n+  zero <- Array$create(0L)$cast(int64())\r\n+  expect_type_equal(zero, int64())\r\n+  ca <- ChunkedArray$create(zero, x)\r\n+  expect_type_equal(ca, int64())\r\n+  expect_is(as.vector(ca), \"integer64\")\r\n+  expect_identical(as.vector(ca), c(bit64::as.integer64(0L), x))\r\n })\r\n {code}\r\n\r\nwhich fails because `as.vector(ca)` is \"integer\" and the values have overflowed. "
        },
        {
            "created_at": "2020-09-28T23:08:28.337Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17203551) by Neal Richardson (npr):*\nOk, split the latter issue to ARROW-10125. "
        },
        {
            "created_at": "2020-10-05T09:46:23.099Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17207960) by Romain Francois (romainfrancois):*\nPlease consider making a reprex, I don't have any of these files, or `df`"
        },
        {
            "created_at": "2020-10-07T16:36:53.498Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17209665) by Neal Richardson (npr):*\nThe integer64 subclass issue doesn't reproduce on master because we've changed how that metadata is collected and we no longer keep \"class\" for integer64: https://github.com/apache/arrow/blob/master/r/R/table.R#L188-L189\r\n\r\n```Java\n\r\n> df <- data.frame(a = bit64::integer64(1L))\r\n> class(df$a) <- c(class(df$a), \"something_else\")\r\n> class(df$a)\r\n[1] \"integer64\"      \"something_else\"\r\n> b <- record_batch(df)\r\n> b\r\nRecordBatch\r\n1 rows x 1 columns\r\n$a <int64>\r\n\r\nSee $metadata for additional Schema metadata\r\n> b$metadata\r\n$r\r\n 'arrow_r_metadata' chr \"A\\n3\\n198146\\n197888\\n5\\nUTF-8\\n531\\n2\\n531\\n1\\n16\\n1\\n262153\\n10\\ndata.frame\\n1026\\n1\\n262153\\n5\\nnames\\n16\\n1\"| __truncated__\r\nList of 2\r\n $ attributes:List of 1\r\n  ..$ class: chr \"data.frame\"\r\n $ columns   :List of 1\r\n  ..$ a: NULL\r\n```\r\n\r\nThe data.table .internal.selfref is still kept though. I would imagine that that should be a problem, but I'm not experienced enough with data.table to know how exactly, and my naive attempts have not been able to cause a failure."
        },
        {
            "created_at": "2022-07-12T14:04:42.421Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-10088?focusedCommentId=17565715) by @toddfarmer:*\nThis issue was last updated over 90 days ago, which may be an indication it is no longer being actively worked. To better reflect the current state, the issue is being unassigned. Please feel free to re-take assignment of the issue if it is being actively worked, or if you plan to start that work soon."
        }
    ]
}