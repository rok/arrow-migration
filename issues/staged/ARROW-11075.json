{
    "issue": {
        "title": "[Python] Getting reference not found with ORC enabled pyarrow",
        "body": "***Note**: This issue was originally created as [ARROW-11075](https://issues.apache.org/jira/browse/ARROW-11075). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nGenerated the pyarrow with OCR enabled on Power using following steps:\r\n```java\n\r\nexport ARROW_HOME=$CONDA_PREFIX\r\nmkdir cpp/build\r\ncd cpp/build\r\ncmake -DCMAKE_INSTALL_PREFIX=$ARROW_HOME \\\r\n\u00a0 \u00a0 \u00a0 -DCMAKE_INSTALL_LIBDIR=lib \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_BZ2=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_ZLIB=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_ZSTD=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_LZ4=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_SNAPPY=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_WITH_BROTLI=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_PARQUET=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_PYTHON=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_BUILD_TESTS=ON \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_CUDA=ON \\\r\n\u00a0 \u00a0 \u00a0 -DCUDA_CUDA_LIBRARY=/usr/local/cuda/lib64/stubs/libcuda.so \\\r\n\u00a0 \u00a0 \u00a0 -DARROW_ORC=ON \\\r\n    \u00a0 ..\r\n\r\nmake -j\r\nmake install\r\n\r\ncd ../../python\r\npython setup.py build_ext --bundle-arrow-cpp --with-orc --with-cuda --with-parquet bdist_wheel\r\n\r\n```\r\n\u00a0\r\n\r\n\u00a0\r\n\r\nWith the generated whl package installed, ran CUDF tests and observed following error:\r\n\r\n**_ERROR cudf - ImportError: /conda/envs/rmm/lib/python3.7/site-packages/pyarrow/_orc.cpython-37m-powerpc64le-linux-gnu.so: undefined symbol: _ZN5arrow8adapters3orc13OR..._**\r\n\r\nPlease find the whole error log below:\r\n\r\n================================================================================ ERRORS ================================================================================\r\n\r\n\r\n ____________________________________________________________________ ERROR collecting test session _____________________________________________________________________\r\n /conda/envs/rmm/lib/python3.7/importlib/__init__.py:127: in import_module\r\n \u00a0\u00a0\u00a0 return _bootstrap._gcd_import(name[level:], package, level)\r\n <frozen importlib._bootstrap>:1006: in _gcd_import\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:983: in _find_and_load\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:953: in _find_and_load_unlocked\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:1006: in _gcd_import\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:983: in _find_and_load\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:953: in _find_and_load_unlocked\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:1006: in _gcd_import\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:983: in _find_and_load\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:967: in _find_and_load_unlocked\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:677: in _load_unlocked\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap_external>:728: in exec_module\r\n \u00a0\u00a0\u00a0 ???\r\n <frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n \u00a0\u00a0\u00a0 ???\r\n cudf/cudf/__init__.py:60: in <module>\r\n \u00a0\u00a0\u00a0 from cudf.io import (\r\n cudf/cudf/io/__init__.py:8: in <module>\r\n \u00a0\u00a0\u00a0 from cudf.io.orc import read_orc, read_orc_metadata, to_orc\r\n cudf/cudf/io/orc.py:6: in <module>\r\n \u00a0\u00a0\u00a0 from pyarrow import orc as orc\r\n /conda/envs/rmm/lib/python3.7/site-packages/pyarrow/orc.py:24: in <module>\r\n \u00a0\u00a0\u00a0 import pyarrow._orc as _orc\r\n <font color=\"#de350b\">E\u00a0\u00a0 ImportError: /conda/envs/rmm/lib/python3.7/site-packages/pyarrow/_orc.cpython-37m-powerpc64le-linux-gnu.so: undefined symbol: _ZN5arrow8adapters3orc13ORCFileReader4ReadEPSt10shared_ptrINS_5TableEE</font>\r\n ======================================================================= short test summary info ========================================================================\r\n **_ERROR cudf - ImportError: /conda/envs/rmm/lib/python3.7/site-packages/pyarrow/_orc.cpython-37m-powerpc64le-linux-gnu.so: undefined symbol: _ZN5arrow8adapters3orc13OR..._**\r\n !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![ Interrupted: 1 error during collection ]( Interrupted: 1 error during collection )!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\r\n =========================================================================== 1 error in 1.54s ===========================================================================\r\n Fatal Python error: Segmentation fault",
        "created_at": "2020-12-30T14:50:39.000Z",
        "updated_at": "2021-02-15T06:25:16.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2021-01-10T15:24:06.269Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17262210) by Uwe Korn (uwe):*\nCan you post the output of `conda list` and the build logs for the C++ and Python part of Arrow? Without these three it will be hard to debug."
        },
        {
            "created_at": "2021-01-11T04:29:40.273Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17262386) by Kandarpa (kandarpamalipeddi):*\nHello `[~uwe]`\r\n\r\nPlease find following:\r\n\n|Conda list|[conda_list.txt](conda_list.txt)|\r|\n|-|-|-|\n|Arrow cpp build logs\r<br> This includes cmake, make, make install|[arrow_cpp_build.log](arrow_cpp_build.log)|\r|\n|Arrow python build logs|[arrow_python_build.log](arrow_python_build.log)|\r<br>\r<br>Please let me know if you need any further information.\r<br>\r<br>Regards,\r<br>\r<br>Kandarpa\r<br>\r<br>\u00a0|\n"
        },
        {
            "created_at": "2021-01-18T04:15:51.032Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17267005) by Kandarpa (kandarpamalipeddi):*\n`[~uwe]`\r\n\r\nAny update on this, we are kind of blocked with this issue."
        },
        {
            "created_at": "2021-01-22T20:36:46.692Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17270411) by Uwe Korn (uwe):*\nI would guess that the issue is related to `-DORC_SOURCE=BUNDLED`\u00a0and having `orc`\u00a0installed as a conda package at the same time. Can you remove the `-DORC_SOURCE=BUNDLED`\u00a0flag and do a clean build? Do you know why you have set that?"
        },
        {
            "created_at": "2021-01-22T20:42:35.497Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17270414) by Wes McKinney (wesm):*\nORC is supported to be statically linked, so this would be unusual. \r\n\r\n`[~kandarpamalipeddi]` can you show what ORC symbols are in your shared library?\r\n\r\n```Java\n\r\nnm -D /path/to/libarrow.so | c++filt | grep orc\r\n```\r\n\r\nCheck also which libarrow.so the pyarrow libraries are linking to if you can (with `ldd`)"
        },
        {
            "created_at": "2021-01-22T20:47:49.990Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17270419) by Uwe Korn (uwe):*\nThe latest ORC release is supporting shared linkage and the conda toolchain has been reworked to link dynamically: https://github.com/conda-forge/arrow-cpp-feedstock/blob/1.0.x/recipe/meta.yaml. The major issue here is probably that ORC 0.6.2 is built as part of the Arrow thirdparty toolchain but 0.6.6 headers are used during the build. Not sure how this links but that feels like the most likely issue to me."
        },
        {
            "created_at": "2021-01-25T05:19:17.263Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17271070) by Kandarpa (kandarpamalipeddi):*\nHello `[~uwe]`, `[~wesm]`, thanks for looking into this issue.\r\n\r\n\u00a0\r\n\r\nRan cmake as following :Ran cmake as following :\r\n\r\n\u00a0\r\n\r\n\u00a0\r\n```java\n\r\n#cmake -DCMAKE_INSTALL_PREFIX=$ARROW_HOME\r\n\u00a0 \u00a0 \u00a0 \u00a0-DCMAKE_INSTALL_LIBDIR=lib\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_BZ2=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_ZLIB=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_ZSTD=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_LZ4=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_SNAPPY=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_WITH_BROTLI=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_PARQUET=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_PYTHON=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_BUILD_TESTS=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DARROW_CUDA=ON\r\n\u00a0 \u00a0 \u00a0 \u00a0-DCUDA_CUDA_LIBRARY=/usr/local/cuda/lib64/stubs/libcuda.so\r\n \u00a0 \u00a0   -DARROW_ORC=ON\r\n    \u00a0 \u00a0-DARROW_JEMALLOC=ON\r\n    \u00a0 \u00a0-DARROW_DATASET=ON\r\n    \u00a0 \u00a0..\r\n#make -j\r\n\r\n```\r\nnm -D ./release/libarrow.so | c++filt | grep orc\r\n 0000000000bf21d0 u guard variable for arrow::adapters::orc::ArrowInputFile::getName[abi:cxx11]() const::filename\r\n U orc::ParseError::ParseError(char const\\*)\r\n U orc::ParseError::ParseError(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)\r\n U orc::ParseError::~ParseError()\r\n U orc::InputStream::~InputStream()\r\n U orc::createReader(std::unique_ptr<orc::InputStream, std::default_delete<orc::InputStream> >, orc::ReaderOptions const&)\r\n U orc::ReaderOptions::ReaderOptions()\r\n U orc::ReaderOptions::~ReaderOptions()\r\n U orc::RowReaderOptions::includeTypes(std::__cxx11::list<unsigned long, std::allocator<unsigned long> > const&)\r\n U orc::RowReaderOptions::range(unsigned long, unsigned long)\r\n U orc::RowReaderOptions::RowReaderOptions(orc::RowReaderOptions const&)\r\n U orc::RowReaderOptions::RowReaderOptions()\r\n U orc::RowReaderOptions::~RowReaderOptions()\r\n 0000000000474110 T arrow::io::internal::LibHdfsShim::BuilderSetForceNewInstance(hdfsBuilder\\*)\r\n 00000000009cfda0 T arrow::adapters::orc::AppendBatch(orc::Type const\\*, orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009cb720 T arrow::adapters::orc::GetArrowType(orc::Type const\\*, std::shared_ptr<arrow::DataType>\\*)\r\n 00000000009c2ad0 T arrow::adapters::orc::ORCFileReader::ReadSchema(std::shared_ptr<arrow::Schema>\\*)\r\n 00000000009c4140 T arrow::adapters::orc::ORCFileReader::ReadStripe(long, std::shared_ptr<arrow::RecordBatch>\\*)\r\n 00000000009c4690 T arrow::adapters::orc::ORCFileReader::ReadStripe(long, std::vector<int, std::allocator<int> > const&, std::shared_ptr<arrow::RecordBatch>\\*)\r\n 00000000009c2a80 T arrow::adapters::orc::ORCFileReader::NumberOfRows()\r\n 00000000009c2a50 T arrow::adapters::orc::ORCFileReader::NumberOfStripes()\r\n 00000000009c4e50 T arrow::adapters::orc::ORCFileReader::NextStripeReader(long, std::shared_ptr<arrow::RecordBatchReader>\\*)\r\n 00000000009c4f60 T arrow::adapters::orc::ORCFileReader::NextStripeReader(long, std::vector<int, std::allocator<int> > const&, std::shared_ptr<arrow::RecordBatchReader>\\*)\r\n 00000000009c2ba0 T arrow::adapters::orc::ORCFileReader::Open(std::shared_ptr<arrow::io::RandomAccessFile> const&, arrow::MemoryPool\\*, std::unique_ptr<arrow::adapters::orc::ORCFileReader, std::default_delete<arrow::adapters::orc::ORCFileReader> >\\*)\r\n <font color=\"#0747a6\">**00000000009c32a0 T arrow::adapters::orc::ORCFileReader::Read(std::shared_ptr<arrow::Table>**)\\*</font>\r\n <font color=\"#0747a6\">**00000000009c3630 T arrow::adapters::orc::ORCFileReader::Read(std::shared_ptr<arrow::Schema> const&, std::shared_ptr<arrow::Table>**)\\*</font>\r\n <font color=\"#0747a6\">**00000000009c3d80 T arrow::adapters::orc::ORCFileReader::Read(std::shared_ptr<arrow::Schema> const&, std::vector<int, std::allocator<int> > const&, std::shared_ptr<arrow::Table>**)\\*</font>\r\n 00000000009c3760 T arrow::adapters::orc::ORCFileReader::Read(std::vector<int, std::allocator<int> > const&, std::shared_ptr<arrow::Table>\\*)\r\n 00000000009c2810 T arrow::adapters::orc::ORCFileReader::Seek(long)\r\n 00000000009c2600 T arrow::adapters::orc::ORCFileReader::ORCFileReader()\r\n 00000000009c2600 T arrow::adapters::orc::ORCFileReader::ORCFileReader()\r\n 00000000009c2770 T arrow::adapters::orc::ORCFileReader::~ORCFileReader()\r\n 00000000009c2770 T arrow::adapters::orc::ORCFileReader::~ORCFileReader()\r\n 00000000009d0fc0 T arrow::adapters::orc::AppendMapBatch(orc::Type const\\*, orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009ca990 T arrow::adapters::orc::AppendBoolBatch(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d0770 T arrow::adapters::orc::AppendListBatch(orc::Type const\\*, orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d1610 W arrow::Status arrow::adapters::orc::AppendBinaryBatch<arrow::BinaryBuilder>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d1df0 W arrow::Status arrow::adapters::orc::AppendBinaryBatch<arrow::StringBuilder>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d0490 T arrow::adapters::orc::AppendStructBatch(orc::Type const\\*, orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009cfa60 T arrow::adapters::orc::AppendDecimalBatch(orc::Type const\\*, orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009cb160 T arrow::adapters::orc::AppendTimestampBatch(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009cf7d0 T arrow::adapters::orc::AppendFixedBinaryBatch(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d46c0 W arrow::Status arrow::adapters::orc::AppendNumericBatchCast<arrow::NumericBuilder<arrow::Date32Type>, int, orc::LongVectorBatch, long>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d3770 W arrow::Status arrow::adapters::orc::AppendNumericBatchCast<arrow::NumericBuilder<arrow::Int8Type>, signed char, orc::LongVectorBatch, long>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d3fe0 W arrow::Status arrow::adapters::orc::AppendNumericBatchCast<arrow::NumericBuilder<arrow::FloatType>, float, orc::DoubleVectorBatch, double>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d3050 W arrow::Status arrow::adapters::orc::AppendNumericBatchCast<arrow::NumericBuilder<arrow::Int16Type>, short, orc::LongVectorBatch, long>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009d29a0 W arrow::Status arrow::adapters::orc::AppendNumericBatchCast<arrow::NumericBuilder<arrow::Int32Type>, int, orc::LongVectorBatch, long>(orc::ColumnVectorBatch\\*, long, long, arrow::ArrayBuilder\\*)\r\n 00000000009c50f0 W std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>::_M_destroy()\r\n 00000000009c5020 W std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>::_M_dispose()\r\n 00000000009c5080 W std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>::_M_get_deleter(std::type_info const&)\r\n 00000000009c72c0 W std::vector<arrow::adapters::orc::StripeInformation, std::allocator<arrow::adapters::orc::StripeInformation> >::_M_default_append(unsigned long)\r\n U typeinfo for orc::ParseError\r\n U typeinfo for orc::InputStream\r\n 0000000000be66c8 V typeinfo for arrow::adapters::orc::ArrowInputFile\r\n 0000000000be66e0 V typeinfo for arrow::adapters::orc::OrcStripeReader\r\n 0000000000be66f8 V typeinfo for std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>\r\n 0000000000aa8a58 V typeinfo name for arrow::adapters::orc::ArrowInputFile\r\n 0000000000aa8a80 V typeinfo name for arrow::adapters::orc::OrcStripeReader\r\n 0000000000aa8aa8 V typeinfo name for std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>\r\n 0000000000be6710 V vtable for arrow::adapters::orc::ArrowInputFile\r\n 0000000000be6750 V vtable for arrow::adapters::orc::OrcStripeReader\r\n 0000000000be6780 V vtable for std::_Sp_counted_ptr<arrow::adapters::orc::OrcStripeReader\\*, (__gnu_cxx::_Lock_policy)2>\r\n 0000000000bf21d8 u arrow::adapters::orc::ArrowInputFile::getName[abi:cxx11]() const::filename\r\n\r\n\u00a0\r\n\r\nLooks like, namespace issue?"
        },
        {
            "created_at": "2021-01-27T14:51:08.114Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17272905) by Kandarpa (kandarpamalipeddi):*\n`[~uwe]`, `[~wesm]`\r\n\r\nAny pointer on this.\r\nI am totally blocked with this.\u00a0\r\nAny workaround is really appreciated.\r\n\r\n\u00a0\r\n\r\nRegards,\r\n\r\nKandarpa\r\n\r\n\u00a0"
        },
        {
            "created_at": "2021-02-04T05:37:19.564Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17278550) by Kandarpa (kandarpamalipeddi):*\nHello `[~uwe]` `[~wesm]`,\r\n\r\n\u00a0\r\n Any update on this ?\r\n\r\n\u00a0\r\n\r\nRegards,\r\n\r\nKandarpa"
        },
        {
            "created_at": "2021-02-04T12:35:19.496Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17278803) by Uwe Korn (uwe):*\nCan you provide a reproducible dockerfile or similar? I fail to see anything obvious here."
        },
        {
            "created_at": "2021-02-08T07:01:25.809Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17280798) by Kandarpa (kandarpamalipeddi):*\n`[~uwe]`\r\n\r\nPlease find the build steps in the attachments.\u00a0[cudf_buildscrip.sh](cudf_buildscrip.sh)\r\n\r\nLet me know if you need any further details.\r\n\r\n\u00a0\r\n\r\nKandarpa"
        },
        {
            "created_at": "2021-02-15T06:25:16.581Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11075?focusedCommentId=17284561) by Kandarpa (kandarpamalipeddi):*\nHello\u00a0 `[~uwe]` `[~wesm]`,\r\n\r\n\u00a0\r\n\r\nAny update or observations on this ?\r\n\r\n\u00a0\r\n\r\nRegards,\r\n\r\nKandarpa"
        }
    ]
}