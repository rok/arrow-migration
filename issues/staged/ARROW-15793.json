{
    "issue": {
        "title": "[C++][FlightRPC] DoPutLargeBatch test sometimes stuck for 10 seconds",
        "body": "***Note**: This issue was originally created as [ARROW-15793](https://issues.apache.org/jira/browse/ARROW-15793). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nNormally the test finishes in 100ms. But it often costs 10s on my test machine.\r\nDebug build is good.\r\n\r\nI did brief debug, looks it's related to <https://github.com/apache/arrow/pull/12302>.\r\nIt stuck 10 seconds in destructing grpc::Server at code <https://github.com/apache/arrow/blob/master/cpp/src/arrow/flight/server.cc#L863>\r\n\r\nTo reproduce:\r\n```bash\n\r\n$ cmake -GNinja -DARROW_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DARROW_FLIGHT=ON ..\r\n\r\n$ ninja arrow-flight-test\r\n\r\n$ relwithdebinfo/arrow-flight-test --gtest_filter=\"*DoPutLargeBatch*\"\r\n[==========] Running 1 test from 1 test suite.\r\n[----------] Global test environment set-up.\r\n[----------] 1 test from TestDoPut\r\n[ RUN      ] TestDoPut.DoPutLargeBatch\r\n[       OK ] TestDoPut.DoPutLargeBatch (10017 ms)\r\n[----------] 1 test from TestDoPut (10017 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 1 test from 1 test suite ran. (10017 ms total)\r\n[  PASSED  ] 1 test.\r\n```",
        "created_at": "2022-02-28T02:56:04.000Z",
        "updated_at": "2022-07-13T09:26:58.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Component: FlightRPC",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2022-07-13T09:26:58.000Z"
    },
    "comments": [
        {
            "created_at": "2022-02-28T02:57:02.567Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15793?focusedCommentId=17498690) by Yibo Cai (yibocai):*\nTurn on GRPC_VERBOSITY=DEBUG\r\n```bash\n\r\n[==========] Running 1 test from 1 test suite.\r\n[----------] Global test environment set-up.\r\n[----------] 1 test from TestDoPut\r\n[ RUN      ] TestDoPut.DoPutLargeBatch\r\nD0228 02:51:30.645780167 2893580 ev_posix.cc:173]            Using polling engine: epollex\r\nD0228 02:51:30.645883567 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"grpclb\"\r\nD0228 02:51:30.645890327 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"priority_experimental\"\r\nD0228 02:51:30.645897087 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"weighted_target_experimental\"\r\nD0228 02:51:30.645903847 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"pick_first\"\r\nD0228 02:51:30.645906887 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"round_robin\"\r\nD0228 02:51:30.645910967 2893580 dns_resolver_ares.cc:500]   Using ares dns resolver\r\nD0228 02:51:30.645924767 2893580 certificate_provider_registry.cc:33] registering certificate provider factory for \"file_watcher\"\r\nD0228 02:51:30.645929047 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"cds_experimental\"\r\nD0228 02:51:30.645931967 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"xds_cluster_impl_experimental\"\r\nD0228 02:51:30.645938127 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"xds_cluster_resolver_experimental\"\r\nD0228 02:51:30.645942327 2893580 lb_policy_registry.cc:42]   registering LB policy factory for \"xds_cluster_manager_experimental\"\r\nI0228 02:51:30.646008368 2893580 server_builder.cc:319]      Synchronous server. Num CQs: 1, Min pollers: 1, Max Pollers: 2, CQ timeout (msec): 10000\r\nI0228 02:51:30.646368128 2893580 socket_utils_common_posix.cc:352] TCP_USER_TIMEOUT is available. TCP_USER_TIMEOUT will be used thereafter\r\nI0228 02:51:30.648109410 2893580 subchannel.cc:1113]         New connected subchannel at 0x7002400 for subchannel 0x6ffc420\r\nI0228 02:51:30.702831602 2893580 chttp2_transport.cc:1715]   ipv6:[::1]:59224: Sending goaway err={\"created\":\"@1646016690.702800442\",\"description\":\"Server shutdown\",\"file\":\"/home/cyb/arrow/cpp/relwithdebinfo/grpc_ep-prefix/src/grpc_ep/src/core/lib/surface/server.cc\",\"file_line\":468,\"grpc_status\":0}\r\nD0228 02:51:30.710433651 2893580 init.cc:227]                grpc_shutdown starts clean-up now\r\n\r\n// stuck here for 10 seconds ...\r\n\r\n[       OK ] TestDoPut.DoPutLargeBatch (10018 ms)\r\n[----------] 1 test from TestDoPut (10018 ms total)\r\n\r\n[----------] Global test environment tear-down\r\n[==========] 1 test from 1 test suite ran. (10018 ms total)\r\n[  PASSED  ] 1 test.\r\n```"
        },
        {
            "created_at": "2022-02-28T03:01:10.340Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15793?focusedCommentId=17498691) by Yibo Cai (yibocai):*\nI'm using bundled grpc.\r\ncc `[~lidavidm]`"
        },
        {
            "created_at": "2022-02-28T12:57:02.589Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15793?focusedCommentId=17498886) by David Li (lidavidm):*\nI investigated this here and it seems to be a gRPC issue: https://github.com/apache/arrow/pull/12499/files#diff-2d05b3bd0ce469f82d903cb7f040168dea4e1b4713e4fec54fed2fa7842ec6e9R620\r\n\r\n```\n\r\n  // For gRPC: This test randomly takes 10 seconds because gRPC has problems\r\n  // joining its internal threads. It's because it's waiting on a thread\r\n  // calling epoll...with a timeout of 10 seconds.\r\n  // https://groups.google.com/g/grpc-io/c/j7xmW0F3eu0\r\n  // \"Grpc Client-side C++ Channel Destructor taking 10 seconds\"\r\n```\r\n\r\nThough maybe we can remove the `impl_.reset()` call from FlightClient, I'll give that a try."
        }
    ]
}