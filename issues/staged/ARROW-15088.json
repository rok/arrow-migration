{
    "issue": {
        "title": "[R] Support for csv options on open_dataset",
        "body": "***Note**: This issue was originally created as [ARROW-15088](https://issues.apache.org/jira/browse/ARROW-15088). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nThere's a lot of gotchas created around heterogeneity in arrow's support for csv parsing options beween read_csv_arrow() and open_dataset() (and further issues arising from migrating from readr::read_csv()).\u00a0 Not sure if it's more helpful to report these in one place or as separate issues, but here's a few that keep tripping me up:\r\n\r\n\u00a0\r\n \\* \"na\" (defining the na-character choices) is not implemented on open_dataset(), though it is on read_csv_arrow()\r\n \\* somewhat confusingly, open_dataset does support `null_strings` though, which appears to play the same roll.\u00a0\u00a0 The docs however suggest that `open_dataset()` `...` options are passed to `dataset_factory()`.\u00a0 I think those docs should link to <https://arrow.apache.org/docs/r/reference/CsvReadOptions.html> . \u00a0<https://arrow.apache.org/docs/r/reference/FileFormat.html> suggests that `null_strings` is not one of the recognized CsvReadOptions, but it seems that it now is.\u00a0 I appreciate the challenge of supporting both the readr-like options and the native arrow option names here, but the functionality and documentation remains very confusing!\r\n\r\nAlso another gotcha: in arrow 6.0 release, if we supply an arrow schema, open_dataset assumes the first line of the csv is data and not column headers, so we have to do skip=1.\u00a0 I see the logic (the schema names the columns anyway, so assuming we're going with those names why parse the names from the csv), but it's surprising since reading without the schema we do not use skip=1, and it's natural to want to go and declare column types while preserving csv column names.\u00a0 The error messages on doing so aren't helpful, since if you forget skip=1, you are just told that any column that is not a string is \"the incorrect type\".\u00a0 The open_dataset() docs imply that we can use read_csv_arrow() options, which suggest that we could provide types using col_types() instead of schema, but this appears not to be the case.\u00a0 Also",
        "created_at": "2021-12-13T22:13:52.000Z",
        "updated_at": "2022-03-03T13:06:43.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: R",
            "Type: enhancement"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-01-26T17:52:41.523Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15088?focusedCommentId=17482649) by Nicola Crane (thisisnic):*\nThanks for this bug report `[~cboettig]` - will take a look at those items 1 by 1 so we can see what's covered already and what might want new tickets opening for:\r\n\r\n- \" in arrow 6.0 release, if we supply an arrow schema, open_dataset assumes the first line of the csv is data and not column headers, so we have to do skip=1....\".. \"error messages on doing so aren't helpful\" - I agree; we have now added in some better error handling in ARROW-15123 and ARROW-14744\n  \n- When you say \"The open_dataset() docs imply that we can use read_csv_arrow() options\", which bits do you mean?  There might be something in there we need to rephrase in there.\n"
        },
        {
            "created_at": "2022-01-26T18:06:18.622Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15088?focusedCommentId=17482654) by Nicola Crane (thisisnic):*\n- \"somewhat confusingly, open_dataset does support `null_strings` though\"\n  \n  Please can you give me a reprex of this working? It's not working for me and I am not seeing it in the code, but given the ellipses arguments get passed to a lot of places, I might be missing something."
        },
        {
            "created_at": "2022-01-26T18:08:23.426Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15088?focusedCommentId=17482656) by Nicola Crane (thisisnic):*\n-  \" \"na\" (defining the na-character choices) is not implemented on open_dataset()\"\n  \n  Have opened ARROW-15470"
        },
        {
            "created_at": "2022-01-28T18:14:25.313Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15088?focusedCommentId=17483901) by Carl Boettiger (cboettig):*\nSorry for the confusion.\u00a0 Here's some reproducible examples:\r\n\r\n\"na is recognized in read_csv_arrow but\u00a0 not implemented on open_dataset\". Witness:\r\n```java\n\r\nlibrary(arrow)\r\nlibrary(readr)\r\ncsv <- readr_example(\"mtcars.csv\")\r\nread_csv_arrow(csv, na=\"-99\")  # Works\r\nopen_dataset(csv, na=\"-99\") # Error:\n```\r\n```java\n\r\n# Error in ParquetFragmentScanOptions$create(...) : \r\n# unused argument (na = \"-99\") \n```\r\n\r\n\r\n\r\n- Re the docs, I'm explicitly referring to the docstring about the `...` option in `open_dataset`, which links to dataset_factory, which says:\n  > Additional format-specific options, passed to `{}FileFormat$create(){`}. For CSV options, note that you can specify them either with the Arrow C++ library naming (\"delimiter\", \"quoting\", etc.) or the `{}readr{`}-style naming used in `[read_csv_arrow()|https://arrow.apache.org/docs/r/reference/read_delim_arrow.html]` (\"delim\", \"quote\", etc.). Not all `readr` options are currently supported; please file an issue if you encounter one that `arrow` should support.\n  \n  \u00a0\n  \n  Re `null_strings`, I'm stumped there too \u2013 I see `null_values` documented in <https://arrow.apache.org/docs/r/reference/CsvReadOptions.html> still, but I cannot use it with either open_dataset() or read_csv_arrow().\u00a0 Can you point me an reproducible example that uses that option?\u00a0 Am I just misunderstanding that those options documented at that link can be used in open_dataset() etc and read_csv_arrow()\n  \n  \u00a0"
        },
        {
            "created_at": "2022-03-03T13:06:08.509Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15088?focusedCommentId=17500735) by Nicola Crane (thisisnic):*\nHi Carl,\r\nI've put together a short reproducible example here:\r\n\r\n```r\nlibrary(arrow)\r\nlibrary(readr)\r\nlibrary(dplyr)\r\n\r\nmtcars[1,1] = -99\r\nreadr::write_csv(mtcars, \"mtcars_na.csv\")\r\nread_csv_arrow(\"mtcars_na.csv\", na=\"-99\")  # Works\r\nopen_dataset(\"mtcars_na.csv\", na=\"-99\", format = \"csv\") \r\n# Error: The following option is supported in \"read_delim_arrow\" functions but not yet supported here: \"na\"\r\nopen_dataset(\"mtcars_na.csv\", null_values=\"-99\", format = \"csv\") %>% collect() # Also works\r\n\r\n```\r\n\r\nIn short, what is happening is that different bits of the Arrow C++ code are used when reading in data via `open_dataset()` versus `read_csv_arrow()`.  We've done some work in `read_csv_arrow()` to hook up the `readr` style arguments with their Arrow equivalents, but there are cases like these where these arguments are not yet supported for datasets or simply haven't been hooked up.  \r\n\r\nIn the example above, I've used the `null_values` argument to do the same thing that the `na` argument does in `read_csv_arrow()`, but from a UX perspective, I think it'd be great it we could just use the `na` argument to achieve the same thing and if I have time will look at getting ARROW-15470 done ahead of our next release."
        }
    ]
}