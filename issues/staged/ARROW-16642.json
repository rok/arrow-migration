{
    "issue": {
        "title": "[C++] An Error Occured While Reading Parquet File Using C++ - GetRecordBatchReader -Corrupt snappy compressed data. ",
        "body": "***Note**: This issue was originally created as [ARROW-16642](https://issues.apache.org/jira/browse/ARROW-16642). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nHi All\r\n\r\nWhen I use Arrow Reading Parquet File like follow:\r\n\r\n\u00a0\r\n```java\n\r\nauto st = parquet::arrow::FileReader::Make(\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 arrow::default_memory_pool(),\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 parquet::ParquetFileReader::Open(_parquet, _properties), &_reader); \u00a0\u00a0\r\narrow::Status status = _reader->GetRecordBatchReader({_current_group},_parquet_column_ids, &_rb_batch); \u00a0 \u00a0\r\n_reader->set_batch_size(65536); \u00a0 \u00a0 \u00a0\u00a0\r\n_reader->set_use_threads(true); \u00a0 \u00a0 \u00a0\r\nstatus = _rb_batch->ReadNext(&_batch);\u00a0 \n```\r\n<font color=\"#172b4d\">status is not ok and an error occured like this:</font>\r\n```java\n\r\nIOError: Corrupt snappy compressed data. \n```\r\nWhen I comment out this statement\r\n```java\n\r\n _reader->set_use_threads(true);\n```\r\nThe program runs normally and I can read parquet file well.\r\nProgram errors only occur when I read multiple columns and using _reader->set_use_threads(true); and a single column will not occur error\r\n\r\nThe testing parquet file is created by pyarrow\uff0cI use only 1 group and each group has 3000000 records.\r\nThe parquet file has 20 columns including int and string types\r\n\r\nyou can create a test parquet file using attachment python script\r\n\r\nIn my case,I read 0,1,2,3,4,5,6 index columns\r\n\r\nReading file using C++,arrow 7.0.0 ,snappy 1.1.8\r\n\r\nWritting file using python3.8 ,pyarrow 7.0.0\r\n\r\nLooking forward to your reply\r\n\r\nThank you!\r\n\r\n`[~apitrou]` \u00a0\r\n\r\n`[~westonpace]` \u00a0",
        "created_at": "2022-05-24T14:48:43.000Z",
        "updated_at": "2022-05-25T21:20:23.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-05-25T21:20:23.878Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-16642?focusedCommentId=17542245) by Weston Pace (westonpace):*\nYou might need to provide a few more details on how you are reading the parquet file.  I used the python script you provided to create a file `/home/pace/test.parquet` which I then tested with this script:\r\n\r\n```\n\r\n#include <iostream>\r\n\r\n#include \"arrow/filesystem/api.h\"\r\n#include \"arrow/record_batch.h\"\r\n\r\n#include \"parquet/api/reader.h\"\r\n#include \"parquet/arrow/reader.h\"\r\n\r\nint main() {\r\n  auto fs = std::make_unique<arrow::fs::LocalFileSystem>();\r\n  auto input_file = fs->OpenInputFile(\"/home/pace/test.parquet\").ValueOrDie();\r\n\r\n  std::unique_ptr<parquet::arrow::FileReader> file_reader;\r\n  arrow::Status st = parquet::arrow::FileReader::Make(\r\n      arrow::default_memory_pool(),\r\n      parquet::ParquetFileReader::Open(input_file), &file_reader);\r\n  if (!st.ok()) {\r\n    std::cerr << \"Error making file reader: \" << st << std::endl;\r\n    return -1;\r\n  }\r\n  std::vector<int> parquet_column_ids = {0, 1, 2, 3, 4, 5, 6};\r\n  std::cout << \"The file has \" << file_reader->num_row_groups() << \" row groups\"\r\n            << std::endl;\r\n  for (int row_group_idx = 0; row_group_idx < file_reader->num_row_groups();\r\n       row_group_idx++) {\r\n    std::cout << \"Reading row group: \" << row_group_idx << std::endl;\r\n    std::shared_ptr<arrow::RecordBatchReader> record_batch_reader;\r\n    st = file_reader->GetRecordBatchReader({row_group_idx}, parquet_column_ids,\r\n                                           &record_batch_reader);\r\n    file_reader->set_batch_size(65536);\r\n    file_reader->set_use_threads(true);\r\n    std::shared_ptr<arrow::RecordBatch> batch;\r\n    while (true) {\r\n      st = record_batch_reader->ReadNext(&batch);\r\n      if (st.ok()) {\r\n        if (!batch) {\r\n          // Reached the end of the row group\r\n          break;\r\n        }\r\n        std::cout << \"  Read in record batch with \" << batch->num_rows()\r\n                  << \" rows\" << std::endl;\r\n      } else {\r\n        std::cerr << \"Error encountered reading record batch: \" << st\r\n                  << std::endl;\r\n        return -2;\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI did not get any errors and got the expected output:\r\n\r\n```\n\r\nThe file has 1 row groups\r\nReading row group: 0\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 65536 rows\r\n  Read in record batch with 50880 rows\r\n```\r\n\r\nDoes my test program work in your environment?"
        }
    ]
}