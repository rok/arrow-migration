{
    "issue": {
        "title": "[Java] PySpark3 with pandas 1.1.5 and pyarrow 2.0.0 getting the below error",
        "body": "***Note**: This issue was originally created as [ARROW-14038](https://issues.apache.org/jira/browse/ARROW-14038). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nWhile running pyspark3 with pandas 1.1.5 and pyarrow 2.0.0 getting the below error:\r\n\r\n**Spark Code:**\r\n```java\n\r\nimport pyarrow\r\nimport pandas as pd\r\n\r\ndf = pd.DataFrame({'col1' : [1,2,3], 'col2': [4,5,6]})\r\ndf_sp = spark.createDataFrame(df)\r\ndf_sp.cache().count()\r\nschema = df_sp.schema\r\n\r\ndef dummy_udf(data):\r\n return data\r\n\r\nres = df_sp.groupby('col1').applyInPandas(dummy_udf, schema=schema)\r\nprint(res.cache().count())\r\nprint(res.toPandas())\r\n```\r\n\r\n **Exception:**\r\n```java\n\r\n21/09/17 07:28:10 ERROR util.Utils: Uncaught exception in thread stdout writer for python3\r\n java.lang.NoSuchMethodError: com.google.flatbuffers.FlatBufferBuilder.createString(Ljava/lang/CharSequence;)I\r\n at org.apache.arrow.vector.types.pojo.Field.getField(Field.java:204)\r\n at org.apache.arrow.vector.types.pojo.Schema.getSchema(Schema.java:178)\r\n at org.apache.arrow.vector.ipc.message.MessageSerializer.serializeMetadata(MessageSerializer.java:187)\r\n at org.apache.arrow.vector.ipc.message.MessageSerializer.serialize(MessageSerializer.java:165)\r\n at org.apache.arrow.vector.ipc.ArrowWriter.ensureStarted(ArrowWriter.java:159)\r\n at org.apache.arrow.vector.ipc.ArrowWriter.start(ArrowWriter.java:112)\r\n at org.apache.spark.sql.execution.python.ArrowPythonRunner$$anon$1.$anonfun$writeIteratorToStream$1(ArrowPythonRunner.scala:86)\r\n at scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)\r\n at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1439)\r\n at org.apache.spark.sql.execution.python.ArrowPythonRunner$$anon$1.writeIteratorToStream(ArrowPythonRunner.scala:103)\r\n at org.apache.spark.api.python.BasePythonRunner$WriterThread.$anonfun$run$1(PythonRunner.scala:397)\r\n at org.apache.spark.util.Utils$.logUncaughtExceptions(Utils.scala:1996)\r\n at org.apache.spark.api.python.BasePythonRunner$WriterThread.run(PythonRunner.scala:232)\r\n 21/09/17 07:28:10 ERROR util.SparkUncaughtExceptionHandler: Uncaught exception in thread Thread[stdout writer for python3,5,main]\r\n java.lang.NoSuchMethodError: com.google.flatbuffers.FlatBufferBuilder.createString(Ljava/lang/CharSequence;)I\r\n at org.apache.arrow.vector.types.pojo.Field.getField(Field.java:204)\r\n at org.apache.arrow.vector.types.pojo.Schema.getSchema(Schema.java:178)\r\n at org.apache.arrow.vector.ipc.message.MessageSerializer.serializeMetadata(MessageSerializer.java:187)\r\n at org.apache.arrow.vector.ipc.message.MessageSerializer.serialize(MessageSerializer.java:165)\r\n at org.apache.arrow.vector.ipc.ArrowWriter.ensureStarted(ArrowWriter.java:159)\r\n at org.apache.arrow.vector.ipc.ArrowWriter.start(ArrowWriter.java:112)\r\n at org.apache.spark.sql.execution.python.ArrowPythonRunner$$anon$1.$anonfun$writeIteratorToStream$1(ArrowPythonRunner.scala:86)\r\n at scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)\r\n at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1439)\r\n at org.apache.spark.sql.execution.python.ArrowPythonRunner$$anon$1.writeIteratorToStream(ArrowPythonRunner.scala:103)\r\n at org.apache.spark.api.python.BasePythonRunner$WriterThread.$anonfun$run$1(PythonRunner.scala:397)\r\n at org.apache.spark.util.Utils$.logUncaughtExceptions(Utils.scala:1996)\r\n at org.apache.spark.api.python.BasePythonRunner$WriterThread.run(PythonRunner.scala:232)\r\n 21/09/17 07:28:10 WARN storage.BlockManager: Putting block rdd_25_69 failed due to exception org.apache.spark.SparkException: Python worker exited unexpectedly (crashed).\r\n 21/09/17 07:28:10 INFO memory.MemoryStore: MemoryStore cleared\r\n 21/09/17 07:28:10 INFO storage.BlockManager: BlockManager stopped\r\n 21/09/17 07:28:10 INFO util.ShutdownHookManager: Shutdown hook called\n```",
        "created_at": "2021-09-20T09:49:49.000Z",
        "updated_at": "2021-12-16T12:40:01.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Java",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2021-09-20T09:52:42.805Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14038?focusedCommentId=17417551) by Ranga Reddy (rangareddy.avula@gmail.com):*\nWhile checking\u00a0**createString()**\u00a0method implementations in\u00a0[FlatBufferBuilder.java](https://github.com/google/flatbuffers/blob/v1.9.0/java/com/google/flatbuffers/FlatBufferBuilder.java)\u00a0class, it has two methods one is accepting CharSequence and another one is accepting the ByteBuffer as a argument.\r\n```java\n\r\npublic int createString(CharSequence s) {\r\n\r\n}\r\n\r\npublic int createString(ByteBuffer s) {\r\n\r\n}\r\n```\r\n\r\n While checking getField() method implementation in\u00a0[Field.java](https://github.com/apache/arrow/blob/apache-arrow-2.0.0/java/vector/src/main/java/org/apache/arrow/vector/types/pojo/Field.java#L204)\u00a0class, here it is passed\u00a0**String**\u00a0value.\r\n```java\n\r\npublic class Field {\r\n   private final String name;\r\n   public int getField(FlatBufferBuilder builder)\r\n   { \r\n     int nameOffset = name == null ? -1 : builder.createString(name); \r\n   }\r\n}\r\n```\r\n\r\n To fix this issue, we need to pass either\u00a0**CharSequence**\u00a0or\u00a0**ByteBuffer**\u00a0as the argument in getField() method.\r\n\r\n**Solution:**\r\n```java\n\r\npublic int getField(FlatBufferBuilder builder) {\r\n   java.nio.ByteBuffer bb = java.nio.ByteBuffer.wrap(name.getBytes());\r\n   int nameOffset = name == null ? -1 : builder.createString(bb);\r\n   .......\r\n}\r\n```\r\n\r\n \u00a0"
        },
        {
            "created_at": "2021-09-20T09:58:16.906Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14038?focusedCommentId=17417554) by Ranga Reddy (rangareddy.avula@gmail.com):*\nIf one of the committer allows my PR, i will contribute the code changes.\u00a0"
        }
    ]
}