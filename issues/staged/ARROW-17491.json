{
    "issue": {
        "title": "Build python lib failed for ARMv8",
        "body": "***Note**: This issue was originally created as [ARROW-17491](https://issues.apache.org/jira/browse/ARROW-17491). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI want to build pyarrow lib for my armv8-a with my own arm v8 cross-compiler. Althrough arror=2.0.0 is old I need to build it for pyflink and I confirmed that 2.0.0 does support armv8 building.\r\n\r\nI follow the steps described in [https://arrow.apache.org/docs/developers/python.html#using-conda](https://arrow.apache.org/docs/developers/python.html#using-conda:)\r\n\r\nFirstly , I have build out arrow c++ libs of arm:\r\n\r\nlibarrow.a \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 libarrow_python.a \u00a0 \u00a0 \u00a0 libarrow_python.so.200.0.0 \u00a0libarrow.so.200.0.0\r\nlibarrow_bundled_dependencies.a \u00a0libarrow_python.so \u00a0 \u00a0 \u00a0libarrow.so \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 libparquet.a\r\nlibarrow_dataset.a \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 libarrow_python.so.200 \u00a0libarrow.so.200\r\n\r\nThe make -4j command failed due to some third party arm lib has not been built out for linking. But It did not affect the building out of the upper libs.\r\n\r\nThen I perform building pyarrow step:\r\n\r\npushd arrow/python\r\n\r\nexport PYARROW_WITH_PARQUET=1\r\n\r\nexport PYARROW_WITH_DATASET=1\r\n\r\nexport PYARROW_PARALLEL=4 python setup.py build_ext --inplace\r\n\r\nThen an error occured:\r\n\r\n\u2013 System processor: arm\r\nset ARROW_CPU_FLAG\r\n\u2013 Arrow build warning level: PRODUCTION\r\nUsing ld linker\r\nConfigured for RELEASE build (set with cmake ~~DCMAKE_BUILD_TYPE=\\{release,debug,...})\r\n-~~ Build Type: RELEASE\r\nARROW_ARMV8_ARCH:\r\nARROW_ARMV8_ARCH\r\n\u2013 Build output directory: /root/build/tmp/arrow/python/build/temp.linux-x86_64-3.6/release\r\nCMake Warning (dev) at /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPackageHandleStandardArgs.cmake:438 (message):\r\n\u00a0 The package name passed to `find_package_handle_standard_args` (PkgConfig)\r\n\u00a0 does not match the name of the calling package (Arrow). \u00a0This can lead to\r\n\u00a0 problems in calling code that expects `find_package` result variables\r\n\u00a0 (e.g., `_FOUND`) to follow a certain pattern.\r\nCall Stack (most recent call first):\r\n\u00a0 /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPkgConfig.cmake:99 (find_package_handle_standard_args)\r\n\u00a0 cmake_modules/FindArrow.cmake:39 (include)\r\n\u00a0 cmake_modules/FindArrowPython.cmake:46 (find_package)\r\n\u00a0 CMakeLists.txt:219 (find_package)\r\nThis warning is for project developers. \u00a0Use -Wno-dev to suppress it.\r\n\r\n\u2013 Could NOT find Arrow (missing: Arrow_DIR)\r\n\u2013 Checking for module 'arrow'\r\n\u2013 \u00a0 No package 'arrow' found\r\nCMake Error at /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPackageHandleStandardArgs.cmake:230 (message):\r\n\u00a0 Could NOT find Arrow (missing: ARROW_INCLUDE_DIR ARROW_LIB_DIR\r\n\u00a0 ARROW_FULL_SO_VERSION ARROW_SO_VERSION)\r\nCall Stack (most recent call first):\r\n\u00a0 /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPackageHandleStandardArgs.cmake:594 (_FPHSA_FAILURE_MESSAGE)\r\n\u00a0 cmake_modules/FindArrow.cmake:418 (find_package_handle_standard_args)\r\n\u00a0 cmake_modules/FindArrowPython.cmake:46 (find_package)\r\n\u00a0 CMakeLists.txt:219 (find_package)\r\n\r\n\r\n\u2013 Configuring incomplete, errors occurred!\r\nerror: command 'cmake' failed with exit status 1\r\n\r\nWhat's it? It seems that I need to pip install arrow and pyarrow. After the installation, the error still occured. How to solve it?",
        "created_at": "2022-08-22T08:04:27.000Z",
        "updated_at": "2022-08-23T09:29:24.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: task"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-08-22T08:33:35.496Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17491?focusedCommentId=17582807) by Yibo Cai (yibocai):*\nFrom below error, looks Arrow packages are not found.\r\n```bash\n\u2013 Could NOT find Arrow (missing: Arrow_DIR)\n```\r\nYou may need to set env `ARROW_HOME` to where you installed Arrow."
        },
        {
            "created_at": "2022-08-22T09:33:32.015Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17491?focusedCommentId=17582835) by Antoine Pitrou (apitrou):*\nAlso, regardless of whether you need 2.0.0, we won't do any bugfixes for such an old version."
        },
        {
            "created_at": "2022-08-22T09:35:55.523Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17491?focusedCommentId=17582836) by chendan (atptour2017):*\n`[~yibocai]` \u00a0\r\n\r\nI follow your instruction and this error disappeared.\r\n\r\nNow the error is in linking:\r\n\r\nsetup start!\r\n\u2013 System processor: x86_64\r\n\u2013 System processor: arm\r\nset ARROW_CPU_FLAG\r\n\u2013 Arrow build warning level: PRODUCTION\r\nUsing ld linker\r\nConfigured for RELEASE build (set with cmake -DCMAKE_BUILD_TYPE=\\{release,debug,...})\r\n\u2013 Build Type: RELEASE\r\nARROW_ARMV8_ARCH:\r\nARROW_ARMV8_ARCH\r\n\u2013 Build output directory: /root/build/tmp/arrow/python/build/temp.linux-x86_64-3.6/release\r\nCMake Warning (dev) at /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPackageHandleStandardArgs.cmake:438 (message):\r\n\u00a0 The package name passed to `find_package_handle_standard_args` (PkgConfig)\r\n\u00a0 does not match the name of the calling package (Arrow). \u00a0This can lead to\r\n\u00a0 problems in calling code that expects `find_package` result variables\r\n\u00a0 (e.g., `_FOUND`) to follow a certain pattern.\r\nCall Stack (most recent call first):\r\n\u00a0 /home/anaconda3/envs/pyarrow-dev/share/cmake-3.23/Modules/FindPkgConfig.cmake:99 (find_package_handle_standard_args)\r\n\u00a0 cmake_modules/FindArrow.cmake:39 (include)\r\n\u00a0 cmake_modules/FindArrowPython.cmake:46 (find_package)\r\n\u00a0 CMakeLists.txt:219 (find_package)\r\nThis warning is for project developers. \u00a0Use -Wno-dev to suppress it.\r\n\r\n\u2013 Arrow version: 2.0.0 (HOME: /root/anaconda3/envs/pyarrow-dev/lib/python3.6/site-packages/pyarrow)\r\n\u2013 Arrow SO and ABI version: 200\r\n\u2013 Arrow full SO version: 200.0.0\r\n\u2013 Found the Arrow core shared library: ARROW_shared_lib-NOTFOUND\r\n\u2013 Found the Arrow core import library:\u00a0\r\n\u2013 Found the Arrow core static library: ARROW_static_lib-NOTFOUND\r\n\u2013 Found the Arrow Python by HOME: /root/anaconda3/envs/pyarrow-dev/lib/python3.6/site-packages/pyarrow\r\n\u2013 Found the Arrow Python shared library: ARROW_PYTHON_shared_lib-NOTFOUND\r\n\u2013 Found the Arrow Python import library:\u00a0\r\n\u2013 Found the Arrow Python static library: ARROW_PYTHON_static_lib-NOTFOUND\r\n\u2013 Parquet version: 1.5.1 (HOME: /root/anaconda3/envs/pyarrow-dev/lib/python3.6/site-packages/pyarrow)\r\n\u2013 Found the Parquet shared library: PARQUET_shared_lib-NOTFOUND\r\n\u2013 Found the Parquet import library:\u00a0\r\n\u2013 Found the Parquet static library: PARQUET_static_lib-NOTFOUND\r\n\u2013 Found ArrowDataset: /root/anaconda3/envs/pyarrow-dev/lib/python3.6/site-packages/pyarrow/include (found version \"2.0.0\")\u00a0\r\n\u2013 Found the Arrow Dataset by HOME: /root/anaconda3/envs/pyarrow-dev/lib/python3.6/site-packages/pyarrow\r\n\u2013 Found the Arrow Dataset shared library: ARROW_DATASET_shared_lib-NOTFOUND\r\n\u2013 Found the Arrow Dataset import library:\u00a0\r\n\u2013 Found the Arrow Dataset static library: ARROW_DATASET_static_lib-NOTFOUND\r\n\u2013 Configuring done\r\n\u2013 Generating done\r\n\u2013 Build files have been written to: /root/build/tmp/arrow/python/build/temp.linux-x86_64-3.6\r\n\u2013 Finished cmake for pyarrow\r\n\u2013 Running cmake --build for pyarrow\r\ncmake --build . --config release \u2013 -j4\r\n[ \u00a04%] Compiling Cython CXX source for lib...\r\n[ \u00a09%] Compiling Cython CXX source for _fs...\r\n[ 14%] Compiling Cython CXX source for _compute...\r\n[ 19%] Compiling Cython CXX source for _csv...\r\n[ 19%] Built target _csv_pyx\r\n[ 23%] Compiling Cython CXX source for _json...\r\n[ 23%] Built target _compute_pyx\r\n[ 28%] Compiling Cython CXX source for _dataset...\r\n[ 28%] Built target _fs_pyx\r\n[ 33%] Compiling Cython CXX source for _parquet...\r\n[ 33%] Built target _json_pyx\r\n[ 38%] Building CXX object CMakeFiles/_fs.dir/_fs.cpp.o\r\n[ 38%] Built target _parquet_pyx\r\n[ 42%] Building CXX object CMakeFiles/_compute.dir/_compute.cpp.o\r\n[ 42%] Built target _dataset_pyx\r\n[ 47%] Building CXX object CMakeFiles/_csv.dir/_csv.cpp.o\r\n[ 47%] Built target lib_pyx\r\n[ 52%] Building CXX object CMakeFiles/_json.dir/_json.cpp.o\r\n[ 57%] Linking CXX shared module release/_json.cpython-36m-x86_64-linux-gnu.so\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_shared\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_python_shared\r\ncollect2: error: ld returned 1 exit status\r\ngmake[2]: \\*\\*\\* [release/_json.cpython-36m-x86_64-linux-gnu.so] Error 1\r\ngmake[1]: \\*\\*\\* [CMakeFiles/_json.dir/all] Error 2\r\ngmake[1]: \\*\\*\\* Waiting for unfinished jobs....\r\n[ 61%] Linking CXX shared module release/_csv.cpython-36m-x86_64-linux-gnu.so\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_shared\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_python_shared\r\ncollect2: error: ld returned 1 exit status\r\ngmake[2]: \\*\\*\\* [release/_csv.cpython-36m-x86_64-linux-gnu.so] Error 1\r\ngmake[1]: \\*\\*\\* [CMakeFiles/_csv.dir/all] Error 2\r\n[ 66%] Linking CXX shared module release/_compute.cpython-36m-x86_64-linux-gnu.so\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_shared\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_python_shared\r\ncollect2: error: ld returned 1 exit status\r\ngmake[2]: \\*\\*\\* [release/_compute.cpython-36m-x86_64-linux-gnu.so] Error 1\r\ngmake[1]: \\*\\*\\* [CMakeFiles/_compute.dir/all] Error 2\r\n[ 71%] Linking CXX shared module release/_fs.cpython-36m-x86_64-linux-gnu.so\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_shared\r\n/opt/aarch64-kedacom-linux/lib/gcc/aarch64-kedacom-linux-gnu/8.3.0/../../../../aarch64-kedacom-linux-gnu/bin/ld: cannot find -larrow_python_shared\r\ncollect2: error: ld returned 1 exit status\r\ngmake[2]: \\*\\*\\* [release/_fs.cpython-36m-x86_64-linux-gnu.so] Error 1\r\ngmake[1]: \\*\\*\\* [CMakeFiles/_fs.dir/all] Error 2\r\ngmake: \\*\\*\\* [all] Error 2\r\nerror: command 'cmake' failed with exit status 2\r\n\r\n\u00a0\r\n\r\nWhen I pip install pyarrow, of course the _json.cpython-36m-x86_64-linux-gnu.so and other so files are x86_64 architecture. So must I compile these shared libs by my arm cross-compiler? How to compile them?\r\n\r\nBut it seems that _json.cpython-36m-armv8a-linux-gnu.so is the aim lib I need to build out but not the linked lib. If I have _json.cpython-36m-armv8a-linux-gnu.so my job is finished. All I need to do is to make all the lib files in site-packages/pyarrow to be arm format. Did I understand \"building pyarrow\" wrongly?"
        },
        {
            "created_at": "2022-08-22T09:56:20.769Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17491?focusedCommentId=17582853) by Yibo Cai (yibocai):*\nI didn't cross build Arrow. Probably due to some toolchain related cmake variables, not sure.\r\nI suggest a native build inside an aarch64 container. It can run on x86 host with qemu, though slower than cross build.\r\nSee this link https://github.com/multiarch/qemu-user-static"
        },
        {
            "created_at": "2022-08-23T09:29:24.651Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-17491?focusedCommentId=17583465) by chendan (atptour2017):*\n`[~yibocai]` \u00a0\r\n\r\nIt seems that this container solution is not suitable for me. As the cross compiler is our company's unique compiler in the world, not same with any others. Cross compiling is the only way to build libs for deployment in my company.\r\n\r\n\u00a0"
        }
    ]
}