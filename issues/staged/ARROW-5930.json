{
    "issue": {
        "title": "[FlightRPC] [Python] Flight CI tests are failing",
        "body": "***Note**: This issue was originally created as [ARROW-5930](https://issues.apache.org/jira/browse/ARROW-5930). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nFlight tests segfault on Travis: <https://travis-ci.org/apache/arrow/jobs/557690959>\r\n\r\nThe relevant part is:\r\n```\n\r\nFatal Python error: Aborted\r\nThread 0x00007fcf009fe700 (most recent call first):\r\n  File \"/home/travis/build/apache/arrow/python/pyarrow/tests/test_flight.py\", line 386 in _server_thread\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/threading.py\", line 864 in run\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/threading.py\", line 916 in _bootstrap_inner\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/threading.py\", line 884 in _bootstrap\r\nCurrent thread 0x00007fcf1f9fa700 (most recent call first):\r\n  File \"/home/travis/build/apache/arrow/python/pyarrow/tests/test_flight.py\", line 411 in flight_server\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/contextlib.py\", line 99 in __exit__\r\n  File \"/home/travis/build/apache/arrow/python/pyarrow/tests/test_flight.py\", line 670 in test_tls_do_get\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/python.py\", line 165 in pytest_pyfunc_call\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/callers.py\", line 187 in _multicall\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 81 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 87 in _hookexec\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/hooks.py\", line 289 in __call__\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/python.py\", line 1451 in runtest\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 117 in pytest_runtest_call\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/callers.py\", line 187 in _multicall\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 81 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 87 in _hookexec\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/hooks.py\", line 289 in __call__\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 192 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 220 in from_call\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 192 in call_runtest_hook\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 167 in call_and_report\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 87 in runtestprotocol\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/runner.py\", line 72 in pytest_runtest_protocol\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/callers.py\", line 187 in _multicall\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 81 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 87 in _hookexec\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/hooks.py\", line 289 in __call__\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/main.py\", line 278 in pytest_runtestloop\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/callers.py\", line 187 in _multicall\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 81 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 87 in _hookexec\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/hooks.py\", line 289 in __call__\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/main.py\", line 257 in _main\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/main.py\", line 213 in wrap_session\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/main.py\", line 250 in pytest_cmdline_main\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/callers.py\", line 187 in _multicall\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 81 in <lambda>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/manager.py\", line 87 in _hookexec\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pluggy/hooks.py\", line 289 in __call__\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/_pytest/config/__init__.py\", line 74 in main\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/pytest.py\", line 102 in <module>\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/coverage/execfile.py\", line 192 in run_python_file\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/coverage/execfile.py\", line 122 in run_python_module\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/coverage/cmdline.py\", line 627 in do_run\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/coverage/cmdline.py\", line 491 in command_line\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/lib/python3.6/site-packages/coverage/cmdline.py\", line 756 in main\r\n  File \"/home/travis/build/apache/arrow/pyarrow-test-3.6/bin/coverage\", line 10 in <module>\r\n/home/travis/build/apache/arrow/ci/travis_script_python.sh: line 202: 12032 Aborted                 (core dumped) coverage run --append -m pytest $PYARROW_PYTEST_FLAGS pyarrow/tests\n```\r\nI haven't been able to reproduce this so far. We may want to just mark the tests as flaky for now.",
        "created_at": "2019-07-12T16:17:31.000Z",
        "updated_at": "2019-08-01T22:39:34.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: FlightRPC",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2019-07-16T20:03:40.000Z"
    },
    "comments": [
        {
            "created_at": "2019-07-16T16:56:08.856Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-5930?focusedCommentId=16886296) by Antoine Pitrou (apitrou):*\nI managed to get a gdb traceback: https://travis-ci.org/pitrou/arrow/builds/559516492#L3018\r\n\r\nThe explanation is: one thread is calling `FlightServerBase::Shutdown` while the `FlightServerBase::Init` call in the other thread hasn't finished, so `impl_->server_` is NULL.\r\n\r\nThe way we're calling `server_instance.shutdown()` in the `flight_server()` function in `test_flight.py` isn't safe."
        },
        {
            "created_at": "2019-07-16T16:59:04.086Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-5930?focusedCommentId=16886300) by David Li (lidavidm):*\n`[~pitrou]` I had just come to the same conclusion. I have a change so that Shutdown doesn't use a DCHECK, but instead does an actual check, so at least it won't segfault. I can add additional synchronization on the Python side."
        },
        {
            "created_at": "2019-07-16T17:12:58.392Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-5930?focusedCommentId=16886312) by Antoine Pitrou (apitrou):*\nPerhaps Python needs to distinguish the setup phase and the serve phase of the Flight server. Then test_flight.py can run the setup phase in the main thread."
        },
        {
            "created_at": "2019-07-16T20:03:40.722Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-5930?focusedCommentId=16886422) by Antoine Pitrou (apitrou):*\nIssue resolved by pull request 4891\n<https://github.com/apache/arrow/pull/4891>"
        }
    ]
}