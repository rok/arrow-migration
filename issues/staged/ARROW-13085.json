{
    "issue": {
        "title": "[Python] Apache Arrow minimal cpp build segfaults with pyarrow libs",
        "body": "***Note**: This issue was originally created as [ARROW-13085](https://issues.apache.org/jira/browse/ARROW-13085). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\n###### _Refer to <https://github.com/kratsg/awkward-arrow-cmake-pybind11/issues/6#issuecomment-861592692>\u00a0and code-base available here: <https://github.com/kratsg/awkward-arrow-cmake-pybind11/tree/0e196983b2452c4c3dbbde40984db7031397d0a7>_\r\n\r\nThe minimal build example provided by arrow (<https://github.com/apache/arrow/blob/master/cpp/examples/minimal_build/example.cc> [)](https://github.com/apache/arrow/blob/master/cpp/examples/minimal_build/example.cc)\u00a0works fine using the libs shipped with `yum`\u00a0on CentOS7. Using the libs shipped by `pip install pyarrow` instead provides a segfault at runtime. Here is the gdb dump with debugging flags included\r\n```java\n\r\n[root@dab7bb04d93f examples]# gdb ./../build/example_arrow \r\nGNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-120.el7\r\nCopyright (C) 2013 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\r\nand \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>...\r\nReading symbols from /Users/kratsg/awkward-arrow-cmake-pybind11/build/example_arrow...done.\r\n(gdb) run\r\nStarting program: /Users/kratsg/awkward-arrow-cmake-pybind11/examples/./../build/example_arrow \r\nwarning: Error disabling address space randomization: Operation not permitted\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\n[New Thread 0x7f9c58dff700 (LWP 1643)]\r\n* Reading CSV file 'test.csv' into table\r\n\r\nProgram received signal SIGSEGV, Segmentation fault.\r\n__destroy<std::basic_string<char>*> (__last=<optimized out>, __first=0x3200000000) at /usr/include/c++/4.8.2/bits/stl_construct.h:103\r\n103\t\t    std::_Destroy(std::__addressof(*__first));\r\nMissing separate debuginfos, use: debuginfo-install glibc-2.17-324.el7_9.x86_64 libgcc-4.8.5-44.el7.x86_64 libstdc++-4.8.5-44.el7.x86_64\r\n(gdb) bt\r\n#0  __destroy<std::basic_string<char>*> (__last=<optimized out>, __first=0x3200000000) at /usr/include/c++/4.8.2/bits/stl_construct.h:103\r\n#1  _Destroy<std::basic_string<char>*> (__last=<optimized out>, __first=<optimized out>) at /usr/include/c++/4.8.2/bits/stl_construct.h:126\r\n#2  _Destroy<std::basic_string<char>*, std::basic_string<char> > (__last=0x0, __first=<optimized out>) at /usr/include/c++/4.8.2/bits/stl_construct.h:151\r\n#3  ~vector (this=0x7ffff43602a8, __in_chrg=<optimized out>) at /usr/include/c++/4.8.2/bits/stl_vector.h:415\r\n#4  arrow::csv::ConvertOptions::~ConvertOptions (this=0x7ffff4360220, __in_chrg=<optimized out>)\r\n    at /usr/local/venv/lib/python3.8/site-packages/pyarrow/include/arrow/csv/options.h:64\r\n#5  0x000000000040171a in (anonymous namespace)::RunMain (argv=<optimized out>, argc=<optimized out>, this=<optimized out>, this=<optimized out>)\r\n    at /Users/kratsg/awkward-arrow-cmake-pybind11/src/example/arrow.cpp:39\r\n#6  0x000000000040135f in main (argc=<optimized out>, argv=<optimized out>) at /Users/kratsg/awkward-arrow-cmake-pybind11/src/example/arrow.cpp:66 \n```\r\nBelow is the full CMake log + build log\r\n```java\n\r\n# ./build.sh \r\n-- The CXX compiler identification is GNU 4.8.5\r\n-- Detecting CXX compiler ABI info\r\n-- Detecting CXX compiler ABI info - done\r\n-- Check for working CXX compiler: /usr/bin/c++ - skipped\r\n-- Detecting CXX compile features\r\n-- Detecting CXX compile features - done\r\n-- pybind11 v2.6.2 \r\n-- Found PythonInterp: /usr/local/bin/python3.8 (found version \"3.8.10\") \r\n-- Found PythonLibs: /usr/local/lib/libpython3.8.so\r\n-- Performing Test HAS_FLTO\r\n-- Performing Test HAS_FLTO - Success\r\n-- PyArrow includes : /usr/local/venv/lib/python3.8/site-packages/pyarrow/include\r\n-- PyArrow libraries : arrow;arrow_python\r\n-- PyArrow library dirs : /usr/local/venv/lib/python3.8/site-packages/pyarrow\r\n-- Awkward includes : /usr/local/venv/lib/python3.8/site-packages/awkward/include\r\n-- Awkward libraries: /usr/local/venv/lib/python3.8/site-packages/awkward\r\n-- Libraries: /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward-cpu-kernels.so /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward.so /usr/lib64/libdl.so /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow.so /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow_python.so\r\n-- Configuring done\r\n-- Generating done\r\n-- Build files have been written to: /Users/kratsg/awkward-arrow-cmake-pybind11/build\r\n-- pybind11 v2.6.2 \r\n-- PyArrow includes : /usr/local/venv/lib/python3.8/site-packages/pyarrow/include\r\n-- PyArrow libraries : arrow;arrow_python\r\n-- PyArrow library dirs : /usr/local/venv/lib/python3.8/site-packages/pyarrow\r\n-- Awkward includes : /usr/local/venv/lib/python3.8/site-packages/awkward/include\r\n-- Awkward libraries: /usr/local/venv/lib/python3.8/site-packages/awkward\r\n-- Libraries: /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward-cpu-kernels.so /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward.so /usr/lib64/libdl.so /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow.so /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow_python.so\r\n-- Configuring done\r\n-- Generating done\r\n-- Build files have been written to: /Users/kratsg/awkward-arrow-cmake-pybind11/build\r\n-- Cache values\r\nCMAKE_BUILD_TYPE:STRING=RelWithDebInfo\r\nCMAKE_INSTALL_PREFIX:PATH=/usr/local\r\nCPU-KERNELS:FILEPATH=/usr/local/venv/lib/python3.8/site-packages/awkward/libawkward-cpu-kernels.so\r\nLIBARROW:FILEPATH=/usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow.so\r\nLIBARROW_PYTHON:FILEPATH=/usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow_python.so\r\nLIBAWKWARD:FILEPATH=/usr/local/venv/lib/python3.8/site-packages/awkward/libawkward.so\r\nLIBDL:FILEPATH=/usr/lib64/libdl.so\r\nPYBIND11_FINDPYTHON:BOOL=OFF\r\nPYBIND11_INSTALL:BOOL=OFF\r\nPYBIND11_NOPYTHON:BOOL=OFF\r\nPYBIND11_PYTHON_VERSION:STRING=\r\nPYBIND11_TEST:BOOL=OFF\r\n\r\n###################################################################\r\n######################### BUILD LOG BELOW #########################\r\n###################################################################\r\n\r\n/usr/local/bin/cmake -S/Users/kratsg/awkward-arrow-cmake-pybind11/src -B/Users/kratsg/awkward-arrow-cmake-pybind11/build --check-build-system CMakeFiles/Makefile.cmake 0\r\n/usr/local/bin/cmake -E cmake_progress_start /Users/kratsg/awkward-arrow-cmake-pybind11/build/CMakeFiles /Users/kratsg/awkward-arrow-cmake-pybind11/build//CMakeFiles/progress.marks\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/Makefile2 all\r\ngmake[1]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/babel.dir/build.make CMakeFiles/babel.dir/depend\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/example_arrow.dir/build.make CMakeFiles/example_arrow.dir/depend\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/example.dir/build.make CMakeFiles/example.dir/depend\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\ncd /Users/kratsg/awkward-arrow-cmake-pybind11/build && /usr/local/bin/cmake -E cmake_depends \"Unix Makefiles\" /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build/CMakeFiles/babel.dir/DependInfo.cmake --color=\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\ncd /Users/kratsg/awkward-arrow-cmake-pybind11/build && /usr/local/bin/cmake -E cmake_depends \"Unix Makefiles\" /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build/CMakeFiles/example_arrow.dir/DependInfo.cmake --color=\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\ncd /Users/kratsg/awkward-arrow-cmake-pybind11/build && /usr/local/bin/cmake -E cmake_depends \"Unix Makefiles\" /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/src /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build /Users/kratsg/awkward-arrow-cmake-pybind11/build/CMakeFiles/example.dir/DependInfo.cmake --color=\r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/example.dir/build.make CMakeFiles/example.dir/build\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/babel.dir/build.make CMakeFiles/babel.dir/build\r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n/usr/bin/gmake\u00a0 -f CMakeFiles/example_arrow.dir/build.make CMakeFiles/example_arrow.dir/build\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\ngmake[2]: Entering directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n[ 14%] Building CXX object CMakeFiles/example.dir/example/python.cpp.o\r\n/usr/bin/c++ -Dexample_EXPORTS -isystem /Users/kratsg/awkward-arrow-cmake-pybind11/src/pybind11/include -isystem /usr/local/venv/lib/python3.8/site-packages/awkward/include -O2 -g -DNDEBUG -fPIC -fvisibility=hidden -std=gnu++11 -MD -MT CMakeFiles/example.dir/example/python.cpp.o -MF CMakeFiles/example.dir/example/python.cpp.o.d -o CMakeFiles/example.dir/example/python.cpp.o -c /Users/kratsg/awkward-arrow-cmake-pybind11/src/example/python.cpp\r\n[ 28%] Building CXX object CMakeFiles/babel.dir/babel/python.cpp.o\r\n/usr/bin/c++ -Dbabel_EXPORTS -isystem /Users/kratsg/awkward-arrow-cmake-pybind11/src/pybind11/include -isystem /usr/local/venv/lib/python3.8/site-packages/pyarrow/include -isystem /usr/local/venv/lib/python3.8/site-packages/awkward/include -O2 -g -DNDEBUG -fPIC -fvisibility=hidden -std=gnu++11 -MD -MT CMakeFiles/babel.dir/babel/python.cpp.o -MF CMakeFiles/babel.dir/babel/python.cpp.o.d -o CMakeFiles/babel.dir/babel/python.cpp.o -c /Users/kratsg/awkward-arrow-cmake-pybind11/src/babel/python.cpp\r\n[ 42%] Building CXX object CMakeFiles/example_arrow.dir/example/arrow.cpp.o\r\n/usr/bin/c++\u00a0 -isystem /usr/local/venv/lib/python3.8/site-packages/pyarrow/include -O2 -g -DNDEBUG -std=gnu++11 -MD -MT CMakeFiles/example_arrow.dir/example/arrow.cpp.o -MF CMakeFiles/example_arrow.dir/example/arrow.cpp.o.d -o CMakeFiles/example_arrow.dir/example/arrow.cpp.o -c /Users/kratsg/awkward-arrow-cmake-pybind11/src/example/arrow.cpp\r\n[ 57%] Linking CXX executable example_arrow\r\n/usr/local/bin/cmake -E cmake_link_script CMakeFiles/example_arrow.dir/link.txt --verbose=1\r\n/usr/bin/c++ -O2 -g -DNDEBUG CMakeFiles/example_arrow.dir/example/arrow.cpp.o -o example_arrow\u00a0 -Wl,-rpath,/usr/local/venv/lib/python3.8/site-packages/pyarrow /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow.so \r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n[ 57%] Built target example_arrow\r\n[ 71%] Building CXX object CMakeFiles/example.dir/example/minimal.cpp.o\r\n/usr/bin/c++ -Dexample_EXPORTS -isystem /Users/kratsg/awkward-arrow-cmake-pybind11/src/pybind11/include -isystem /usr/local/venv/lib/python3.8/site-packages/awkward/include -O2 -g -DNDEBUG -fPIC -fvisibility=hidden -std=gnu++11 -MD -MT CMakeFiles/example.dir/example/minimal.cpp.o -MF CMakeFiles/example.dir/example/minimal.cpp.o.d -o CMakeFiles/example.dir/example/minimal.cpp.o -c /Users/kratsg/awkward-arrow-cmake-pybind11/src/example/minimal.cpp\r\n[ 85%] Linking CXX shared module example.cpython-38-x86_64-linux-gnu.so\r\n/usr/local/bin/cmake -E cmake_link_script CMakeFiles/example.dir/link.txt --verbose=1\r\n/usr/bin/c++ -fPIC -O2 -g -DNDEBUG -shared\u00a0 -o example.cpython-38-x86_64-linux-gnu.so CMakeFiles/example.dir/example/python.cpp.o CMakeFiles/example.dir/example/minimal.cpp.o\u00a0 -Wl,-rpath,/usr/local/venv/lib/python3.8/site-packages/awkward /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward-cpu-kernels.so /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward.so /usr/lib64/libdl.so \r\n[100%] Linking CXX shared module babel.cpython-38-x86_64-linux-gnu.so\r\n/usr/local/bin/cmake -E cmake_link_script CMakeFiles/babel.dir/link.txt --verbose=1\r\n/usr/bin/c++ -fPIC -O2 -g -DNDEBUG -shared\u00a0 -o babel.cpython-38-x86_64-linux-gnu.so CMakeFiles/babel.dir/babel/python.cpp.o\u00a0 -Wl,-rpath,/usr/local/venv/lib/python3.8/site-packages/pyarrow:/usr/local/venv/lib/python3.8/site-packages/awkward /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow.so /usr/local/venv/lib/python3.8/site-packages/pyarrow/libarrow_python.so /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward-cpu-kernels.so /usr/local/venv/lib/python3.8/site-packages/awkward/libawkward.so /usr/lib64/libdl.so \r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n[100%] Built target example\r\ngmake[2]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n[100%] Built target babel\r\ngmake[1]: Leaving directory `/Users/kratsg/awkward-arrow-cmake-pybind11/build'\r\n/usr/local/bin/cmake -E cmake_progress_start /Users/kratsg/awkward-arrow-cmake-pybind11/build/CMakeFiles 0 \n```\r\nOne can reproduce this by cloning the corresponding repository recursively, then building the docker image, compiling the code, and then running it\r\n```java\n\r\ngit clone --recursive git@github.com:kratsg/awkward-arrow-cmake-pybind11.git\r\nmake build-image-debug\r\nmake debug # launches docker image\r\n> ./build.sh\r\n> ./run_example.sh\n```\r\nwhere `>` denotes commands run inside the docker image.",
        "created_at": "2021-06-15T15:55:36.000Z",
        "updated_at": "2021-06-15T19:25:53.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Documentation",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2021-06-15T19:24:58.000Z"
    },
    "comments": [
        {
            "created_at": "2021-06-15T16:19:11.254Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363748) by Antoine Pitrou (apitrou):*\nThis is probably a classic case of C++ toolchain incompatibility.\r\nOur manylinux wheels use the toolchain provided by the upstream manylinux build images (see https://quay.io/organization/pypa ). This is probably devtoolset-8 or devtoolset-9, depending on which manylinux wheel version (2010 or 2014) you used."
        },
        {
            "created_at": "2021-06-15T17:36:57.283Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363806) by Giordon Stark (kratsg):*\n`[~apitrou]` \u00a0- thanks for the nice hint. Switching to `devtoolset-8` does fix the segfault! (Maybe the docs need to have some hint about making sure a compatible toolchain is used if one is building extensions using the python libs?)\r\n\r\n\u00a0\r\n```java\n\r\n# ./run_example.sh \r\n/Users/kratsg/awkward-arrow-cmake-pybind11/examples /Users/kratsg/awkward-arrow-cmake-pybind11\r\n* Reading CSV file 'test.csv' into table\r\n* Read table:\r\nIntegers: int64\r\nStrings: string\r\nTimestamps: timestamp[s]\r\n----\r\nIntegers:\r\n  [\r\n    [\r\n      1,\r\n      2\r\n    ]\r\n  ]\r\nStrings:\r\n  [\r\n    [\r\n      \"Some\",\r\n      \"data\"\r\n    ]\r\n  ]\r\nTimestamps:\r\n  [\r\n    [\r\n      2018-11-13 17:11:10,\r\n      null\r\n    ]\r\n  ]\r\n* Writing table into Arrow IPC file 'test.arrow'\r\n \n```\r\nwhere the changes I made to the `Dockerfile` are\r\n```java\n\r\ndiff --git a/Dockerfile b/Dockerfile\r\nindex 1fc311e..87b9289 100644\r\n--- a/Dockerfile\r\n+++ b/Dockerfile\r\n@@ -7,6 +7,11 @@ WORKDIR /\r\n SHELL [ \"/bin/bash\", \"-c\" ]\r\n \r\n COPY build-requirements.txt /tmp/build-requirements.txt\r\n-RUN python -m pip --no-cache-dir install --upgrade pip setuptools wheel && \\\r\n+\r\n+RUN yum update -y -q && \\\r\n+    yum install -y -q centos-release-scl && \\\r\n+    yum install -y -q devtoolset-8 && \\\r\n+    echo \"source scl_source enable devtoolset-8\" >> ~/.bash_profile && \\\r\n+    python -m pip --no-cache-dir install --upgrade pip setuptools wheel && \\\r\n     python -m pip --no-cache-dir install --requirement /tmp/build-requirements.txt && \\\r\n     python -m pip list \n```\r\nwhich is not so bad. This certainly was not obvious at all to me\u00a0\ud83d\ude00"
        },
        {
            "created_at": "2021-06-15T17:42:54.399Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363812) by Antoine Pitrou (apitrou):*\n`[~kratsg]` Do you want to open a PR for improving the docs? Or at least suggest where this could be added?"
        },
        {
            "created_at": "2021-06-15T17:45:53.019Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363815) by Giordon Stark (kratsg):*\nSure, let me fork and then create a PR and link it here."
        },
        {
            "created_at": "2021-06-15T17:57:37.389Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363826) by Giordon Stark (kratsg):*\nI've opened a PR here\u00a0https://github.com/apache/arrow/pull/10535"
        },
        {
            "created_at": "2021-06-15T19:24:58.601Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-13085?focusedCommentId=17363871) by Antoine Pitrou (apitrou):*\nIssue resolved by pull request 10535\n<https://github.com/apache/arrow/pull/10535>"
        }
    ]
}