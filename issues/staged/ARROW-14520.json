{
    "issue": {
        "title": "[Python] Non-deterministic Segfault with Pyarrow",
        "body": "***Note**: This issue was originally created as [ARROW-14520](https://issues.apache.org/jira/browse/ARROW-14520). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nHi all,\r\n\r\nI've been getting this non-deterministic seg fault when writing out parquet files via Dask. I was wondering if anyone could help me figure out what the stack trace means and I can probably triage the issue from there.\r\n```java\n\r\n// code placeholder\r\nepee:23196] *** Process received signal ***\r\n[epee:23196] Signal: Segmentation fault (11)\r\n[epee:23196] Signal code:  (128)\r\n[epee:23196] Failing at address: (nil)\r\n[epee:23196] [ 0] /lib/x86_64-linux-gnu/libpthread.so.0(+0x12980)[0x7f595b277980]\r\n[epee:23196] [ 1] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute8internal12DoStaticCastIhlEEvPKvlllPv+0x98)[0x7f594720c278]\r\n[epee:23196] [ 2] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute8internal14CastNumberImplINS_9Int64TypeEEEvNS_4Type4typeERKNS_5DatumEPS6_+0xe72)[0x7f5947217592]\r\n[epee:23196] [ 3] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute8internal20CastIntegerToIntegerEPNS0_13KernelContextERKNS0_9ExecBatchEPNS_5DatumE+0x74)[0x7f5947231254]\r\n[epee:23196] [ 4] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(+0x52e87d)[0x7f594710d87d]\r\n[epee:23196] [ 5] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZNK5arrow7compute8Function7ExecuteERKSt6vectorINS_5DatumESaIS3_EEPKNS0_15FunctionOptionsEPNS0_11ExecContextE+0xd9b)[0x7f594711455b]\r\n[epee:23196] [ 6] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(+0x51efbd)[0x7f59470fdfbd]\r\n[epee:23196] [ 7] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZNK5arrow7compute12MetaFunction7ExecuteERKSt6vectorINS_5DatumESaIS3_EEPKNS0_15FunctionOptionsEPNS0_11ExecContextE+0x7c)[0x7f594710f21c]\r\n[epee:23196] [ 8] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute12CallFunctionERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEERKSt6vectorINS_5DatumESaISA_EEPKNS0_15FunctionOptionsEPNS0_11ExecContextE+0x94)[0x7f5947108df4]\r\n[epee:23196] [ 9] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute4CastERKNS_5DatumERKNS0_11CastOptionsEPNS0_11ExecContextE+0xc8)[0x7f59470ff038]\r\n[epee:23196] [10] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute4CastERKNS_5DatumESt10shared_ptrINS_8DataTypeEERKNS0_11CastOptionsEPNS0_11ExecContextE+0xed)[0x7f59471013ed]\r\n[epee:23196] [11] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow.so.400(_ZN5arrow7compute4CastERKNS_5ArrayESt10shared_ptrINS_8DataTypeEERKNS0_11CastOptionsEPNS0_11ExecContextE+0x87)[0x7f5947101957]\r\n[epee:23196] [12] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow_python.so.400(+0xbf123)[0x7f5946b4e123]\r\n[epee:23196] [13] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow_python.so.400(+0xc5df6)[0x7f5946b54df6]\r\n[epee:23196] [14] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow_python.so.400(+0xcc828)[0x7f5946b5b828]\r\n[epee:23196] [15] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow_python.so.400(_ZN5arrow2py14NumPyConverter7ConvertEv+0x4d)[0x7f5946b5b97d]\r\n[epee:23196] [16] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/../../../libarrow_python.so.400(_ZN5arrow2py14NdarrayToArrowEPNS_10MemoryPoolEP7_objectS4_bRKSt10shared_ptrINS_8DataTypeEERKNS_7compute11CastOptionsEPS5_INS_12ChunkedArrayEE+0x2b0)[0x7f5946b5bf60]\r\n[epee:23196] [17] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/lib.cpython-38-x86_64-linux-gnu.so(+0x1b5493)[0x7f5947bfa493]\r\n[epee:23196] [18] /home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/lib.cpython-38-x86_64-linux-gnu.so(+0x1b85ff)[0x7f5947bfd5ff]\r\n[epee:23196] [19] python3(PyCFunction_Call+0x54)[0x5652b403fc64]\r\n[epee:23196] [20] python3(_PyObject_MakeTpCall+0x31e)[0x5652b404f0fe]\r\n[epee:23196] [21] python3(_PyEval_EvalFrameDefault+0x5685)[0x5652b40e5a95]\r\n[epee:23196] [22] python3(_PyEval_EvalCodeWithName+0x2c3)[0x5652b40c2fa3]\r\n[epee:23196] [23] python3(_PyFunction_Vectorcall+0x378)[0x5652b40c4388]\r\n[epee:23196] [24] python3(_PyEval_EvalFrameDefault+0x947)[0x5652b40e0d57]\r\n[epee:23196] [25] python3(_PyEval_EvalCodeWithName+0x2c3)[0x5652b40c2fa3]\r\n[epee:23196] [26] python3(_PyFunction_Vectorcall+0x378)[0x5652b40c4388]\r\n[epee:23196] [27] python3(_PyEval_EvalFrameDefault+0x947)[0x5652b40e0d57]\r\n[epee:23196] [28] python3(_PyEval_EvalCodeWithName+0x2c3)[0x5652b40c2fa3]\r\n[epee:23196] [29] python3(_PyFunction_FastCallDict+0x1b2)[0x5652b3fe018a]\r\n[epee:23196] *** End of error message ***\r\n```\r\n\r\nHere's another concrete stack trace with faulthandler.\r\n```java\n\r\nCurrent thread 0x00007f0256ad9700 (most recent call first):\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/pandas_compat.py\", line 575 in convert_column\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/pandas_compat.py\", line 594 in <listcomp>\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/pyarrow/pandas_compat.py\", line 594 in dataframe_to_arrays\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/dask/dataframe/io/parquet/arrow.py\", line 892 in _pandas_to_arrow_table\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/dask/dataframe/io/parquet/arrow.py\", line 922 in write_partition\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/distributed/worker.py\", line 3936 in apply_function_simple\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/distributed/worker.py\", line 3914 in apply_function\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/distributed/_concurrent_futures_thread.py\", line 66 in run\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/site-packages/distributed/threadpoolexecutor.py\", line 55 in _worker\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/threading.py\", line 870 in run\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/threading.py\", line 932 in _bootstrap_inner\r\n  File \"/home/vkarthik/anaconda3/envs/katana-dev/lib/python3.8/threading.py\", line 890 in _bootstrap\r\n```\r\n",
        "created_at": "2021-10-29T18:29:07.000Z",
        "updated_at": "2021-11-09T10:28:03.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2021-11-09T10:27:04.007Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14520?focusedCommentId=17441048) by Joris Van den Bossche (jorisvandenbossche):*\nThe segfault is happening somewhere in the Cast implementation, during the conversion from pandas DataFrame to an arrow Table (i.e. during the conversion of each of the columns of the dataframe to an arrow array). \r\nDo you specify the schema when writing to parquet?\r\n\r\nI don't know if the above information would help further triaging the issue. Could you otherwise give some additional information? Do you have a code example that (from time to time) reproduces the segfault?"
        },
        {
            "created_at": "2021-11-09T10:28:03.052Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-14520?focusedCommentId=17441049) by Joris Van den Bossche (jorisvandenbossche):*\nI would also suggest trying with the latest version of pyarrow, to see if it might already have been fixed (since you mention you are using pyarrow 4.0)"
        }
    ]
}