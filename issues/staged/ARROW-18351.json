{
    "issue": {
        "title": "[C++][Flight] Crash in UcxErrorHandlingTest.TestDoExchange",
        "body": "***Note**: This issue was originally created as [ARROW-18351](https://issues.apache.org/jira/browse/ARROW-18351). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI get a non-deterministic crash in the Flight UCX tests.\r\n```Java\n\r\n[----------] 3 tests from UcxErrorHandlingTest\r\n[ RUN      ] UcxErrorHandlingTest.TestGetFlightInfo\r\n[       OK ] UcxErrorHandlingTest.TestGetFlightInfo (24 ms)\r\n[ RUN      ] UcxErrorHandlingTest.TestDoPut\r\n[       OK ] UcxErrorHandlingTest.TestDoPut (15 ms)\r\n[ RUN      ] UcxErrorHandlingTest.TestDoExchange\r\n/arrow/cpp/src/arrow/util/future.cc:125:  Check failed: !IsFutureFinished(state_) Future already marked finished\r\n```\r\n\r\nHere is the GDB backtrace:\r\n```Java\n\r\n#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51\r\n#1  0x00007f18c49cd7f1 in __GI_abort () at abort.c:79\r\n#2  0x00007f18c5854e00 in arrow::util::CerrLog::~CerrLog (this=0x7f18a81607b0, __in_chrg=<optimized out>) at /arrow/cpp/src/arrow/util/logging.cc:72\r\n#3  0x00007f18c5854e1c in arrow::util::CerrLog::~CerrLog (this=0x7f18a81607b0, __in_chrg=<optimized out>) at /arrow/cpp/src/arrow/util/logging.cc:74\r\n#4  0x00007f18c5855181 in arrow::util::ArrowLog::~ArrowLog (this=0x7f18c07fc380, __in_chrg=<optimized out>) at /arrow/cpp/src/arrow/util/logging.cc:250\r\n#5  0x00007f18c5826f86 in arrow::ConcreteFutureImpl::DoMarkFinishedOrFailed (this=0x7f18a815f030, state=arrow::FutureState::FAILURE)\r\n    at /arrow/cpp/src/arrow/util/future.cc:125\r\n#6  0x00007f18c58265af in arrow::ConcreteFutureImpl::DoMarkFailed (this=0x7f18a815f030) at /arrow/cpp/src/arrow/util/future.cc:40\r\n#7  0x00007f18c5827660 in arrow::FutureImpl::MarkFailed (this=0x7f18a815f030) at /arrow/cpp/src/arrow/util/future.cc:195\r\n#8  0x00007f18c80ff8d8 in arrow::Future<std::shared_ptr<arrow::flight::transport::ucx::Frame> >::DoMarkFinished (this=0x7f18a815efb0, res=...)\r\n    at /arrow/cpp/src/arrow/util/future.h:660\r\n#9  0x00007f18c80fb37d in arrow::Future<std::shared_ptr<arrow::flight::transport::ucx::Frame> >::MarkFinished (this=0x7f18a815efb0, res=...)\r\n    at /arrow/cpp/src/arrow/util/future.h:403\r\n#10 0x00007f18c80f5ae3 in arrow::flight::transport::ucx::UcpCallDriver::Impl::Push (this=0x7f18a804d2d0, status=...)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:780\r\n#11 0x00007f18c80f5c1f in arrow::flight::transport::ucx::UcpCallDriver::Impl::RecvActiveMessage (this=0x7f18a804d2d0, header=0x7f18c8081865, header_length=12, \r\n    data=0x7f18c8081864, data_length=1, param=0x7f18c07fc680) at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:791\r\n#12 0x00007f18c80f7d29 in arrow::flight::transport::ucx::UcpCallDriver::RecvActiveMessage (this=0x7f18b80017e0, header=0x7f18c8081865, header_length=12, \r\n    data=0x7f18c8081864, data_length=1, param=0x7f18c07fc680) at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:1082\r\n#13 0x00007f18c80e3ea4 in arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::HandleIncomingActiveMessage (self=0x7f18a80259a0, \r\n    header=0x7f18c8081865, header_length=12, data=0x7f18c8081864, data_length=1, param=0x7f18c07fc680)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:586\r\n#14 0x00007f18c4661a09 in ucp_am_invoke_cb (recv_flags=<optimized out>, reply_ep=<optimized out>, data_length=1, data=<optimized out>, \r\n    user_hdr_length=<optimized out>, user_hdr=0x7f18c8081865, am_id=4132, worker=<optimized out>) at core/ucp_am.c:1220\r\n#15 ucp_am_handler_common (name=<synthetic pointer>, recv_flags=<optimized out>, am_flags=0, reply_ep=<optimized out>, total_length=<optimized out>, \r\n    am_hdr=0x7f18c808185c, worker=<optimized out>) at core/ucp_am.c:1289\r\n#16 ucp_am_handler_reply (am_arg=<optimized out>, am_data=<optimized out>, am_length=<optimized out>, am_flags=<optimized out>) at core/ucp_am.c:1327\r\n#17 0x00007f18c28e3f1c in uct_iface_invoke_am (flags=0, length=29, data=0x7f18c808185c, id=<optimized out>, iface=0x7f18a8027e20)\r\n    at /usr/local/src/conda/ucx-1.13.1/src/uct/base/uct_iface.h:861\r\n#18 uct_mm_iface_invoke_am (flags=0, length=29, data=0x7f18c808185c, am_id=<optimized out>, iface=0x7f18a8027e20) at sm/mm/base/mm_iface.h:256\r\n#19 uct_mm_iface_process_recv (iface=0x7f18a8027e20) at sm/mm/base/mm_iface.c:256\r\n#20 uct_mm_iface_poll_fifo (iface=0x7f18a8027e20) at sm/mm/base/mm_iface.c:304\r\n#21 uct_mm_iface_progress (tl_iface=0x7f18a8027e20) at sm/mm/base/mm_iface.c:357\r\n#22 0x00007f18c4686e22 in ucs_callbackq_dispatch (cbq=<optimized out>) at /usr/local/src/conda/ucx-1.13.1/src/ucs/datastruct/callbackq.h:211\r\n#23 uct_worker_progress (worker=<optimized out>) at /usr/local/src/conda/ucx-1.13.1/src/uct/api/uct.h:2638\r\n#24 ucp_worker_progress (worker=0x7f18a80008d0) at core/ucp_worker.c:2782\r\n#25 0x00007f18c80f586f in arrow::flight::transport::ucx::UcpCallDriver::Impl::MakeProgress (this=0x7f18a804d2d0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:759\r\n#26 0x00007f18c80f2e40 in arrow::flight::transport::ucx::UcpCallDriver::Impl::ReadNextFrame (this=0x7f18a804d2d0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:449\r\n#27 0x00007f18c80f7661 in arrow::flight::transport::ucx::UcpCallDriver::ReadNextFrame (this=0x7f18b80017e0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_internal.cc:1037\r\n#28 0x00007f18c80dc7cd in arrow::flight::transport::ucx::(anonymous namespace)::PutServerStream::ReadImpl (this=0x7f18c07fcb60, data=0x7f18c07fcaf0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:140\r\n#29 0x00007f18c80dc525 in arrow::flight::transport::ucx::(anonymous namespace)::PutServerStream::ReadData (this=0x7f18c07fcb60, data=0x7f18c07fcaf0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:120\r\n#30 0x00007f18c80e18c9 in arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::HandleDoExchange (this=0x7f18b405c430, driver=0x7f18b80017e0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:414\r\n#31 0x00007f18c80e2008 in arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::HandleOneCall (this=0x7f18b405c430, driver=0x7f18b80017e0, \r\n    frame=0x7f18a804df80) at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:426\r\n#32 0x00007f18c80e2d21 in arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::WorkerLoop (this=0x7f18b405c430, request=0x7f18b80016d0)\r\n    at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:493\r\n#33 0x00007f18c80e335e in operator() (__closure=0x7f18b4050c30) at /arrow/cpp/src/arrow/flight/transport/ucx/ucx_server.cc:520\r\n#34 0x00007f18c80ecb1a in arrow::detail::ContinueFuture::operator()<arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::DriveConnections()::<lambda()>&>(arrow::Future<arrow::internal::Empty>, struct {...} &) const (this=0x7f18b4050c28, next=..., f=...) at /arrow/cpp/src/arrow/util/future.h:133\r\n#35 0x00007f18c80ec9e1 in std::__invoke_impl<void, arrow::detail::ContinueFuture&, arrow::Future<arrow::internal::Empty>&, arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::DriveConnections()::<lambda()>&>(std::__invoke_other, arrow::detail::ContinueFuture &) (__f=...)\r\n    at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/bits/invoke.h:60\r\n#36 0x00007f18c80ec883 in std::__invoke<arrow::detail::ContinueFuture&, arrow::Future<arrow::internal::Empty>&, arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::DriveConnections()::<lambda()>&>(arrow::detail::ContinueFuture &) (__fn=...)\r\n    at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/bits/invoke.h:95\r\n#37 0x00007f18c80ec71c in std::_Bind<arrow::detail::ContinueFuture(arrow::Future<arrow::internal::Empty>, arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::DriveConnections()::<lambda()>)>::__call<void, 0, 1>(std::tuple<> &&, std::_Index_tuple<0, 1>) (this=0x7f18b4050c28, __args=...)\r\n    at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/functional:416\r\n#38 0x00007f18c80ec5b9 in std::_Bind<arrow::detail::ContinueFuture(arrow::Future<arrow::internal::Empty>, arrow::flight::transport::ucx::(anonymous namespace)::---Type <return> to continue, or q <return> to quit---\r\nUcxServerImpl::DriveConnections()::<lambda()>)>::operator()<>(void) (this=0x7f18b4050c28)\r\n    at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/functional:499\r\n#39 0x00007f18c80ec440 in arrow::internal::FnOnce<void()>::FnImpl<std::_Bind<arrow::detail::ContinueFuture(arrow::Future<arrow::internal::Empty>, arrow::flight::transport::ucx::(anonymous namespace)::UcxServerImpl::DriveConnections()::<lambda()>)> >::invoke(void) (this=0x7f18b4050c20)\r\n    at /arrow/cpp/src/arrow/util/functional.h:152\r\n#40 0x00007f18c587331d in arrow::internal::FnOnce<void ()>::operator()() && (this=0x7f18c07fd110) at /arrow/cpp/src/arrow/util/functional.h:140\r\n#41 0x00007f18c587130f in arrow::internal::WorkerLoop (state=..., it=...) at /arrow/cpp/src/arrow/util/thread_pool.cc:262\r\n#42 0x00007f18c587227c in operator() (__closure=0x7f18b40517d8) at /arrow/cpp/src/arrow/util/thread_pool.cc:423\r\n#43 0x00007f18c587b8b6 in std::__invoke_impl<void, arrow::internal::ThreadPool::LaunchWorkersUnlocked(int)::<lambda()> >(std::__invoke_other, struct {...} &&)\r\n    (__f=...) at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/bits/invoke.h:60\r\n#44 0x00007f18c587b86b in std::__invoke<arrow::internal::ThreadPool::LaunchWorkersUnlocked(int)::<lambda()> >(struct {...} &&) (__fn=...)\r\n    at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/bits/invoke.h:95\r\n#45 0x00007f18c587b818 in std::thread::_Invoker<std::tuple<arrow::internal::ThreadPool::LaunchWorkersUnlocked(int)::<lambda()> > >::_M_invoke<0>(std::_Index_tuple<0>) (this=0x7f18b40517d8) at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/thread:264\r\n#46 0x00007f18c587b65c in std::thread::_Invoker<std::tuple<arrow::internal::ThreadPool::LaunchWorkersUnlocked(int)::<lambda()> > >::operator()(void) (\r\n    this=0x7f18b40517d8) at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/thread:271\r\n#47 0x00007f18c587b580 in std::thread::_State_impl<std::thread::_Invoker<std::tuple<arrow::internal::ThreadPool::LaunchWorkersUnlocked(int)::<lambda()> > > >::_M_run(void) (this=0x7f18b40517d0) at /opt/conda/envs/arrow/x86_64-conda-linux-gnu/include/c++/10.4.0/thread:215\r\n#48 0x00007f18c4e4ba93 in std::execute_native_thread_routine (__p=<optimized out>)\r\n    at /home/conda/feedstock_root/build_artifacts/gcc_compilers_1666516830325/work/build/x86_64-conda-linux-gnu/libstdc++-v3/include/new_allocator.h:82\r\n#49 0x00007f18c47756db in start_thread (arg=0x7f18c07fe700) at pthread_create.c:463\r\n#50 0x00007f18c4aae61f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\r\n```\r\n",
        "created_at": "2022-11-17T17:59:54.000Z",
        "updated_at": "2022-11-17T18:01:53.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: C++",
            "Component: FlightRPC",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2022-11-17T18:00:24.894Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-18351?focusedCommentId=17635483) by Antoine Pitrou (apitrou):*\ncc `[~lidavidm]` `[~yibocai]`"
        }
    ]
}