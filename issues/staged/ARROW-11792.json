{
    "issue": {
        "title": "PyArrow unable to read file with large string values",
        "body": "***Note**: This issue was originally created as [ARROW-11792](https://issues.apache.org/jira/browse/ARROW-11792). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nI am having difficulty re-reading a Parquet file written out using Pandas. The error message hints that either the file was malformed on write, or possibly that it is corrupt on disk (hard for me to confirm or deny that option - if there's an easy way for me to check, let me know).\r\n\r\nThe original Pandas dataframe consisted of around 50 million rows with four columns. Three columns are simple `float` data, while the fourth is a string-typed column containing long strings, averaging 200 characters. Each string value is present in 20-30 rows, giving around 2 million unique strings. This is currently where my suspicion lies if it is an issue with pyarrow.\r\n\r\nThe file was written out with `df.to_parquet(compression=\"brotli\")`.\r\n\r\nAs well as pyarrow 3.0.0, I have quickly tried 2.0.0 and 1.0.1, both of which fail to read. Re-generating the data and writing takes several hours, annoyingly - a test on a smaller dataset produces a readable file.\r\n\r\nI am able to read the metadata of the file with PyArrow, which looks as I expect. The full metadata is attached in JSON format.\r\n\r\n>>> pyarrow.parquet.read_metadata(\"builtenv_vulns_bad.parquet\")\r\n<pyarrow._parquet.FileMetaData object at 0x7f8ae91f88e0>\r\n  created_by: parquet-cpp version 1.5.1-SNAPSHOT\r\n  num_columns: 4\r\n  num_rows: 55761732\r\n  num_row_groups: 1\r\n  format_version: 1.0\r\n  serialized_size: 3213\r\n\r\nI can provide the problematic file privately - it's around 250MB.\r\n\r\n{{\r\n[...snip...]\r\n    df = pd.read_parquet(data_source, columns=columns)\r\n  File \"/home/farm/farmcatenv/lib64/python3.6/site-packages/pandas/io/parquet.py\", line 312, in read_parquet\r\n    return impl.read(path, columns=columns, \\*\\*kwargs)\r\n  File \"/home/farm/farmcatenv/lib64/python3.6/site-packages/pandas/io/parquet.py\", line 127, in read\r\n    path, columns=columns, \\*\\*kwargs\r\n  File \"/home/farm/farmcatenv/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 1704, in read_table\r\n    use_pandas_metadata=use_pandas_metadata)\r\n  File \"/home/farm/farmcatenv/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 1582, in read\r\n    use_threads=use_threads\r\n  File \"pyarrow/_dataset.pyx\", line 372, in pyarrow._dataset.Dataset.to_table\r\n  File \"pyarrow/_dataset.pyx\", line 2266, in pyarrow._dataset.Scanner.to_table\r\n  File \"pyarrow/error.pxi\", line 122, in pyarrow.lib.pyarrow_internal_check_status\r\n  File \"pyarrow/error.pxi\", line 99, in pyarrow.lib.check_status\r\nOSError: Couldn't deserialize thrift: TProtocolException: Invalid data\r\nDeserializing page header failed.\r\n}}",
        "created_at": "2021-02-26T10:25:03.000Z",
        "updated_at": "2021-03-01T09:13:16.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": false
    },
    "comments": [
        {
            "created_at": "2021-02-26T11:05:10.272Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11792?focusedCommentId=17291573) by Daniel Evans (DanielEvans):*\nOn some further investigation with pyarrow itself, I can actually read the String-typed data (so the title may be misleading), but the other three columns fail to read:\r\n\r\ndataset = pyarrow.parquet.ParquetDataset(fp)\r\n\r\ndataset.read([\"damage_ratio_id\"])  # No error\r\n\r\ndataset.read([\"min_hazard_intensity\"])\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 1349, in read\r\n    use_pandas_metadata=use_pandas_metadata)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 781, in read\r\n    table = reader.read(\\*\\*options)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 384, in read\r\n    use_threads=use_threads)\r\n  File \"pyarrow/_parquet.pyx\", line 1097, in pyarrow._parquet.ParquetReader.read_all\r\n  File \"pyarrow/error.pxi\", line 99, in pyarrow.lib.check_status\r\nOSError: Couldn't deserialize thrift: TProtocolException: Invalid data\r\nDeserializing page header failed.\r\n\r\ndataset.read([\"max_hazard_intensity\"])\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 1349, in read\r\n    use_pandas_metadata=use_pandas_metadata)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 781, in read\r\n    table = reader.read(\\*\\*options)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 384, in read\r\n    use_threads=use_threads)\r\n  File \"pyarrow/_parquet.pyx\", line 1097, in pyarrow._parquet.ParquetReader.read_all\r\n  File \"pyarrow/error.pxi\", line 99, in pyarrow.lib.check_status\r\nOSError: Couldn't deserialize thrift: No more data to read.\r\nDeserializing page header failed.\r\n\r\ndataset.read([\"damage_ratio\"])\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 1349, in read\r\n    use_pandas_metadata=use_pandas_metadata)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 781, in read\r\n    table = reader.read(\\*\\*options)\r\n  File \"/home/jbanorthwest.co.uk/danielevans/venvs/farmcat3/lib64/python3.6/site-packages/pyarrow/parquet.py\", line 384, in read\r\n    use_threads=use_threads)\r\n  File \"pyarrow/_parquet.pyx\", line 1097, in pyarrow._parquet.ParquetReader.read_all\r\n  File \"pyarrow/error.pxi\", line 99, in pyarrow.lib.check_status\r\nOSError: Couldn't deserialize thrift: TProtocolException: Invalid data\r\nDeserializing page header failed."
        },
        {
            "created_at": "2021-03-01T09:13:16.687Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-11792?focusedCommentId=17292758) by Daniel Evans (DanielEvans):*\nI've re-run the file generation over the weekend, and it appears that a valid file has been generated. It therefore seems that this may have been a file corruption issue, rather than a bug - feel free to close it off unless you suspect that there was an intermittent issue with file writing."
        }
    ]
}