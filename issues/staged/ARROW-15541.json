{
    "issue": {
        "title": "[Python] Cannot build pyarrow with older version of cython",
        "body": "***Note**: This issue was originally created as [ARROW-15541](https://issues.apache.org/jira/browse/ARROW-15541). Please see the [migration documentation](https://gist.github.com/toddfarmer/12aa88361532d21902818a6044fda4c3) for further details.*\n\n### Original Issue Description:\nHi There,\r\n\r\nI installed arrow/5.0.0 as the following.\r\n\r\n\"\"\"\r\n\r\ngit clone https://github.com/apache/arrow.git\r\n\r\ncd arrow\r\n\r\ngit checkout apache-arrow-5.0.0\r\n\r\nexport ARROW_HOME=/g/data/z00/yxs900/.local/environments/arrow\r\n\r\nmkdir cpp/build\r\n\r\ncd cpp/build\r\n\r\ncmake -DCMAKE_INSTALL_PREFIX=$ARROW_HOME \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DCMAKE_INSTALL_LIBDIR=lib64 \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DCMAKE_BUILD_TYPE=release \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DPython3_EXECUTABLE=/apps/python3/3.7.4/bin/python3 \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DARROW_PARQUET=ON \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DARROW_PYTHON=ON \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DARROW_CUDA=ON \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DARROW_DATASET=ON \\\r\n\r\n\u00a0 \u00a0 \u00a0 -DARROW_BUILD_TESTS=OFF \\\r\n\r\n\u00a0 \u00a0 \u00a0 ..\r\n\r\n\u00a0\r\n\r\nmake -j1 VERBOSE=1\r\n\r\nmake install\r\n\r\n\"\"\"\r\n\r\nThe build is successful and installed properly. But when I try to install the python wrapper as the following\r\n\r\n\"\"\"\r\n\r\ncd ../../python\r\n\r\nexport PYARROW_WITH_CUDA=1\r\n\r\nexport PYARROW_WITH_DATASET=1\r\n\r\nexport PYARROW_WITH_PARQUET=1\r\n\r\nexport LD_LIBRARY_PATH=${ARROW_HOME}/lib64:${LD_LIBRARY_PATH}\r\n\r\npython3 setup.py build_ext --inplace\r\n\r\n\"\"\"\r\n\r\nIt stopped at the error message\r\n\r\n\"\"\"\r\n\r\nError compiling Cython file:\r\n\r\n------------------------------------------------------------\r\n\r\n...\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Writable):\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 pass\r\n\r\n\u00a0\r\n\r\n\u00a0 \u00a0 cdef cppclass CInputStream\" arrow::io::InputStream\"(FileInterface,\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Readable):\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 CResult[shared_ptr[const CKeyValueMetadata]] ReadMetadata()\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ^\r\n\r\n------------------------------------------------------------\r\n\r\n\u00a0\r\n\r\npyarrow/includes/libarrow.pxd:1199:33: Expected ']', found 'CKeyValueMetadata'\r\n\r\n\"\"\"\r\n\r\nDid you see this error before? I am using cmake/3.21.4, cuda/11.0.3, mccl/2.8.4, and python 3.7.4. The cython version is 0.29.14.\u00a0\r\n\r\nLet me know what else do you need for the diagnosis.\r\n\r\nCheers,\r\nYue",
        "created_at": "2022-02-03T05:55:48.000Z",
        "updated_at": "2022-02-10T16:08:47.000Z",
        "labels": [
            "Migrated from Jira",
            "Component: Python",
            "Type: bug"
        ],
        "closed": true,
        "closed_at": "2022-02-08T13:09:51.000Z"
    },
    "comments": [
        {
            "created_at": "2022-02-03T11:13:38.962Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15541?focusedCommentId=17486382) by Joris Van den Bossche (jorisvandenbossche):*\nCan you try with a more recent version of cython? (0.29.14 is quite old, more than two years) It might be we need to set a minimum cython version in our build scripts"
        },
        {
            "created_at": "2022-02-03T23:05:00.087Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15541?focusedCommentId=17486743) by Yue Sun (u4865578@anu.edu.au):*\nHi Joris,\r\n\r\nThank you for the prompt response.\r\nI actually read the setup.py file in the repo https://github.com/apache/arrow/blob/4591d76fce2846a29dac33bf01e9ba0337b118e9/python/setup.py#L45 and the minimum version is set to 0.29.\r\n\r\nI installed a newer version 0.29.27 and tried the build again. It passes the breaking point previous throw the error message complains about the cython grammar error:)\r\n\r\nHowever, the new build of pyarrow ended up with the following return message\r\n\u201c\u201d\u201d\r\n[ 90%] Built target _dataset\r\n[ 93%] Compiling Cython CXX source for _json...\r\n[ 93%] Built target _json_pyx\r\n[ 96%] Building CXX object CMakeFiles/_json.dir/_json.cpp.o\r\n[100%] Linking CXX shared module release/_json.cpython-37m-x86_64-linux-gnu.so\r\n[100%] Built target _json\r\n\u2013 Finished cmake --build for pyarrow\r\nBundling includes: release/include\r\nMoving built C-extension release/lib.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/lib.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_fs.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_fs.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_csv.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_csv.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_json.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_json.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_compute.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_compute.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_cuda.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_cuda.cpython-37m-x86_64-linux-gnu.so\r\nDid not find release/_flight.cpython-37m-x86_64-linux-gnu.so\r\nCython module _flight failure permitted\r\nMoving built C-extension release/_dataset.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_dataset.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_feather.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_feather.cpython-37m-x86_64-linux-gnu.so\r\nMoving built C-extension release/_parquet.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_parquet.cpython-37m-x86_64-linux-gnu.so\r\nDid not find release/_orc.cpython-37m-x86_64-linux-gnu.so\r\nCython module _orc failure permitted\r\nDid not find release/_plasma.cpython-37m-x86_64-linux-gnu.so\r\nCython module _plasma failure permitted\r\nDid not find release/_s3fs.cpython-37m-x86_64-linux-gnu.so\r\nCython module _s3fs failure permitted\r\nDid not find release/_hdfs.cpython-37m-x86_64-linux-gnu.so\r\nCython module _hdfs failure permitted\r\nMoving built C-extension release/_hdfsio.cpython-37m-x86_64-linux-gnu.so to build path /scratch/z00/yxs900/install/python_modules/arrow/python/pyarrow/_hdfsio.cpython-37m-x86_64-linux-gnu.so\r\nDid not find release/gandiva.cpython-37m-x86_64-linux-gnu.so\r\nCython module gandiva failure permitted\r\n\r\n\u201c\u201d\"\r\n\r\n\r\nAre the complaints about \u201cdid not find release/ <cython module>, failure permitted\u201d harmless? Given I turned off those modules in my arrow cpp build.\r\n\r\nMany thanks again for the support.\r\n\r\nCheers,\r\nYue\r\n"
        },
        {
            "created_at": "2022-02-04T11:43:34.539Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15541?focusedCommentId=17487038) by Joris Van den Bossche (jorisvandenbossche):*\n> Are the complaints about \u201cdid not find release/ <cython module>, failure permitted\u201d harmless? Given I turned off those modules in my arrow cpp build.\r\n\r\nYes, those messages are harmless. There are optional modules in pyarrow that need a certain part of arrow C++ to be build and for which the python build is also not enabled by default (such gandiva, flight, orc, ..). The way that this works is that if not enabled they are \"permitted to fail\". So it is normal that you see some of such messages.\r\n\r\n"
        },
        {
            "created_at": "2022-02-04T11:44:48.691Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15541?focusedCommentId=17487039) by Joris Van den Bossche (jorisvandenbossche):*\nAnd thanks for the feedback! So it seems upgrading cython resolved the issue, and so we should update the minimum required version in our setup.py"
        },
        {
            "created_at": "2022-02-08T13:09:51.570Z",
            "body": "***Note**: [Comment](https://issues.apache.org/jira/browse/ARROW-15541?focusedCommentId=17488832) by Antoine Pitrou (apitrou):*\nIssue resolved by pull request 12334\n<https://github.com/apache/arrow/pull/12334>"
        }
    ]
}